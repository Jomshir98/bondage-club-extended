if("function"!=typeof window.ImportBondageCollege)throw alert("Club not detected! Please only use this while you have Club open!"),"Dependency not met";if(void 0!==window.BCX_Loaded)throw alert("BCX is already detected in current window. To reload, please refresh the window."),"Already loaded";window.BCX_Loaded=!1,console.debug("BCX: Parse start..."),function(){"use strict";const BCX_VERSION="0.7.2-31c10355",BCX_DEVEL=!0,icon_ExternalLink="data:image/svg+xml;base64,\nPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxzdmcgeG1sbnM9Imh0dHA6\nLy93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAg\nMCAyMCAyMCI+DQogIDx0aXRsZT4NCiAgICBleHRlcm5hbCBsaW5rDQogIDwvdGl0bGU+DQogIDxw\nYXRoIGQ9Ik0xNyAxN0gzVjNoNVYxSDNhMiAyIDAgMCAwLTIgMnYxNGEyIDIgMCAwIDAgMiAyaDE0\nYTIgMiAwIDAgMCAyLTJ2LTVoLTJ6Ii8+DQogIDxwYXRoIGQ9Ik0xOSAxaC04bDMuMjkgMy4yOS01\nLjczIDUuNzMgMS40MiAxLjQyIDUuNzMtNS43M0wxOSA5VjF6Ii8+DQo8L3N2Zz4NCg==\n".replaceAll("\n",""),icon_Typing_base="m16.224 3.7453 18.537-0.00135c8.045 0.12979 14.142 7.9048 13.74 13.256v5c-0.07394 7.8789-4.2176 15.139-12.946 15.375l-13.663 0.17306-10.992 8.5772-0.13168-8.8861c-4.4316-3.095-9.4592-6.006-9.113-12.266l-0.15485-7.9735c-0.11565-6.8309 6.3297-13.251 14.724-13.255z",icon_Typing_dot="m15.793 19.891a3.5336 3.5336 0 0 1-2.5515 4.2857 3.5336 3.5336 0 0 1-4.2954-2.5351 3.5336 3.5336 0 0 1 2.5186-4.3051 3.5336 3.5336 0 0 1 4.3147 2.5021",icon_Typing_star="m11.902 16.017 0.16893 3.7841-3.5814-1.2839-0.64194 1.9934 3.6489 1.0136-2.3313 3.007 1.6893 1.2163 2.1285-3.1421 2.0948 3.1421 1.7231-1.2163-2.365-3.007 3.6489-1.0136-0.64194-1.9934-3.5814 1.2839 0.16893-3.7841z",icon_NewMessage="data:image/png;base64,\niVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAABGdBTUEAALGOfPtRkwAAACBjSFJN\nAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAADpElEQVR42uyZP0grWRTGz+gk\nyhPEXYSQQmTAJoWCqJ2VqAgmYhBFtxELURHfW7ERbATTprEIJmAEWcbONBKf+KcRG7HQoGEW0ZhC\ngwmmEGIiZvy2eXlkvE40muhG5oMUmTn3nvO75947d85wAOgrqIi+iDQQDUQD0UA0EA3kPeLD4TA5\nnc7voihOSpL0BxHJhZIEQRDuOjs7F8fHx220sLDwg4hQyL/p6Wk7NTU1/ZvJiOO4Tw/0pRiqq6uD\nHM/zN8lk8k8iIqPRSKFQSJE/q9VKExMTVFJSQvF4nMkvAOI47sV5kDqcZrJN7wsAlZaWkizL5HK5\nSBRFha0gCBQMBunx8ZGIKEo8z9+kyNbW1uB0OhnikZERXF5e4qMVDocxOTnJZMRut2N/fz/92o0C\nZGdnBwCwu7sLk8mkaFxZWQmPx/NhEOvr66iqqlLEIAgCNjc3AQB+v18dZGtrSzEaY2NjTHZmZ2cR\nj8fzBnB/fw+bzcb4HRwcxNXV1W+7k5MTdZDt7W2mY5fLxXTa0dEBSZJyDnF+fg6r1cr4m5+fhyzL\nCtusQQDA5/PBYrEoOi8vL4fD4cDd3V1OsuB2u2EwGBQ+WltbcXBw8Gyb4+Pj7EEAIJFIwG63M6PV\n39+PUCj0ZohIJIKhoSGm37m5OcRiMdV2GTOSvkbUtLGxAaPRqHBaU1OTcRDUtLe3h9raWkVfFRUV\n8Hq9L7Z909R6qmAwiL6+PmYUbTZbxlF8KbsWiwWnp6eviiEnIKl5vbKywszrlpYW+Hw+1XaSJMFs\nNjNZcLvdWe2GDEhxcfGbQFLy+/1obm5WBMbzPBYXFxU7jSzLEEURZWVlCtuGhgYcHh5m7ffda+Q5\n3d7eYmZm5tm9//r6GtFoFKOjo8z9qakpRKPRN/nM2dR6Tl6vl3ka19fXo7GxkTklrK6uvstXXkEA\nIBAIYGBgQPWk2t3d/eoF/akgAJBMJrG0tAS9Xq+AcDgceHh4yImPvKwRNR0dHcFsNqOtrU31CZ0r\nED69iP2a94psVFdXRx6PhwCQTqfL7zt7roNnHPD8x1dRCvkTgwIk39nJK8iX+dCTnoVCzgj/qwpB\nREQXFxcUCAQokUgwVY+n1ZLU/6cZVbN/TeUl3Wem9jqdjs7OzpQXTSbTRaEX6AwGw2VRb2/vP4W+\nPrq6urb5np6euUgk8m15efmvWCxWQkSPBRI/p9fr5fb29p/Dw8N/c9rnaQ1EA9FANBANRAPRQP5/\n+m8A4sEE5SZccHcAAAAASUVORK5CYII=".replaceAll("\n",""),icon_star="m12 .288l2.833 8.718h9.167l-7.417 5.389 2.833 8.718-7.416-5.388-7.417 5.388 2.833-8.718-7.416-5.389h9.167z",icon_heart="m14.483 4.5372c-10.063 0.0305-12.109 8.5713-12.008 12.355 0.1628 6.5444 5.4929 11.067 10.223 15.516 4.7684 3.8893 8.5801 8.3608 12.383 12.838 3.8031-4.4771 7.614-8.9486 12.382-12.838 4.7298-4.4488 10.06-8.9712 10.223-15.516 0.10164-3.7842-1.9446-12.325-12.008-12.355-4.9198-0.28718-10.597 6.153-10.597 6.153-1.7777-1.9041-4.833-6.2892-10.598-6.153z",icon_BCX_cross="m7.3532 5.3725 10.98 19.412-10.98 19.803h15.294l2.3528-5.4898c0.78426 1.8299 1.5685 3.6599 2.3528 5.4898h15.294l-10.98-19.803c3.6599-6.4706 7.3197-12.941 10.98-19.412h-15.294l-2.3528 5.4898-2.3528-5.4898z",icon_BCX="data:image/png;base64,\niVBORw0KGgoAAAANSUhEUgAAAFYAAABWCAQAAAD/X6l8AAAABGdBTUEAALGOfPtRkwAAACBjSFJN\nAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAUPUlEQVR42rTbeZRdVbUu8N8+\n/ak2VUmlJ30fCKGTRiFECQECCAER5cngCfK4cFFRvOodV0EZDK/eq2LzHD5RwOYiCELohNBjICBN\nICSkIX3fVaoq1ddp9n5/1EmlEtAEU5w1xhn7VK191nfmmmvObzY7iPzj15jyXX8280sdk3UpCkWI\nEICYuKSiO2N/iyZcPejeEESaRKX/75m18d5piUvDitI9+9bb+w0ZG/woY8nAs1fW/2MsiYNgVdHW\n8dru2WtSE8WECErLRQKBSCiUdbTX7D6/tgdsrAdU81w1U5SLxHru1QtwTMxqnYa8OLr+YFhiB5sQ\nqZgXa1miWUKsJI2g539EQgWTjNA0s2F8h3btOnTJyclrHdry8cGGi5V+2r67gx5ptVokbMrcvcdh\ng82oWlz23AYrxQS9pgcluJFQUT+ThUOaz0tKSkrIl8Dm5uQmjDZUWIIaHaAIMQlrbVC9urBix+GD\n7VIslD3QbpmcuKBHLlHPopFQ3DRlWs7IZwoKCuLi4oJE4yVZR0r+g+Ujy7Wru29sy9jDB0uk8oXU\nqhXqS2CD/XQuLiEp7gjVOme0fbRTh86S1IrTO4+rNExKRlJc0Gv7u68SGiyR3h57dJeGgyI56AEr\nIr6+8rmm8e8aKiYswY2JIa9Vh112aNAmKmub0/+ZsMdeNJ4V1uQ8o9ZQg2VlpQRCYWlfYhJW2a3q\n+WB558GldnCwBQTKH2q88u34ybIKcnK6NNiu1SabddmjS1xSXNvZ/W4NdndbimJF6zlxXV4SSquS\nMcQRKg02QEpSQlzkHZ1G/aVfFPYF2O4vybxU9tq7J71uiHpbrdWqSZNIKBAXkyltcX5c24ziA5Gk\nQO7U/HEBkog0KtrsDZEaNcqMNNRATdYqX1w7PyvqC7DdE4I9ZffvOemPyCkoiIn3GLKYqGQVIkGi\ndc6wB+jAnguKqag0LxAXL52APRqE3hGXRqcBT9nZTl+Ardh7Dp9qru8YEBNI9LopFCqISQgMVW2L\n5vOyk8pXbJEb1TY7bqyc7UJFYckBEJcoaXUXkm39H8gL+wbsXouQWZp9uf28bi9U7LGX5WpljDBU\ntaGqPGx+3bZZg1Z06Tg9N/IjzhOp12yrzTo0aS7tRLesA6Gy16sWB4cG4uBg925QLCx/qOM8CgL9\npIxRq8IgA6WlS5uddJSFGueW/yrW1XZOhSNVSBgoUJTTpd42LRqt06lTuzSqHu9oD/sKbFWPVUw9\n27ixMOI40w2RUS7ZY4ZCRTGBomGOsOTY+KTKjrWnTzJCKJQHSSnVxonktOvQZJHXJLb3n5c4pMN1\nSGA79l2uS8/r+OJ4M3XKycv3eLG9fr8ga4IVVQ3fIV43RlkvFxL28LC4av1N0m6hyqcSK/sQ7K5e\nHic7v+XqdzP1siWt3eeJ9rneqZ6z85ORChMkxCVFJbYWCBRLliOm2QpR2O+xmAJ9BTbb27m+mFqx\nfPpmk7qdaQ/QoIeDFQwywd8wwQhpjZbaLY+YlBrT9FcUSdpqubLVNQsI+g5s7wmx5sqHtk9fYmIv\nvqoXXEIpUy3RaYJ2j9upwvlG6VQu4zl/0c+J+kt7S73h9/ffGhyyEhwC2Nh+tKX8scSX3u23W42w\nZ/u7GVhQug6N009Rg/uc4LvGqsVyf7PDKlstsdh4oywRb6h+aLcifQc2tf+nN8qeXn/xBgMUe8UM\nvd8Lak31iryfOQXtfukt8/FpZ7pQmTa7PGaL8uaO5iah4FCN/cHnpfcPQ8Kqv2y7eJlpglKY44Bg\nJaHRDpf4nhp5j/u+dWb5hWmG9Zp1mSV+NmrBfdkvJZ49dMkelM8W9xuh6qdjG96xQ1zQww72vZKa\nPOlzfqrGble72hTz3ensXlBDnQab5SeuPNJ9xbl9qAYHGpbEpn5PbPs/Kw3vkew+2cZ1eMTlrsQK\nX9DqTrNL8uiy0qvWaZcx1qlShvhvmdpf3hHf5uU+Apt7TzyauS+4fGn2RNmS8Yp6NinvEaf4PNa5\nwpF+oFqXrB2ec5e3pIVy0lqNd73zRS62oHrZL+Ona+wTNWg/YLSJvZp+a4Nt4iUWtS/AeVk/Nwls\n8r+d7OdqxST9j7mukzJZRlZkms+K+brfWmm6a6Sm5S7tVrLDBpt+72ipeqzR2yXSF5S8U9ImO3xf\nRrvrHeN7OnVo9g23Otq3DbdNq3Z5aT92t5F+q12XSeoU56rpE8lWvmdUqHwianxbo0QpGgvEtHrG\nFUbjZhk/kJG2wyWWeMIN3jJPU+mndXnLDqdrstACrcpFIx3bJzr7fpuTebt84Y45G/QXiImssNYu\nOxUttN4Tfi6J0HcN8w3tHvakUKLkOoarsFBWu3WulTTIu2Vhvz4Bm3+/7chX/XHzOYuDaeJC8633\nNYNsVm23d82w3jLHWajBH6U850/yJedS0N/JJmuwWkzSuwbLCcSCD8V0lSzCi6k168ftMMIO77jM\nHF1GGoXTZDW41/N+b46ChBW2i5eccd5glV61zWJZExU8ayedUXOfku8D4G5omr9x3EqjNQo0+g8p\nY40zxiApg31Jl0941HUu8KbWUiSXV+HrTveCjZar8wkTrNMmttGiD00NiOn30O4vLEoVNZlqmS71\nNko40/FmOBZpx5ruGXd6VVIgkhd3sTNl1HhKu9k2S1lsj/jCqP5QwAYHI2gT/97BK9/5WGLGmX4i\naYexmiywxk6Paneiy8xUrVVGpzv8UJuEpH/3aZuU+a2fOtO3ZLzkt96pz34kWgeb+9qD9fCvtuz8\n9IxL7VKQEZc1y0X4qsV+4zojXOlkY5S5Xo1blLnZDDW2e9hvHGW2Sboss0L659bF+sbdvn8OKi4U\nPV286cF0g4Q6oxzvOKGYIYY4y1/90HVOdIMpGpxpsm/YIa5gqZ+p8kUfsczr/iJ4JfbzQ40VDqoG\nQ/6Oznadcuy3Z5+xPt4maY3NutS4zKmmyYgEWt3jP7W40izHqvZ7N/umuJtU+ayLTXC731i3LXlR\n0ENjNh0u2KHvk/CgMHbiM78aOdEGQ2TtVLTYi97yonNc5nQFWSmLfdUCZ/k3Q7T7g98qmOBGoyRV\n+ooXculrgjv3ffNh62zwPmCLEsdMH77ZRkmBAbLKnOUsnR4xz+ed5EozFI12ix97VLlzjXeTNd70\nVeeI+bV5FrWnvu7OQ4/ADjl9tB/YVNvxwSnPeUiXhKkuNMjxRiLjUy7ymO+73FyfV+Z4t7vWQzIG\na3eRN62yyxr3Wryl7MbgnugDrXyIKc/en7Nf+cIt5Ym1qmRsscqNIke51CxHoWCOM/zETy31L4Yb\n6CpbPGmANhe6yzyhB6xfkb0yWPhBxXRQna07QCXyl196x4/iCVuNEGi13RrveNCbKs3wLybqL4l7\n3KjWt/RXbpsbDHa9mX7ldmmtDydviNbuXxWDLYdLEbtLGXuzhwWOGx7/g1972waNisaY7Svm+5OT\nPOwc13nBLlvNdL+M71gk7QLnW2WTDYaL7PlV6qLYWv/E6xDzBiESCmJ03q1TTpnBTnSG6QaizDlm\n+ZNfmGeRy33CBCe53cXuM0yLC8y3yFSvy0stigrRP4NV7INMDnVOGDhtioSxZulvgWud4ufelEen\ny/zJV7W4zW22KBjoCls9ostMH/eUa/xZoi1YGQpLNbQ+lmxvGl747Kwf3DDscaFbTcLLvqLWf+p0\noc+aKmmYHxjrFo/pdJWsy+Xcb5W8OhU6xTdEN3vee7S1TyUbCBPF73zmrq8Pm29nCep63/Ypj5jn\nXz3oMt/0uh2WOdt/GW6B3wkMd4bAGkdJyUn+OvWRxF2hvzf6Kk1flv+vr197na9Z7w4DsNkVxpgr\nZpqXZbX5s5dc7UT9fUbcVzzvCDtNd7EX/be/KkhHQ3cWtXyAvOEHLjRHIp03zr32Rk/b4MeGSVvj\nImPcJmmr292qS0ZGm5/4f7aqd6xLBZ5Sb4oZ3vEr68W1ndJY989DPUTJ5k6d+OUv+oPvuc0UNLpa\nzpdVKXO378tLieQcb5Z7/YfPG+VmGzzmDfOlDMAYXZZOHDij7v7iPw32ECQbpqPzrqip9kPfdI6C\nolutcqOsdzzv+5qlUNTPdOe50wqPa5N1ugprpQ3TZphrzJRNNF2aixX9vdEHko2qKyYP9IAxLkfC\nPLe7yiWS3vYjm5SXSPrJPmKDMtM9aIR651rmj27UocPRksYaZOPHBk5KL4s+LMl2C3eR37tCXKTe\nLYY50S7tnvKyshJFH+kq5xvjNTlneUSZwUZIaFDuXKfIqXKU4qA9sxIlr/je0QeSjbXkV97hY85E\n4EFLzTFes1ZPlg5LTsanTUe15c5xhnM9KSOjwhmOExcpSjrSy/ZcOOL2ZPuH58E6w9XtZpfC6Zfk\nbDHIJHWa5QW6JFzv0+pt9Li8k6zAq0ZKKjNZQrFUNh3lCG0f3X1ysz3vO/rCdJU7Km4QWOB5M/Dv\n1gh9x5H2KHetfzXWQG0edb5jNCpaa657fFJlqV4WKUo5SpBo+mRY+suB47DVIKAYdVIJNtjhStM9\n7BqtqoXOcpUpUqj2M036+5sl9hjvNHUq5UrpuG44Ew3QMnPQwOTO6MOwsxGd0cqg1OeSQqNjzLFQ\nuyqhsQYJNUu6yyNutdsaL2CacTrkepVJQgWDTLHgyKYZZfeFHxo3WBrt6s7MHGu8J3SKOc5pTjJd\nbXd+xt2+7TpnGGW99YYYbY9CqbK7t/xUlHCMtLYL+wU13jsOG2wgELwSPb0RjHOu5b7mDZEMMpIi\nG93seqc73iavWazLGDGF0sHaq4+hSNFIw7XMzk8vl33P6AudFfDo7z81N1GBqzzvIcudZZajJW3w\nhD9b70rXeVGrdy1WZ3KptyYsvcdLudmCGpOtqN398dSbH9ztHmKSoyh88McXfE5R3NuutETeMCOw\n2QbVLnerrNu1utdqH3VCqYkqUQqKupusYuLKrPB/Ff467qxEx4Frv9I3fDam+K2b1r0ojmlud7GJ\nGrzkNYG5bneJJouEXrTaYBMUFEp1s70dCXt7P/KOMFHXiYWTszIHjD4LxVNLd9305d/cljxFo9Hu\n8LaHkDPG55RZ7Y8ylntFymRl8uJiwlLxKegpQYWKyk31RrrhkvSzYV+brnyP5ibvXjntqhtujM9W\nK2W0G9TaZY1QpyUqrPAXOaOM0CohLhQqCkol6VhJayOh8Yao/3j5sHBLH4Pdl98SJm/bEvvWNX8r\n+19G2KpWmZ3WWSmryWue0GGgo8WslTBRsdQOEfQ0XEY91na0TePzMyrvDj8MsHtTh+l7Ok64+9QX\nfNTZNntHq1C7lZ6zVpc606V12Ywx4gqlQ7GvC6y73zbtOG/Y88mKu6MPDWwxaoiP6xxTq9qznjFE\njaQOO9VrlzDYFOUKOm0ValYrJiUlJdnrHHc7hzFGW/Gx6MjM0qiP3e2+7EwYOzY/bIxT7bLJaqtE\nSIipMdxQaaG07VpF6o0VSJcKe/v6bQOhomqjLRvafsGApWFfgq3srQfJxvNTpqnTz3jTNcsrCJFU\njkBaymKdIvUqe4WGUU+feFQKuo/xgoazB/0k1tKHbSf9e6lsy9Htx08yTEpKd+Pf3vbTvQwgZadN\nAjFr7DT8fWs93YdsqLGWHLv9hPSz0Qc4NIeUmIuLS2i/OOw/xYCeVF13F21cXFJaWlLSBk2SUnZZ\n8Z6U9L4m6kCN6cJM57kfxCkccq4r0FW7Z05Mi/WakJCS7MkvdnuqQKe3dapQoehdnb3iqkBcUlJK\nQmS35XaLaZulLilRGn3mwWJaTssfmfCSherUKTfQSBUqlEmWCtJxG62VVHlfVJWevdZGU+RL7Weh\nNm3abLJVsy3ahZJyR7bNKb+rz3oRO3ok03xeJC4vtNF6kZgqMXVGqVRnqHJpq7Wqbq2YXxhVMbvR\nEmPltdpuu2br7VbQrFhSnu6uo6Zz+/0uDPsIbLwEtXNk+0zCno2HNqFGq0TKVKlQYZNI3abUfWpq\nr2oe/Jqd2rXao70k30CyVB8PSgSy47TChOyKPuqfDUtKkJ+TG52V1Fp6lmP/buOCXXaKxJSre6wt\nJV/1u8y/tVoiVrISwX65s1AopkpeV139nH59BbabIkeJPReWOdsI6+zSbLMuRbmS349RitGKhrzS\n73stbYVk7Q8HnLLlYymxHnrY3TSZlJAyTLUBJtlhnuazB/wi6OgzyQa6Tmw58WgnqDJRpFOjPXZb\nqVXOTh1iiuICSQN/VGgIg6graq377o75URCVmFdWnbRyY9WpVqNCWlLOSq9+tOu0qvl90qBejcDm\nT8QqR8vKiwmkDDFM5CR5nbbbpdUaG+RUrIo/n1eIIjmJNyqWNU7NGGmcSrWGKisZu+724C4FGRO8\nnmk8p3p+0BdgYwJhXcsllSb26N3ejF9MUlqtQKDZbbaqebq4K54MCqFocHxb7f27p5a73DDFUvgY\nyffEdaFAaLI6TWc2DI5vjw7fKXTJqZ/ZPnWCgT2PVe1TkVBRTk5cs2aZrsEP9hOdEKUJ+hWD5EPJ\n1jYtYvLyJbD784XuTELHxOIZFaVs5GGBzUpqvqDcJOkDoO7t6Oqm1m/ao+bNygWdwhWpQmUU2x7F\nc0uqXmnxpsIBXYuRfc87pUyWDZo+G0+mDh9sh9axrR+rM+6Ax6N6X8e1eFdgyLygM0FDopAQNgWF\nysKAe+KW2CnRs1B0QAmgYJw6TSe1TwoPH2xB08eLR0xQ1RP6Rb2CwG6GmrLGelW7+z2S2McGIspU\nPFm2cZvVPZY56EVp9vKvfqYLa5pmJw8fbCLbcVnGeAl6PSu3L+cXiMl5R07tM43LNtpWOnyBLk3y\nmyofK1isU1ysF+cKelHLmKMM0HBxR+VhW4OuqS2TJ7WNLES99DXarxMhYZeVQSJRdX9Y8k1Bj8UI\nVf3Prs+si28Oxyrs186+j4rnjTI88dYRrUd78R9j+f8DAFFTI9BZXoPgAAAAAElFTkSuQmCC\n".replaceAll("\n",""),icon_OwnerList="data:image/png;base64,\niVBORw0KGgoAAAANSUhEUgAAAFYAAABWCAYAAABVVmH3AAAABGdBTUEAALGOfPtRkwAAACBjSFJN\nAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAMyUlEQVR42uyde2xUV37HP3Pv\nzPg5gz02njE2hrjhsSF4wRBCsgtBBiK1aOv1atOHFJWN2rCNKqKoEklXVaQkjdSlm6ZJiygl2zZt\nNt0u2pJNQrI0ySpZSIXlBBwwGD+CAzZjxsZ47BnPwzP33tM/5kwyMWDmvY53vtKRNWPfe3/3e37n\n/J732iSEoIDsQylQUCC2QGwBBWILxBaILaBAbIHYArEFFIjNMUx5vNYqYCXgBIqAEHAFOAtc+A3z\nsBpYLmUrBsJStm6gdy4S6wJ2Adul0OUVFRXFDofDAuherzfg9XqngEHgbeDfgMk8kbkU2AncDywE\nyuWEK4AhyfUDw8BbwE+AkbmwGn4AXFBV1Q+IJIZPau+f5VguK/A0cB6YSkG208Du36TGOoGfqqq6\nUdf1kviXjzzyCJs3b8bpdGK1WgmHw7jdbt577z1eeeWVxONDwGvAI/KGsrXlCWAF8CKwGShJ4zxB\nKdvjUpPzhjqgR1VVIz7b+/btE4ODgyIcDotIJCKi0ajQNE1Eo1ExPT0tQqGQ6O/vF88++2yihhjA\n+0BlFmVbB3QkqaG3Gm8Bt+eL1FK5lAUgtm/fLs6ePSt0XReGYYjZYBiG0DRNfPjhh2LLli2JN/Cm\n3PcyRSPw6yyRGh//JVdnzvHT+EVbW1uFx+MR6aC7u1u0trYm3sATgJqhS/nvWSY1Pp7MNan3WywW\nDRBNTU1icHBQZIKOjg7R0tISFz4K3JaBbN8DRnNE7GfAtlwS2wEIm80mjh49KrKBl156STidzvhe\nfTDNYKYCOJwjUuPj79M0hEkZhen4FqBpWlaIvXbtmmhra4sLHwFsacj2beBSjontAu7ORUj7XavV\nqgDs2rULVVWzMlsOh4OWlhbsdrsALMDvpnGaZqAhx9vgnTfyELJB7CbDMFSANWvWZFXijRs3cttt\nn2+v96V4uC3DvTkVrJjpvWSD2Ns1TTMBuFyurEpbX1+P3W6PBzErUzy8Ro58YLHcz7NGrCKTFuzY\nsQNFyW6yzGazYbFY4h8Xpnh4mRz5wIJsa6z58wDcas1+6s1kmhnjpzrp+cremWZeK1NiI3Jw+vRp\nst1VEwgEMAwjMU5PNa4P5olYv/SMsrrHXrJYLGJgYICxsbGsSjs8PEwgEIh/vJLi4aPA1TwRe3lm\nujMbxB63Wq0irrXZxKlTpxgcHIwvg09SPHwCuJgnYvtlVi6rxB4KBoM6wOHDh9E0LSuS+nw+jh49\nysjISHzvejuN03wCeHJM6qekWWVIBh/GI5Fjx45lJfI6dOiQqK+v1xOim3SsoxM4kuPIa7/0CnKC\nLdKIiba2NnHx4sWMSO3q6hLbtm0zEoT/TgayfV9uC7kgdRj4vVzvM8/GL7hnz560M1y9vb1i165d\nicIfTFNb47AnpjSzPPbG/fhcogx4PpHczs7OpAnVNE2cOHFCPPzww4mCvwJUZ0G2JuDjLJN6BFiS\nD8uoAn9OQoGura1NvPzyy6Knp0dEIpEbEhoKhcSZM2fEwYMHE3Ow8fETIFsJiG+SUOHIcLwvky+z\nRgyZoopYGfn3iZWU60wmk9lkMn3u3O/cuZNly5ZRV1f3pWLiyMgIQ0NDdHd3c+jQoVgoZ7ag61o8\n2JgChmS+98fSSGaCtcCPgK0ZnONnxCoH/bmMj/8aODXTOJSUlopN920RdrtdmM3mL832XXfdJTZt\n2iSam5uv0wSnq1asWt0kVFWd+TudWLb+VZn/zQSLgD2kXlW4QKxHoirZGDddS/t9YBmxRocvobzc\nxvMHfozXfZFfvf0GZ3p6uTrmRdf16wN6RaG6upoNa9by9fXrONV1lnd/+fbN/GFdRjnvSmN5KU35\nS4B6YAfQRqwcfiNEgV8Rq0K8K72ASC6IvRv4G/nTPtsf7vvX/8DrvkiFOYqqWuj45By9A5/Rde48\nU1NTVFZWUOtyUbeolubmdTgdlfgDIU52d/PLI0eIRmaVPyoJfhX4IRBIk+BieR9lMvVXJ0kPyvNf\nltuRL1lCr8tOJYEfAH8hl9KsE2KxWDCbVUQ0gqGApkX43oN/yJ1fX8UPf/SPnO/5lJqahVRVV2Er\nL0fTDaLRCBbFoLioCMV0y/m2EEti7wH+APgn6agbKRIblgMZ/qp80dwRD07SzqfeCnXAIWJtOXXJ\naLmiKOjRKIamYbGYiUSjeCfGqaqrZf26NTQ2LqW21oVZVQkGgxiGwGJWcJQXU1FWOjNdOBuKiDWz\nPSejsz+VpKcDAWhyNWiZkJoMseuBnwMPpCJwUXExQgi0aBhFUdB0DYtqZXR0BLdngm9sbsFeUf1F\nmtEEJiGwCJ0Sq0o4HE71PoqArwH/Qqwn66/IUzNFOsRuk37kxpRDnQUL8HmvUVZkpbjIimIyYbGq\nRKMm/FN+BGA2q5+7YyYhMJtVbCVWVH063YKkSS7l3wH+VrpDrxGr1Jbnm9ib3cF24IC0+iljyu9n\nYnycppW3YysrJhCK0rCknqsTQTxXRhHCAKHg801gVlXMqoq9yMzUxDg/P/o+nqtZyesWEauT/RHw\nl9J3bZDhsU8mpk0zBjf4zpTuLM/EPTI+vzPTO1vkcrHI5eK+b9zNhg3rmAzrjI2NceXyMIuX3saw\ne4hoZJpQMMgHx45zbdyLz+8nT8/3TgIDMq04Kq3/tBwR6Wn45e/7ZKAyLQ3kLQ3bTGKXSwt7f7rS\nLl++HKfTSWNjI2vXrsXlcrF//35CwRCbN20mEPAzMHCB5vV3c/LjDgY++4w1a9bQ2tpKb18fn3R2\ncuXKFfr7+/H7/cwhCBkB/i/wBnBOGjr9VgdWAP+Qbvzc3NwsHnzwQfH6668Lt9t9XU4gEAiIA/+8\nXxw+/D/C7XaL1177hWg/0X7d34XDYXHy5Enx1FNP3Sh3MJfGceBb3KQSrCZobqt0W1LGAw88wOOP\nP85jjz3GHXfcgc12fTeQruv09fQycOECH390krLycpYvX47D4fiyY202U1tby5YtW1i/fj3FxcUM\nDQ3h8/mYY2gA/phYi+h5blJfWwGcTGfmnnzySTE6OnrLtKBhGKK3p1c893fPizffOCLa29tvmvGa\nqcH79u0T9fX1c1l7z8hk/3XW87F0Trh3714RDAaTzrn6fD7x6qv/LT744LgYGxtLKQF+4MCBuUpq\nvNJxLtE1VWVo+CLgSGUdPProozzxxBOUlSXfbKJpGt3nzlFSbGVRXR0lJcl3PzY1NTE5OUlHR8dc\n2xLiIXCNDEqOAX5FspxyP/3u3btvuJfOBq/Xi883ydDgEB3t7UwFppI+1mq1snv3buYo4t7Vt2QM\nYFZllJJSIPDCCy+wdetWzObkczjRaJSPPvoI36QXz/Aw4+NeFtbUUFOTfN9aVVUVPp+P9vZ25jCc\nwFtKOj5rS0tLYrNa0sSOjo5x+7IV7HzoIVZ+bSVTU6ln+3bs2MEcxz1Ag5Ji6jA2JU5nyp2FJpMJ\nQ9ew2+w0LF1KcWk5hq6nLHVDQwNfAaw2p3NUuu2aJkyc6z5HeDqM99o4FRVLUz5HLroac+Hj5u3p\nb1VVqaxy4PGM8OsPjhOeDrN48WLmKSzmfF3JarWyYcNdBINBHJUODEOnurp6vhIr8vq+ggUL7CxY\nYEfTNMrKy7P2IMhchAL8Z0L2JqeIRjVGPB50LYrJpKRSgvlKEvscsQ6R2e5ygix0R7uHh3FfHqav\nt4/+/j6uXh2b18R2AX9C7InmG+EisU6X45lcSNM03O5hKisrqa5ZiKIojI6OzFti48ark9gzp01A\nC7Eaux84AfyfJPehTC+mRaI0NTVx7zfv5Z133iEUCs17YgHGiDV7nZDfG8RKEdqMeDh9U4mObmhM\nR6YxDIP5/IpV83X3PqOXPmt7jqJgtVg5e6aLU52ncdYspLGxcV7vsfm5kKLQsGQJkz4/JUVFlNts\nOJ3O3xqNzSlqamqor1/M4iUNlJaXppx2LGjsLIkYk6IQDobAMLL+iOhvrcbquo7PP4EWmSYcDhBc\ntYrS0tKCxmZK6sDAAKqicGHgU852n2dwcKigsZkiEonQ29tHfV0dq1evZujyZYIplGYKGnuzGTSb\nqaioxLWojnvuvRdHpYNAMFjQWDJ7RROqqlJWVsbgpUuUlZYyOTGJ05X6exq+IkGFkgqxnwI9MiIL\n8UUndNKEBAJTS7rOdNV1dp7WGpYsVpatWNYHjKfoWdiI9epOz1FSSwB3KmFqcYKGB0mxLf3pp59G\nVYu2OirtP3M5XbZLFy91ea56Wvfu3etOVfnJ0euYsmlSzCksrXAmV3rmmWdYuLDyjKZpD5XZytTp\nSKihOBQKprG0dWItlwWvIA6Px3MVeDP+woinXnxx3ma6TYV/4jMPQtoCsQUUiC0QWyC2gAKxBWIL\nxBaQJfz/AJiiFen2ESExAAAAAElFTkSuQmCC\n".replaceAll("\n",""),icon_rules="data:image/png;base64,\niVBORw0KGgoAAAANSUhEUgAAAFYAAABWCAQAAAD/X6l8AAAABGdBTUEAALGOfPtRkwAAACBjSFJN\nAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAF5UlEQVR42uybf1BUVRTHP/sT\nhRWMNAdLFMNMMLUZSGoYbdAYRtS0nEJLbcgfjCZaaiOjKWE6jpaDmWZZmjL5C8tfhIwa5TSIP1ML\nUksTyPInprLgCuze/uCx7rLsG3bp0WPac/95c8+5937ffeee83333acRtB7RyykvcJaL7GNPo9pQ\nMvGjhDX8LNXEEjU4M5l7dhNNkC1u0fELf9j1aYRyg6FUNtKflgn4E0l34rwBKy8adOgxIkLwRwAU\nmo+kMszR5ja7zogNmOoaiCr9ZX0zhmwG2LvcIJC89OI0tNgArFhd+rMt5r36uysUG5ZOf+dqnbEy\nYDVu6q+RQdv2JVOEsakj2MieuH+Z5c5dN6ba5oHVY9RYQ2hHo+uwtJaHaOvJ3NQYrz/GTXejWssN\n5Tq55kKmlLE1tM9XbSqxUuu22GS7aFhsMj1ZTTfDt6/s9oPbxrI9FwR1LfYIyr9QHi5a9bg7pawb\nrH29NAKC6epmSWio5qxHy0VHL/SN+xSC81TxZ+SW8VPSvHAD09cIxG7hXiyip0fzFi4sMr3NFAiE\nZr1XM2s2AnSQsfAjiyyZiOE8LTAGPxmLdnY7b6JBE3JxNNEtlm61tCLxgVUN2OOMZBg71UcRXeUE\ng3mbUMYyn9lOmnP8jkDwAL0JbNDqEhX0anmwRbRjDlqqaUhGFrKPHlixYSabSCfdNo6ypeXd4EX8\nmA4kM7VhTCaDAg5zlAksAO5QIzHa+1H4PLnckq5PcQCzsmC/5UkKGEShjE1bLMBIyWYIpfihAVYy\njsW8wq/AJlJYQAKXlXODMsZymAg+ZADD2erU2MR8NlKNAS1ZQAW1ANyhFmhDMbkcAg4yi918ypu8\nTCFCuZkNJpAcIJVT5LHeSWdhFMvpjyCf7i4tjRRziFj6M4MiBHNIpS+/0Fm5mTWxiWGcZh2RLkys\nlj7EEMOrLCLD8bXGnrej+IBb6LBRSwKn2MUSrpGmnM8O4AxanuYFXiMZwV8uBDGTPeQD3cihnM1c\nwgBYiKeCK0RzhDwMjOIEExlMubJJoTNZzCeXcAxcY7w9hAUTQB1He5+VwFJOEkMZ0UAAAbRnBUvo\nQwFTgWmk0wvh9AyaRNzcF/YgEIccGOcckS0xz4FCCJuoEDY7s62RruprraJSCHFX2ESNxGId7atF\npQufTa8b1js+6yo3SSUME/uIBTTShkAds73//mCSHpo/0Aao3ytwtDdgUDqDLSeECUACc9XPDQJI\nZ17z9kZaDiz/GVAf+faB9YFVO9hSUrneOsDm0o8AOqo3zt6X1bzBFl5Sc1Kol8+YRz7POpDDUo/z\nfQ1dmaE82B1MZq8DVCsfccGLfiI8AOuxz64jGStljCOJeLVzg0rW05vD6Hhf/URmGueYCWwixKle\nxxRKvPJZRRdYIquIIsml/i01xtmnSCGrSXvdKghdD/Kxjxv4wPrA+sACVoejGqoH+439tEM2n6g9\nzt4mk0l04V0WssyJ3f7mRboNI7Xp5p5tzAkhRIXoIUaIL4RBHHSorRWPevXJPkK5jTkAEzuIYyer\nGdAaokEYHQFja+AGZ4kjgTUM4Uem0UH6xK+jG2bZD/SNyT0eURLsSYYSx1p05JHA5xwgVtLs9eoI\nlFZJsP04Rid0wDOUcJswu8agPjfQOHwOCibYl259YH1g/8dgzVS1HrAr2A5AFTPYrPZ0ayGD0ViI\nx8wYh/qL/O3xvdsIJFxJsJNYwSyuc5XT0oG8OqqZyBkvZusJflISbBd2MoggjjlABRvVXj1aq9LR\nwEoAVs6pnyJW8SWTyEHDcFJ5nr60l+46CL3HFNEinVJQCOwO5rKNRCCXUXxPvp3g7Mfi8Xad8Oj2\nPAY7mhHSbMRzBY3D+fRg9bmB1uHB+fvSrQ+sD2wzwGrqwotaRDYaRF86BiwmystU6pkY2QVAJ5tM\nWHZfZie29M8qCERSilf/1mwkabKxsiWB6iuHp+Rq3ak1ch5ZShE53bOfKze0iONqe5pjvhtcMpAu\n7pZQa/rh8p8BAGnHC5gYPqZsAAAAAElFTkSuQmCC".replaceAll("\n",""),icon_restrictions="data:image/png;base64,\niVBORw0KGgoAAAANSUhEUgAAAFYAAABWCAYAAABVVmH3AAAABGdBTUEAALGOfPtRkwAAACBjSFJN\nAAB6JQAAgIMAAPn/AACA6QAAdTAAAOpgAAA6mAAAF2+SX8VGAAAHsklEQVR42uyda2wVRRSAv0KB\ntkipKLYCMVJBIOVRRREQH1GUkKCoxMifQnwGVBRQEAwSKMFAIBgNCmgkGkSDIgooGNEIAkZ8BAVB\n5P0URKW8KWB7/XFPk5vNzt2d2dl797Y9yYSw3Tv3zLc7Z2bOOTM3KxaLUS/2pUE9gnAk2+uGrKys\ndOtYANwO3Cz//wFYAxxNp1KePT0WiyUtaZRi4GVgPxBzlKPAbKBTOsEm5RZBsB2A14EzLkCd5Rww\nH+hWD1YtVwPvAP/5AOpWPkkl4EwAmw9MBU4ZAk0sF4G5QFFdBpsNDAcOWADqLMflYTWra2C7A2tD\nAOosvwP96wLYlsA8oDIFUBPLYqBtbQU7WDF1SlWpAEYBjWoL2FJgaRqBOss64I5MBttCJvHnIwQ1\nsSwAWmcS2GbACOBgRIEmlmPABODyKINtCgwD9mQAUGc5ArwANI8S2NbAs8DuDATqLAeAiUB7ICsI\n2CwveAnerSzgCuBacZB0Bm6Vf/NqmdfvArAVWA38Ir1wO/CXPABr3q2WwBLgdC14K03LKeAreZGs\nmII84Os6DNRZdgNXe3HzE0EYamPeV4ukLTAkcARBDHm67V2N56uBrJxyfeoelrSxAfZgipWuBn4W\ne7ZWBo3jcj0baCLmqQjoA/QFesv1VMnx4PMxeDhFtusw8CrQFf0gZ3ugHNiVIl0n2Bi8HghZyQvA\ndFkCB5VcYGwKZi8jbIDtG7K/9JYQumon4pHcsPQeYgNsjwBxKK8YVdMQ7WCWmJYwwA704uZn8KqQ\nrtXcYqM/BMrEDCSTPLG5JUDDBNOxG9jsMYjEZKl9Fhhn+aGdtDF4FQA7LT7t9wVSMukDfCQzkipF\nPUeBZUA/H/XNsKh/JVBqywmz3pJSWyQqq5IOwGcytdKpdwPQK0m9jS2uHv8EimyB/dSCQuc9BqrH\nxeyY1l/m8dZeI2950HZ8DzSwBXauBYVmJGn0iwHrftKnbRxmoR3LbPpjn7Yw+b9S0diyAPVWA09p\nDDqNxQ0YpC1v2QTbL6AysxUNLQFOBKh3tKLeYqCn4m/PBGzLSJtguxgMKInlJkUjlweoc3wSqDuB\nbUCOwoESxJb3twm2uYyGJor8qAhz3B2gcc8roHZ0hIgGK+5bFMD0dLEd8/rWUJnXFI2bY1jfZEV9\nnYF9jnuXWx7EDtVMF22CnW+ozCCXhuUbhsdHKUB1U9R3TmJ0bg+hyuD7v/G7sNJxz20wyWsAdii6\nrG6yxGTgFQXUFYr6csRX65QjYmd1ZYffG3XAbjZQ5IwkRbh5n3RkHDDJ5XoPYBXQKslnWyn8H4cN\n2rM+DLB7JUSiI5VS3JwrfmWi+GudUiorwpYen3dzHlXJNE9XfgsD7BEZHHRNQUxx3S/UKS7XewIr\nkyw6EqVhEt105B+d9uuArZaZgY7kKGJRp318dowC6vXyphZp9Bo3X61utvcWgWsdLMB3mvfnidvR\nKbs8PlcOzFTY1M+BQg0dDivMQ6FmW1br9VW93K2r0N+E0V8x3TqkuH+sQtUbZCDU+e4qscVus5KL\nmnXdpcXNIClug6ZCUxSg3nO5t1xxbxfMNoFsVNjYQehnIxbogDXZS/uF5v29FdcXu3T/iS73dZeB\nqo2BrgvkrXVbTuvIGvzkEgQwBYinXjeU4ZZNky1+hGQOlc6Yb1c6rJjD5svUUaeux7S5GYDNNYiB\nTVCAGwBMU/ytlGCbQVTO74c06zkpY0voYAHe1VRuqzwQv1Iids0U6vwkdX+pWddSo55uCHaAQWP9\nevqLiedrmUJdpfDDIiO7bn3DUgk216Dx/+KduVgcsPsvRJ0Eki9LUp36ziq8Y6HuQTCJ1a/0ANvL\n0ARUEN+pk0xM/L9LjQf9AGC7Es9K0VV2mgeAS2SAWedjEr9JBikvR8xowx4w0BSszuYON1mB2Sbg\n8T4A1ywMbpSH2CKhe24lnkP7E95pSmXEz0HQnbNvA65T+BpCP7rk3gD2cDrhy0jME/pGB+IWEGxT\n8aoHyTgsDAFoHvBGAL1c566pBBvEftWU/dJdG1uCOsBg9HeWeYFXrBbA5mNnV+KvAtgkZ7YRcA/m\nkeTEcoZ4cl7awQI8h700yf3Am/LmdSS+gThHvFQNxXF+KdBOnCmzgD8sfv9sGz6WoLOCxCnSJiyf\nYiEDzwnxLJ2Ta03EUV1g0XzUyDGJUOzzAzbMWYFzBM70XYfl1ryCFsE2ktBNpkLdC1wWRbAQP4Ow\nOkPBPmLVjx3CCRuzMhDqx7qNTAfYQtJ7WpHJ9KokE8AC3JdBYEeZNDCdpxhNzQCoi0wbl06wuQah\n8lSW7QQ4XDLdB5q1I5rHRFUSP8+GTAVbE2eK2qFmw4M2KipnGw6NENTJNhoUpUMjJ0UA6gJbjYna\nMafpnCl8gKWTOKMIFuK7aFINdQmWD+eJ6onH01MIdTEhHDgR5TO6x6QA6hxC+nWSqJ8q/4SEs20D\nrRZ7HtrPjmTCcf29UWd3m5QTuG/aq3NgkZCOjVPmd6DeEF0nwSLd9qUAjvK3JfZGPVh3uRO9E98q\ngEdTrWQmgoV4rsJMvJPiFpJ8u2c9WIX0JJ745gS6B7g/nYqlKq8gTMkDHgRuk9XTRuJbmf5ON9ik\n3Op/MzEcqf/NxJDk/wEAzLV3Lfb0+2sAAAAASUVORK5CYII=".replaceAll("\n","");function BCX_setInterval(e,t){return setInterval((()=>{const t=debugContextStart("BCX internal interval",{root:!0,bcxArea:!0});e(),t.end()}),t)}function BCX_setTimeout(e,t){return setTimeout((()=>{const t=debugContextStart("BCX internal timeout",{root:!0,bcxArea:!0});e(),t.end()}),t)}let contextStack=[];function contextInBCXArea(){return 0!==contextStack.length&&contextStack[contextStack.length-1].bcxArea}function debugContextStart(e,{root:t=!1,bcxArea:o,extraInfo:n}={}){const r={name:e,bcxArea:null!=o?o:contextInBCXArea(),root:t,extraInfo:n},i={end:()=>{if(contextStack[contextStack.length-1]===r)return void contextStack.pop();const e=contextStack.indexOf(r);if(e<0)console.warn("BCX: Debug context end while it is not on stack",r,new Error);else{const t=contextStack.length-e,o=contextStack.splice(e,t);console.warn(`BCX: Debug context end while not on top of the stack (depth ${t})`,o,new Error)}}};return t&&contextStack.length>0&&(console.warn("BCX: Root context when we already have context",contextStack,new Error),contextStack=[]),contextStack.push(r),i}function debugMakeContextReport(){let e="----- Current context (most recent first) -----\n";if(0===contextStack.length)e+="[None]\n";else{for(let t=contextStack.length-1;t>=0;t--){const o=contextStack[t];if(e+=`> ${o.name}\n`,o.extraInfo){let t="";try{t=o.extraInfo()}catch(e){t="Error processing extra info:\n"+(e instanceof Error?e.stack:`${e}`)}e+=t.trim().replace(/\n|^/g,(e=>`${e}| `))+"\n"}}contextStack[0].root||(e+="[unknown origin]\n")}return e}const GROUP_NAME_OVERRIDES={ItemNeckAccessories:"Collar Addon",ItemNeckRestraints:"Collar Restraint",ItemNipplesPiercings:"Nipple Piercing",ItemHood:"Hood",ItemMisc:"Miscellaneous",ItemDevices:"Devices",ItemHoodAddon:"Hood Addon",ItemAddon:"General Addon",ItemLegs:"Upper Leg",ItemFeet:"Lower Leg",ItemBoots:"Feet",ItemMouth:"Mouth (1)",ItemMouth2:"Mouth (2)",ItemMouth3:"Mouth (3)"};let allowMode=!1,developmentMode=!1;function setAllowMode(e){if(e)console.warn("Cheats enabled; please be careful not to break things");else{if(!setDevelopmentMode(!1))return!1;console.info("Cheats disabled")}return allowMode=e,!0}function setDevelopmentMode(e){if(e){if(!setAllowMode(!0))return console.info("To use developer mode, cheats must be enabled first!"),!1;window.BCX_Devel=!0,AssetGroup.forEach((e=>e.Description=e.Name)),Asset.forEach((e=>e.Description=e.Group.Name+":"+e.Name)),BackgroundSelectionAll.forEach((e=>{e.Description=e.Name,e.Low=e.Description.toLowerCase()})),console.warn("Developer mode enabled")}else delete window.BCX_Devel,AssetLoadDescription("Female3DCG"),BackgroundSelectionAll.forEach((e=>{e.Description=DialogFindPlayer(e.Name),e.Low=e.Description.toLowerCase()})),console.info("Developer mode disabled");return developmentMode=e,!0}let BCXSource=null,BCXSourceExternal=!1;function init_findBCXSource(){for(const e of Array.from(document.getElementsByTagName("script"))){const t=/^(https:\/\/[^?/]+\/([^?]+)?)bcx.js($|\?)/.exec(e.src);if(t)return void(BCXSource=t[1])}const e=window.BCX_SOURCE;if("string"==typeof e){BCXSourceExternal=!0;const t=/^(https:\/\/[^?/]+\/(?:[^?]+?)?)(?:bcx.js)?(?:$|\?)/.exec(e);if(t)return BCXSource=t[1],void console.log("BCX: External BCX_SOURCE supplied, using it");console.warn("BCX: External BCX_SOURCE supplied, but malformed, ignoring",e)}const t="BCX: Failed to find BCX's source! Some functions will not work properly. Are you using the official version?";console.error(t),alert(t)}function getVisibleGroupName(e){var t;return developmentMode?e.Name:null!==(t=GROUP_NAME_OVERRIDES[e.Name])&&void 0!==t?t:e.Description}function InfoBeep(e,t=3e3){ServerBeep={Timer:Date.now()+t,Message:e}}function ChatRoomActionMessage(e,t=null){e&&ServerSend("ChatRoomChat",{Content:"Beep",Type:"Action",Target:t,Dictionary:[{Tag:"Beep",Text:"msg"},{Tag:"Biep",Text:"msg"},{Tag:"Sonner",Text:"msg"},{Tag:"msg",Text:e}]})}function ChatRoomSendLocal(e,t,o){var n,r;const i=document.createElement("div");i.setAttribute("class","ChatMessage ChatMessageLocalMessage"),i.setAttribute("data-time",ChatRoomCurrentTime()),i.setAttribute("data-sender",`${null!==(n=null!=o?o:Player.MemberNumber)&&void 0!==n?n:0}`),i.style.background="#6e6eff54",i.style.margin="0.15em 0","string"==typeof e?i.innerText=e:i.appendChild(e),t&&BCX_setTimeout((()=>i.remove()),t);const a="InputChat"===(null===(r=document.activeElement)||void 0===r?void 0:r.id),s=ElementIsScrolledToEnd("TextAreaChatLog"),l=document.getElementById("TextAreaChatLog");return null!=l?(l.appendChild(i),s&&ElementScrollToEnd("TextAreaChatLog"),a&&ElementFocus("InputChat"),i):null}function isNModClient(){return"function"==typeof window.ChatRoomDrawFriendList}function detectOtherMods(){var e,t,o;const n=window;return{NMod:isNModClient(),BondageClubTools:!0===window.BCX_BondageClubToolsPatch||ServerSocket.listeners("ChatRoomMessage").some((e=>e.toString().includes("window.postMessage"))),BCFriendList:ServerSocket.listeners("AccountQueryResult").some((e=>e.toString().includes("f_t_body.innerText"))),Curse:"function"==typeof n.CursedStarter&&(`${n.currentManifestVersion}`||!0),RPScript:"string"==typeof(null===(e=Player)||void 0===e?void 0:e.RPSScriptstatus)&&(`${null===(t=Player)||void 0===t?void 0:t.RPSScriptstatus}`||!0),Moaner:void 0!==n.M_MOANER_scriptOn&&(`${n.M_MOANER_scriptOn}`||!0),BcUtil:"function"==typeof n.StartBcUtil,QuickAccessMenu:"function"==typeof n.OLDmenu&&"function"==typeof n.NEWmenu,ImprovedStruggle:"function"==typeof n.OLDclick&&"function"==typeof n.NEWclick,BCE:void 0!==n.BCE_VERSION&&(null===(o=n.BCE_VERSION)||void 0===o||o)}}function DrawImageEx(e,t,o,{Canvas:n=MainCanvas,Alpha:r=1,SourcePos:i,Width:a,Height:s,Invert:l=!1,Mirror:c=!1,Zoom:u=1}={}){if("string"==typeof e){if(!(e=DrawGetImage(e)).complete)return!1;if(!e.naturalWidth)return!0}const d=null!=a||null!=s;return null==a&&(a=i?i[2]:e.width),null==s&&(s=i?i[3]:e.height),n.save(),n.globalCompositeOperation="source-over",n.globalAlpha=r,n.translate(t,o),1!==u&&n.scale(u,u),l&&n.transform(1,0,0,-1,0,s),c&&n.transform(-1,0,0,1,a,0),i?n.drawImage(e,i[0],i[1],i[2],i[3],0,0,a,s):d?n.drawImage(e,0,0,a,s):n.drawImage(e,0,0),n.restore(),!0}function DrawImageBCX(e,t,o,n){return!BCXSource||DrawImageEx(BCXSource+"resources/"+e,t,o,n)}function smartGetAsset(e){const t=Asset.includes(e)?e:e.Asset;if(!Asset.includes(t))throw new Error("Failed to convert item to asset");return t}function smartGetAssetGroup(e){const t=AssetGroup.includes(e)?e:Asset.includes(e)?e.Group:e.Asset.Group;if(!AssetGroup.includes(t))throw new Error("Failed to convert item to group");return t}function isCloth(e,t=!1){const o=smartGetAssetGroup(e);return"Appearance"===o.Category&&o.AllowNone&&o.Clothing&&(t||!o.BodyCosplay)}function isBind(e){const t=smartGetAssetGroup(e);return"Item"===t.Category&&!t.BodyCosplay&&!["ItemNeck","ItemNeckAccessories","ItemNeckRestraints"].includes(t.Name)}function getCharacterName(e,t=null){var o;const n=ChatRoomCharacter.find((t=>t.MemberNumber===e));if(n)return n.Name;const r=null===(o=Player.FriendNames)||void 0===o?void 0:o.get(e);return r||t}function itemColorsEquals(e,t){return null==e?e="Default":Array.isArray(e)&&1===e.length&&(e=e[0]),null==t?t="Default":Array.isArray(t)&&1===t.length&&(t=t[0]),Array.isArray(e)&&Array.isArray(t)?CommonArraysEqual(e,t):e===t}function showHelp(e){MainCanvas.fillStyle="#ffff88",MainCanvas.fillRect(1e3,190,800,600),MainCanvas.strokeStyle="Black",MainCanvas.strokeRect(1e3,190,800,600),MainCanvas.textAlign="left",DrawTextWrap(e,640,210,760,560,"black")}function getCurrentRoomData(){return ChatRoomData?{Name:ChatRoomData.Name,Description:ChatRoomData.Description,Background:ChatRoomData.Background,Limit:ChatRoomData.Limit,Admin:ChatRoomData.Admin.slice(),Ban:ChatRoomData.Ban.slice(),BlockCategory:ChatRoomData.BlockCategory.slice(),Game:ChatRoomGame,Private:ChatRoomData.Private,Locked:ChatRoomData.Locked}:null}function updateChatroom(e){const t=getCurrentRoomData();if(!ServerPlayerIsInChatRoom()||!ChatRoomPlayerIsAdmin()||!t)return!1;const o={...t,...e};return o.Limit=o.Limit.toString(),ServerSend("ChatRoomAdmin",{MemberNumber:Player.ID,Action:"Update",Room:o}),!0}function drawTypingIndicatorSpeechBubble(e,t,o,n,r,i,a=!1){e.save(),e.globalAlpha=i,e.translate(t,o),e.scale(n/50,r/50),e.fillStyle="white",e.strokeStyle="black",e.lineWidth=3;let s=new Path2D(icon_Typing_base);e.fill(s),e.stroke(s),e.fillStyle="black",s=new Path2D(a?icon_Typing_star:icon_Typing_dot);for(const t of[0,12,12])e.translate(t,0),e.fill(s);e.restore()}function drawIcon(e,t,o,n,r,i,a,s,l,c,u="black"){e.save(),e.globalAlpha=s,e.translate(o,n),e.scale(r/a,i/a),e.fillStyle=c,e.strokeStyle=u,e.lineWidth=l;const d=new Path2D(t);e.fill(d),e.stroke(d),e.restore()}const VERSION=BCX_VERSION,VERSION_CHECK_BOT=37685,FUNCTION_HASHES={"Player.CanChange":["082287C0"],"Player.GetBlindLevel":["B0DE4B87"],"Player.GetDeafLevel":["42CB6D63"],"Player.IsSlow":["4D9B1713"],ActivityOrgasmPrepare:["E4EE085D"],ActivityOrgasmStart:["5C3627D7","1F7E8FF9"],AppearanceClick:["48FA3705","BA17EA90","F0B11F43","CCD4AC31","EECC190D","19A126DF","0D1455A9"],AppearanceGetPreviewImageColor:["C4BDF19F"],AppearanceMenuBuild:["264DC3C6"],AppearanceMenuClick:["187B3371"],AppearanceMenuDraw:["28FDF65B"],AppearanceRun:["904E8E84","45C6BA53","6D5EFEAA","6DDA14A1"],AsylumEntranceCanWander:["3F5F4041","609FA096"],BackgroundSelectionRun:["DB865494"],CharacterAppearanceLoadCharacter:["3641512F"],CharacterCanChangeToPose:["F55FE4B0"],CharacterCanKneel:["A5A325E3"],CharacterLoadEffect:["0498693B"],ChatAdminClick:["6B460E3D"],ChatAdminLoad:["EB8AF0DB"],ChatAdminRun:["CBE642C8"],ChatCreateClick:["765AEBFE"],ChatCreateRun:["B0A3D236"],ChatRoomAddCharacterToChatRoom:["5B72DA3E"],ChatRoomAdminAction:["0C867BF6"],ChatRoomCanAttemptKneel:["0AA710FA"],ChatRoomCanAttemptStand:["026065D0"],ChatRoomCanBeLeashedBy:["0ADB85BD"],ChatRoomCanChangeClothes:["87102B7C"],ChatRoomCanLeave:["5BEE6F9D","77FB6CF8"],ChatRoomClearAllElements:["D1E1F8C3","D9169281","AFB1B3ED","C49AA2C1"],ChatRoomClickCharacter:["21AEE568"],ChatRoomCreateElement:["4837C2F6","6C4CCF41","35D54383"],ChatRoomDrawCharacterOverlay:["D58A9AD3","4AE4AD9E"],ChatRoomFirstTimeHelp:["078BEEA9"],ChatRoomIsOwnedByPlayer:["82640FF9"],ChatRoomKeyDown:["5FD37EC9","111B6F0C","33C77F12"],ChatRoomListManage:["6F6E51D0"],ChatRoomListManipulation:["8BE7D2C6"],ChatRoomLovershipOptionIs:["6F5CE6A0"],ChatRoomMenuClick:["8D9D74CE","959128FD"],ChatRoomMessage:["2C6E4EC3","4340BC41","6026A4B6","E3EE1C77","58EAAE61","60ECCB9B"],ChatRoomOwnershipOptionIs:["FE060F0B"],ChatRoomSendChat:["39B06D87","9019F7EF","D64CCA1D","7F540ED0"],ChatRoomSendEmote:["30DB56A6"],ChatRoomShouldBlockGaggedOOCMessage:["4940C855"],ChatRoomSync:["B67D8226","DF257D5B","EE15739F"],ChatRoomSyncMemberLeave:["A95EADE6"],ChatRoomUpdateDisplay:["8DFC494A"],ChatSearchJoin:["22514B80"],ChatSearchNormalDraw:["6BEDBABB"],ChatSearchRun:["4C56AC68","06BFF877"],CheatFactor:["594CFC45"],CheatImport:["412422CC","26C67608"],ColorPickerDraw:["D1E82FB3"],CommandParse:["12DC018B"],CommonKeyDown:["A8EC46AB"],CommonSetScreen:["17692CD7"],DialogCanUnlock:["634C862B"],DialogClickExpressionMenu:["5938DDC1"],DialogDrawExpressionMenu:["EEFB3D22"],DialogDrawItemMenu:["7B1D71E9","0199F25B","D832A940"],DialogDrawPoseMenu:["4B146E82"],DialogFindPlayer:["32851FF2"],DialogInventoryAdd:["FD9268E1"],DialogItemClick:["7039462A","A08AC13E"],DialogLeaveItemMenu:["B369F7C0"],DialogMenuButtonBuild:["1D4265E4","75E8CCCD"],DialogMenuButtonClick:["9D8202CC","8B705620"],DrawArousalMeter:["F4BDB7C1"],DrawCharacter:["A9C65470"],DrawGetImage:["BEC7B0DA"],ElementIsScrolledToEnd:["D28B0638"],ExtendedItemDraw:["486A52DF","9256549A","45432E84","455F5FDD","BDE09647","E831F57A"],FriendListBeepMenuSend:["B81A695E"],FriendListClick:["6B039C7C"],FriendListLoadFriendList:["72099AC9","1F8A29E2"],FriendListRun:["051E747B"],InfiltrationStealItems:["1F601756"],InformationSheetClick:["E535609B"],InformationSheetExit:["75521907"],InformationSheetRun:["58B7879C","A8A56ACA"],InventoryItemNeckAccessoriesCollarAutoShockUnitDetectSpeech:["BE1F6406"],LoginMistressItems:["B58EF410"],LoginResponse:["16C2C651","FA9EFD03","02E9D246","548405C8","4FE91547","CF1C0400"],LoginStableItems:["EA93FBF7"],MainHallWalk:["E52553C4"],ManagementCanBeReleased:["A2E2CA35"],ManagementCanBeReleasedOnline:["3374263B"],ManagementCanBreakDatingLoverOnline:["366AECAE"],ManagementCanBreakTrialOnline:["51E9B7F4"],ManagementCanBreakUpLoverOnline:["92E30200"],ManagementCannotBeReleased:["755DB909"],ManagementCannotBeReleasedExtreme:["2DA1650E"],ManagementCannotBeReleasedOnline:["D1ACE212"],PreferenceSubscreenDifficultyClick:["3882E581"],PreferenceSubscreenDifficultyRun:["65BF560F"],PrivateRansomStart:["0E968EDD","511E91C6"],ServerAccountBeep:["2D918B69","D2802EE7"],ServerSend:["90A61F57"],SpeechGarble:["1BC8E005","15C3B50B","9D669F73"],StruggleDrawStrengthProgress:["4755C02D"],TextGet:["4DDE5794"],ValidationResolveModifyDiff:["C2FE52D3"]},FUNCTION_HASHES_NMOD={"Player.CanChange":["082287C0"],"Player.GetBlindLevel":["B0DE4B87"],"Player.GetDeafLevel":["42CB6D63"],"Player.IsSlow":["4D9B1713"],ActivityOrgasmPrepare:["AA5FC17F"],ActivityOrgasmStart:["1F7E8FF9"],AppearanceClick:["19A126DF"],AppearanceGetPreviewImageColor:["C4BDF19F"],AppearanceRun:["6DDA14A1"],AsylumEntranceCanWander:["609FA096"],CharacterAppearanceLoadCharacter:["3641512F"],CharacterLoadEffect:["74D62AA1"],ChatAdminClick:["3355D63D"],ChatAdminLoad:["BF159B25"],ChatAdminRun:["F92A0B2E"],ChatRoomAdminAction:["0C867BF6"],ChatRoomCanChangeClothes:["DF8A6550"],ChatRoomCanLeave:["4ED4453D"],ChatRoomClearAllElements:["904C924D"],ChatRoomClickCharacter:["21AEE568"],ChatRoomCreateElement:["76299AEC"],ChatRoomDrawCharacterOverlay:["61F5F655"],ChatRoomDrawFriendList:["327DA1B8"],ChatRoomFirstTimeHelp:["078BEEA9"],ChatRoomIsOwnedByPlayer:["82640FF9"],ChatRoomKeyDown:["15C1889B"],ChatRoomLovershipOptionIs:["6F5CE6A0"],ChatRoomMessage:["1FA3BF62"],ChatRoomOwnershipOptionIs:["FE060F0B"],ChatRoomSendChat:["7F540ED0"],ChatRoomSendEmote:["30DB56A6"],ChatRoomSync:["A8E55C95"],ChatRoomUpdateDisplay:["8B37556F"],CheatFactor:["594CFC45"],CheatImport:["1ECB0CC4"],ColorPickerDraw:["FF93AF2E"],CommandParse:["36295DDC"],CommonSetScreen:["17692CD7"],DialogCanUnlock:["634C862B"],DialogClickExpressionMenu:["AFBB0323"],DialogDrawExpressionMenu:["EEFB3D22"],DialogDrawItemMenu:["05301080"],DialogDrawPoseMenu:["4B146E82"],DialogFindPlayer:["44A7263C"],DialogItemClick:["C5E68BE8"],DialogMenuButtonBuild:["76060837"],DialogMenuButtonClick:["0E218260"],DrawCharacter:["C9EC1A94"],DrawGetImage:["BEC7B0DA"],ElementIsScrolledToEnd:["D28B0638"],ExtendedItemDraw:["E831F57A"],FriendListBeepMenuSend:["C5C27229"],FriendListLoadFriendList:["428B288B"],InfiltrationStealItems:["1F601756"],InformationSheetClick:["E535609B"],InformationSheetExit:["75521907"],InformationSheetRun:["19872251"],LoginMistressItems:["984A6AD9"],LoginResponse:["0D6009B6"],LoginStableItems:["C3F50DD1"],MainHallWalk:["E52553C4"],ManagementCanBeReleased:["A2E2CA35"],ManagementCanBeReleasedOnline:["3374263B"],ManagementCanBreakDatingLoverOnline:["366AECAE"],ManagementCanBreakTrialOnline:["51E9B7F4"],ManagementCanBreakUpLoverOnline:["92E30200"],ManagementCannotBeReleased:["755DB909"],ManagementCannotBeReleasedExtreme:["2DA1650E"],ManagementCannotBeReleasedOnline:["D1ACE212"],PrivateRansomStart:["511E91C6"],ServerAccountBeep:["207D9580"],SpeechGarble:["9D669F73"],ValidationResolveModifyDiff:["C2FE52D3"]},encoder=new TextEncoder;function crc32(e){let t=-1;for(const o of encoder.encode(e)){let e=255&(t^o);for(let t=0;t<8;t++)e=1&e?-306674912^e>>>1:e>>>1;t=t>>>8^e}return((-1^t)>>>0).toString(16).padStart(8,"0").toUpperCase()}function addStyle(e){const t=document.createElement("style");t.textContent=e,document.head.append(t)}function isObject$1(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function longestCommonPrefix(e){if(0===e.length)return"";e=e.slice().sort();let t=0;for(;t<e[0].length&&e[0][t]===e[e.length-1][t];)t++;return e[0].substring(0,t)}function arrayUnique(e){const t=new Set;return e.filter((e=>!t.has(e)&&t.add(e)))}function capitalizeFirstLetter(e){return e.charAt(0).toLocaleUpperCase()+e.slice(1)}function uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))}const clipboardAvailable=Boolean(navigator.clipboard);function clamp(e,t,o){return Math.min(Math.max(e,t),o)}function clampWrap(e,t,o){return e<t?o:e>o?t:e}function formatTimeInterval(e,t="full"){let o="";e<0&&(o="-",e*=-1);const n=Math.floor(e/1e3),r=Math.floor(n/60),i=Math.floor(r/60),a=Math.floor(i/24);return"full"===t||void 0===t?(a>0&&(o+=`${a} days, `),i>0&&(o+=i%24+" hours, "),r>0&&(o+=r%60+" minutes, "),n>0&&(o+=n%60+" seconds")):"short"===t&&(a>1?o+=`${a}d`:i>1?o+=`${i}h`:r>1?o+=`${r}m`:n>0&&(o+=`${n}s`)),o}function dictionaryProcess(e,t){for(const[o,n]of Object.entries({PLAYER_NAME:Player.Name,...t}))e=e.replaceAll(o,n);return e}function createInputElement(e,t){const o=document.createElement("input");return o.type=e,t&&(o.maxLength=t),o.addEventListener("keydown",KeyDown),o.className="HideOnPopup",o}function positionElement(e,t,o,n,r){const i=MainCanvas.canvas.clientHeight/1e3,a=MainCanvas.canvas.clientWidth/2e3,s=MainCanvas.canvas.clientWidth<=2*MainCanvas.canvas.clientHeight?MainCanvas.canvas.clientWidth/50:MainCanvas.canvas.clientHeight/25,l=r?r*i:1.15*s,c=n*a-18,u=MainCanvas.canvas.offsetTop+o*i-l/2,d=MainCanvas.canvas.offsetLeft+(t-n/2)*a;Object.assign(e.style,{fontSize:s+"px",fontFamily:CommonGetFontName(),position:"fixed",left:d+"px",top:u+"px",width:c+"px",height:l+"px",display:"inline"})}const patchedFunctions=new Map;let unloaded=!1;function makePatchRouter(e){return(...t)=>{if(unloaded)return console.warn(`BCX: Function router called while unloaded for ${e.original.name}`),e.original(...t);const o=debugContextStart(`Hooked function ${e.name}`,{bcxArea:!0}),n=e.hooks.slice();let r=0;const i=o=>{if(r<n.length)return r++,n[r-1].hook(o,i);{const o=debugContextStart(`Hook chain exit (${e.name})`,{bcxArea:!1}),n=e.final.apply(e.context,t);return o.end(),n}},a=i(t);return o.end(),a}}function isHashExpected(e,t){var o;return(null!==(o=(isNModClient()?FUNCTION_HASHES_NMOD:FUNCTION_HASHES)[e])&&void 0!==o?o:[]).includes(t)}function initPatchableFunction(e){if(unloaded)throw new Error("Cannot init patchable function after unload");let t=patchedFunctions.get(e);if(!t){let o=window;const n=e.split(".");for(let t=0;t<n.length-1;t++)if(o=o[n[t]],!isObject$1(o))throw new Error(`BCX: Function ${e} to be patched not found; ${n.slice(0,t+1).join(".")} is not object`);const r=o[n[n.length-1]];if("function"!=typeof r)throw new Error(`BCX: Function ${e} to be patched not found`);const i=crc32(r.toString().replaceAll("\r\n","\n"));isHashExpected(e,i)||console.warn(`BCX: Patched function ${e} has unknown hash ${i}`),console.debug(`BCX: Initialized ${e} for patching`),t={name:e,original:r,originalHash:i,final:r,hooks:[],patches:{},context:o},patchedFunctions.set(e,t),o[n[n.length-1]]=makePatchRouter(t)}return t}function applyPatches(info){if(0===Object.keys(info.patches).length)return void(info.final=info.original);let fn_str=info.original.toString();const N=`BCX: Patching ${info.original.name}`;for(const e of Object.keys(info.patches))fn_str.includes(e)||console.warn(`${N}: Patch ${e} not applied`),fn_str=fn_str.replaceAll(e,info.patches[e]);info.final=eval(`(${fn_str})`)}function hookFunction(e,t,o,n=null){const r=initPatchableFunction(e);r.hooks.some((e=>e.hook===o))?console.error(`BCX: Duplicate hook for "${e}"`,o):(r.hooks.push({hook:o,priority:t,module:n}),r.hooks.sort(((e,t)=>t.priority-e.priority)))}function removeHooksByModule(e,t){const o=initPatchableFunction(e);for(let e=o.hooks.length-1;e>=0;e--)o.hooks[e].module===t&&o.hooks.splice(e,1);return!0}function removeAllHooksByModule(e){for(const t of patchedFunctions.values())for(let o=t.hooks.length-1;o>=0;o--)t.hooks[o].module===e&&t.hooks.splice(o,1);return!0}function patchFunction(e,t){const o=initPatchableFunction(e);Object.assign(o.patches,t),applyPatches(o)}function unload_patches(){unloaded=!0;for(const[e,t]of patchedFunctions.entries()){t.hooks=[],t.patches={},t.final=t.original;const o=e.split(".");t.context[o[o.length-1]]=t.original}patchedFunctions.clear()}function callOriginal(e,t){return initPatchableFunction(e).original(...t)}function getPatchedFunctionsHashes(e){return Array.from(patchedFunctions.entries()).map((e=>[e[0],e[1].originalHash])).filter((t=>e||!isHashExpected(...t)))}var Preset,ModuleCategory;!function(e){e[e.dominant=0]="dominant",e[e.switch=1]="switch",e[e.submissive=2]="submissive",e[e.slave=3]="slave"}(Preset||(Preset={})),function(e){e[e.Global=0]="Global",e[e.Authority=1]="Authority",e[e.Log=2]="Log",e[e.Curses=3]="Curses",e[e.Rules=4]="Rules",e[e.Misc=99]="Misc"}(ModuleCategory||(ModuleCategory={}));const MODULE_NAMES={[ModuleCategory.Global]:"Global",[ModuleCategory.Authority]:"Authority",[ModuleCategory.Log]:"Behaviour Log",[ModuleCategory.Curses]:"Curses",[ModuleCategory.Rules]:"Rules",[ModuleCategory.Misc]:"Miscellaneous"},MODULE_ICONS={[ModuleCategory.Global]:"Icons/General.png",[ModuleCategory.Authority]:"Icons/Security.png",[ModuleCategory.Log]:"Icons/Title.png",[ModuleCategory.Curses]:"Icons/Struggle.png",[ModuleCategory.Rules]:icon_rules,[ModuleCategory.Misc]:"Icons/Random.png"},TOGGLEABLE_MODULES=[ModuleCategory.Log,ModuleCategory.Curses,ModuleCategory.Rules];var ModuleInitPhase,MiscCheat,ConditionsLimit;!function(e){e[e.construct=0]="construct",e[e.init=1]="init",e[e.load=2]="load",e[e.ready=3]="ready",e[e.destroy=4]="destroy"}(ModuleInitPhase||(ModuleInitPhase={})),function(e){e[e.BlockRandomEvents=0]="BlockRandomEvents",e[e.CantLoseMistress=1]="CantLoseMistress",e[e.GiveMistressKey=2]="GiveMistressKey",e[e.GivePandoraKey=3]="GivePandoraKey"}(MiscCheat||(MiscCheat={})),function(e){e[e.normal=0]="normal",e[e.limited=1]="limited",e[e.blocked=2]="blocked"}(ConditionsLimit||(ConditionsLimit={}));const defaultBCXEffects={Effect:[]};class BaseModule{init(){}load(e){}run(){}unload(){}reload(e){}applyPreset(e){}}function listCacheClear(){this.__data__=[],this.size=0}function eq(e,t){return e===t||e!=e&&t!=t}function assocIndexOf(e,t){for(var o=e.length;o--;)if(eq(e[o][0],t))return o;return-1}var arrayProto$1=Array.prototype,splice$1=arrayProto$1.splice;function listCacheDelete(e){var t=this.__data__,o=assocIndexOf(t,e);return!(o<0)&&(o==t.length-1?t.pop():splice$1.call(t,o,1),--this.size,!0)}function listCacheGet(e){var t=this.__data__,o=assocIndexOf(t,e);return o<0?void 0:t[o][1]}function listCacheHas(e){return assocIndexOf(this.__data__,e)>-1}function listCacheSet(e,t){var o=this.__data__,n=assocIndexOf(o,e);return n<0?(++this.size,o.push([e,t])):o[n][1]=t,this}function ListCache(e){var t=-1,o=null==e?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}function stackClear(){this.__data__=new ListCache,this.size=0}function stackDelete(e){var t=this.__data__,o=t.delete(e);return this.size=t.size,o}function stackGet(e){return this.__data__.get(e)}function stackHas(e){return this.__data__.has(e)}ListCache.prototype.clear=listCacheClear,ListCache.prototype.delete=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet;var freeGlobal="object"==typeof global&&global&&global.Object===Object&&global,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")(),Symbol=root.Symbol,objectProto$e=Object.prototype,hasOwnProperty$b=objectProto$e.hasOwnProperty,nativeObjectToString$1=objectProto$e.toString,symToStringTag$1=Symbol?Symbol.toStringTag:void 0;function getRawTag(e){var t=hasOwnProperty$b.call(e,symToStringTag$1),o=e[symToStringTag$1];try{e[symToStringTag$1]=void 0;var n=!0}catch(e){}var r=nativeObjectToString$1.call(e);return n&&(t?e[symToStringTag$1]=o:delete e[symToStringTag$1]),r}var objectProto$d=Object.prototype,nativeObjectToString=objectProto$d.toString;function objectToString(e){return nativeObjectToString.call(e)}var nullTag="[object Null]",undefinedTag="[object Undefined]",symToStringTag=Symbol?Symbol.toStringTag:void 0;function baseGetTag(e){return null==e?void 0===e?undefinedTag:nullTag:symToStringTag&&symToStringTag in Object(e)?getRawTag(e):objectToString(e)}function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var asyncTag="[object AsyncFunction]",funcTag$2="[object Function]",genTag$1="[object GeneratorFunction]",proxyTag="[object Proxy]";function isFunction(e){if(!isObject(e))return!1;var t=baseGetTag(e);return t==funcTag$2||t==genTag$1||t==asyncTag||t==proxyTag}var coreJsData=root["__core-js_shared__"],maskSrcKey=(uid=/[^.]+$/.exec(coreJsData&&coreJsData.keys&&coreJsData.keys.IE_PROTO||""),uid?"Symbol(src)_1."+uid:""),uid;function isMasked(e){return!!maskSrcKey&&maskSrcKey in e}var funcProto$1=Function.prototype,funcToString$1=funcProto$1.toString;function toSource(e){if(null!=e){try{return funcToString$1.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor=/^\[object .+?Constructor\]$/,funcProto=Function.prototype,objectProto$c=Object.prototype,funcToString=funcProto.toString,hasOwnProperty$a=objectProto$c.hasOwnProperty,reIsNative=RegExp("^"+funcToString.call(hasOwnProperty$a).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function baseIsNative(e){return!(!isObject(e)||isMasked(e))&&(isFunction(e)?reIsNative:reIsHostCtor).test(toSource(e))}function getValue(e,t){return null==e?void 0:e[t]}function getNative(e,t){var o=getValue(e,t);return baseIsNative(o)?o:void 0}var Map$1=getNative(root,"Map"),nativeCreate=getNative(Object,"create");function hashClear(){this.__data__=nativeCreate?nativeCreate(null):{},this.size=0}function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var HASH_UNDEFINED$2="__lodash_hash_undefined__",objectProto$b=Object.prototype,hasOwnProperty$9=objectProto$b.hasOwnProperty;function hashGet(e){var t=this.__data__;if(nativeCreate){var o=t[e];return o===HASH_UNDEFINED$2?void 0:o}return hasOwnProperty$9.call(t,e)?t[e]:void 0}var objectProto$a=Object.prototype,hasOwnProperty$8=objectProto$a.hasOwnProperty;function hashHas(e){var t=this.__data__;return nativeCreate?void 0!==t[e]:hasOwnProperty$8.call(t,e)}var HASH_UNDEFINED$1="__lodash_hash_undefined__";function hashSet(e,t){var o=this.__data__;return this.size+=this.has(e)?0:1,o[e]=nativeCreate&&void 0===t?HASH_UNDEFINED$1:t,this}function Hash(e){var t=-1,o=null==e?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}function mapCacheClear(){this.size=0,this.__data__={hash:new Hash,map:new(Map$1||ListCache),string:new Hash}}function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}function getMapData(e,t){var o=e.__data__;return isKeyable(t)?o["string"==typeof t?"string":"hash"]:o.map}function mapCacheDelete(e){var t=getMapData(this,e).delete(e);return this.size-=t?1:0,t}function mapCacheGet(e){return getMapData(this,e).get(e)}function mapCacheHas(e){return getMapData(this,e).has(e)}function mapCacheSet(e,t){var o=getMapData(this,e),n=o.size;return o.set(e,t),this.size+=o.size==n?0:1,this}function MapCache(e){var t=-1,o=null==e?0:e.length;for(this.clear();++t<o;){var n=e[t];this.set(n[0],n[1])}}Hash.prototype.clear=hashClear,Hash.prototype.delete=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet,MapCache.prototype.clear=mapCacheClear,MapCache.prototype.delete=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet;var LARGE_ARRAY_SIZE=200;function stackSet(e,t){var o=this.__data__;if(o instanceof ListCache){var n=o.__data__;if(!Map$1||n.length<LARGE_ARRAY_SIZE-1)return n.push([e,t]),this.size=++o.size,this;o=this.__data__=new MapCache(n)}return o.set(e,t),this.size=o.size,this}function Stack(e){var t=this.__data__=new ListCache(e);this.size=t.size}function arrayEach(e,t){for(var o=-1,n=null==e?0:e.length;++o<n&&!1!==t(e[o],o,e););return e}Stack.prototype.clear=stackClear,Stack.prototype.delete=stackDelete,Stack.prototype.get=stackGet,Stack.prototype.has=stackHas,Stack.prototype.set=stackSet;var defineProperty=function(){try{var e=getNative(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();function baseAssignValue(e,t,o){"__proto__"==t&&defineProperty?defineProperty(e,t,{configurable:!0,enumerable:!0,value:o,writable:!0}):e[t]=o}var objectProto$9=Object.prototype,hasOwnProperty$7=objectProto$9.hasOwnProperty;function assignValue(e,t,o){var n=e[t];hasOwnProperty$7.call(e,t)&&eq(n,o)&&(void 0!==o||t in e)||baseAssignValue(e,t,o)}function copyObject(e,t,o,n){var r=!o;o||(o={});for(var i=-1,a=t.length;++i<a;){var s=t[i],l=n?n(o[s],e[s],s,o,e):void 0;void 0===l&&(l=e[s]),r?baseAssignValue(o,s,l):assignValue(o,s,l)}return o}function baseTimes(e,t){for(var o=-1,n=Array(e);++o<e;)n[o]=t(o);return n}function isObjectLike(e){return null!=e&&"object"==typeof e}var argsTag$3="[object Arguments]";function baseIsArguments(e){return isObjectLike(e)&&baseGetTag(e)==argsTag$3}var objectProto$8=Object.prototype,hasOwnProperty$6=objectProto$8.hasOwnProperty,propertyIsEnumerable$1=objectProto$8.propertyIsEnumerable,isArguments=baseIsArguments(function(){return arguments}())?baseIsArguments:function(e){return isObjectLike(e)&&hasOwnProperty$6.call(e,"callee")&&!propertyIsEnumerable$1.call(e,"callee")},isArray=Array.isArray;function stubFalse(){return!1}var freeExports$2="object"==typeof exports&&exports&&!exports.nodeType&&exports,freeModule$2=freeExports$2&&"object"==typeof module&&module&&!module.nodeType&&module,moduleExports$2=freeModule$2&&freeModule$2.exports===freeExports$2,Buffer$1=moduleExports$2?root.Buffer:void 0,nativeIsBuffer=Buffer$1?Buffer$1.isBuffer:void 0,isBuffer=nativeIsBuffer||stubFalse,MAX_SAFE_INTEGER$1=9007199254740991,reIsUint=/^(?:0|[1-9]\d*)$/;function isIndex(e,t){var o=typeof e;return!!(t=null==t?MAX_SAFE_INTEGER$1:t)&&("number"==o||"symbol"!=o&&reIsUint.test(e))&&e>-1&&e%1==0&&e<t}var MAX_SAFE_INTEGER=9007199254740991;function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=MAX_SAFE_INTEGER}var argsTag$2="[object Arguments]",arrayTag$2="[object Array]",boolTag$3="[object Boolean]",dateTag$3="[object Date]",errorTag$2="[object Error]",funcTag$1="[object Function]",mapTag$5="[object Map]",numberTag$3="[object Number]",objectTag$3="[object Object]",regexpTag$3="[object RegExp]",setTag$5="[object Set]",stringTag$3="[object String]",weakMapTag$2="[object WeakMap]",arrayBufferTag$3="[object ArrayBuffer]",dataViewTag$4="[object DataView]",float32Tag$2="[object Float32Array]",float64Tag$2="[object Float64Array]",int8Tag$2="[object Int8Array]",int16Tag$2="[object Int16Array]",int32Tag$2="[object Int32Array]",uint8Tag$2="[object Uint8Array]",uint8ClampedTag$2="[object Uint8ClampedArray]",uint16Tag$2="[object Uint16Array]",uint32Tag$2="[object Uint32Array]",typedArrayTags={};function baseIsTypedArray(e){return isObjectLike(e)&&isLength(e.length)&&!!typedArrayTags[baseGetTag(e)]}function baseUnary(e){return function(t){return e(t)}}typedArrayTags[float32Tag$2]=typedArrayTags[float64Tag$2]=typedArrayTags[int8Tag$2]=typedArrayTags[int16Tag$2]=typedArrayTags[int32Tag$2]=typedArrayTags[uint8Tag$2]=typedArrayTags[uint8ClampedTag$2]=typedArrayTags[uint16Tag$2]=typedArrayTags[uint32Tag$2]=!0,typedArrayTags[argsTag$2]=typedArrayTags[arrayTag$2]=typedArrayTags[arrayBufferTag$3]=typedArrayTags[boolTag$3]=typedArrayTags[dataViewTag$4]=typedArrayTags[dateTag$3]=typedArrayTags[errorTag$2]=typedArrayTags[funcTag$1]=typedArrayTags[mapTag$5]=typedArrayTags[numberTag$3]=typedArrayTags[objectTag$3]=typedArrayTags[regexpTag$3]=typedArrayTags[setTag$5]=typedArrayTags[stringTag$3]=typedArrayTags[weakMapTag$2]=!1;var freeExports$1="object"==typeof exports&&exports&&!exports.nodeType&&exports,freeModule$1=freeExports$1&&"object"==typeof module&&module&&!module.nodeType&&module,moduleExports$1=freeModule$1&&freeModule$1.exports===freeExports$1,freeProcess=moduleExports$1&&freeGlobal.process,nodeUtil=function(){try{var e=freeModule$1&&freeModule$1.require&&freeModule$1.require("util").types;return e||freeProcess&&freeProcess.binding&&freeProcess.binding("util")}catch(e){}}(),nodeIsTypedArray=nodeUtil&&nodeUtil.isTypedArray,isTypedArray=nodeIsTypedArray?baseUnary(nodeIsTypedArray):baseIsTypedArray,objectProto$7=Object.prototype,hasOwnProperty$5=objectProto$7.hasOwnProperty;function arrayLikeKeys(e,t){var o=isArray(e),n=!o&&isArguments(e),r=!o&&!n&&isBuffer(e),i=!o&&!n&&!r&&isTypedArray(e),a=o||n||r||i,s=a?baseTimes(e.length,String):[],l=s.length;for(var c in e)!t&&!hasOwnProperty$5.call(e,c)||a&&("length"==c||r&&("offset"==c||"parent"==c)||i&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||isIndex(c,l))||s.push(c);return s}var objectProto$6=Object.prototype;function isPrototype(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||objectProto$6)}function overArg(e,t){return function(o){return e(t(o))}}var nativeKeys=overArg(Object.keys,Object),objectProto$5=Object.prototype,hasOwnProperty$4=objectProto$5.hasOwnProperty;function baseKeys(e){if(!isPrototype(e))return nativeKeys(e);var t=[];for(var o in Object(e))hasOwnProperty$4.call(e,o)&&"constructor"!=o&&t.push(o);return t}function isArrayLike(e){return null!=e&&isLength(e.length)&&!isFunction(e)}function keys(e){return isArrayLike(e)?arrayLikeKeys(e):baseKeys(e)}function baseAssign(e,t){return e&&copyObject(t,keys(t),e)}function nativeKeysIn(e){var t=[];if(null!=e)for(var o in Object(e))t.push(o);return t}var objectProto$4=Object.prototype,hasOwnProperty$3=objectProto$4.hasOwnProperty;function baseKeysIn(e){if(!isObject(e))return nativeKeysIn(e);var t=isPrototype(e),o=[];for(var n in e)("constructor"!=n||!t&&hasOwnProperty$3.call(e,n))&&o.push(n);return o}function keysIn(e){return isArrayLike(e)?arrayLikeKeys(e,!0):baseKeysIn(e)}function baseAssignIn(e,t){return e&&copyObject(t,keysIn(t),e)}var freeExports="object"==typeof exports&&exports&&!exports.nodeType&&exports,freeModule=freeExports&&"object"==typeof module&&module&&!module.nodeType&&module,moduleExports=freeModule&&freeModule.exports===freeExports,Buffer=moduleExports?root.Buffer:void 0,allocUnsafe=Buffer?Buffer.allocUnsafe:void 0;function cloneBuffer(e,t){if(t)return e.slice();var o=e.length,n=allocUnsafe?allocUnsafe(o):new e.constructor(o);return e.copy(n),n}function copyArray(e,t){var o=-1,n=e.length;for(t||(t=Array(n));++o<n;)t[o]=e[o];return t}function arrayFilter(e,t){for(var o=-1,n=null==e?0:e.length,r=0,i=[];++o<n;){var a=e[o];t(a,o,e)&&(i[r++]=a)}return i}function stubArray(){return[]}var objectProto$3=Object.prototype,propertyIsEnumerable=objectProto$3.propertyIsEnumerable,nativeGetSymbols$1=Object.getOwnPropertySymbols,getSymbols=nativeGetSymbols$1?function(e){return null==e?[]:(e=Object(e),arrayFilter(nativeGetSymbols$1(e),(function(t){return propertyIsEnumerable.call(e,t)})))}:stubArray;function copySymbols(e,t){return copyObject(e,getSymbols(e),t)}function arrayPush(e,t){for(var o=-1,n=t.length,r=e.length;++o<n;)e[r+o]=t[o];return e}var getPrototype=overArg(Object.getPrototypeOf,Object),nativeGetSymbols=Object.getOwnPropertySymbols,getSymbolsIn=nativeGetSymbols?function(e){for(var t=[];e;)arrayPush(t,getSymbols(e)),e=getPrototype(e);return t}:stubArray;function copySymbolsIn(e,t){return copyObject(e,getSymbolsIn(e),t)}function baseGetAllKeys(e,t,o){var n=t(e);return isArray(e)?n:arrayPush(n,o(e))}function getAllKeys(e){return baseGetAllKeys(e,keys,getSymbols)}function getAllKeysIn(e){return baseGetAllKeys(e,keysIn,getSymbolsIn)}var DataView=getNative(root,"DataView"),Promise$1=getNative(root,"Promise"),Set$1=getNative(root,"Set"),WeakMap=getNative(root,"WeakMap"),mapTag$4="[object Map]",objectTag$2="[object Object]",promiseTag="[object Promise]",setTag$4="[object Set]",weakMapTag$1="[object WeakMap]",dataViewTag$3="[object DataView]",dataViewCtorString=toSource(DataView),mapCtorString=toSource(Map$1),promiseCtorString=toSource(Promise$1),setCtorString=toSource(Set$1),weakMapCtorString=toSource(WeakMap),getTag=baseGetTag;(DataView&&getTag(new DataView(new ArrayBuffer(1)))!=dataViewTag$3||Map$1&&getTag(new Map$1)!=mapTag$4||Promise$1&&getTag(Promise$1.resolve())!=promiseTag||Set$1&&getTag(new Set$1)!=setTag$4||WeakMap&&getTag(new WeakMap)!=weakMapTag$1)&&(getTag=function(e){var t=baseGetTag(e),o=t==objectTag$2?e.constructor:void 0,n=o?toSource(o):"";if(n)switch(n){case dataViewCtorString:return dataViewTag$3;case mapCtorString:return mapTag$4;case promiseCtorString:return promiseTag;case setCtorString:return setTag$4;case weakMapCtorString:return weakMapTag$1}return t});var getTag$1=getTag,objectProto$2=Object.prototype,hasOwnProperty$2=objectProto$2.hasOwnProperty;function initCloneArray(e){var t=e.length,o=new e.constructor(t);return t&&"string"==typeof e[0]&&hasOwnProperty$2.call(e,"index")&&(o.index=e.index,o.input=e.input),o}var Uint8Array$1=root.Uint8Array;function cloneArrayBuffer(e){var t=new e.constructor(e.byteLength);return new Uint8Array$1(t).set(new Uint8Array$1(e)),t}function cloneDataView(e,t){var o=t?cloneArrayBuffer(e.buffer):e.buffer;return new e.constructor(o,e.byteOffset,e.byteLength)}var reFlags=/\w*$/;function cloneRegExp(e){var t=new e.constructor(e.source,reFlags.exec(e));return t.lastIndex=e.lastIndex,t}var symbolProto$2=Symbol?Symbol.prototype:void 0,symbolValueOf$1=symbolProto$2?symbolProto$2.valueOf:void 0;function cloneSymbol(e){return symbolValueOf$1?Object(symbolValueOf$1.call(e)):{}}function cloneTypedArray(e,t){var o=t?cloneArrayBuffer(e.buffer):e.buffer;return new e.constructor(o,e.byteOffset,e.length)}var boolTag$2="[object Boolean]",dateTag$2="[object Date]",mapTag$3="[object Map]",numberTag$2="[object Number]",regexpTag$2="[object RegExp]",setTag$3="[object Set]",stringTag$2="[object String]",symbolTag$3="[object Symbol]",arrayBufferTag$2="[object ArrayBuffer]",dataViewTag$2="[object DataView]",float32Tag$1="[object Float32Array]",float64Tag$1="[object Float64Array]",int8Tag$1="[object Int8Array]",int16Tag$1="[object Int16Array]",int32Tag$1="[object Int32Array]",uint8Tag$1="[object Uint8Array]",uint8ClampedTag$1="[object Uint8ClampedArray]",uint16Tag$1="[object Uint16Array]",uint32Tag$1="[object Uint32Array]";function initCloneByTag(e,t,o){var n=e.constructor;switch(t){case arrayBufferTag$2:return cloneArrayBuffer(e);case boolTag$2:case dateTag$2:return new n(+e);case dataViewTag$2:return cloneDataView(e,o);case float32Tag$1:case float64Tag$1:case int8Tag$1:case int16Tag$1:case int32Tag$1:case uint8Tag$1:case uint8ClampedTag$1:case uint16Tag$1:case uint32Tag$1:return cloneTypedArray(e,o);case mapTag$3:return new n;case numberTag$2:case stringTag$2:return new n(e);case regexpTag$2:return cloneRegExp(e);case setTag$3:return new n;case symbolTag$3:return cloneSymbol(e)}}var objectCreate=Object.create,baseCreate=function(){function e(){}return function(t){if(!isObject(t))return{};if(objectCreate)return objectCreate(t);e.prototype=t;var o=new e;return e.prototype=void 0,o}}();function initCloneObject(e){return"function"!=typeof e.constructor||isPrototype(e)?{}:baseCreate(getPrototype(e))}var mapTag$2="[object Map]";function baseIsMap(e){return isObjectLike(e)&&getTag$1(e)==mapTag$2}var nodeIsMap=nodeUtil&&nodeUtil.isMap,isMap=nodeIsMap?baseUnary(nodeIsMap):baseIsMap,setTag$2="[object Set]";function baseIsSet(e){return isObjectLike(e)&&getTag$1(e)==setTag$2}var nodeIsSet=nodeUtil&&nodeUtil.isSet,isSet=nodeIsSet?baseUnary(nodeIsSet):baseIsSet,CLONE_DEEP_FLAG$1=1,CLONE_FLAT_FLAG=2,CLONE_SYMBOLS_FLAG$1=4,argsTag$1="[object Arguments]",arrayTag$1="[object Array]",boolTag$1="[object Boolean]",dateTag$1="[object Date]",errorTag$1="[object Error]",funcTag="[object Function]",genTag="[object GeneratorFunction]",mapTag$1="[object Map]",numberTag$1="[object Number]",objectTag$1="[object Object]",regexpTag$1="[object RegExp]",setTag$1="[object Set]",stringTag$1="[object String]",symbolTag$2="[object Symbol]",weakMapTag="[object WeakMap]",arrayBufferTag$1="[object ArrayBuffer]",dataViewTag$1="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",cloneableTags={};function baseClone(e,t,o,n,r,i){var a,s=t&CLONE_DEEP_FLAG$1,l=t&CLONE_FLAT_FLAG,c=t&CLONE_SYMBOLS_FLAG$1;if(o&&(a=r?o(e,n,r,i):o(e)),void 0!==a)return a;if(!isObject(e))return e;var u=isArray(e);if(u){if(a=initCloneArray(e),!s)return copyArray(e,a)}else{var d=getTag$1(e),m=d==funcTag||d==genTag;if(isBuffer(e))return cloneBuffer(e,s);if(d==objectTag$1||d==argsTag$1||m&&!r){if(a=l||m?{}:initCloneObject(e),!s)return l?copySymbolsIn(e,baseAssignIn(a,e)):copySymbols(e,baseAssign(a,e))}else{if(!cloneableTags[d])return r?e:{};a=initCloneByTag(e,d,s)}}i||(i=new Stack);var h=i.get(e);if(h)return h;i.set(e,a),isSet(e)?e.forEach((function(n){a.add(baseClone(n,t,o,n,e,i))})):isMap(e)&&e.forEach((function(n,r){a.set(r,baseClone(n,t,o,r,e,i))}));var g=u?void 0:(c?l?getAllKeysIn:getAllKeys:l?keysIn:keys)(e);return arrayEach(g||e,(function(n,r){g&&(n=e[r=n]),assignValue(a,r,baseClone(n,t,o,r,e,i))})),a}cloneableTags[argsTag$1]=cloneableTags[arrayTag$1]=cloneableTags[arrayBufferTag$1]=cloneableTags[dataViewTag$1]=cloneableTags[boolTag$1]=cloneableTags[dateTag$1]=cloneableTags[float32Tag]=cloneableTags[float64Tag]=cloneableTags[int8Tag]=cloneableTags[int16Tag]=cloneableTags[int32Tag]=cloneableTags[mapTag$1]=cloneableTags[numberTag$1]=cloneableTags[objectTag$1]=cloneableTags[regexpTag$1]=cloneableTags[setTag$1]=cloneableTags[stringTag$1]=cloneableTags[symbolTag$2]=cloneableTags[uint8Tag]=cloneableTags[uint8ClampedTag]=cloneableTags[uint16Tag]=cloneableTags[uint32Tag]=!0,cloneableTags[errorTag$1]=cloneableTags[funcTag]=cloneableTags[weakMapTag]=!1;var CLONE_DEEP_FLAG=1,CLONE_SYMBOLS_FLAG=4,Views;function cloneDeep(e){return baseClone(e,CLONE_DEEP_FLAG|CLONE_SYMBOLS_FLAG)}class GuiSubscreen{get active(){return getCurrentSubscreen()===this}Load(){}Run(){}Click(){}Exit(){setSubscreen(null)}Unload(){}onChange(e){}}class GuiAuthorityDialogMin extends GuiSubscreen{constructor(e,t,o,n,r,i){super(),this.character=e,this.permission=t,this.permissionData=o,this.back=i,this.myAccessLevel=n,this.noAccess=r,this.selectedLevel=o.min}Run(){if(DrawTextFit(`- Authority: Changing minimum access to permission "${this.permissionData.name}" -`,125,125,1850,"Black","Gray"),MainCanvas.textAlign="center",DrawText("Please select the new lowest role that should still have this permission.",1e3,255,"Black"),DrawTextFit(`Info: Currently set role: ${this.permissionData.min===AccessLevel.self?this.character.Name:capitalizeFirstLetter(AccessLevel[this.permissionData.min])}  Newly selected role: ${this.selectedLevel===AccessLevel.self?this.character.Name:capitalizeFirstLetter(AccessLevel[this.selectedLevel])}`,1e3,320,1850,"Black"),DrawText("All roles to the left of the selected one will also automatically get access.",1e3,385,"Black"),this.myAccessLevel===AccessLevel.self){const e=this.permissionData.min<=AccessLevel.self||!this.noAccess;DrawButton(890,460,220,72,getPermissionMinDisplayText(AccessLevel.self,this.character),this.selectedLevel===AccessLevel.self?"Cyan":e?"White":"#ddd",void 0,void 0,!e)}for(let e=1;e<8;e++){const t=this.selectedLevel===e,o=this.myAccessLevel===AccessLevel.self&&this.permissionData.min<=e&&e<=AccessLevel.owner||!this.noAccess&&this.myAccessLevel<=e;DrawButton(230*e-15,577,190,72,getPermissionMinDisplayText(e,this.character),t?"Cyan":o?"White":"#ddd",void 0,void 0,!o),e<7&&DrawText(">",196+230*e,613,"Black")}this.character.isPlayer()&&"authority_revoke_self"===this.permission&&this.selectedLevel!==AccessLevel.self&&DrawText("WARNING: If you confirm, all permitted roles can remove your access to this and all other permissions!",1e3,730,"Red","Gray"),DrawButton(700,800,200,80,"Confirm","White"),DrawButton(1120,800,200,80,"Cancel","White")}Click(){if(MouseIn(700,800,200,80))return this.Confirm();if(MouseIn(1120,800,200,80))return this.Exit();if(MouseIn(890,460,220,72)&&this.myAccessLevel===AccessLevel.self){(this.permissionData.min<=AccessLevel.self||!this.noAccess)&&(this.selectedLevel=AccessLevel.self)}for(let e=1;e<8;e++){const t=this.selectedLevel===e,o=this.myAccessLevel===AccessLevel.self&&this.permissionData.min<=e&&e<=AccessLevel.owner||!this.noAccess&&this.myAccessLevel<=e;MouseIn(230*e-15,577,190,72)&&!t&&o&&(this.selectedLevel=e)}}Confirm(){this.character.setPermission(this.permission,"min",this.selectedLevel)}Exit(){setSubscreen(this.back)}onChange(){this.Exit()}}class GuiAuthorityDialogSelf extends GuiSubscreen{constructor(e,t,o,n){super(),this.character=e,this.permission=t,this.permissionData=o,this.back=n}Run(){DrawTextFit(`- Authority: Removing self access to permission "${this.permissionData.name}" -`,125,125,1850,"Black","Gray"),MainCanvas.textAlign="center",DrawText("- Warning -",1e3,375,"Black","Black"),DrawText("If you confirm, you won't be able to change your access to this permission back yourself.",1e3,525,"Black"),DrawButton(700,720,200,80,"Confirm","White"),DrawButton(1120,720,200,80,"Cancel","White")}Click(){return MouseIn(700,720,200,80)?this.Confirm():MouseIn(1120,720,200,80)?this.Exit():void 0}Confirm(){this.character.setPermission(this.permission,"self",!1)}Exit(){setSubscreen(this.back)}onChange(){this.Exit()}}!function(e){e[e.AuthorityRoles=10]="AuthorityRoles",e[e.AuthorityPermissions=11]="AuthorityPermissions",e[e.Log=20]="Log",e[e.LogConfig=21]="LogConfig",e[e.ConditionsViewCurses=30]="ConditionsViewCurses",e[e.ConditionsEditCurses=31]="ConditionsEditCurses",e[e.ConditionsGlobalCurses=32]="ConditionsGlobalCurses",e[e.CursesAdd=33]="CursesAdd",e[e.CursesAddPermissionMode=34]="CursesAddPermissionMode",e[e.ConditionsViewRules=40]="ConditionsViewRules",e[e.ConditionsEditRules=41]="ConditionsEditRules",e[e.ConditionsGlobalRules=42]="ConditionsGlobalRules",e[e.RulesAdd=43]="RulesAdd",e[e.RulesAddPermissionMode=44]="RulesAddPermissionMode",e[e.Misc=100]="Misc"}(Views||(Views={}));const HELP_TEXTS={[Views.AuthorityRoles]:"If you are permitted, this screen enables you to view, add, or remove the BCX-only roles 'Owner' and 'Mistress', which expand the classic roles of BC such as Bondage Club's Owner and the Lovers. The hierarchy of all roles that can be used to set various things in BCX can be seen on the right. The higher up a role is, the more authority it has. For instance, if something applies or is permitted for a Mistress, it also always is for an Owner. Any number of Owners and Mistresses can be set. Check their current power over BCX with the button on the right.",[Views.AuthorityPermissions]:"The heart of BCX: Allows to configure the permissions to set up and use most of BCX. Default settings depend on the initial BCX setup preset selected. Self access is the checkbox next to every permission and the lowest access role is to its right. Example: If 'allow forbidding self access', 'allow granting self access', 'allow lowest access modification' have the checkbox removed and lowest role is 'Owner', then current and newly added BCX owners and the BC owner can get full control over any permissions they have access to. So careful with those three permissions!",[Views.Log]:"This screen shows logs of important events. What is logged depends on the logging configuration, which can be viewed/edited via the button to the right. Log entries can have normal or protected visibility. Access to those as well as removing entries or the configuration is determined by the according authority module permission settings. The log can document the BCX's user's conduct, any rule violations, important changes made to BCX settings, curses or rules, and notes from other people.",[Views.LogConfig]:"This screen determines what is logged in the behaviour log and what the visibility of each type of log messages is. 'Yes' means this log type has normal visibility, while 'protected' means only roles who have permission to view protected entries can view them. 'No' means that this log type is not logged at all. In the permission settings view of the authority module, the permissions of this log module can be configured.",[Views.ConditionsViewCurses]:"This screen shows all active curses on the player, including many information, such as duration, if it is a cursed item or a blocked item or clothing slot that forces to stay unrestrained or naked there. Clicking on the button with the cog icon in the middle of each row moves you to a new screen that allows to configure the curse (if you have permission). When the cog icon has a blue aura, that means that the curse's conditions are the same as the global config. If permitted, you can remove single curses with the 'X' button.",[Views.ConditionsEditCurses]:"Here you can switch the curse on/off, set a timer for activating/deactivating/deleting the curse and define when it can trigger, such as either always or based on where the player is and with whom. The small green/red bars next to the checkboxes indicate whether a condition is true at present or not and the big bar whether this means that the curse is in effect, if active. On the right side, you can curse the usage/alteration of an item such as fixing cuffs behind the back. Lastly, in the bottom right you can set the trigger conditions of this curse to the global curses config.",[Views.ConditionsGlobalCurses]:"The settings on this page are the global/default settings for all newly added curses. Changes to the trigger conditions are also applied to existing curses that are (still) set to global curses configuration, though. Exception is if a timer is set here. Such a timer only applies to newly created curses.",[Views.CursesAdd]:"On this screen you can add a curse to any empty slot (white) which will keep it empty or on any worn item (gold) that then will be hard to remove. You add the curse by simply clicking the slot which then becomes purple to indicate that it is now cursed. You can switch the curse's configuration from the default globale configuration on the previous screen. Grey slots indicate that you have no access to them, due to it being blocked or due to your permission settings. Slots can be limited/blocked via the settings button on the very right.",[Views.CursesAddPermissionMode]:"Here you can cycle item and clothing slots between being not limited, limited and blocked. Blocked means no one can add a curse to it, while limited means only roles that have the permission to curse limited slots can curse them. There is no need to save changes as they are instantly in effect.",[Views.ConditionsViewRules]:"This screen shows all active rules for the player, including many information, such as duration, the rule type and little status icons that show if the rule is enforced and/or transgressions are logged. Clicking on the button with the cog icon in the middle of each row moves you to a new screen that allows to configure the rule (if you have permission). When the cog icon has a blue aura, then that means that the rule's conditions are the same as the global config. If permitted, you can remove single rules with the 'X' button.",[Views.ConditionsEditRules]:"Here you switch the rule on/off, set a timer for activating/deactivating/deleting the rule and define when it can trigger, such as either always or based on where the player is and with whom. The small green/red bars next to the checkboxes indicate whether a condition is true at present or not and the big bar whether this means that the rule is in effect, if active. Depending on the rule, you can either enforce its effect, log all violations, or both at the same time. Lastly on the bottom right, you can set whether the trigger conditions of this rule should follow the global rules config or not.",[Views.ConditionsGlobalRules]:"The settings on this page are the global/default settings for all newly added rules. Changes to the trigger conditions are also applied to existing rules that are (still) set to global rules configuration, though. Exception is if a timer is set here. Such a timer only applies to newly established rules.",[Views.RulesAdd]:"On this screen you can establish new rules for the player by simply clicking any rule template. After clicking on it, you can edit the rule's configuration. Purple rule templates indicate, that they are already in use; greyed out ones, that you have no access to them due to being blocked or due to your permission settings. Rule templates can be limited/blocked via the settings button on the very right. Note: If you want to be able to log rule violations, this type of log entry may need to be allowed in the configuration page of the behavior log module.",[Views.RulesAddPermissionMode]:"Here you can cycle rule templates between being not limited, limited and blocked. Blocked means no one can add/use this rule, while limited means only roles that have the permission to establish limited rules can add them. There is no need to save changes as they are instantly in effect.",[Views.Misc]:"This screen offers various settings to configure your Bondage Club experience in general, such as enabling/disabling the typing indicator that shows other BCX users an icon when you are currently typing something to public chat or whispering something to only them. The cheats are only temporarily active as long as they are set; items that were only given via a cheat are then also gone again."},PER_PAGE_COUNT$6=6;class GuiAuthorityPermissions extends GuiSubscreen{constructor(e){super(),this.permissionData=null,this.myAccessLevel=AccessLevel.public,this.failed=!1,this.permList=[],this.page=0,this.showHelp=!1,this.filterInput=createInputElement("text",30),this.character=e,this.character.isPlayer()&&(this.myAccessLevel=AccessLevel.self),this.filterInput.addEventListener("input",(e=>{this.rebuildList()}))}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.permissionData=null,this.rebuildList(),Promise.all([this.character.getPermissions(),this.character.getMyAccessLevel()]).then((e=>{this.permissionData=e[0],this.myAccessLevel=e[1],this.rebuildList()}),(e=>{console.error(`BCX: Failed to get permission info for ${this.character}`,e),this.failed=!0}))}rebuildList(){if(!this.active)return;if(this.permList=[],null===this.permissionData)return void this.filterInput.remove();this.filterInput.parentElement||document.body.appendChild(this.filterInput);const e=this.filterInput.value.trim().toLocaleLowerCase().split(" ").filter(Boolean),t=!!this.permissionData.authority_grant_self&&checkPermisionAccesData(this.permissionData.authority_grant_self,this.myAccessLevel),o=!!this.permissionData.authority_revoke_self&&checkPermisionAccesData(this.permissionData.authority_revoke_self,this.myAccessLevel),n=!!this.permissionData.authority_edit_min&&checkPermisionAccesData(this.permissionData.authority_edit_min,this.myAccessLevel),r=this.myAccessLevel===AccessLevel.self,i=new Map;for(const[t,o]of Object.entries(this.permissionData)){let n=i.get(o.category);e.some((e=>!MODULE_NAMES[o.category].toLocaleLowerCase().includes(e)&&!o.name.toLocaleLowerCase().includes(e)&&!t.toLocaleLowerCase().includes(e)))||(n||i.set(o.category,n={}),n[t]=o)}for(const[a,s]of Array.from(i.entries()).sort(((e,t)=>e[0]-t[0]))){if(0===e.length)for(;this.permList.length%PER_PAGE_COUNT$6!=0;)this.permList.push(null);this.permList.push({separator:!0,name:`${MODULE_NAMES[a]} module permissions`});for(const[i,l]of Object.entries(s).sort(((e,t)=>e[1].name.localeCompare(t[1].name)))){0===e.length&&this.permList.length%PER_PAGE_COUNT$6==0&&this.permList.push({separator:!0,name:`${MODULE_NAMES[a]} module permissions (continued)`});const s=checkPermisionAccesData(l,this.myAccessLevel);this.permList.push({separator:!1,permission:i,permissionInfo:l,editSelf:(l.self?o:t)&&(r||s)&&(!l.self||l.min!==AccessLevel.self),editMin:r&&l.min<AccessLevel.owner||n&&s})}}const a=Math.ceil(this.permList.length/PER_PAGE_COUNT$6);this.page<0?this.page=Math.max(a-1,0):this.page>=a&&(this.page=0)}Run(){if(null!==this.permissionData){DrawTextFit(this.character.Name,1111,190,189,"Black"),DrawText("is permitted",1111,235,"Black"),DrawText("Lowest permitted role",1370,235,"Black"),MainCanvas.beginPath(),MainCanvas.moveTo(1335,230),MainCanvas.lineTo(1335,840),MainCanvas.stroke(),DrawText("Filter:",130,215,"Black"),positionElement(this.filterInput,550,210,600,64),this.filterInput.value&&(MainCanvas.textAlign="center",DrawButton(870,182,64,64,"X","White")),MainCanvas.textAlign="left";for(let e=0;e<PER_PAGE_COUNT$6;e++){const t=this.page*PER_PAGE_COUNT$6+e;if(t>=this.permList.length)break;const o=this.permList[t];if(null===o)continue;const n=275+100*e;o.separator?(MainCanvas.beginPath(),MainCanvas.rect(125,n,1173,64),MainCanvas.fillStyle="#eeeeee",MainCanvas.fill(),DrawText(o.name,140,n+34,"Black")):(DrawImageEx(MODULE_ICONS[o.permissionInfo.category],125,n,{Height:64,Width:64}),DrawButton(200,n,1e3,64,"","White"),DrawTextFit(o.permissionInfo.name,210,n+34,990,"Black"),DrawButton(1235,n,64,64,"",o.editSelf?"White":"#ddd",o.permissionInfo.self?"Icons/Checked.png":"",void 0,!o.editSelf),MainCanvas.textAlign="center",DrawButton(1370,n,170,64,getPermissionMinDisplayText(o.permissionInfo.min,this.character),o.editMin?"White":"#ddd",void 0,void 0,!o.editMin),MainCanvas.textAlign="left")}const e=Math.max(1,Math.ceil(this.permList.length/PER_PAGE_COUNT$6));MainCanvas.textAlign="center",DrawBackNextButton(1605,800,300,90,`${DialogFindPlayer("Page")} ${this.page+1} / ${e}`,"White","",(()=>""),(()=>""))}else this.failed?(MainCanvas.textAlign="center",DrawText(`Failed to get permission data from ${this.character.Name}. Maybe you have no access?`,1e3,480,"Black")):(MainCanvas.textAlign="center",DrawText("Loading...",1e3,480,"Black"));this.showHelp&&showHelp(HELP_TEXTS[Views.AuthorityPermissions]),MainCanvas.textAlign="left",DrawText(`- Authority: Permission Settings for ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","BCX main menu"),DrawButton(1815,190,90,90,"","White","Icons/Question.png"),DrawButton(1815,305,90,90,"","White","Icons/West.png","Previous screen")}Click(){if(MouseIn(1815,75,90,90))return this.Exit();if(MouseIn(1815,190,90,90))this.showHelp=!this.showHelp;else{if(MouseIn(1815,305,90,90))return setSubscreen(new GuiAuthorityRoles(this.character));if(null!==this.permissionData){MouseIn(870,182,64,64)&&(this.filterInput.value="",this.rebuildList());for(let e=0;e<PER_PAGE_COUNT$6;e++){const t=this.page*PER_PAGE_COUNT$6+e;if(t>=this.permList.length)break;const o=this.permList[t];if(null===o)continue;const n=275+100*e;if(!o.separator){if(MouseIn(200,n,1e3,64),MouseIn(1235,n,64,64)&&o.editSelf)return void(!o.permissionInfo.self||!this.character.isPlayer()||"authority_grant_self"!==o.permission&&checkPermissionAccess("authority_grant_self",getPlayerCharacter())?this.character.setPermission(o.permission,"self",!o.permissionInfo.self):setSubscreen(new GuiAuthorityDialogSelf(this.character,o.permission,o.permissionInfo,this)));if(MouseIn(1370,n,170,64)&&o.editMin){const e=!!this.permissionData.authority_edit_min&&checkPermisionAccesData(this.permissionData.authority_edit_min,this.myAccessLevel);return void setSubscreen(new GuiAuthorityDialogMin(this.character,o.permission,o.permissionInfo,this.myAccessLevel,!e||!checkPermisionAccesData(o.permissionInfo,this.myAccessLevel),this))}}}const e=Math.ceil(this.permList.length/PER_PAGE_COUNT$6);MouseIn(1605,800,150,90)?(this.page--,this.page<0&&(this.page=Math.max(e-1,0))):MouseIn(1755,800,150,90)&&(this.page++,this.page>=e&&(this.page=0))}}}Exit(){setSubscreen(new GuiMainMenu(this.character))}Unload(){this.filterInput.remove()}}const PER_PAGE_COUNT$5=8;class GuiMemberSelect extends GuiSubscreen{constructor(e,t,o,n=[]){super(),this.roleData=null,this.roleList=[],this.failed=!1,this.page=0,this.character=e,this.back=t,this.callback=o,this.ignoredCharacters=n}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.roleData=null,this.refreshScreen(),Promise.all([this.character.getRolesData()]).then((e=>{this.roleData=e[0],this.refreshScreen()}),(e=>{console.error(`BCX: Failed to get role info for ${this.character}`,e),this.failed=!0}))}refreshScreen(){var e,t,o;if(!this.active)return;this.roleList=[];let n=document.getElementById("BCX_Filter");if(null===this.roleData)return void(n&&n.remove());n||(n=ElementCreateInput("BCX_Filter","text","","30"),n.addEventListener("input",(e=>{this.refreshScreen()})));const r=n.value.trim().toLocaleLowerCase().split(" ");this.roleList=[{type:"Character",memberNumber:this.character.MemberNumber,name:this.character.Name}],this.character.isPlayer()||this.roleList.push({type:"Player",memberNumber:Player.MemberNumber,name:Player.Name}),"number"!=typeof(null===(e=this.character.Character.Ownership)||void 0===e?void 0:e.MemberNumber)||this.roleList.some((e=>{var t;return e.memberNumber===(null===(t=this.character.Character.Ownership)||void 0===t?void 0:t.MemberNumber)}))||this.roleList.push({type:"Clubowner",memberNumber:this.character.Character.Ownership.MemberNumber,name:this.character.Character.Ownership.Name});for(const e of this.roleData.owners)this.roleList.some((t=>t.memberNumber===e[0]))||this.roleList.push({type:"Owner",memberNumber:e[0],name:getCharacterName(e[0],e[1]||"[unknown name]")});if(Array.isArray(this.character.Character.Lovership))for(const e of this.character.Character.Lovership)"number"!=typeof e.MemberNumber||this.roleList.some((t=>t.memberNumber===e.MemberNumber))||this.roleList.push({type:"Lover",memberNumber:e.MemberNumber,name:e.Name});for(const e of this.roleData.mistresses)this.roleList.some((t=>t.memberNumber===e[0]))||this.roleList.push({type:"Mistress",memberNumber:e[0],name:getCharacterName(e[0],e[1]||"[unknown name]")});if(Player.GetBlindLevel()<3||!(null===(t=Player.GameplaySettings)||void 0===t?void 0:t.BlindDisableExamine)){const e=getAllCharactersInRoom();if(Player.GetBlindLevel()>0&&(null===(o=Player.ImmersionSettings)||void 0===o?void 0:o.BlindAdjacent)){const t=e.findIndex((e=>e.isPlayer()));for(let o=0;o<e.length;o++)1!==Math.abs(o-t)||this.roleList.some((t=>t.memberNumber===e[o].MemberNumber))||this.roleList.push({type:"in same room",memberNumber:e[o].MemberNumber,name:e[o].Name})}else for(const t of e)this.roleList.some((e=>e.memberNumber===t.MemberNumber))||this.roleList.push({type:"in same room",memberNumber:t.MemberNumber,name:t.Name})}if(Player.FriendNames)for(const[e,t]of Player.FriendNames.entries())this.roleList.some((t=>t.memberNumber===e))||this.roleList.push({type:"Friend",memberNumber:e,name:t});this.roleList=this.roleList.filter((e=>!this.ignoredCharacters.includes(e.memberNumber)&&r.every((t=>{var o;return(null===(o=e.name)||void 0===o?void 0:o.toLocaleLowerCase().includes(t))||e.memberNumber.toString().includes(t)}))));const i=Math.ceil(this.roleList.length/PER_PAGE_COUNT$5);this.page<0?this.page=Math.max(i-1,0):this.page>=i&&(this.page=0)}Run(){var e;if(null!==this.roleData){DrawText("Filter name:",703,125,"Black"),ElementPosition("BCX_Filter",1203,118,600,64),(null===(e=document.getElementById("BCX_Filter"))||void 0===e?void 0:e.value)&&(MainCanvas.textAlign="center",DrawButton(1510,92,64,64,"X","White"));for(let e=0;e<PER_PAGE_COUNT$5;e++){const t=this.page*PER_PAGE_COUNT$5+e;if(t>=this.roleList.length)break;const o=this.roleList[t],n=290+75*e;MainCanvas.textAlign="center",DrawText(`${o.name}`,383,n+34,"Black"),DrawText(`${o.memberNumber}`,780,n+34,"Black"),DrawText(`${"Character"===o.type?"":o.type}`,1100,n+34,"Black"),MainCanvas.beginPath(),MainCanvas.moveTo(175,n+69),MainCanvas.lineTo(1280,n+69),MainCanvas.strokeStyle="#ddd",MainCanvas.stroke(),DrawButton(1340,n,150,64,"Select","White","")}const t=Math.max(1,Math.ceil(this.roleList.length/PER_PAGE_COUNT$5));DrawBackNextButton(1605,800,300,90,`${DialogFindPlayer("Page")} ${this.page+1} / ${t}`,"White","",(()=>""),(()=>""))}else this.failed?(MainCanvas.textAlign="center",DrawText(`Failed to get data from ${this.character.Name}. Maybe you have no access?`,1e3,480,"Black")):(MainCanvas.textAlign="center",DrawText("Loading...",1e3,480,"Black"));MainCanvas.textAlign="left",DrawText("Please select a member.",125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","Back"),MainCanvas.beginPath(),MainCanvas.moveTo(125,176),MainCanvas.lineTo(1566,176),MainCanvas.stroke(),DrawText("Name",383,222,"Black"),DrawText("Member number",780,222,"Black"),DrawText("Note",1100,222,"Black"),MainCanvas.beginPath(),MainCanvas.moveTo(125,265),MainCanvas.lineTo(1566,265),MainCanvas.stroke()}Click(){if(MouseIn(1815,75,90,90))return this.Exit();if(null!==this.roleData){const e=document.getElementById("BCX_Filter");MouseIn(1510,92,64,64)&&e&&(e.value="",this.refreshScreen());for(let e=0;e<PER_PAGE_COUNT$5;e++){const t=this.page*PER_PAGE_COUNT$5+e;if(t>=this.roleList.length)break;const o=this.roleList[t];if(MouseIn(1340,290+75*e,150,64))return this.callback(o.memberNumber),void this.Exit()}const t=Math.ceil(this.roleList.length/PER_PAGE_COUNT$5);MouseIn(1605,800,150,90)?(this.page--,this.page<0&&(this.page=Math.max(t-1,0))):MouseIn(1755,800,150,90)&&(this.page++,this.page>=t&&(this.page=0))}}Exit(){setSubscreen(this.back)}Unload(){ElementRemove("BCX_Filter")}}const PER_PAGE_COUNT$4=6;class GuiAuthorityRoles extends GuiSubscreen{constructor(e){super(),this.roleData=null,this.roleList=[],this.failed=!1,this.page=0,this.hoveringTextList=[],this.roleAddInputAutofill=null,this.showHelp=!1,this.character=e,this.hoveringTextList=e.isPlayer()?["You - either top or bottom of the hierarchy","Your owner, visible on your character profile",'Any character, added to the list on the left as "Owner"',"Any of your lovers, visible on your character profile",'Any character, added to the list on the left as "Mistress"',"Anyone you have white-listed","Anyone you have friend-listed","Anyone, who can use items on you"]:["This player - either top or bottom of the hierarchy","This player's owner, visible on their character profile",'Any character, added to the list on the left as "Owner"',"Any lover of this player, visible on their profile",'Any character, added to the list on the left as "Mistress"',"Anyone this player has white-listed","Anyone this player has friend-listed","Anyone, who can use items on this player"]}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.roleData=null,this.rebuildList(),Promise.all([this.character.getRolesData()]).then((e=>{this.roleData=e[0],this.rebuildList()}),(e=>{console.error(`BCX: Failed to get role info for ${this.character}`,e),this.failed=!0}))}rebuildList(){if(!this.active)return;this.roleList=[];let e=document.getElementById("BCX_RoleAdd");if(!this.roleData)return void(e&&e.remove());const t=this.roleData.allowAddMistress||this.roleData.allowAddOwner;!t&&e?e.remove():t&&!e&&(e=ElementCreateInput("BCX_RoleAdd","text","","6"),null!==this.roleAddInputAutofill&&(e.value=`${this.roleAddInputAutofill}`,this.roleAddInputAutofill=null)),this.roleList=this.roleData.owners.map((e=>({type:"Owner",memberNumber:e[0],name:getCharacterName(e[0],e[1]||null)}))),this.roleList.push(...this.roleData.mistresses.map((e=>({type:"Mistress",memberNumber:e[0],name:getCharacterName(e[0],e[1]||null)}))));const o=Math.ceil(this.roleList.length/PER_PAGE_COUNT$4);this.page<0?this.page=Math.max(o-1,0):this.page>=o&&(this.page=0)}Run(){if(DrawText("Hierarchy of roles:",1336,95,"Black"),MainCanvas.beginPath(),MainCanvas.moveTo(1450,134),MainCanvas.lineTo(1600,134),MainCanvas.lineTo(1530,740),MainCanvas.lineTo(1520,740),MainCanvas.lineTo(1450,134),MainCanvas.fillStyle="Black",MainCanvas.fill(),this.roleData){for(let e=0;e<PER_PAGE_COUNT$4;e++){const t=this.page*PER_PAGE_COUNT$4+e;if(t>=this.roleList.length)break;const o=this.roleList[t],n=210+95*e;MainCanvas.beginPath(),MainCanvas.rect(130,n,900,64),MainCanvas.stroke();const r=`${o.type} ${null===o.name?"[unknown name]":o.name} (${o.memberNumber})`;DrawTextFit(r,140,n+34,590,"Black"),(("Owner"===o.type?this.roleData.allowRemoveOwner:this.roleData.allowRemoveMistress)||o.memberNumber===Player.MemberNumber)&&(MainCanvas.textAlign="center",DrawButton(1090,n,64,64,"X","White"),MainCanvas.textAlign="left")}document.getElementById("BCX_RoleAdd")&&(DrawText("Member Number:",130,847,"Black"),ElementPosition("BCX_RoleAdd",580,842,300,64)),MainCanvas.textAlign="center",this.roleData.allowAddOwner&&DrawButton(833,815,210,64,"Add as owner","white"),this.roleData.allowAddMistress&&DrawButton(1074,815,210,64,"Add as mistress","white"),(this.roleData.allowAddMistress||this.roleData.allowAddOwner)&&(DrawButton(740,815,64,64,"","White",void 0,"Select member number from list"),DrawImageEx("Icons/Title.png",742,815,{Width:60,Height:60}));const e=Math.ceil(this.roleList.length/PER_PAGE_COUNT$4);DrawBackNextButton(1430,800,300,90,`Page ${this.page+1} / ${e}`,"White","",(()=>""),(()=>""))}else this.failed?(MainCanvas.textAlign="center",DrawText(`Failed to get role data from ${this.character.Name}. Maybe you have no access?`,800,480,"Black")):(MainCanvas.textAlign="center",DrawText("Loading...",800,480,"Black"));MainCanvas.textAlign="center",DrawButton(1420,130,208,54,this.character.Name,"White",void 0,this.hoveringTextList[0]);for(let e=1;e<8;e++)DrawButton(1430,130+80*e,188,54,capitalizeFirstLetter(AccessLevel[e]),"White",void 0,this.hoveringTextList[e]);this.showHelp&&showHelp(HELP_TEXTS[Views.AuthorityRoles]),MainCanvas.textAlign="left",DrawText(`- Authority: Role Management for ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","BCX main menu"),DrawButton(1815,190,90,90,"","White","Icons/Question.png"),DrawButton(1815,305,90,90,"","White","Icons/Preference.png","Configure the role-based BCX permissions")}Click(){var e;if(MouseIn(1815,75,90,90))return this.Exit();if(MouseIn(1815,190,90,90))this.showHelp=!this.showHelp;else{if(MouseIn(1815,305,90,90))return this.Back();if(this.roleData){for(let e=0;e<PER_PAGE_COUNT$4;e++){const t=this.page*PER_PAGE_COUNT$4+e;if(t>=this.roleList.length)break;const o=this.roleList[t],n=210+95*e;if((("Owner"===o.type?this.roleData.allowRemoveOwner:this.roleData.allowRemoveMistress)||o.memberNumber===Player.MemberNumber)&&MouseIn(1090,n,64,64))return void this.character.editRole("Owner"===o.type?"owner":"mistress","remove",o.memberNumber)}const t=document.getElementById("BCX_RoleAdd"),o=null!==(e=null==t?void 0:t.value)&&void 0!==e?e:"",n=/^[0-9]+$/.test(o)?Number.parseInt(o,10):null;if(this.roleData.allowAddOwner&&t&&null!==n&&MouseIn(833,815,210,64))return t.value="",void this.character.editRole("owner","add",n);if(this.roleData.allowAddMistress&&t&&null!==n&&MouseIn(1074,815,210,64))return t.value="",void this.character.editRole("mistress","add",n);const r=Math.ceil(this.roleList.length/PER_PAGE_COUNT$4);if(MouseIn(1430,800,150,90)?(this.page--,this.page<0&&(this.page=Math.max(r-1,0))):MouseIn(1580,800,150,90)&&(this.page++,this.page>=r&&(this.page=0)),MouseIn(740,815,64,64))return void setSubscreen(new GuiMemberSelect(this.character,this,(e=>{this.roleAddInputAutofill=e})))}}}Exit(){setSubscreen(new GuiMainMenu(this.character))}Back(){setSubscreen(new GuiAuthorityPermissions(this.character))}Unload(){ElementRemove("BCX_RoleAdd")}}class GuiGlobalDialogClearData extends GuiSubscreen{constructor(e){super(),this.allowedConfirmTime=0,this.back=e}Load(){this.allowedConfirmTime=Date.now()+1e4}Run(){if(MainCanvas.textAlign="center",DrawText("- Permanent deletion of ALL Bondage Club Extended data -",1e3,125,"Black"),DrawText("- Warning -",1e3,225,"Black","Black"),DrawText("If you confirm, all BCX data (including settings, curses, logs, ...) will be permanently deleted!",1e3,325,"Black"),DrawText("As part of the deletion process, the window will reload, logging you out of your account.",1e3,500,"Gray"),DrawText("You will be able to use BCX again, but none of your current data will be coming back!",1e3,550,"Gray"),DrawText("This action cannot be undone!",1e3,625,"Red","Black"),null===this.allowedConfirmTime)return void DrawText("Deleting...",1e3,720,"Black");const e=Date.now();e<this.allowedConfirmTime?DrawButton(300,720,200,80,`Confirm (${Math.floor((this.allowedConfirmTime-e)/1e3)})`,"#ddd",void 0,void 0,!0):DrawButton(300,720,200,80,"Confirm","White"),DrawButton(1520,720,200,80,"Cancel","White")}Click(){if(null!==this.allowedConfirmTime)return MouseIn(1520,720,200,80)?this.Exit():MouseIn(300,720,200,80)&&Date.now()>=this.allowedConfirmTime?this.Confirm():void 0}Confirm(){this.allowedConfirmTime=null,clearAllData()}Exit(){null!==this.allowedConfirmTime&&setSubscreen(this.back)}}class GuiGlobalModuleToggling extends GuiSubscreen{constructor(){super(...arguments),this.enabledModules=new Set,this.changed=!1}Load(){this.enabledModules.clear();for(const e of TOGGLEABLE_MODULES.filter((e=>moduleIsEnabled(e))))this.enabledModules.add(e);this.changed=!1}Run(){MainCanvas.textAlign="left",DrawText("- Global: Enable/Disable BCX's modules -",125,125,"Black","Gray"),DrawText("Warning: Disabling a module will reset all its settings and stored data!",125,180,"FireBrick");for(let e=0;e<TOGGLEABLE_MODULES.length;e++){const t=TOGGLEABLE_MODULES[e],o=Math.floor(e/5),n=e%5;DrawCheckbox(150+500*o,240+110*n,64,64,"",this.enabledModules.has(t)),DrawImageEx(MODULE_ICONS[t],280+500*o,240+110*n,{Height:64,Width:64}),DrawText(MODULE_NAMES[t],370+500*o,272+110*n,"Black")}MainCanvas.textAlign="center",DrawButton(300,800,200,80,"Confirm",this.changed?"White":"#ddd",void 0,void 0,!this.changed),DrawButton(1520,800,200,80,"Cancel","White")}Click(){if(MouseIn(1815,75,90,90))return this.Exit();for(let e=0;e<TOGGLEABLE_MODULES.length;e++){const t=TOGGLEABLE_MODULES[e],o=Math.floor(e/5);if(MouseIn(150+500*o,240+110*(e%5),64,64))return this.enabledModules.has(t)?this.enabledModules.delete(t):this.enabledModules.add(t),void(this.changed=!0)}if(!MouseIn(300,800,200,80)||!this.changed)return MouseIn(1520,800,200,80)?this.Exit():void 0;setDisabledModules(TOGGLEABLE_MODULES.filter((e=>!this.enabledModules.has(e))))&&this.Exit()}Exit(){setSubscreen(new GuiGlobal(getPlayerCharacter()))}}class GuiGlobal extends GuiSubscreen{constructor(e){super(),this.character=e}Run(){MainCanvas.textAlign="left",DrawText(`- Global: Configuration for ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","BCX main menu"),this.character.isPlayer()?(DrawButton(120,200,400,90,"Manage BCX modules","White","","Enable/Disable individual modules"),DrawButton(1525,800,300,90,"Clear all BCX data","#FF3232","","Emergency reset of BCX")):DrawText("Global configuration is not possible on others",1e3,500,"Black")}Click(){if(MouseIn(1815,75,90,90))return this.Exit();this.character.isPlayer()&&(MouseIn(120,200,400,90)?setSubscreen(new GuiGlobalModuleToggling):MouseIn(1525,800,300,90)&&setSubscreen(new GuiGlobalDialogClearData(this)))}Exit(){setSubscreen(new GuiMainMenu(this.character))}}const COMMAND_GENERIC_ERROR="The command failed to execute, likely because you are lacking the permission to give it.",commands=new Map,whisperCommands=new Map;let firstTimeHelp=null;function CommandsShowFirstTimeHelp(){!firstTimeHelp&&modStorage.chatShouldDisplayFirstTimeHelp&&(firstTimeHelp=ChatRoomSendLocal("[ BCX commands tutorial ]\nBCX also provides helpful chat commands.\nAll commands start with a dot ( . )\nThe commands also support auto-completion: While writing a command, press 'Tab' to try automatically completing the currently typed word.\nOther club members can also use commands of your BCX, without needing BCX themselves. They will get a list of all commands they have permission using by whispering '!help' ( ! instead of . ) to you.\nNote: Messages colored like this text can only be seen by you and no one else.\n\nTo complete this tutorial, use '.help' command by writing '.he' and pressing 'Tab' to complete it to '.help', it will show you list of available BCX commands."))}function CommandsCompleteFirstTimeHelp(){void 0!==modStorage.chatShouldDisplayFirstTimeHelp&&(delete modStorage.chatShouldDisplayFirstTimeHelp,modStorageSync()),firstTimeHelp&&(firstTimeHelp.remove(),firstTimeHelp=null)}function registerCommand(e,t,o,n=null){if(e=e.toLocaleLowerCase(),commands.has(e))throw new Error(`Command "${e}" already registered!`);commands.set(e,{parse:!1,callback:o,autocomplete:n,description:t})}function aliasCommand(e,t){e=e.toLocaleLowerCase(),t=t.toLocaleLowerCase();const o=commands.get(e);if(!o)throw new Error(`Command "${e}" to alias not found`);o.parse?commands.set(t,{parse:!0,description:null,callback:o.callback,autocomplete:o.autocomplete}):commands.set(t,{parse:!1,description:null,callback:o.callback,autocomplete:o.autocomplete})}function registerCommandParsed(e,t,o,n=null){if(e=e.toLocaleLowerCase(),commands.has(e))throw new Error(`Command "${e}" already registered!`);commands.set(e,{parse:!0,callback:o,autocomplete:n,description:t})}function registerWhisperCommand(e,t,o,n=null,r=!0){if(e=e.toLocaleLowerCase(),r&&registerCommandParsed(e,t,(e=>(o(e,getPlayerCharacter(),(e=>ChatRoomSendLocal(e))),!0)),n?e=>n(e,getPlayerCharacter()):null),whisperCommands.has(e))throw new Error(`Command "${e}" already registered!`);whisperCommands.set(e,{callback:o,autocomplete:n,description:t})}function CommandParse(e){e=e.trimStart();const t=/^(\S+)(?:\s|$)(.*)$/.exec(e);return t?[(t[1]||"").toLocaleLowerCase(),t[2]]:["",""]}function CommandParseArguments(e){return[...e.matchAll(/".*?(?:"|$)|'.*?(?:'|$)|[^ ]+/g)].map((e=>e[0])).map((e=>'"'===e[0]||"'"===e[0]?e.substring(1,e.length>1&&e[e.length-1]===e[0]?e.length-1:e.length):e))}function CommandHasEmptyArgument(e){const t=CommandParseArguments(e);return 0===t.length||!e.endsWith(t[t.length-1])}function CommandArgumentNeedsQuotes(e){return e.includes(" ")||e.includes('"')||e.startsWith("'")}function CommandQuoteArgument(e,t=!1){return e.startsWith('"')?`'${e}'`:e.startsWith("'")?`"${e}"`:e.includes(" ")||t?e.includes('"')?`'${e}'`:`"${e}"`:e}let autocompleteMessage=null,autocompleteLastQuery=null,autocompleteLastResult=[],autocompleteNextIndex=0;function autocompleteClear(){autocompleteMessage&&(autocompleteMessage.remove(),autocompleteMessage=null),autocompleteLastQuery=null}function autocompleteShow(e,t,o){if(autocompleteClear(),t.length>0){const n=document.createElement("div");n.innerText+=`[${e}]\n`;for(let e=0;e<t.length;e++){const r=document.createElement("div");r.innerText=t[e],e===o&&(r.style.background="#7e7eff54"),n.appendChild(r)}autocompleteMessage=ChatRoomSendLocal(n,1e4)}}function RunCommand(e){autocompleteClear();const[t,o]=CommandParse(e),n=commands.get(t);return n?n.parse?n.callback(CommandParseArguments(o)):n.callback(o):(ChatRoomSendLocal(`Unknown command "${t}"\nTo see list of valid commands use '.help'`,15e3),!1)}function RunWhisperCommand(e,t,o){const[n,r]=CommandParse(e),i=whisperCommands.get(n);if(i)return i.callback(CommandParseArguments(r),t,o);o(`Unknown command "${n}"\nTo see list of valid commands whisper '!help'`)}function CommandAutocomplete(e){e=e.trimStart();const[t,o]=CommandParse(e);if(e.length===t.length){const e=Array.from(commands.entries()).filter((e=>null!==e[1].description&&e[0].startsWith(t))).map((e=>e[0]+" "));return 0===e.length?[]:e.map((e=>[e,e]))}const n=commands.get(t);if(n&&n.autocomplete){if(n.parse){const e=CommandParseArguments(o);CommandHasEmptyArgument(o)&&e.push("");let r=n.autocomplete(e);const i=1===r.length;0===r.length&&(r=[e[e.length-1]]),e.pop();const a=r.some(CommandArgumentNeedsQuotes);return r.map((o=>[`${t} `+e.map((e=>CommandQuoteArgument(e))).concat(a?CommandQuoteArgument(o,!0):o).join(" ")+(i?" ":""),o]))}{const e=n.autocomplete(o);return 0===e.length?[]:e.map((e=>[`${t} ${e}`,e]))}}return[]}function CommandAutocompleteCycle(e){if(autocompleteLastQuery===e&&autocompleteNextIndex<autocompleteLastResult.length){autocompleteShow("autocomplete hint",autocompleteLastResult.map((e=>e[1])),autocompleteNextIndex);const e=autocompleteLastResult[autocompleteNextIndex][0].trim();return autocompleteNextIndex=(autocompleteNextIndex+1)%autocompleteLastResult.length,autocompleteLastQuery=e,e}if(autocompleteClear(),autocompleteLastResult=CommandAutocomplete(e).sort(((e,t)=>e[1].localeCompare(t[1]))),0===autocompleteLastResult.length)return e;if(1===autocompleteLastResult.length)return autocompleteLastResult[0][0];const t=longestCommonPrefix(autocompleteLastResult.map((e=>e[0])));return autocompleteShow("autocomplete hint",autocompleteLastResult.map((e=>e[1]))),autocompleteLastQuery=t,autocompleteNextIndex=0,t}function WhisperCommandAutocomplete(e,t){e=e.trimStart();const[o,n]=CommandParse(e);if(e.length===o.length){const t=Array.from(whisperCommands.entries()).filter((e=>null!==e[1].description&&e[0].startsWith(o))).map((e=>e[0]+" "));if(0===t.length)return[e,null];const n=longestCommonPrefix(t);return[n,n===e?t.slice().sort():null]}const r=whisperCommands.get(o);if(r&&r.autocomplete){const e=CommandParseArguments(n);CommandHasEmptyArgument(n)&&e.push("");const i=r.autocomplete(e,t);let a=null;if(i.length>0){const t=longestCommonPrefix(i);i.length>1&&t===e[e.length-1]&&(a=i.slice().sort()),e[e.length-1]=t}return[`${o} `+e.map((e=>CommandQuoteArgument(e))).join(" ")+(1===i.length?" ":""),a]}return[e,null]}function Command_fixExclamationMark(e,t){return e.isPlayer()?t.replace(/^!/gm,"."):t}function Command_pickAutocomplete(e,t){return e=e.toLocaleLowerCase(),t.filter((t=>t.toLocaleLowerCase().startsWith(e)))}function Command_selectCharacter(e){const t=getAllCharactersInRoom();if(/^[0-9]+$/.test(e)){const o=Number.parseInt(e,10),n=t.find((e=>e.MemberNumber===o));return n||`Player #${o} not found in the room.`}let o=t.filter((t=>t.Name===e));return 0===o.length&&(o=t.filter((t=>t.Name.toLocaleLowerCase()===e.toLocaleLowerCase()))),1===o.length?o[0]:0===o.length?`Player "${e}" not found in the room.`:`Multiple players match "${e}". Please use Member Number instead.`}function Command_selectCharacterMemberNumber(e,t=!0){const o=Command_selectCharacter(e);return"string"==typeof o&&t&&/^[0-9]+$/.test(e)?Number.parseInt(e,10):"string"==typeof o?o:o.MemberNumber}function Command_selectCharacterAutocomplete(e){const t=getAllCharactersInRoom();return/^[0-9]+$/.test(e)?t.map((e=>{var t;return null===(t=e.MemberNumber)||void 0===t?void 0:t.toString(10)})).filter((t=>null!=t&&t.startsWith(e))):t.map((e=>e.Name)).filter((t=>t.toLocaleLowerCase().startsWith(e.toLocaleLowerCase())))}function Command_selectWornItem(e,t,o=isBind){const n=e.Character.Appearance.filter(o);let r=n.filter((e=>e.Asset.Group.Name.toLocaleLowerCase()===t.toLocaleLowerCase()));return 0===r.length&&(r=n.filter((e=>getVisibleGroupName(e.Asset.Group).toLocaleLowerCase()===t.toLocaleLowerCase()))),0===r.length&&(r=n.filter((e=>e.Asset.Name.toLocaleLowerCase()===t.toLocaleLowerCase()))),0===r.length&&(r=n.filter((e=>e.Asset.Description.toLocaleLowerCase()===t.toLocaleLowerCase()))),1===r.length?r[0]:0===r.length?`Item "${t}" not found on character ${e}. If your item(group) consists of more than one word, please put it in quotes, such as "lower leg".`:"Multiple items match, please use group name instead. (eg. arms)"}function Command_selectWornItemAutocomplete(e,t,o=isBind){const n=e.Character.Appearance.filter(o);let r=arrayUnique(n.map((e=>getVisibleGroupName(e.Asset.Group))).concat(n.map((e=>e.Asset.Description)))).filter((e=>e.toLocaleLowerCase().startsWith(t.toLocaleLowerCase())));return 0===r.length&&(r=arrayUnique(n.map((e=>e.Asset.Group.Name)).concat(n.map((e=>e.Asset.Name)))).filter((e=>e.toLocaleLowerCase().startsWith(t.toLocaleLowerCase())))),r}function Command_selectGroup(e,t,o){let n=AssetGroup.filter((t=>t.Name.toLocaleLowerCase()===e.toLocaleLowerCase()&&(!o||o(t))));if(0===n.length&&(n=AssetGroup.filter((t=>getVisibleGroupName(t).toLocaleLowerCase()===e.toLocaleLowerCase()&&(!o||o(t))))),n.length>1)return`Multiple groups match "${e}", please report this as a bug.`;if(1===n.length)return n[0];if(t){const n=Command_selectWornItem(t,e,(e=>!o||o(e.Asset.Group)));return"string"==typeof n?n:n.Asset.Group}return`Unknown group "${e}".`}function Command_selectGroupAutocomplete(e,t,o){const n=t?t.Character.Appearance:[];let r=arrayUnique(AssetGroup.filter((e=>!o||o(e))).map((e=>getVisibleGroupName(e))).concat(n.filter((e=>!o||o(e.Asset.Group))).map((e=>e.Asset.Description)))).filter((t=>t.toLocaleLowerCase().startsWith(e.toLocaleLowerCase())));return 0===r.length&&(r=arrayUnique(AssetGroup.filter((e=>!o||o(e))).map((e=>e.Name)).concat(n.filter((e=>!o||o(e.Asset.Group))).map((e=>e.Asset.Name)))).filter((t=>t.toLocaleLowerCase().startsWith(e.toLocaleLowerCase())))),r}function Command_parseTime(e){const t=/^([0-9]+)([a-z]+)$/.exec(e.toLocaleLowerCase());if(!t)return`Unknown time format "${e}", please use format 'number+unit' (e.g. 23h 30m)`;const o=Number.parseInt(t[1],10),n=t[2];return["d","day","days"].includes(n)?24*o*60*60*1e3:["h","hour","hours"].includes(n)?60*o*60*1e3:["m","min","minute","minutes"].includes(n)?60*o*1e3:["s","sec","second","seconds"].includes(n)?1e3*o:`Unknown time unit "${n}", please use one of:\nd (day), h (hour), m (minute), s (second)`}class ModuleCommands extends BaseModule{load(){hookFunction("ChatRoomFirstTimeHelp",0,((e,t)=>{t(e),CommandsShowFirstTimeHelp()})),hookFunction("ChatRoomClearAllElements",1,((e,t)=>(firstTimeHelp=null,t(e)))),hookFunction("ChatRoomSendChat",10,((e,t)=>{const o=document.getElementById("InputChat");if(o&&!firstTimeInit){const e=o.value.trim();if(e.startsWith(".."))o.value=e.substr(1);else if(e.startsWith("."))return void(RunCommand(e.substr(1))&&(ChatRoomLastMessage.push(e),ChatRoomLastMessageIndex=ChatRoomLastMessage.length,o.value=""))}return t(e)})),hookFunction("ChatRoomKeyDown",10,((e,t)=>{var o,n;const r=document.getElementById("InputChat");if(9===KeyPress&&r&&r.value.startsWith(".")&&!r.value.startsWith("..")&&!firstTimeInit){const t=null!==(o=e[0])&&void 0!==o?o:event;null==t||t.preventDefault(),null==t||t.stopImmediatePropagation(),r.value="."+CommandAutocompleteCycle(r.value.substr(1))}else{if(9!==KeyPress||null==ChatRoomTargetMemberNumber||!r||!r.value.startsWith("!")||r.value.startsWith("!!")||firstTimeInit)return t(e);{const t=r.value,o=ChatRoomTargetMemberNumber,i=null!==(n=e[0])&&void 0!==n?n:event;null==i||i.preventDefault(),null==i||i.stopImmediatePropagation(),sendQuery("commandHint",t,o).then((e=>{if(r.value===t&&ChatRoomTargetMemberNumber===o){if(!Array.isArray(e)||2!==e.length||"string"!=typeof e[0]||null!==e[1]&&(!Array.isArray(e[1])||e[1].some((e=>"string"!=typeof e))))throw console.error("BCX: Bad data during 'commandHint' query\n",e),new Error("Bad data");r.value=e[0],e[1]&&ChatRoomSendLocal("[remote autocomplete hint]\n"+e[1].join("\n"),1e4,o)}}),(()=>{}))}}})),hookFunction("ChatRoomMessage",9,((e,t)=>{const o=e[0],n="number"==typeof o.Sender&&getChatroomCharacter(o.Sender);return"Whisper"===(null==o?void 0:o.Type)&&"string"==typeof o.Content&&o.Content.startsWith("!")&&!o.Content.startsWith("!!")&&n&&n.hasAccessToPlayer()?o.Sender===Player.MemberNumber||firstTimeInit?t(e):(console.debug(`BCX: Console command from ${n}: ${o.Content}`),void RunWhisperCommand(o.Content.substr(1),n,(e=>{ServerSend("ChatRoomChat",{Content:`[BCX]\n${e}`,Type:"Whisper",Target:n.MemberNumber})}))):t(e)})),queryHandlers.commandHint=(e,t,o)=>{if("string"!=typeof o||!o.startsWith("!")||o.startsWith("!!"))return t(!1);const n=WhisperCommandAutocomplete(o.substr(1),e);n[0]="!"+n[0],t(!0,n)},registerCommand("help","- Display this help [alias: . ]",(()=>(CommandsCompleteFirstTimeHelp(),ChatRoomSendLocal("Available commands:\n"+Array.from(commands.entries()).filter((e=>null!==e[1].description)).map((e=>`.${e[0]}`+(e[1].description?` ${e[1].description}`:""))).sort().join("\n")),!0))),aliasCommand("help",""),registerCommand("action","- Send custom (action) [alias: .a ]",(e=>(ChatRoomActionMessage(e),!0))),aliasCommand("action","a"),registerWhisperCommand("help","- Display this help",((e,t,o)=>(o("Available commands:\n"+Array.from(whisperCommands.entries()).filter((e=>null!==e[1].description)).map((e=>`!${e[0]}`+(e[1].description?` ${e[1].description}`:""))).sort().join("\n")),!0)),null,!1)}unload(){commands.clear()}}var HASH_UNDEFINED="__lodash_hash_undefined__";function setCacheAdd(e){return this.__data__.set(e,HASH_UNDEFINED),this}function setCacheHas(e){return this.__data__.has(e)}function SetCache(e){var t=-1,o=null==e?0:e.length;for(this.__data__=new MapCache;++t<o;)this.add(e[t])}function arraySome(e,t){for(var o=-1,n=null==e?0:e.length;++o<n;)if(t(e[o],o,e))return!0;return!1}function cacheHas(e,t){return e.has(t)}SetCache.prototype.add=SetCache.prototype.push=setCacheAdd,SetCache.prototype.has=setCacheHas;var COMPARE_PARTIAL_FLAG$5=1,COMPARE_UNORDERED_FLAG$3=2;function equalArrays(e,t,o,n,r,i){var a=o&COMPARE_PARTIAL_FLAG$5,s=e.length,l=t.length;if(s!=l&&!(a&&l>s))return!1;var c=i.get(e),u=i.get(t);if(c&&u)return c==t&&u==e;var d=-1,m=!0,h=o&COMPARE_UNORDERED_FLAG$3?new SetCache:void 0;for(i.set(e,t),i.set(t,e);++d<s;){var g=e[d],f=t[d];if(n)var p=a?n(f,g,d,t,e,i):n(g,f,d,e,t,i);if(void 0!==p){if(p)continue;m=!1;break}if(h){if(!arraySome(t,(function(e,t){if(!cacheHas(h,t)&&(g===e||r(g,e,o,n,i)))return h.push(t)}))){m=!1;break}}else if(g!==f&&!r(g,f,o,n,i)){m=!1;break}}return i.delete(e),i.delete(t),m}function mapToArray(e){var t=-1,o=Array(e.size);return e.forEach((function(e,n){o[++t]=[n,e]})),o}function setToArray(e){var t=-1,o=Array(e.size);return e.forEach((function(e){o[++t]=e})),o}var COMPARE_PARTIAL_FLAG$4=1,COMPARE_UNORDERED_FLAG$2=2,boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",mapTag="[object Map]",numberTag="[object Number]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag$1="[object Symbol]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",symbolProto$1=Symbol?Symbol.prototype:void 0,symbolValueOf=symbolProto$1?symbolProto$1.valueOf:void 0;function equalByTag(e,t,o,n,r,i,a){switch(o){case dataViewTag:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case arrayBufferTag:return!(e.byteLength!=t.byteLength||!i(new Uint8Array$1(e),new Uint8Array$1(t)));case boolTag:case dateTag:case numberTag:return eq(+e,+t);case errorTag:return e.name==t.name&&e.message==t.message;case regexpTag:case stringTag:return e==t+"";case mapTag:var s=mapToArray;case setTag:var l=n&COMPARE_PARTIAL_FLAG$4;if(s||(s=setToArray),e.size!=t.size&&!l)return!1;var c=a.get(e);if(c)return c==t;n|=COMPARE_UNORDERED_FLAG$2,a.set(e,t);var u=equalArrays(s(e),s(t),n,r,i,a);return a.delete(e),u;case symbolTag$1:if(symbolValueOf)return symbolValueOf.call(e)==symbolValueOf.call(t)}return!1}var COMPARE_PARTIAL_FLAG$3=1,objectProto$1=Object.prototype,hasOwnProperty$1=objectProto$1.hasOwnProperty;function equalObjects(e,t,o,n,r,i){var a=o&COMPARE_PARTIAL_FLAG$3,s=getAllKeys(e),l=s.length;if(l!=getAllKeys(t).length&&!a)return!1;for(var c=l;c--;){var u=s[c];if(!(a?u in t:hasOwnProperty$1.call(t,u)))return!1}var d=i.get(e),m=i.get(t);if(d&&m)return d==t&&m==e;var h=!0;i.set(e,t),i.set(t,e);for(var g=a;++c<l;){var f=e[u=s[c]],p=t[u];if(n)var C=a?n(p,f,u,t,e,i):n(f,p,u,e,t,i);if(!(void 0===C?f===p||r(f,p,o,n,i):C)){h=!1;break}g||(g="constructor"==u)}if(h&&!g){var y=e.constructor,v=t.constructor;y==v||!("constructor"in e)||!("constructor"in t)||"function"==typeof y&&y instanceof y&&"function"==typeof v&&v instanceof v||(h=!1)}return i.delete(e),i.delete(t),h}var COMPARE_PARTIAL_FLAG$2=1,argsTag="[object Arguments]",arrayTag="[object Array]",objectTag="[object Object]",objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;function baseIsEqualDeep(e,t,o,n,r,i){var a=isArray(e),s=isArray(t),l=a?arrayTag:getTag$1(e),c=s?arrayTag:getTag$1(t),u=(l=l==argsTag?objectTag:l)==objectTag,d=(c=c==argsTag?objectTag:c)==objectTag,m=l==c;if(m&&isBuffer(e)){if(!isBuffer(t))return!1;a=!0,u=!1}if(m&&!u)return i||(i=new Stack),a||isTypedArray(e)?equalArrays(e,t,o,n,r,i):equalByTag(e,t,l,o,n,r,i);if(!(o&COMPARE_PARTIAL_FLAG$2)){var h=u&&hasOwnProperty.call(e,"__wrapped__"),g=d&&hasOwnProperty.call(t,"__wrapped__");if(h||g){var f=h?e.value():e,p=g?t.value():t;return i||(i=new Stack),r(f,p,o,n,i)}}return!!m&&(i||(i=new Stack),equalObjects(e,t,o,n,r,i))}function baseIsEqual(e,t,o,n,r){return e===t||(null==e||null==t||!isObjectLike(e)&&!isObjectLike(t)?e!=e&&t!=t:baseIsEqualDeep(e,t,o,n,baseIsEqual,r))}function isEqual(e,t){return baseIsEqual(e,t)}function initRules_bc_alter(){registerRule("alt_restrict_hearing",{name:"Sensory deprivation: Sound",icon:"Icons/Swap.png",loggable:!1,shortDescription:"impacts PLAYER_NAME's hearing; adjustable",longDescription:"This rule impacts PLAYER_NAME's natural ability to hear in the same way items do, independent of them (strength of deafening can be adjusted).",defaultLimit:ConditionsLimit.normal,dataDefinition:{deafeningStrength:{type:"listSelect",options:[["light","Light"],["medium","Medium"],["heavy","Heavy"]],default:"light",description:"Hearing impairment:"}},load(e){const t={light:1,medium:2,heavy:4};hookFunction("Player.GetDeafLevel",1,((o,n)=>{var r;let i=n(o);return e.isEnforced&&e.customData&&(i+=null!==(r=t[e.customData.deafeningStrength])&&void 0!==r?r:0),i}),ModuleCategory.Rules)}}),registerRule("alt_hearing_whitelist",{name:"Hearing whitelist",icon:"Icons/Swap.png",loggable:!1,shortDescription:"of members whom PLAYER_NAME can always understand",longDescription:"This rule defines a list of members whose voice can always be understood by PLAYER_NAME - independent of any sensory deprivation items or hearing impairing BCX rules on PLAYER_NAME. There is an additional option to toggle whether PLAYER_NAME can still understand a white-listed member's voice if that member is speech impaired herself (e.g. by being gagged).",defaultLimit:ConditionsLimit.normal,dataDefinition:{whitelistedMembers:{type:"memberNumberList",default:[],description:"Members numbers still heard while hearing impaired:",Y:350},ignoreGaggedMembersToggle:{type:"toggle",default:!1,description:"Also understand if those are speech impaired",Y:750}},load(e){hookFunction("SpeechGarble",2,((t,o)=>{const n=t[0];return e.isEnforced&&e.customData&&null!=n.MemberNumber&&e.customData.whitelistedMembers.filter((e=>e!==Player.MemberNumber)).includes(n.MemberNumber)&&(n.CanTalk()||e.customData.ignoreGaggedMembersToggle)?t[1]:o(t)}),ModuleCategory.Rules)}}),registerRule("alt_restrict_sight",{name:"Sensory deprivation: Sight",icon:"Icons/Swap.png",loggable:!1,shortDescription:"impacts PLAYER_NAME's sight; adjustable",longDescription:"This rule impacts PLAYER_NAME's natural ability to see in the same way items do, independent of them (strength of blindness can be adjusted).",defaultLimit:ConditionsLimit.normal,dataDefinition:{blindnessStrength:{type:"listSelect",options:[["light","Light"],["medium","Medium"],["heavy","Heavy"]],default:"light",description:"Eyesight impairment:"}},load(e){const t={light:1,medium:2,heavy:3};hookFunction("Player.GetBlindLevel",1,((o,n)=>{var r,i;let a=n(o);return e.isEnforced&&e.customData&&(a+=null!==(r=t[e.customData.blindnessStrength])&&void 0!==r?r:0),Math.min(a,"SensDepLight"===(null===(i=Player.GameplaySettings)||void 0===i?void 0:i.SensDepChatLog)?2:3)}),ModuleCategory.Rules)}}),registerRule("alt_seeing_whitelist",{name:"Seeing whitelist",icon:"Icons/Swap.png",loggable:!1,shortDescription:"of members whom PLAYER_NAME can always see",longDescription:"This rule defines a list of members whose appearance can always be seen normally by PLAYER_NAME - independent of any blinding items or seeing impairing BCX rules on PLAYER_NAME.",defaultLimit:ConditionsLimit.normal,dataDefinition:{whitelistedMembers:{type:"memberNumberList",default:[],description:"Members still seen while under blindness:"}},load(e){let t=!1;hookFunction("DrawCharacter",0,((o,n)=>{const r=o[0];e.isEnforced&&e.customData&&null!=r.MemberNumber&&e.customData.whitelistedMembers.includes(r.MemberNumber)&&(t=!0),n(o),t=!1}),ModuleCategory.Rules),hookFunction("DialogMenuButtonBuild",0,((o,n)=>{const r=o[0];e.isEnforced&&e.customData&&null!=r.MemberNumber&&e.customData.whitelistedMembers.includes(r.MemberNumber)&&(t=!0),n(o),t=!1}),ModuleCategory.Rules),hookFunction("ChatRoomClickCharacter",0,((o,n)=>{const r=o[0];e.isEnforced&&e.customData&&null!=r.MemberNumber&&e.customData.whitelistedMembers.includes(r.MemberNumber)&&(t=!0),n(o),t=!1}),ModuleCategory.Rules),hookFunction("ChatRoomMessage",0,((o,n)=>{var r;let i=null;"number"==typeof(null===(r=o[0])||void 0===r?void 0:r.Sender)&&(i=getChatroomCharacter(o[0].Sender)),i&&e.isEnforced&&e.customData&&null!=i.MemberNumber&&e.customData.whitelistedMembers.includes(i.MemberNumber)&&(t=!0),n(o),t=!1}),ModuleCategory.Rules),hookFunction("Player.GetBlindLevel",6,((e,o)=>t?0:o(e)),ModuleCategory.Rules),hookFunction("ChatRoomUpdateDisplay",0,((t,o)=>{if(o(t),e.isEnforced&&e.customData){1===ChatRoomCharacterCount&&(ChatRoomCharacterDrawlist=[Player]),ChatRoomSenseDepBypass=!0;for(const t of ChatRoomCharacter)null!=t.MemberNumber&&!ChatRoomCharacterDrawlist.includes(t)&&e.customData.whitelistedMembers.includes(t.MemberNumber)&&ChatRoomCharacterDrawlist.push(t);ChatRoomCharacterDrawlist.sort(((e,t)=>ChatRoomCharacter.indexOf(e)-ChatRoomCharacter.indexOf(t))),ChatRoomCharacterCount=ChatRoomCharacterDrawlist.length}}))}}),registerRule("alt_eyes_fullblind",{name:"Fully blind when eyes are closed",icon:"Icons/Swap.png",loggable:!1,longDescription:"This rule enforces full blindness when the eyes are closed. (Light sensory deprivation setting is still respected and doesn't blind fully)",defaultLimit:ConditionsLimit.normal,tick:e=>(e.isEnforced&&(DialogFacialExpressionsSelectedBlindnessLevel=3),!1),load(e){hookFunction("DialogClickExpressionMenu",5,((t,o)=>{if(!e.isEnforced||!MouseIn(220,50,90,90))return o(t)}))}}),registerRule("alt_blindfolds_fullblind",{name:"Fully blind when blindfolded",icon:"Icons/Swap.png",loggable:!1,longDescription:"This rule enforces full blindness when wearing any item that limits sight in any way. (This rules does NOT respect Light sensory deprivation setting and always forces player to be fully blind)",defaultLimit:ConditionsLimit.normal,load(e){hookFunction("Player.GetBlindLevel",2,((t,o)=>e.isEnforced&&["BlindHeavy","BlindNormal","BlindLight"].some((e=>Player.Effect.includes(e)))?3:o(t)),ModuleCategory.Rules)}}),registerRule("alt_always_slow",{name:"Always leave rooms slowly",icon:"Icons/Swap.png",loggable:!1,longDescription:"This rule forces PLAYER_NAME to always leave the room slowly, independent of the items she is wearing. WARNING: Due to limitation in Bondage Club itself, only BCX users will be able to stop PLAYER_NAME from leaving the room.",defaultLimit:ConditionsLimit.normal,init(e){registerEffectBuilder((t=>{e.isEnforced&&!t.Effect.includes("Slow")&&t.Effect.push("Slow")}))}}),registerRule("alt_control_orgasms",{name:"Control ability to orgasm",icon:"Icons/Swap.png",loggable:!1,shortDescription:"adjustable: only-edge, only-ruin, no-resist",longDescription:"This rule impacts PLAYER_NAME's ability to control their orgasms, independent of items. There are three control options, which are: Never cum (always edge, the bar never reaches 100%), force into ruined orgasm (orgasm screen starts, but doesn't let her actually cum) and prevent resisting orgasm (able to enter orgasm screen, but unable to resist it).",defaultLimit:ConditionsLimit.limited,dataDefinition:{orgasmHandling:{type:"listSelect",default:"edge",options:[["edge","Edge"],["ruined","Ruin"],["noResist","Prevent resisting"]],description:"Orgasm attempts will be fixed to:"}},load(e){hookFunction("ServerSend",0,((t,o)=>{"ChatRoomChat"===t[0]&&isObject$1(t[1])&&"string"==typeof t[1].Content&&"Activity"===t[1].Type&&e.isEnforced&&(t[1].Content.startsWith("OrgasmFailPassive")?t[1].Content="OrgasmFailPassive0":t[1].Content.startsWith("OrgasmFailTimeout")?t[1].Content="OrgasmFailTimeout2":t[1].Content.startsWith("OrgasmFailResist")?t[1].Content="OrgasmFailResist2":t[1].Content.startsWith("OrgasmFailSurrender")&&(t[1].Content="OrgasmFailSurrender2")),o(t)})),hookFunction("ActivityOrgasmPrepare",5,((t,o)=>{const n=t[0];if(e.isEnforced&&e.customData&&0===n.ID){if("edge"===e.customData.orgasmHandling)return void(n.ArousalSettings&&(n.ArousalSettings.Progress=95));if("ruined"===e.customData.orgasmHandling){const e=Player.Effect;return Player.Effect=e.concat("DenialMode","RuinOrgasms"),o(t),void(Player.Effect=e)}"noResist"===e.customData.orgasmHandling&&(ActivityOrgasmGameResistCount=496.5)}return o(t)}),ModuleCategory.Rules)}}),registerRule("alt_secret_orgasms",{name:"Secret orgasm progress",icon:"Icons/Swap.png",loggable:!1,shortDescription:"unable to see the own arousal meter",longDescription:"This rule prevents PLAYER_NAME from seeing their own arousal meter, even while it is active and working. This means, that it is a surprise to them, when the orgasm (quick-time event) happens. Does not effect other characters being able to see the meter, if club settings allow that.",defaultLimit:ConditionsLimit.limited,load(e){hookFunction("DrawArousalMeter",5,((t,o)=>{if(0!==t[0].ID||!e.isEnforced)return o(t)})),hookFunction("ChatRoomClickCharacter",5,((t,o)=>{const n=t[0],r=t[1],i=t[2],a=t[3];if((0!==n.ID||!e.isEnforced||!MouseIn(r+60*a,i+400*a,80*a,100*a)||n.ArousalZoom)&&!(0===n.ID&&e.isEnforced&&MouseIn(r+50*a,i+200*a,100*a,500*a)&&n.ArousalZoom))return o(t)}))}}),registerRule("alt_room_admin_transfer",{name:"Room admin transfer",icon:"Icons/Swap.png",loggable:!1,shortDescription:"give admin to defined roles",longDescription:"This rule lets you define a minimum role which PLAYER_NAME will automatically give room admin rights to (if she has admin rights in the room). Also has the option to remove admin rights from PLAYER_NAME afterwards.",defaultLimit:ConditionsLimit.blocked,dataDefinition:{minimumRole:{type:"roleSelector",default:AccessLevel.owner,description:"Minimum role that gets admin:",Y:320},removeAdminToggle:{type:"toggle",default:!1,description:"Player loses admin afterwards",Y:470}},tick(e){var t;let o=!1;if(e.isEnforced&&e.customData&&ChatRoomPlayerIsAdmin()&&ServerPlayerIsInChatRoom()){let n=!1;for(const r of getAllCharactersInRoom())!r.isPlayer()&&getCharacterAccessLevel(r)<=e.customData.minimumRole&&((null===(t=null===ChatRoomData||void 0===ChatRoomData?void 0:ChatRoomData.Admin)||void 0===t?void 0:t.includes(r.MemberNumber))?n=!0:(ServerSend("ChatRoomAdmin",{MemberNumber:r.MemberNumber,Action:"Promote"}),o=!0));if(!o&&n&&ChatRoomData&&e.customData.removeAdminToggle){const e={Name:ChatRoomData.Name,Description:ChatRoomData.Description,Background:ChatRoomData.Background,Limit:ChatRoomData.Limit.toString(),Admin:ChatRoomData.Admin.filter((e=>e!==Player.MemberNumber)),Ban:ChatRoomData.Ban,BlockCategory:ChatRoomData.BlockCategory.slice(),Game:ChatRoomGame,Private:ChatRoomData.Private,Locked:ChatRoomData.Locked};ServerSend("ChatRoomAdmin",{MemberNumber:Player.ID,Room:e,Action:"Update"}),o=!0}}return o}}),registerRule("alt_room_admin_limit",{name:"Limit bound admin power",icon:"Icons/Swap.png",loggable:!1,shortDescription:"restrict room admin powers while restrained",longDescription:"This rule forbids PLAYER_NAME to do any room admin actions (except for kick/ban), when she is tied (meaning either being unable to use her hands or unable to leave the room). Tip: This rule can be combined with the rule to enforce joining the last room to trap her in it.",defaultLimit:ConditionsLimit.limited,load(e){hookFunction("ChatAdminLoad",0,((t,o)=>{var n,r,i,a;o(t),e.isEnforced&&ChatRoomPlayerIsAdmin()&&Player.IsRestrained()&&(null===(n=document.getElementById("InputName"))||void 0===n||n.setAttribute("disabled","disabled"),null===(r=document.getElementById("InputDescription"))||void 0===r||r.setAttribute("disabled","disabled"),null===(i=document.getElementById("InputSize"))||void 0===i||i.setAttribute("disabled","disabled"),null===(a=document.getElementById("InputAdminList"))||void 0===a||a.setAttribute("disabled","disabled"))})),hookFunction("ChatAdminRun",0,((t,o)=>{o(t),e.isEnforced&&ChatRoomPlayerIsAdmin()&&Player.IsRestrained()&&(DrawButton(100,770,250,65,TextGet("AddOwnerAdminList"),"#ebebe4","","",!0),DrawButton(365,770,250,65,TextGet("AddLoverAdminList"),"#ebebe4","","",!0),DrawBackNextButton(1300,450,500,60,DialogFindPlayer(ChatAdminBackgroundSelect),"#ebebe4","",(()=>DialogFindPlayer(0===ChatAdminBackgroundIndex?ChatCreateBackgroundList[ChatCreateBackgroundList.length-1]:ChatCreateBackgroundList[ChatAdminBackgroundIndex-1])),(()=>DialogFindPlayer(ChatAdminBackgroundIndex>=ChatCreateBackgroundList.length-1?ChatCreateBackgroundList[0]:ChatCreateBackgroundList[ChatAdminBackgroundIndex+1])),!0),DrawButton(1840,450,60,60,"","#ebebe4","Icons/Small/Preference.png","",!0),DrawBackNextButton(1625,575,275,60,TextGet("Game"+ChatAdminGame),"#ebebe4","",(()=>""),(()=>""),!0),DrawButton(1486,708,64,64,"","#ebebe4",ChatAdminPrivate?"Icons/Checked.png":"","",!0),DrawButton(1786,708,64,64,"","#ebebe4",ChatAdminLocked?"Icons/Checked.png":"","",!0),MainCanvas.fillStyle="#ffff88",MainCanvas.fillRect(100,850,1125,70),MainCanvas.strokeStyle="Black",MainCanvas.strokeRect(100,850,1125,70),DrawText("Some settings are not available due to a BCX rule.",650,885,"Black","Gray"))})),hookFunction("ChatAdminClick",5,((t,o)=>{if(!(e.isEnforced&&ChatRoomPlayerIsAdmin()&&Player.IsRestrained()&&(MouseIn(1300,75,600,350)||MouseIn(1840,450,60,60)||MouseIn(1300,450,500,60)||MouseIn(1625,575,275,60)||MouseIn(1486,708,64,64)||MouseIn(1786,708,64,64)||MouseIn(100,770,250,65)||MouseIn(365,770,250,65))))return o(t)})),hookFunction("CommonSetScreen",5,((t,o)=>(e.isEnforced&&"Online"===t[0]&&"ChatBlockItem"===t[1]&&ChatRoomPlayerIsAdmin()&&Player.IsRestrained()&&(ChatBlockItemEditable=!1),o(t)))),hookFunction("ChatRoomAdminAction",5,((t,o)=>{const n=t[1];return e.isEnforced&&Player.IsRestrained()&&"Kick"!==n&&"Ban"!==n?(InfoBeep("BCX: You are not allowed to use this while restrained.",7e3),void DialogLeave()):o(t)}))}}),registerRule("alt_set_profile_description",{name:"Control profile online description",icon:"Icons/Swap.png",loggable:!1,shortDescription:"directly sets PLAYER_NAME's description",longDescription:"This rule sets PLAYER_NAME's online description (in her profile) to any text entered in the rule config, blocking changes to it.",defaultLimit:ConditionsLimit.blocked,dataDefinition:{playersProfileDescription:{type:"textArea",default:()=>Player.Description||"",description:"Edit this player's profile description:"}},tick(e){if(e.isEnforced&&e.customData&&Player.Description!==e.customData.playersProfileDescription){let t=Player.Description=e.customData.playersProfileDescription;const o=""+LZString.compressToUTF16(t);return(o.length<t.length||t.startsWith(""))&&(t=o),ServerAccountUpdate.QueueData({Description:t}),e.trigger(),!0}return!1}}),registerRule("alt_force_suitcase_game",{name:"Always carry a suitcase",icon:"Icons/Swap.png",loggable:!1,shortDescription:"from the kidnappers league multiplayer game",longDescription:"This rule forces PLAYER_NAME to constantly participate in the kidnappers league's suitcase delivery task, by automatically giving her a new suitcase, whenever the suitcase item slot is empty.",defaultLimit:ConditionsLimit.normal,tick(e){const t=InventoryGet(Player,"ItemMisc");return!(!(e.isEnforced&&ReputationGet("Kidnap")>0&&Player.CanTalk())||t)&&(KidnapLeagueOnlineBountyStart(),!0)}}),registerRule("alt_restrict_leashability",{name:"Restrict being leashed by others",icon:"Icons/Swap.png",loggable:!1,longDescription:"This rule only allows selected roles to leash PLAYER_NAME, responding with a message about unsuccessful leashing to others when they attempt to do so.",defaultLimit:ConditionsLimit.limited,dataDefinition:{minimumRole:{type:"roleSelector",default:AccessLevel.owner,description:"Minimum role that is allowed to leash:",Y:320}},load(e){hookFunction("ChatRoomCanBeLeashedBy",4,((t,o)=>{const n=t[0];return 0!==n&&n!==Player.MemberNumber&&e.isEnforced&&e.customData&&getCharacterAccessLevel(n)>e.customData.minimumRole?(ChatRoomActionMessage(`${Player.Name}'s leash seems to be cursed and slips out of ${getCharacterName(n,"[unknown]")}'s hand.`),!1):o(t)}))}}),registerRule("alt_hide_friends",{name:"Hide online friends if blind",icon:"Icons/Swap.png",loggable:!1,shortDescription:"also preventing beeps from the friendlist - exceptions settable",longDescription:"This rule hides persons on PLAYER_NAME's friend list when she is fully blinded, which also makes sending beeps impossible. Received beeps can still be answered. The rule allows to manage a list of members who can be seen normally.",defaultLimit:ConditionsLimit.blocked,dataDefinition:{allowedMembers:{type:"memberNumberList",default:[],description:"Members numbers that can always be seen:"}},load(e){patchFunction("FriendListLoadFriendList",{"data.forEach(friend => {":'data.forEach(friend => { if (typeof friend.MemberNumber !== "number") return;'}),patchFunction("FriendListLoadFriendList",{"FriendListContent += `<div class='FriendListLinkColumn' onClick='FriendListBeep(${friend.MemberNumber})'> ${BeepCaption} </div>`;":"if (typeof friend.MemberNumber === 'number') FriendListContent += `<div class='FriendListLinkColumn' onClick='FriendListBeep(${friend.MemberNumber})'> ${BeepCaption} </div>`;"}),hookFunction("FriendListLoadFriendList",1,((t,o)=>{var n;const r=t[0],i=null===(n=e.customData)||void 0===n?void 0:n.allowedMembers;return e.isEnforced&&i&&Player.GetBlindLevel()>=3&&r.forEach((e=>{i.includes(e.MemberNumber)||(e.MemberName="Someone",e.MemberNumber="######")})),o(t)}))}}),registerRule("alt_forced_summoning",{name:"Ready to be summoned",icon:"Icons/Swap.png",loggable:!1,shortDescription:"leash PLAYER_NAME from anywhere using a beep with message",longDescription:"This rule forces PLAYER_NAME to switch rooms from anywhere in the club to the chat room of the summoner after 15 seconds. It works by sending a beep message with the set text or simply the word 'summon' to PLAYER_NAME. Members who are allowed to summon PLAYER_NAME can be set. NOTES: PLAYER_NAME can always be summoned no matter if she has a leash or is prevented from leaving the room (ignoring restraints or locked rooms). However, if the target room is full or locked, she will end up in the lobby. Summoning will not work if the room name is not included with the beep message!",triggerTexts:{infoBeep:"You are summoned by SUMMONER!"},defaultLimit:ConditionsLimit.blocked,dataDefinition:{allowedMembers:{type:"memberNumberList",default:[],description:"Members numbers allowed to summon:",Y:300},summoningText:{type:"string",default:"Come to my room immediately",description:"The text used for summoning:",Y:715}},load(e){let t=!1;hookFunction("ServerAccountBeep",7,((o,n)=>{const r=o[0];isObject$1(r)&&!r.BeepType&&"number"==typeof r.MemberNumber&&e.isEnforced&&e.customData&&e.customData.allowedMembers.includes(r.MemberNumber)&&"string"==typeof r.Message&&(r.Message.toLocaleLowerCase().startsWith(e.customData.summoningText.toLocaleLowerCase())||"summon"===r.Message.toLocaleLowerCase())&&r.ChatRoomName&&(ChatRoomActionMessage(`${Player.Name} received a summon: "${e.customData.summoningText}".`),t=!0,BCX_setTimeout((()=>{e.isEnforced&&(ChatRoomActionMessage(`The demand for ${Player.Name}'s presence is now enforced.`),DialogLentLockpicks=!1,ChatRoomClearAllElements(),ServerSend("ChatRoomLeave",""),ChatRoomSetLastChatRoom(""),ChatRoomLeashPlayer=null,CommonSetScreen("Online","ChatSearch"),CharacterDeleteAllOnline(),ChatRoomPlayerCanJoin=!0,ServerSend("ChatRoomJoin",{Name:r.ChatRoomName}))}),15e3)),n(o),t&&e.triggerAttempt({SUMMONER:`${r.MemberName} (${r.MemberNumber})`}),t=!1}),ModuleCategory.Rules)}})}const cheatChangeHooks={};function cheatIsEnabled(e){return Array.isArray(modStorage.cheats)&&modStorage.cheats.includes(e)}function cheatSetEnabled(e,t){Array.isArray(modStorage.cheats)?(t?modStorage.cheats.includes(e)||modStorage.cheats.push(e):modStorage.cheats=modStorage.cheats.filter((t=>t!==e)),cheatChangeHooks[e]&&cheatChangeHooks[e](t),modStorageSync()):console.error("BCX: Attempt to set cheat, while not initalized")}function cheatToggle(e){cheatSetEnabled(e,!cheatIsEnabled(e))}const MISTRESS_CHEAT_ONLY_ITEMS=["MistressPadlock","MistressPadlockKey","MistressTimerPadlock"],PANDORA_CHEAT_ONLY_ITEMS=["PandoraPadlock","PandoraPadlockKey"],PlayerDialogOverrides=new Map;function OverridePlayerDialog(e,t){PlayerDialogOverrides.set(e,t)}const GetImageRedirects=new Map;function RedirectGetImage(e,t){GetImageRedirects.set(e,t)}const DialogMenuButtonClickHooks=new Map;function HookDialogMenuButtonClick(e,t){let o=DialogMenuButtonClickHooks.get(e);o||(o=[],DialogMenuButtonClickHooks.set(e,o)),o.includes(t)||o.push(t)}class ModuleMiscPatches extends BaseModule{load(){Array.isArray(modStorage.cheats)?modStorage.cheats=modStorage.cheats.filter((e=>void 0!==MiscCheat[e])):modStorage.cheats=[],hookFunction("DialogFindPlayer",10,((e,t)=>{const o=PlayerDialogOverrides.get(e[0]);return void 0!==o?o:t(e)})),hookFunction("DrawGetImage",10,((e,t)=>{const o=GetImageRedirects.get(e[0]);return void 0!==o&&(e[0]=o),t(e)})),hookFunction("DialogMenuButtonClick",5,((e,t)=>{const o=CharacterGetCurrent();for(let e=0;e<DialogMenuButton.length;e++)if(MouseX>=1885-110*e&&MouseX<=1975-110*e&&o){const t=DialogMenuButtonClickHooks.get(DialogMenuButton[e]);if(null==t?void 0:t.some((e=>e(o))))return}return t(e)})),hookFunction("AsylumEntranceCanWander",0,(()=>!0)),hookFunction("ElementIsScrolledToEnd",0,(e=>{const t=document.getElementById(e[0]);return null!=t&&t.scrollHeight-t.scrollTop-t.clientHeight<=1})),hookFunction("CheatFactor",1,((e,t)=>{const[o,n]=e;return"CantLoseMistress"===o&&cheatIsEnabled(MiscCheat.CantLoseMistress)||"BlockRandomKidnap"===o&&cheatIsEnabled(MiscCheat.BlockRandomEvents)?n:t(e)})),hookFunction("PrivateRansomStart",0,((e,t)=>!cheatIsEnabled(MiscCheat.BlockRandomEvents)&&t(e))),hookFunction("MainHallWalk",0,((e,t)=>(cheatIsEnabled(MiscCheat.BlockRandomEvents)&&(MainHallRandomEventOdds=0),t(e))));isNModClient()||(patchFunction("LoginMistressItems",{'LogQuery("ClubMistress", "Management")':"true"}),hookFunction("LoginMistressItems",0,((e,t)=>{if(t(e),!cheatIsEnabled(MiscCheat.GiveMistressKey)&&!LogQuery("ClubMistress","Management"))for(const e of MISTRESS_CHEAT_ONLY_ITEMS)InventoryDelete(Player,e,"ItemMisc",!1)})),cheatChangeHooks[MiscCheat.GiveMistressKey]=()=>{LoginMistressItems(),ServerPlayerInventorySync()},patchFunction("LoginStableItems",{'LogQuery("JoinedStable", "PonyExam") || LogQuery("JoinedStable", "TrainerExam")':"true"})),cheatChangeHooks[MiscCheat.GivePandoraKey]=e=>{for(const t of PANDORA_CHEAT_ONLY_ITEMS)e?InventoryAdd(Player,t,"ItemMisc",!1):InventoryDelete(Player,t,"ItemMisc",!1);ServerPlayerInventorySync()},hookFunction("InfiltrationStealItems",0,((e,t)=>{t(e),cheatIsEnabled(MiscCheat.GivePandoraKey)&&cheatChangeHooks[MiscCheat.GivePandoraKey](!0)})),hookFunction("Player.CanChange",1,((e,t)=>allowMode||t(e))),hookFunction("ChatRoomCanLeave",0,((e,t)=>allowMode||t(e))),hookFunction("DrawCharacter",100,((e,t)=>{if(null!=e[0])return t(e)}))}run(){LoginMistressItems(),LoginStableItems(),cheatIsEnabled(MiscCheat.GivePandoraKey)&&cheatChangeHooks[MiscCheat.GivePandoraKey](!0),ServerPlayerInventorySync()}}function initRules_bc_blocks(){const e=isNModClient();registerRule("block_remoteuse_self",{name:"Forbid using remotes on self",icon:icon_restrictions,shortDescription:"PLAYER_NAME using one on PLAYER_NAME",longDescription:"This rule forbids PLAYER_NAME to use or trigger a vibrator or similar remote controlled item on her own body. (Others still can use remotes on her)",triggerTexts:{infoBeep:"You are not allowed to use a remote control for items on your body!",attempt_log:"PLAYER_NAME tried to use a remote control on her own body, which was forbidden",log:"PLAYER_NAME used a remote control on her own body, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_RemoteDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_Remote.png","Icons/Remote.png"),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);if(0===t[0].ID&&e.isEnforced){const e=DialogMenuButton.indexOf("Remote");e>=0&&(DialogMenuButton[e]="BCX_RemoteDisabled")}}),ModuleCategory.Rules),HookDialogMenuButtonClick("Remote",(t=>(0===t.ID&&e.inEffect&&e.trigger(),!1))),HookDialogMenuButtonClick("BCX_RemoteDisabled",(t=>(0===t.ID&&e.inEffect&&e.triggerAttempt(),!1)))}}),registerRule("block_remoteuse_others",{name:"Forbid using remotes on others",icon:icon_restrictions,longDescription:"This rule forbids PLAYER_NAME to use or trigger a vibrator or similar remote controlled item on other club members.",triggerTexts:{infoBeep:"You are not allowed to use a remote control on other's items!",attempt_log:"PLAYER_NAME tried to use a remote control on TARGET_PLAYER's body, which was forbidden",log:"PLAYER_NAME used a remote control on TARGET_PLAYER's body, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_RemoteDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_Remote.png","Icons/Remote.png"),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);if(0!==t[0].ID&&e.isEnforced){const e=DialogMenuButton.indexOf("Remote");e>=0&&(DialogMenuButton[e]="BCX_RemoteDisabled")}}),ModuleCategory.Rules),HookDialogMenuButtonClick("Remote",(t=>(0!==t.ID&&e.inEffect&&e.trigger({TARGET_PLAYER:`${t.Name} (${t.MemberNumber})`}),!1))),HookDialogMenuButtonClick("BCX_RemoteDisabled",(t=>(0!==t.ID&&e.inEffect&&e.triggerAttempt({TARGET_PLAYER:`${t.Name} (${t.MemberNumber})`}),!1)))}}),registerRule("block_keyuse_self",{name:"Forbid using keys on self",icon:icon_restrictions,shortDescription:"PLAYER_NAME using one on PLAYER_NAME",longDescription:"This rule forbids PLAYER_NAME to unlock any locked item on her own body. Note: Despite the name, this rule also blocks unlocking locks that don't require a key (e.g. exclusive lock). However, locks that can be unlocked in other ways (timer locks by removing time, code/password locks by entering correct code) can still be unlocked by PLAYER_NAME. Others can still unlock her items on her normally.",triggerTexts:{infoBeep:"You are not allowed to use a key on items on your body!",attempt_log:"PLAYER_NAME tried to use a key on a worn item, which was forbidden",log:"PLAYER_NAME used a key on a worn item, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_UnlockDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_Unlock.png","Icons/Unlock.png"),hookFunction("DialogCanUnlock",0,((t,o)=>(0!==t[0].ID||!e.isEnforced)&&o(t)),ModuleCategory.Rules),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);0===t[0].ID&&e.isEnforced&&DialogMenuButton.includes("InspectLock")&&DialogMenuButton.splice(-1,0,"BCX_UnlockDisabled")}),ModuleCategory.Rules),HookDialogMenuButtonClick("Unlock",(t=>(0===t.ID&&e.inEffect&&e.trigger(),!1))),HookDialogMenuButtonClick("BCX_UnlockDisabled",(t=>(0===t.ID&&e.inEffect&&e.triggerAttempt(),!1)))}}),registerRule("block_keyuse_others",{name:"Forbid using keys on others",icon:icon_restrictions,longDescription:"This rule forbids PLAYER_NAME to unlock any locked item on other club members, with options to still allow unlocking of owner and/or lover locks and items. Note: Despite the name, this rule also blocks unlocking locks that don't require a key (e.g. exclusive lock). However, locks that can be unlocked in other ways (timer locks by removing time, code/password locks by entering correct code) can still be unlocked by PLAYER_NAME.",triggerTexts:{infoBeep:"You are not allowed to use a key on other's items!",attempt_log:"PLAYER_NAME tried to use a key to unlock TARGET_PLAYER's item, which was forbidden",log:"PLAYER_NAME used a key to unlock TARGET_PLAYER's item, which was forbidden"},defaultLimit:ConditionsLimit.normal,dataDefinition:{allowOwnerLocks:{type:"toggle",default:!1,description:"Still allow unlocking owner locks or items"},allowLoverLocks:{type:"toggle",default:!1,description:"Still allow unlocking lover locks or items",Y:530}},load(e){let t=!1;OverridePlayerDialog("BCX_UnlockDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_Unlock.png","Icons/Unlock.png"),hookFunction("DialogCanUnlock",0,((o,n)=>{const r=o[0],i=o[1],a=InventoryGetLock(i);return e.customData&&0!==r.ID&&null!=i&&null!=i.Asset&&(e.customData.allowOwnerLocks&&(i.Asset.OwnerOnly||(null==a?void 0:a.Asset.OwnerOnly))&&r.IsOwnedByPlayer()||e.customData.allowLoverLocks&&(i.Asset.LoverOnly||(null==a?void 0:a.Asset.LoverOnly))&&r.IsLoverOfPlayer())?(t=!0,n(o)):(t=!1,(0===r.ID||!e.isEnforced)&&n(o))}),ModuleCategory.Rules),hookFunction("DialogMenuButtonBuild",0,((o,n)=>{if(n(o),!t){0!==o[0].ID&&e.isEnforced&&DialogMenuButton.includes("InspectLock")&&DialogMenuButton.splice(-1,0,"BCX_UnlockDisabled")}}),ModuleCategory.Rules),HookDialogMenuButtonClick("Unlock",(o=>(!t&&0!==o.ID&&e.inEffect&&e.trigger({TARGET_PLAYER:`${o.Name} (${o.MemberNumber})`}),!1))),HookDialogMenuButtonClick("BCX_UnlockDisabled",(o=>(!t&&0!==o.ID&&e.inEffect&&e.triggerAttempt({TARGET_PLAYER:`${o.Name} (${o.MemberNumber})`}),!1)))}}),registerRule("block_lockpicking_self",{name:"Forbid picking locks on self",icon:icon_restrictions,shortDescription:"PLAYER_NAME picking one on PLAYER_NAME",longDescription:"This rule forbids PLAYER_NAME to lockpick any locked items on her own body. (Others still can pick locks on her normally)",triggerTexts:{infoBeep:"You are not allowed to lockpick worn items on your body!",attempt_log:"PLAYER_NAME tried to lockpick a worn item, which was forbidden",log:"PLAYER_NAME lockpicked a worn item, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_PickLockDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_PickLock.png","Icons/PickLock.png"),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);if(0===t[0].ID&&e.isEnforced){const e=DialogMenuButton.indexOf("PickLock");e>=0&&(DialogMenuButton[e]="BCX_PickLockDisabled")}}),ModuleCategory.Rules),HookDialogMenuButtonClick("PickLock",(t=>(0===t.ID&&e.inEffect&&e.trigger(),!1))),HookDialogMenuButtonClick("BCX_PickLockDisabled",(t=>(0===t.ID&&e.inEffect&&e.triggerAttempt(),!1)))}}),registerRule("block_lockpicking_others",{name:"Forbid picking locks on others",icon:icon_restrictions,longDescription:"This rule forbids PLAYER_NAME to lockpick any locked items on other club members.",triggerTexts:{infoBeep:"You are not allowed to lockpick items on others!",attempt_log:"PLAYER_NAME tried to lockpick an item on TARGET_PLAYER, which was forbidden",log:"PLAYER_NAME lockpicked an item on TARGET_PLAYER, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_PickLockDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_PickLock.png","Icons/PickLock.png"),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);if(0!==t[0].ID&&e.isEnforced){const e=DialogMenuButton.indexOf("PickLock");e>=0&&(DialogMenuButton[e]="BCX_PickLockDisabled")}}),ModuleCategory.Rules),HookDialogMenuButtonClick("PickLock",(t=>(0!==t.ID&&e.inEffect&&e.trigger({TARGET_PLAYER:`${t.Name} (${t.MemberNumber})`}),!1))),HookDialogMenuButtonClick("BCX_PickLockDisabled",(t=>(0!==t.ID&&e.inEffect&&e.triggerAttempt({TARGET_PLAYER:`${t.Name} (${t.MemberNumber})`}),!1)))}}),registerRule("block_lockuse_self",{name:"Forbid using locks on self",icon:icon_restrictions,shortDescription:"PLAYER_NAME using one on PLAYER_NAME",longDescription:"This rule forbids PLAYER_NAME to use any kind of lock on her own body. (Others still can add locks on her items normally)",triggerTexts:{infoBeep:"You are not allowed to lock items on your body!",attempt_log:"PLAYER_NAME tried to lock a worn item, which was forbidden",log:"PLAYER_NAME locked a worn item, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_LockDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_Lock.png","Icons/Lock.png"),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);if(0===t[0].ID&&e.isEnforced){const e=DialogMenuButton.indexOf("Lock");e>=0&&(DialogMenuButton[e]="BCX_LockDisabled")}}),ModuleCategory.Rules),HookDialogMenuButtonClick("Lock",(t=>(0===t.ID&&e.inEffect&&e.trigger(),!1))),HookDialogMenuButtonClick("BCX_LockDisabled",(t=>(0===t.ID&&e.inEffect&&e.triggerAttempt(),!1)))}}),registerRule("block_lockuse_others",{name:"Forbid using locks on others",icon:icon_restrictions,longDescription:"This rule forbids PLAYER_NAME to use any kind of lock on other club members.",triggerTexts:{infoBeep:"You are not allowed to lock other's items!",attempt_log:"PLAYER_NAME tried to lock TARGET_PLAYER's item, which was forbidden",log:"PLAYER_NAME locked TARGET_PLAYER's item, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_LockDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_Lock.png","Icons/Lock.png"),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);if(0!==t[0].ID&&e.isEnforced){const e=DialogMenuButton.indexOf("Lock");e>=0&&(DialogMenuButton[e]="BCX_LockDisabled")}}),ModuleCategory.Rules),HookDialogMenuButtonClick("Lock",(t=>(0!==t.ID&&e.inEffect&&e.trigger({TARGET_PLAYER:`${t.Name} (${t.MemberNumber})`}),!1))),HookDialogMenuButtonClick("BCX_LockDisabled",(t=>(0!==t.ID&&e.inEffect&&e.triggerAttempt({TARGET_PLAYER:`${t.Name} (${t.MemberNumber})`}),!1)))}}),registerRule("block_wardrobe_access_self",{name:"Forbid wardrobe use on self",icon:icon_restrictions,shortDescription:"PLAYER_NAME using PLAYER_NAME's wardrobe",longDescription:"This rule forbids PLAYER_NAME to access her own wardrobe. (Others still can change her clothes normally)",triggerTexts:{infoBeep:"You are not allowed to change what you are wearing!",attempt_log:"PLAYER_NAME tried to use their wardrobe, which was forbidden",log:"PLAYER_NAME used their wardrobe, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){hookFunction("Player.CanChange",2,((t,o)=>!e.isEnforced&&o(t)),ModuleCategory.Rules),hookFunction("CharacterAppearanceLoadCharacter",0,((t,o)=>(0===t[0].ID&&e.inEffect&&e.trigger(),o(t))),ModuleCategory.Rules)}}),registerRule("block_wardrobe_access_others",{name:"Forbid wardrobe use on others",icon:icon_restrictions,longDescription:"This rule forbids PLAYER_NAME to use the wardrobe of other club members.",triggerTexts:{infoBeep:"You are not allowed to change what others wear!",attempt_log:"PLAYER_NAME tried to use TARGET_PLAYER's wardrobe, which was forbidden",log:"PLAYER_NAME used TARGET_PLAYER's wardrobe, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){hookFunction("ChatRoomCanChangeClothes",5,((t,o)=>!e.isEnforced&&o(t)),ModuleCategory.Rules),hookFunction("CharacterAppearanceLoadCharacter",0,((t,o)=>(0!==t[0].ID&&e.inEffect&&e.trigger(),o(t))),ModuleCategory.Rules)}}),registerRule("block_restrict_allowed_poses",{name:"Restrict allowed body poses",icon:icon_restrictions,loggable:!1,longDescription:"Allows to restrict the body poses PLAYER_NAME is able to get into by herself.",defaultLimit:ConditionsLimit.normal,dataDefinition:{poseButtons:{type:"poseSelect",default:[],description:"Mark poses as being allowed or forbidden:"}},load(e){let t=!1;hookFunction("CharacterCanChangeToPose",3,((o,n)=>{var r;return!(!t&&e.isEnforced&&(null===(r=e.customData)||void 0===r?void 0:r.poseButtons.includes(o[1])))&&n(o)}),ModuleCategory.Rules),hookFunction("ChatRoomCanAttemptStand",3,((t,o)=>{var n;return(!e.isEnforced||!(null===(n=e.customData)||void 0===n?void 0:n.poseButtons.includes("BaseLower")))&&o(t)}),ModuleCategory.Rules),hookFunction("ChatRoomCanAttemptKneel",3,((t,o)=>{var n;return(!e.isEnforced||!(null===(n=e.customData)||void 0===n?void 0:n.poseButtons.includes("Kneel")))&&o(t)}),ModuleCategory.Rules),hookFunction("CharacterCanKneel",3,((o,n)=>{var r,i;if(e.isEnforced&&(null===(r=e.customData)||void 0===r?void 0:r.poseButtons.includes("Kneel"))&&!Player.IsKneeling())return!1;if(e.isEnforced&&(null===(i=e.customData)||void 0===i?void 0:i.poseButtons.includes("BaseLower"))&&Player.IsKneeling())return!1;t=!0;const a=n(o);return t=!1,a}),ModuleCategory.Rules)}}),registerRule("block_creating_rooms",{name:"Forbid creating new rooms",icon:icon_restrictions,longDescription:"This rule forbids PLAYER_NAME to create new rooms.",triggerTexts:{infoBeep:"You are not allowed to create a new room!",attempt_log:"PLAYER_NAME tried to create a chatroom, which was forbidden",log:"PLAYER_NAME created a chatroom, which was forbidden",announce:"",attempt_announce:""},defaultLimit:ConditionsLimit.blocked,load(t){e||hookFunction("ChatSearchRun",0,((e,o)=>{o(e),t.isEnforced&&DrawButton(1280,898,280,64,TextGet("CreateRoom"),"Gray",void 0,"Blocked by BCX",!0)}),ModuleCategory.Rules),hookFunction("CommonSetScreen",5,((e,o)=>{if("Online"===e[0]&&"ChatCreate"===e[1]){if(t.isEnforced)return void t.triggerAttempt();t.inEffect&&t.trigger()}o(e)}),ModuleCategory.Rules)}}),registerRule("block_entering_rooms",{name:"Restrict entering rooms",icon:icon_restrictions,shortDescription:"only allow entering specific ones",longDescription:'This rule forbids PLAYER_NAME to enter all rooms, that are not on an editable whitelist of still allowed ones. NOTE: As safety measure this rule is not in effect while the list is empty. TIP: This rule can be combined with the rule "Forbid creating new rooms".',triggerTexts:{infoBeep:"You are not allowed to enter this room!",attempt_log:"PLAYER_NAME tried to enter a forbidden room",log:"PLAYER_NAME entered a forbidden room",attempt_announce:"",announce:"PLAYER_NAME violated a rule to not enter this room"},defaultLimit:ConditionsLimit.blocked,dataDefinition:{roomList:{type:"stringList",default:[],description:"Only joining rooms with these names is allowed:"}},load(t){e||(hookFunction("ChatSearchJoin",5,((e,o)=>{if(t.inEffect&&t.customData&&t.customData.roomList.length>0){let e=25,o=25;for(let n=ChatSearchResultOffset;n<ChatSearchResult.length&&n<ChatSearchResultOffset+24;n++){if(MouseIn(e,o,630,85)&&!t.customData.roomList.some((e=>e.toLocaleLowerCase()===ChatSearchResult[n].Name.toLocaleLowerCase()))){if(t.isEnforced)return void t.triggerAttempt();t.trigger()}e+=660,e>1500&&(e=25,o+=109)}}o(e)}),ModuleCategory.Rules),hookFunction("ChatSearchNormalDraw",5,((e,o)=>{if(o(e),t.isEnforced&&t.customData&&t.customData.roomList.length>0){let e=25,o=25;for(let n=ChatSearchResultOffset;n<ChatSearchResult.length&&n<ChatSearchResultOffset+24;n++)t.customData.roomList.some((e=>e.toLocaleLowerCase()===ChatSearchResult[n].Name.toLocaleLowerCase()))||(DrawButton(e,o,630,85,"","#88c",void 0,"Blocked by BCX",!0),DrawTextFit((null!=ChatSearchResult[n].Friends&&ChatSearchResult[n].Friends.length>0?"("+ChatSearchResult[n].Friends.length+") ":"")+ChatSearchMuffle(ChatSearchResult[n].Name)+" - "+ChatSearchMuffle(ChatSearchResult[n].Creator)+" "+ChatSearchResult[n].MemberCount+"/"+ChatSearchResult[n].MemberLimit,e+315,o+25,620,"black"),DrawTextFit(ChatSearchMuffle(ChatSearchResult[n].Description),e+315,o+62,620,"black")),e+=660,e>1500&&(e=25,o+=109)}}),ModuleCategory.Rules))}}),registerRule("block_leaving_room",{name:"Prevent leaving the room",icon:icon_restrictions,loggable:!1,shortDescription:"while defined roles are inside",longDescription:"This rule prevents PLAYER_NAME from leaving the room they are currently inside while at least one character with the set minimum role or a higher one is present inside. NOTE: Careful when setting the minimum role too low. If it is set to public for instance, it would mean that PLAYER_NAME can only leave the room when they are alone in it.",triggerTexts:{infoBeep:"Someone's presence does not allowed you to leave!",attempt_announce:"PLAYER_NAME violated a rule by trying to leave this room"},defaultLimit:ConditionsLimit.blocked,dataDefinition:{minimumRole:{type:"roleSelector",default:AccessLevel.mistress,description:"Minimum role preventing room leaving:",Y:320}},load(e){const t=()=>e.isEnforced&&!!e.customData&&getAllCharactersInRoom().some((t=>!t.isPlayer()&&getCharacterAccessLevel(t)<=e.customData.minimumRole));hookFunction("ChatRoomCanLeave",6,((e,o)=>!t()&&o(e)),ModuleCategory.Rules),hookFunction("ChatRoomMenuClick",6,((o,n)=>{const r=870/(ChatRoomMenuButtons.length-1);for(let o=0;o<ChatRoomMenuButtons.length;o++)MouseXIn(1005+r*o,120)&&"Exit"===ChatRoomMenuButtons[o]&&t()&&e.triggerAttempt();return n(o)}),ModuleCategory.Rules)}}),registerRule("block_freeing_self",{name:"Forbid freeing self",icon:icon_restrictions,shortDescription:"PLAYER_NAME removing any items from PLAYER_NAME's body",longDescription:"This rule forbids PLAYER_NAME to remove any items from her own body. Other people can still remove them.",triggerTexts:{infoBeep:"You are not allowed to remove an item from your body!",attempt_log:"PLAYER_NAME tried to remove a worn item, which was forbidden",log:"PLAYER_NAME removed a worn item, which was forbidden"},defaultLimit:ConditionsLimit.normal,load(e){OverridePlayerDialog("BCX_RemoveDisabled","Usage blocked by BCX"),OverridePlayerDialog("BCX_StruggleDisabled","Usage blocked by BCX"),OverridePlayerDialog("BCX_DismountDisabled","Usage blocked by BCX"),OverridePlayerDialog("BCX_EscapeDisabled","Usage blocked by BCX"),RedirectGetImage("Icons/BCX_Remove.png","Icons/Remove.png"),RedirectGetImage("Icons/BCX_Struggle.png","Icons/Struggle.png"),RedirectGetImage("Icons/BCX_Dismount.png","Icons/Dismount.png"),RedirectGetImage("Icons/BCX_Escape.png","Icons/Escape.png"),hookFunction("DialogMenuButtonBuild",0,((t,o)=>{o(t);if(0===t[0].ID&&e.isEnforced){const e=DialogMenuButton.indexOf("Remove"),t=DialogMenuButton.indexOf("Struggle"),o=DialogMenuButton.indexOf("Dismount"),n=DialogMenuButton.indexOf("Escape");e>=0&&(DialogMenuButton[e]="BCX_RemoveDisabled"),t>=0&&(DialogMenuButton[t]="BCX_StruggleDisabled"),o>=0&&(DialogMenuButton[o]="BCX_DismountDisabled"),n>=0&&(DialogMenuButton[n]="BCX_EscapeDisabled")}}),ModuleCategory.Rules);const t=t=>(0===t.ID&&e.inEffect&&e.trigger(),!1),o=t=>(0===t.ID&&e.inEffect&&e.triggerAttempt(),!1);HookDialogMenuButtonClick("Remove",t),HookDialogMenuButtonClick("BCX_RemoveDisabled",o),HookDialogMenuButtonClick("Struggle",t),HookDialogMenuButtonClick("BCX_StruggleDisabled",o),HookDialogMenuButtonClick("Dismount",t),HookDialogMenuButtonClick("BCX_DismountDisabled",o),HookDialogMenuButtonClick("Escape",t),HookDialogMenuButtonClick("BCX_EscapeDisabled",o)}}),registerRule("block_tying_others",{name:"Forbid tying up others",icon:icon_restrictions,shortDescription:"either everybody or only more dominant characters",longDescription:"This rule forbids PLAYER_NAME to use any items on other characters. Can be set to only affect using items on characters with a higher dominant / lower submissive score than PLAYER_NAME has.",triggerTexts:{infoBeep:"You are not allowed to use an item on TARGET_PLAYER!",attempt_log:"PLAYER_NAME tried to use an item on TARGET_PLAYER, which was forbidden",log:"PLAYER_NAME used an item on TARGET_PLAYER, which was forbidden"},defaultLimit:ConditionsLimit.normal,dataDefinition:{onlyMoreDominantsToggle:{type:"toggle",default:!0,description:"Only forbid tying people with higher dominance"}},load(e){hookFunction("DialogItemClick",5,((t,o)=>{if(e.inEffect&&e.customData){const t=e.customData.onlyMoreDominantsToggle,o=null!=Player.FocusGroup?Player:CurrentCharacter;if(o&&0!==o.ID&&(!t||ReputationCharacterGet(Player,"Dominant")<ReputationCharacterGet(o,"Dominant"))){if(e.isEnforced)return void e.triggerAttempt({TARGET_PLAYER:`${o.Name} (${o.MemberNumber})`});e.trigger({TARGET_PLAYER:`${o.Name} (${o.MemberNumber})`})}}o(t)}),ModuleCategory.Rules),hookFunction("AppearanceGetPreviewImageColor",5,((t,o)=>{var n;const r=null===(n=e.customData)||void 0===n?void 0:n.onlyMoreDominantsToggle,i=t[0];return i&&0!==i.ID&&e.isEnforced&&(!r||ReputationCharacterGet(Player,"Dominant")<ReputationCharacterGet(i,"Dominant"))?"grey":o(t)}),ModuleCategory.Rules)}}),registerRule("block_blacklisting",{name:"Prevent blacklisting",icon:icon_restrictions,loggable:!1,shortDescription:"and ghosting of the defined roles",longDescription:"This rule prevents PLAYER_NAME from adding characters with the set minimum role or a higher one to their bondage club blacklist and ghostlist.",triggerTexts:{infoBeep:"You are not allowed to blacklist/ghost this person!",attempt_announce:"PLAYER_NAME violated a rule by trying to blacklist TARGET_CHARACTER"},defaultLimit:ConditionsLimit.blocked,dataDefinition:{minimumRole:{type:"roleSelector",default:AccessLevel.mistress,description:"Minimum role forbidden to blacklist:",Y:320}},load(e){hookFunction("ChatRoomListManipulation",6,((t,o)=>{const n=parseInt(t[2],10);if(!(e.isEnforced&&e.customData&&(t[0]===Player.BlackList||t[0]===Player.GhostList)&&"number"==typeof n&&getCharacterAccessLevel(n)<=e.customData.minimumRole))return o(t);e.triggerAttempt({TARGET_CHARACTER:`${getCharacterName(n,"[Unknown]")} (${n})`})}),ModuleCategory.Rules),hookFunction("ChatRoomListManage",6,((t,o)=>{if(!(e.isEnforced&&e.customData&&"Add"===t[0]&&("BlackList"===t[1]||"GhostList"===t[1])&&null!=(null===CurrentCharacter||void 0===CurrentCharacter?void 0:CurrentCharacter.MemberNumber)&&getCharacterAccessLevel(CurrentCharacter.MemberNumber)<=e.customData.minimumRole))return o(t);e.triggerAttempt({TARGET_CHARACTER:`${CurrentCharacter.Name} (${CurrentCharacter.MemberNumber})`})}),ModuleCategory.Rules)}}),registerRule("block_antiblind",{name:"Forbid the antiblind option",icon:icon_restrictions,shortDescription:"BCX's .antiblind command",longDescription:"This rule forbids PLAYER_NAME to use the antiblind command. Antiblind is a BCX feature that enables a BCX user to see the whole chat room and all other characters at all times, even when wearing a blinding item. If PLAYER_NAME should be forbidden to use the command, this rule should be used.",triggerTexts:{infoBeep:"You are not allowed to use the antiblind command!",attempt_log:"PLAYER_NAME tried to use the antiblind command",log:"PLAYER_NAME used the antiblind command"},defaultLimit:ConditionsLimit.normal}),registerRule("block_difficulty_change",{name:"Forbid changing difficulty",icon:icon_restrictions,shortDescription:"multiplayer difficulty preference",longDescription:"This rule forbids PLAYER_NAME to change her Bondage Club multiplayer difficulty, regardless of the current value.",triggerTexts:{infoBeep:"You are not allowed to change your difficulty!",attempt_log:"PLAYER_NAME tried to change her multiplayer difficulty",log:"PLAYER_NAME changed her multiplayer difficulty"},defaultLimit:ConditionsLimit.blocked,load(e){hookFunction("PreferenceSubscreenDifficultyRun",5,((t,o)=>{var n;o(t);const r="number"!=typeof(null===(n=null===Player||void 0===Player?void 0:Player.Difficulty)||void 0===n?void 0:n.LastChange)?Player.Creation:Player.Difficulty.LastChange;e.isEnforced&&null!=PreferenceDifficultyLevel&&PreferenceDifficultyLevel!==Player.GetDifficulty()&&(PreferenceDifficultyLevel<=1||r+6048e5<CurrentTime)&&PreferenceDifficultyAccept&&DrawButton(500,825,300,64,TextGet("DifficultyChangeMode")+" "+TextGet("DifficultyLevel"+PreferenceDifficultyLevel.toString()),"#88c",void 0,"Blocked by BCX",!0)})),hookFunction("PreferenceSubscreenDifficultyClick",5,((t,o)=>{var n;const r="number"!=typeof(null===(n=null===Player||void 0===Player?void 0:Player.Difficulty)||void 0===n?void 0:n.LastChange)?Player.Creation:Player.Difficulty.LastChange;if(e.inEffect&&null!=PreferenceDifficultyLevel&&PreferenceDifficultyLevel!==Player.GetDifficulty()&&(PreferenceDifficultyLevel<=1||r+6048e5<CurrentTime)&&PreferenceDifficultyAccept&&MouseIn(500,825,300,64)){if(e.isEnforced)return void e.triggerAttempt();e.trigger()}o(t)}))}})}function initRules_bc_settings(){function e(){ServerAccountUpdate.QueueData({ArousalSettings:Player.ArousalSettings,GameplaySettings:Player.GameplaySettings,ImmersionSettings:Player.ImmersionSettings,OnlineSettings:Player.OnlineSettings,OnlineSharedSettings:Player.OnlineSharedSettings,GraphicsSettings:Player.GraphicsSettings,ItemPermission:Player.ItemPermission})}function t(e,t){return{name:`Force '${e}'`,icon:"Icons/Preference.png",loggable:!1,shortDescription:"Existing BC setting",defaultLimit:t,longDescription:`This rule forces PLAYER_NAME's base game setting '${e}' to configurable value and prevents her from changing it.`,triggerTexts:{infoBeep:`Rule changed your '${e}' setting`}}}function o({id:o,setting:n,defaultValue:r,defaultLimit:i,get:a,set:s}){return registerRule(o,{...t(n,i),longDescription:`This rule forces PLAYER_NAME's base game setting '${n}' to configurable value and prevents her from changing it. There is also an option to restore the setting to the state it was in before the rule changed it. The restoration happens either when the rule becomes inactive (for instance through toggle or unfulfilled trigger conditions) or when it is removed.`,dataDefinition:{value:{type:"toggle",description:n,default:r},restore:{type:"toggle",description:"Restore previous value when rule ends",default:!0,Y:420}},internalDataValidate:e=>"boolean"==typeof e,internalDataDefault:()=>{var e;return null!==(e=a())&&void 0!==e&&e},stateChange(t,o){var n;if(o){const e=a();void 0!==e&&(t.internalData=e)}else if(null===(n=t.customData)||void 0===n?void 0:n.restore){const o=t.internalData;void 0!==o&&(s(o),e())}},tick(t){if(t.isEnforced&&t.customData){const o=a();if(null==o)return console.error(`BCX: Undfined value while forcing setting ${n}`),!1;if(o!==t.customData.value)return s(t.customData.value),t.trigger(),e(),!0}return!1}})}registerRule("setting_item_permission",{...t("Item permission",ConditionsLimit.limited),dataDefinition:{value:{type:"listSelect",options:[["everyone","Everyone, no exceptions"],["everyoneBlacklist","Everyone, except blacklist"],["dominants","Owner, Lovers, whitelist & Dominants"],["whitelist","Owner, Lovers and whitelist only"]],default:"everyone",description:"Item permission"}},tick(t){var o;if(t.isEnforced&&t.customData){const n=null!==(o={everyone:0,everyoneBlacklist:1,dominants:2,whitelist:3}[t.customData.value])&&void 0!==o?o:0;if(Player.ItemPermission!==n)return Player.ItemPermission=n,t.trigger(),e(),!0}return!1}}),o({id:"setting_forbid_lockpicking",setting:"Locks on you can't be picked",defaultValue:!0,defaultLimit:ConditionsLimit.limited,get:()=>{var e;return null===(e=Player.OnlineSharedSettings)||void 0===e?void 0:e.DisablePickingLocksOnSelf},set:e=>Player.OnlineSharedSettings.DisablePickingLocksOnSelf=e}),o({id:"setting_forbid_SP_rooms",setting:"Cannot enter single-player rooms when restrained",defaultValue:!0,defaultLimit:ConditionsLimit.limited,get:()=>{var e;return null===(e=Player.GameplaySettings)||void 0===e?void 0:e.OfflineLockedRestrained},set:e=>Player.GameplaySettings.OfflineLockedRestrained=e}),o({id:"setting_forbid_safeword",setting:"Allow safeword use",defaultValue:!1,defaultLimit:ConditionsLimit.limited,get:()=>{var e;return null===(e=Player.GameplaySettings)||void 0===e?void 0:e.EnableSafeword},set:e=>Player.GameplaySettings.EnableSafeword=e}),registerRule("setting_arousal_meter",{...t("Arousal meter",ConditionsLimit.limited),dataDefinition:{active:{type:"listSelect",options:[["Inactive","Disable sexual activities"],["NoMeter","Allow without a meter"],["Manual","Allow with a manual meter"],["Hybrid","Allow with a hybrid meter"],["Automatic","Allow with a locked meter"]],default:"Hybrid",description:"Sexual activities - Activation"},visible:{type:"listSelect",options:[["All","Show arousal to everyone"],["Access","Show if they have access"],["Self","Show to yourself only"]],default:"All",description:"Meter visibility",Y:480}},tick(t){let o=!1;return t.isEnforced&&t.customData&&Player.ArousalSettings&&(Player.ArousalSettings.Active!==t.customData.active&&(Player.ArousalSettings.Active=t.customData.active,o=!0),Player.ArousalSettings.Visible!==t.customData.visible&&(Player.ArousalSettings.Visible=t.customData.visible,o=!0),o&&(t.trigger(),e())),o}}),o({id:"setting_block_vibe_modes",setting:"Block advanced vibrator modes",defaultValue:!1,defaultLimit:ConditionsLimit.limited,get:()=>{var e;return null===(e=Player.ArousalSettings)||void 0===e?void 0:e.DisableAdvancedVibes},set:e=>Player.ArousalSettings.DisableAdvancedVibes=e}),registerRule("setting_arousal_stutter",{...t("Arousal speech stuttering",ConditionsLimit.limited),dataDefinition:{value:{type:"listSelect",options:[["None","Never stutter"],["Arousal","When you're aroused"],["Vibration","When you're vibrated"],["All","Aroused & vibrated"]],default:"All",description:"Speech stuttering"}},tick:t=>!!(t.isEnforced&&t.customData&&Player.ArousalSettings&&Player.ArousalSettings.AffectStutter!==t.customData.value)&&(Player.ArousalSettings.AffectStutter=t.customData.value,t.trigger(),e(),!0)}),o({id:"setting_show_afk",setting:"Show AFK bubble",defaultValue:!0,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.OnlineSettings)||void 0===e?void 0:e.EnableAfkTimer},set:e=>Player.OnlineSettings.EnableAfkTimer=e}),o({id:"setting_show_wardrobe_use",setting:"Show wardrobe icon",defaultValue:!0,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.OnlineSettings)||void 0===e?void 0:e.EnableWardrobeIcon},set:e=>Player.OnlineSettings.EnableWardrobeIcon=e}),o({id:"setting_allow_body_mod",setting:"Allow others to alter your whole appearance",defaultValue:!0,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.OnlineSharedSettings)||void 0===e?void 0:e.AllowFullWardrobeAccess},set:e=>Player.OnlineSharedSettings.AllowFullWardrobeAccess=e}),o({id:"setting_forbid_cosplay_change",setting:"Prevent others from changing cosplay items",defaultValue:!1,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.OnlineSharedSettings)||void 0===e?void 0:e.BlockBodyCosplay},set:e=>Player.OnlineSharedSettings.BlockBodyCosplay=e}),registerRule("setting_sensdep",{...t("Sensory deprivation setting",ConditionsLimit.blocked),dataDefinition:{value:{type:"listSelect",options:[["SensDepLight","Light"],["Normal","Normal"],["SensDepNames","Hide names"],["SensDepTotal","Heavy"],["SensDepExtreme","Total"]],default:"Normal",description:"Sensory deprivation setting"},disableExamine:{type:"toggle",default:!1,description:"Disable examining when blind",Y:480},hideMessages:{type:"toggle",default:!1,description:"Hide others' messages",Y:580}},tick(t){let o=!1;if(t.isEnforced&&t.customData&&Player.GameplaySettings&&Player.ImmersionSettings){Player.GameplaySettings.SensDepChatLog!==t.customData.value&&(Player.GameplaySettings.SensDepChatLog=t.customData.value,o=!0);const n="SensDepLight"===t.customData.value,r="SensDepExtreme"===t.customData.value,i=t.customData.disableExamine&&!n||r;Player.GameplaySettings.BlindDisableExamine!==i&&(Player.GameplaySettings.BlindDisableExamine=i,o=!0);const a="SensDepLight"!==t.customData.value&&t.customData.hideMessages;Player.ImmersionSettings.SenseDepMessages!==a&&(Player.ImmersionSettings.SenseDepMessages=a,o=!0),o&&(t.trigger(),e())}return o}}),o({id:"setting_hide_non_adjecent",setting:"Hide non-adjacent players while partially blind",defaultValue:!0,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.ImmersionSettings)||void 0===e?void 0:e.BlindAdjacent},set:e=>Player.ImmersionSettings.BlindAdjacent=e}),o({id:"setting_blind_room_garbling",setting:"Garble chatroom names and descriptions while blind",defaultValue:!0,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.ImmersionSettings)||void 0===e?void 0:e.ChatRoomMuffle},set:e=>Player.ImmersionSettings.ChatRoomMuffle=e}),o({id:"setting_relog_keeps_restraints",setting:"Keep all restraints when relogging",defaultValue:!0,defaultLimit:ConditionsLimit.limited,get:()=>{var e;return null===(e=Player.GameplaySettings)||void 0===e?void 0:e.DisableAutoRemoveLogin},set:e=>Player.GameplaySettings.DisableAutoRemoveLogin=e}),o({id:"setting_leashed_roomchange",setting:"Players can drag you to rooms when leashed",defaultValue:!0,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.OnlineSharedSettings)||void 0===e?void 0:e.AllowPlayerLeashing},set:e=>Player.OnlineSharedSettings.AllowPlayerLeashing=e}),registerRule("setting_room_rejoin",{...t("Return to chatrooms on relog",ConditionsLimit.limited),dataDefinition:{value:{type:"toggle",default:!0,description:"Return to chatrooms on relog"},remakeRooms:{type:"toggle",default:!1,description:"Auto-remake rooms",Y:425}},tick(t){let o=!1;if(t.isEnforced&&t.customData&&Player.ImmersionSettings){Player.ImmersionSettings.ReturnToChatRoom!==t.customData.value&&(Player.ImmersionSettings.ReturnToChatRoom=t.customData.value,o=!0);const n=t.customData.value&&t.customData.remakeRooms;Player.ImmersionSettings.ReturnToChatRoomAdmin!==n&&(Player.ImmersionSettings.ReturnToChatRoomAdmin=n,o=!0),o&&(t.trigger(),e())}return o}}),o({id:"setting_plug_vibe_events",setting:"Events while plugged or vibed",defaultValue:!0,defaultLimit:ConditionsLimit.normal,get:()=>{var e;return null===(e=Player.ImmersionSettings)||void 0===e?void 0:e.StimulationEvents},set:e=>Player.ImmersionSettings.StimulationEvents=e}),o({id:"setting_upsidedown_view",setting:"Flip room vertically when upside-down",defaultValue:!0,defaultLimit:ConditionsLimit.blocked,get:()=>{var e;return null===(e=Player.GraphicsSettings)||void 0===e?void 0:e.InvertRoom},set:e=>Player.GraphicsSettings.InvertRoom=e})}function initRules_bc_relation_control(){registerRule("rc_club_owner",{name:"Forbid club owner changes",icon:icon_OwnerList,shortDescription:"getting or leaving owner",longDescription:"This rule forbids PLAYER_NAME to leave their current club owner or get a new one. Advancing ownership from trial to full ownership is unaffected. Doesn't prevent the club owner from releasing her.",loggable:!1,defaultLimit:ConditionsLimit.blocked,load(e){hookFunction("ChatRoomOwnershipOptionIs",5,((t,o)=>{const n=t[0];return(!e.isEnforced||"CanStartTrial"!==n)&&o(t)}),ModuleCategory.Rules);for(const t of["ManagementCanBeReleasedOnline","ManagementCanBreakTrialOnline","ManagementCannotBeReleasedOnline","ManagementCanBeReleased","ManagementCannotBeReleased"])hookFunction(t,5,((t,o)=>!e.isEnforced&&o(t)),ModuleCategory.Rules);hookFunction("ManagementCannotBeReleasedExtreme",5,((t,o)=>e.isEnforced||o(t)),ModuleCategory.Rules)}}),registerRule("rc_lover_new",{name:"Forbid getting new lovers",icon:icon_OwnerList,longDescription:"This rule forbids PLAYER_NAME to get a new lover. Advancing lovership from dating to engagement or from engagement to marriage is unaffected.",loggable:!1,defaultLimit:ConditionsLimit.blocked,load(e){hookFunction("ChatRoomLovershipOptionIs",5,((t,o)=>{const n=t[0];return(!e.isEnforced||"CanOfferBeginDating"!==n&&"CanBeginDating"!==n)&&o(t)}),ModuleCategory.Rules)}}),registerRule("rc_lover_leave",{name:"Forbid breaking up with lovers",icon:icon_OwnerList,longDescription:"This rule forbids PLAYER_NAME to leave any of their lovers, independent of lovership stage (leaving dating, engaged and married characters is forbidden). Doesn't prevent her lovers from breaking up with her.",loggable:!1,defaultLimit:ConditionsLimit.blocked,load(e){for(const t of["ManagementCanBreakDatingLoverOnline","ManagementCanBreakUpLoverOnline"])hookFunction(t,5,((t,o)=>!e.isEnforced&&o(t)),ModuleCategory.Rules)}}),registerRule("rc_sub_new",{name:"Forbid taking new submissives",icon:icon_OwnerList,shortDescription:"by offering them an ownership trial",longDescription:"This rule forbids PLAYER_NAME to start a trial with new submissive. Advancing ownership from trial to full ownership is unaffected.",loggable:!1,defaultLimit:ConditionsLimit.blocked,load(e){hookFunction("ChatRoomOwnershipOptionIs",5,((t,o)=>{const n=t[0];return(!e.isEnforced||"Propose"!==n)&&o(t)}),ModuleCategory.Rules)}}),registerRule("rc_sub_leave",{name:"Forbid disowning submissives",icon:icon_OwnerList,longDescription:"This rule forbids PLAYER_NAME to let go of any of their subs. (affects both trial and full ownerships). Doesn't prevent her submissives from breaking the bond.",loggable:!1,defaultLimit:ConditionsLimit.blocked,load(e){hookFunction("ChatRoomIsOwnedByPlayer",5,((t,o)=>!e.isEnforced&&o(t)),ModuleCategory.Rules)}})}const speechHooks=[];function registerSpeechHook(e){if(moduleInitPhase!==ModuleInitPhase.init)throw new Error("Speech hooks can be registered only during init");speechHooks.push(e)}function falteringSpeech(e){const t=["uuh... ","uhh... ","...ah... ","uhm... ","mnn... ","..nn... "];let o=!1,n=!0,r=!1,i=e.length;for(let a=0;a<e.length;a++){const s=e.charAt(a).toLowerCase();if("("===s&&(o=!0),!o&&!r&&/\p{L}/giu.test(s)){const o=Math.floor(1e5*Math.sin(i++))%10;(!r&&o>=6||n)&&(e=e.substring(0,a+1)+"-"+e.substring(a,e.length),i++,Math.random()<.33&&!n&&(e=e.substring(0,a)+t[Math.floor(Math.random()*t.length)]+e.substring(a,e.length)),a+=2,n&&(n=!1)),r=!0}")"===s&&(o=!1)," "===s&&(r=!1)}return e}function parseMsg(e){var t;const o=e;if(e.startsWith("//"))e=e.substr(1);else if(e.startsWith("/"))return{type:"Command",rawMessage:o,originalMessage:e,target:null,hasOOC:!0};return e.startsWith("*")||(null===(t=Player.ChatSettings)||void 0===t?void 0:t.MuStylePoses)&&e.startsWith(":")&&e.length>3?null:{type:null==ChatRoomTargetMemberNumber?"Chat":"Whisper",rawMessage:o,originalMessage:e,target:ChatRoomTargetMemberNumber,noOOCMessage:e.replace(/\([^)]*\)?\s?/gs,""),hasOOC:e.includes("(")}}function processMsg(e){if("Command"===e.type)return e.rawMessage;if(("Chat"===e.type||"Whisper"===e.type)&&ChatRoomShouldBlockGaggedOOCMessage(e.originalMessage,ChatRoomCharacter.find((e=>e.MemberNumber===ChatRoomTargetMemberNumber))))return e.rawMessage;for(const t of speechHooks)if(t.allowSend&&!t.allowSend(e))return null;let t=e.originalMessage;for(const o of speechHooks)o.modify&&(t=o.modify(e,t));for(const o of speechHooks)o.onSend&&o.onSend(e,t);return t.startsWith("/")&&(t="/"+t),t}let antigarble=0;function setAntigarble(e){if(![0,1,2].includes(e))throw new Error("Bad antigarble value, expected 0/1/2");if(0!==e){const e=RulesGetRuleState("speech_block_antigarble");if(e.isEnforced)return e.triggerAttempt(),!1;e.inEffect&&e.trigger()}return antigarble=e,!0}class ModuleSpeech extends BaseModule{load(){hookFunction("ChatRoomSendChat",5,((e,t)=>{const o=document.getElementById("InputChat");if(o){const e=o.value.trim();if(e){const t=parseMsg(e);if(t){const e=processMsg(t);if(null===e)return void(RulesGetRuleState("speech_force_retype").isEnforced&&(o.value=""));o.value=e}}}return t(e)})),hookFunction("CommandParse",0,((e,t)=>t(e))),hookFunction("ChatRoomSendEmote",5,((e,t)=>{var o;const n=e[0];let r=n;(null===(o=Player.ChatSettings)||void 0===o?void 0:o.MuStylePoses)&&r.startsWith(":")?r=r.substring(1):(r=r.replace(/^\*/,"").replace(/\*$/,""),r.startsWith("/me ")&&(r=r.replace("/me ","")),r.startsWith("/action ")&&(r=r.replace("/action ","*"))),r=r.trim();const i=processMsg({type:"Emote",rawMessage:n,originalMessage:r,target:ChatRoomTargetMemberNumber,noOOCMessage:r,hasOOC:!1});if(null!==i)return t(["*"+i]);if(RulesGetRuleState("speech_force_retype").isEnforced){const e=document.getElementById("InputChat");e&&(e.value="")}}));const e={0:0,1:1,2:2,normal:0,both:1,ungarbled:2},t=Object.keys(e).filter((e=>e.length>1));registerCommand("antigarble","<level> - Set garble prevention to show [normal|both|ungarbled] messages (only affects received messages!)",(o=>{const n=e[o||""];return void 0!==n?!!setAntigarble(n)&&(ChatRoomSendLocal(`Antigarble set to ${t[n]}`),!0):(ChatRoomSendLocal(`Invalid antigarble level; use ${t.join("/")}`),!1)}),(e=>t.filter((t=>t.length>1&&t.startsWith(e))))),hookFunction("SpeechGarble",0,((e,t)=>{if(2===antigarble)return e[1];let o=t(e);return"string"==typeof o&&o!==e[1]&&1===antigarble&&(o+=` <> ${e[1]}`),o})),"function"==typeof window.InventoryItemNeckAccessoriesCollarAutoShockUnitDetectSpeech&&hookFunction("InventoryItemNeckAccessoriesCollarAutoShockUnitDetectSpeech",10,((e,t)=>!(ChatRoomLastMessage&&ChatRoomLastMessage.length>0&&ChatRoomLastMessage[ChatRoomLastMessage.length-1].startsWith(".")&&!ChatRoomLastMessage[ChatRoomLastMessage.length-1].startsWith(".."))&&t(e)))}}function initRules_bc_speech_control(){registerRule("speech_specific_sound",{name:"Allow specific sounds only",icon:"Icons/Chat.png",shortDescription:"such as an animal sound",longDescription:"This rule allows PLAYER_NAME to only communicate using a list of specific sound patterns in chat messages and whispers. These patterns cannot be mixed in the same message, though. Only one sound from the list per message is valid. That said, any variation of a sound in the list is allowed as long as the letters are in order. (Example: if the set sound is 'Meow', then this is a valid message: 'Me..ow? meeeow! mmeooowwwwwww?! meow. me.. oo..w ~')",triggerTexts:{infoBeep:"You are allowed to speak only using one of the defined sounds!",attempt_log:"PLAYER_NAME tried to break a rule to only speak using specific sound patterns",log:"PLAYER_NAME broke a rule to only speak using specific sound patterns"},defaultLimit:ConditionsLimit.normal,dataDefinition:{soundWhitelist:{type:"stringList",default:[],description:"Set the allowed sounds:"}},init(e){const t=t=>{var o,n;const r=null===(o=e.customData)||void 0===o?void 0:o.soundWhitelist;if(r&&r.length>0&&("Chat"===t.type||"Whisper"===t.type)){const e=(null!==(n=t.noOOCMessage)&&void 0!==n?n:t.originalMessage).toLocaleLowerCase();for(let t of r){t=t.toLocaleLowerCase();let o=!0,n=0;for(const r of e)if(/\p{L}/giu.test(r)){if(r===t[(n+1)%t.length])n=(n+1)%t.length;else if(r!==t[n]){o=!1;break}}if(o)return!0}return!1}return!0};registerSpeechHook({allowSend:o=>!(e.isEnforced&&!t(o))||(e.triggerAttempt(),!1),onSend:o=>{e.inEffect&&!t(o)&&e.trigger()}})}}),registerRule("speech_garble_whispers",{name:"Garble whispers while gagged",icon:"Icons/Chat.png",loggable:!1,shortDescription:"same as normal messages",longDescription:"This rule alters PLAYER_NAME's outgoing whisper messages while gagged to be garbled the same way normal chat messages are. This means, that strength of the effect depends on the type of gag and (OOC text) is not affected. Note: While the rule is in effect, the BC immersion preference 'Prevent OOC & whispers while gagged' is altered, to allow gagged whispers, since those are now garbled by the rule. OOC prevention is not changed.",defaultLimit:ConditionsLimit.limited,init(e){registerSpeechHook({modify:(t,o)=>e.isEnforced&&"Whisper"===t.type?callOriginal("SpeechGarble",[Player,o,!0]):o})},load(e){hookFunction("ChatRoomShouldBlockGaggedOOCMessage",2,((t,o)=>!(e.isEnforced&&null!==ChatRoomTargetMemberNumber&&!t[0].includes("("))&&o(t)),ModuleCategory.Rules)}}),registerRule("speech_block_gagged_ooc",{name:"Block OOC chat while gagged",icon:"Icons/Chat.png",shortDescription:"no more misuse of OOC for normal chatting while gagged",longDescription:"This rule forbids PLAYER_NAME to use OOC (messages between round brackets) in chat or OOC whisper messages while she is gagged.",triggerTexts:{infoBeep:"You are not allowed to use OOC in messages while gagged.",attempt_log:"PLAYER_NAME tried to use OOC in a message while gagged",log:"PLAYER_NAME used OOC in a message while gagged"},defaultLimit:ConditionsLimit.blocked,init(e){const t=e=>!e.hasOOC||Player.CanTalk()||"Chat"!==e.type&&"Whisper"!==e.type;registerSpeechHook({allowSend:o=>!(e.isEnforced&&!t(o))||(e.triggerAttempt(),!1),onSend:o=>{e.inEffect&&!t(o)&&e.trigger()}})}}),registerRule("speech_block_ooc",{name:"Block OOC chat",icon:"Icons/Chat.png",shortDescription:"blocks use of OOC in messages",longDescription:"This rule forbids PLAYER_NAME to use OOC (messages between round brackets) in chat or OOC whisper messages at any moment. This is a very extreme rule and should be used with great caution!",triggerTexts:{infoBeep:"You are not allowed to use OOC in messages!",attempt_log:"PLAYER_NAME tried to use OOC in a message",log:"PLAYER_NAME used OOC in a message"},defaultLimit:ConditionsLimit.blocked,init(e){const t=e=>!e.hasOOC||"Chat"!==e.type&&"Whisper"!==e.type;registerSpeechHook({allowSend:o=>!(e.isEnforced&&!t(o))||(e.triggerAttempt(),!1),onSend:o=>{e.inEffect&&!t(o)&&e.trigger()}})}}),registerRule("speech_doll_talk",{name:"Doll talk",icon:"Icons/Chat.png",shortDescription:"allows only short sentences with simple words",longDescription:"This rule forbids PLAYER_NAME to use any words longer than set limit and limits number of words too. Both limits are configurable independently. Doesn't affect OOC text, but does affect whispers.",triggerTexts:{infoBeep:"You broke the doll talk rule!",attempt_log:"PLAYER_NAME tried to break the doll talk rule",log:"PLAYER_NAME broke the doll talk rule"},defaultLimit:ConditionsLimit.normal,dataDefinition:{maxWordLength:{type:"number",default:6,description:"Max. character length of any word:",Y:420},maxNumberOfWords:{type:"number",default:5,description:"Max. number of words per message:",Y:570}},init(e){const t=t=>{var o,n;if("Chat"!==t.type&&"Whisper"!==t.type||!(null===(o=e.customData)||void 0===o?void 0:o.maxWordLength)||!e.customData.maxNumberOfWords)return!0;const r=Array.from((null!==(n=t.noOOCMessage)&&void 0!==n?n:t.originalMessage).matchAll(/[^\t\p{Z}\v.:!?~,;^]+/gmu)).map((e=>e[0]));return!(r.length>e.customData.maxNumberOfWords)&&!r.some((t=>t.length>e.customData.maxWordLength))};registerSpeechHook({allowSend:o=>!(e.isEnforced&&!t(o))||(e.triggerAttempt(),!1),onSend:o=>{e.inEffect&&!t(o)&&e.trigger()}})}}),registerRule("speech_ban_words",{name:"Forbid saying certain words in chat",icon:"Icons/Chat.png",shortDescription:"based on a configurable blacklist",longDescription:"This rule forbids PLAYER_NAME to use certain words in the chat. The list of banned words can be configured. Checks are not case sensitive (forbidding 'no' also forbids 'NO' and 'No'). Doesn't affect emotes and OOC text, but does affect whispers.",triggerTexts:{infoBeep:"You are not allowed to use the word 'USED_WORD'!",attempt_log:"PLAYER_NAME tried to use the banned word 'USED_WORD'",log:"PLAYER_NAME used the banned word 'USED_WORD'"},defaultLimit:ConditionsLimit.normal,dataDefinition:{bannedWords:{type:"stringList",default:[],description:"All forbidden words:"}},init(e){let t;const o=o=>{var n,r,i;if("Chat"!==o.type&&"Whisper"!==o.type||!(null===(n=e.customData)||void 0===n?void 0:n.bannedWords))return!0;const a=Array.from((null!==(r=o.noOOCMessage)&&void 0!==r?r:o.originalMessage).toLocaleLowerCase().matchAll(/\p{L}+/giu)).map((e=>e[0]));return t=null===(i=e.customData)||void 0===i?void 0:i.bannedWords.find((e=>a.includes(e.toLocaleLowerCase()))),void 0===t};registerSpeechHook({allowSend:n=>!(e.isEnforced&&!o(n)&&void 0!==t)||(e.triggerAttempt({USED_WORD:t}),!1),onSend:n=>{e.inEffect&&!o(n)&&void 0!==t&&e.trigger({USED_WORD:t})}})}}),registerRule("speech_forbid_open_talking",{name:"Forbid talking openly",icon:"Icons/Chat.png",shortDescription:"in a chat room",longDescription:"This rule forbids PLAYER_NAME to send any message to all people inside a chat room. Does not affect whispers or emotes, but does affect OOC.",triggerTexts:{infoBeep:"You are not allowed to talk openly in chatrooms!",attempt_log:"PLAYER_NAME tried to openly speak in a room",log:"PLAYER_NAME spoke openly in a room"},defaultLimit:ConditionsLimit.blocked,init(e){const t=e=>"Chat"!==e.type;registerSpeechHook({allowSend:o=>!(e.isEnforced&&!t(o))||(e.triggerAttempt(),!1),onSend:o=>{e.inEffect&&!t(o)&&e.trigger()}})}}),registerRule("speech_restrict_whisper_send",{name:"Restrict sending whispers",icon:"Icons/Chat.png",shortDescription:"except to defined roles",longDescription:"This rule forbids PLAYER_NAME to whisper anything to most people inside a chat room, except to the defined roles. Also affects whispered OOC messages.",triggerTexts:{infoBeep:"You are not allowed to whisper to TARGET_PLAYER!",attempt_log:"PLAYER_NAME tried to whisper to TARGET_PLAYER",log:"PLAYER_NAME whispered to TARGET_PLAYER"},defaultLimit:ConditionsLimit.limited,dataDefinition:{minimumPermittedRole:{type:"roleSelector",default:AccessLevel.mistress,description:"Minimum role whispering is still allowed to:"}},init(e){const t=t=>{var o;const n=t.target&&getChatroomCharacter(t.target);return"Whisper"!==t.type||!n||!(null===(o=e.customData)||void 0===o?void 0:o.minimumPermittedRole)||getCharacterAccessLevel(n)<=e.customData.minimumPermittedRole};registerSpeechHook({allowSend:o=>!(e.isEnforced&&!t(o))||(e.triggerAttempt({TARGET_PLAYER:`${o.target?getCharacterName(o.target,"[unknown]"):"[unknown]"} (${o.target})`}),!1),onSend:o=>{e.inEffect&&!t(o)&&e.trigger({TARGET_PLAYER:`${o.target?getCharacterName(o.target,"[unknown]"):"[unknown]"} (${o.target})`})}})}}),registerRule("speech_restrict_whisper_receive",{name:"Restrict receiving whispers",icon:"Icons/Chat.png",loggable:!1,shortDescription:"except from defined roles",longDescription:"This rule prevents PLAYER_NAME from receiving any whispers, except from the defined roles. If someone tries to send PLAYER_NAME a whisper message while this rule blocks them from doing so, they get an auto reply whisper, if the rule has an auto reply set (text field is not empty). PLAYER_NAME won't get any indication that she would have received a whisper. This rule can also be used (by dommes) to prevent getting unwanted whispers from strangers in public.",defaultLimit:ConditionsLimit.blocked,dataDefinition:{minimumPermittedRole:{type:"roleSelector",default:AccessLevel.whitelist,description:"Minimum role still allowed to send whisper:",Y:480},autoreplyText:{type:"string",default:"PLAYER_NAME is currently forbidden to receive whispers.",description:"Auto replies blocked sender with this:",Y:320}},load(e){hookFunction("ChatRoomMessage",5,((t,o)=>{const n=t[0];if(isObject$1(n)&&"string"==typeof n.Content&&""!==n.Content&&"Whisper"===n.Type&&"number"==typeof n.Sender&&e.isEnforced&&e.customData){const t=getChatroomCharacter(n.Sender);if(t&&getCharacterAccessLevel(t)>=e.customData.minimumPermittedRole)return void(e.customData.autoreplyText&&ServerSend("ChatRoomChat",{Content:`[Automatic reply by BCX]\n${dictionaryProcess(e.customData.autoreplyText,{})}`,Type:"Whisper",Target:n.Sender}))}return o(t)}),ModuleCategory.Rules)}}),registerRule("speech_restrict_beep_send",{name:"Restrict sending beep messages",icon:"Icons/Chat.png",shortDescription:"except to selected members",longDescription:"This rule forbids PLAYER_NAME to send any beeps with message, except to the defined list of member numbers. Sending beeps without a message is not affected. Optionally, it can be set that PLAYER_NAME is only forbidden to send beeps while she is unable to use her hands (e.g. fixed to a cross).",triggerTexts:{infoBeep:"You broke the rule that forbids sending a beep message to TARGET_PLAYER!",attempt_log:"PLAYER_NAME broke a rule by trying to send a beep message to TARGET_PLAYER",log:"PLAYER_NAME broke a rule by sending a beep message to TARGET_PLAYER"},defaultLimit:ConditionsLimit.blocked,dataDefinition:{whitelistedMemberNumbers:{type:"memberNumberList",default:[],description:"Member numbers still allowed to be beeped:"},onlyWhenBound:{type:"toggle",default:!1,description:"Only in effect when unable to use hands",Y:76}},load(e){hookFunction("FriendListBeepMenuSend",5,((t,o)=>{var n;if(e.inEffect&&e.customData&&(null===(n=document.getElementById("FriendListBeepTextArea"))||void 0===n?void 0:n.value)&&null!=FriendListBeepTarget&&!e.customData.whitelistedMemberNumbers.includes(FriendListBeepTarget)&&(!Player.CanInteract()||!e.customData.onlyWhenBound)){if(e.isEnforced)return void e.triggerAttempt({TARGET_PLAYER:`${getCharacterName(FriendListBeepTarget,"[unknown]")} (${FriendListBeepTarget})`});e.trigger({TARGET_PLAYER:`${getCharacterName(FriendListBeepTarget,"[unknown]")} (${FriendListBeepTarget})`})}return o(t)}),ModuleCategory.Rules)}}),registerRule("speech_restrict_beep_receive",{name:"Restrict receiving beeps",icon:"Icons/Chat.png",loggable:!1,shortDescription:"and beep messages, except from selected members",longDescription:"This rule prevents PLAYER_NAME from receiving any beep (regardless if the beep carries a message or not), except for beeps from the defined list of member numbers. If someone tries to send PLAYER_NAME a beep message while this rule blocks them from doing so, they get an auto reply beep, if the rule has an auto reply set. PLAYER_NAME won't get any indication that she would have received a beep. Optionally, it can be set that PLAYER_NAME is only forbidden to send beeps while she is unable to use her hands (e.g. fixed to a cross).",defaultLimit:ConditionsLimit.blocked,dataDefinition:{whitelistedMemberNumbers:{type:"memberNumberList",default:[],description:"Member numbers still allowed to send beeps:",Y:430},autoreplyText:{type:"string",default:"PLAYER_NAME is currently forbidden to receive beeps.",description:"Auto replies blocked sender with this:",Y:280},onlyWhenBound:{type:"toggle",default:!1,description:"Only in effect when unable to use hands",Y:76}},load(e){hookFunction("ServerAccountBeep",5,((t,o)=>{const n=t[0];if(!isObject$1(n)||n.BeepType||"number"!=typeof n.MemberNumber||!e.isEnforced||!e.customData||e.customData.whitelistedMemberNumbers.includes(n.MemberNumber)||Player.CanInteract()&&e.customData.onlyWhenBound)return o(t);e.customData.autoreplyText&&ServerSend("AccountBeep",{MemberNumber:n.MemberNumber,BeepType:"",Message:`[Automatic reply by BCX]\n${dictionaryProcess(e.customData.autoreplyText,{})}`,IsSecret:!0})}),ModuleCategory.Rules)}}),registerRule("speech_greet_order",{name:"Order to greet club",icon:"Icons/Chat.png",loggable:!1,shortDescription:"when entering it through the login portal",longDescription:"PLAYER_NAME will automatically send all defined member numbers (if they are currently online) a beep the moment PLAYER_NAME joins the club or the moment she start BCX to make her presence known. Disconnects don't count as coming into the club again, as far as detectable. NOTE: Trigger conditions should not be selected when using this rule, as if you for instance select 'when in public room' the rule will only greet when you load BCX in a public room.",triggerTexts:{infoBeep:"A BCX rule made you greet one or more people (if currently online) with a beep.",attempt_log:"",log:""},defaultLimit:ConditionsLimit.blocked,dataDefinition:{toGreetMemberNumbers:{type:"memberNumberList",default:[],description:"Member numbers that will be greeted:"}},load(e){if(e.isEnforced&&e.customData){for(const t of e.customData.toGreetMemberNumbers)ServerSend("AccountBeep",{MemberNumber:t,BeepType:"",IsSecret:!0});e.customData.toGreetMemberNumbers.length>0&&BCX_setTimeout((()=>{e.trigger()}),5e3)}}}),registerRule("speech_block_antigarble",{name:"Forbid the antigarble option",icon:"Icons/Chat.png",shortDescription:"BCX's .antigarble command",longDescription:"This rule forbids PLAYER_NAME to use the antigarble command. Antigarble is a BCX feature that enables a BCX user to understand muffled voices from other gagged characters or when wearing a deafening item. If PLAYER_NAME should be forbidden to use the command, this rule should be used.",triggerTexts:{infoBeep:"You are not allowed to use the antigarble command!",attempt_log:"PLAYER_NAME tried to use the antigarble command",log:"PLAYER_NAME used the antigarble command"},defaultLimit:ConditionsLimit.normal}),registerRule("speech_force_retype",{name:"Force to retype",icon:"Icons/Chat.png",loggable:!1,shortDescription:"if sending a message in chat is rejected by BCX due to a rule violation",longDescription:"This rule forces PLAYER_NAME to retype any chat/whisper/emote/OOC message as a punishment when they try to send it and another enforced BCX speech rule determines that there is any rule violation in that message.",defaultLimit:ConditionsLimit.limited});let e=!1,t="";registerRule("greet_room_order",{name:"Order to greet room",icon:"Icons/Chat.png",shortDescription:"with a settable sentence when entering it newly",longDescription:"Sets a specific sentence that PLAYER_NAME must say loud after entering a room that is not empty. The sentence is autopopulating the chat window text input. When to say it is left to PLAYER_NAME, but when the rule is enforced, it is the only thing that can be said in this room after joining it. Disconnects don't count as coming into a new room again, as far as detectable.",triggerTexts:{infoBeep:"You broke the rule to greet this room like taught!",attempt_infoBeep:"You need to greet this room like taught!",attempt_log:"PLAYER_NAME almost broke a rule by not greeting the room like taught",log:"PLAYER_NAME broke a rule by not greeting the room like taught"},defaultLimit:ConditionsLimit.limited,dataDefinition:{greetingSentence:{type:"string",default:"",description:"The sentence that has to be used to greet any joined room:"}},load(o){hookFunction("ChatRoomSync",0,((n,r)=>{const i=n[0];i.Name!==t&&(e=!1),r(n);const a=document.getElementById("InputChat");a&&o.customData&&o.inEffect&&!e&&i.Name!==t&&(a.value=o.customData.greetingSentence)}),ModuleCategory.Rules)},init(o){const n=e=>{var t,n;return(null!==(t=e.noOOCMessage)&&void 0!==t?t:e.originalMessage).toLocaleLowerCase()===(null===(n=o.customData)||void 0===n?void 0:n.greetingSentence.toLocaleLowerCase())};registerSpeechHook({allowSend:r=>{var i;return!o.isEnforced||e||n(r)?(n(r)&&(e=!0),t=ChatRoomData.Name,!0):(o.triggerAttempt(),ChatRoomSendLocal(`You are expected to greet the room with "${null===(i=o.customData)||void 0===i?void 0:i.greetingSentence}".`),!1)},onSend:t=>{!o.inEffect||e||n(t)||(o.trigger(),e=!0)}})}}),registerRule("greet_new_guests",{name:"Greet new guests",icon:"Icons/Chat.png",loggable:!1,shortDescription:"when they join the current room",longDescription:"Forces PLAYER_NAME to greet people newly entering the current chat room with the set sentence. NOTE: Only PLAYER_NAME and the new guest can see the message not to make it spammy. After a new person has been greeted, she will not be greeted for 10 minutes after she left (including disconnect) the room PLAYER_NAME is in.",defaultLimit:ConditionsLimit.limited,dataDefinition:{greetingSentence:{type:"string",default:"",description:"The sentence that will be used to greet new guests:"}},load(e){const t=new Map;hookFunction("ChatRoomSyncMemberLeave",2,((e,o)=>{o(e);const n=e[0];t.has(n.SourceMemberNumber)&&t.set(n.SourceMemberNumber,Date.now()+6e5)}),ModuleCategory.Rules),hookFunction("ChatRoomAddCharacterToChatRoom",3,((o,n)=>{const r=ChatRoomCharacter.length;if(n(o),e.customData&&e.isEnforced&&r<ChatRoomCharacter.length){const n=o[0];void 0!==n.MemberNumber&&t.has(n.MemberNumber)&&t.get(n.MemberNumber)<Date.now()&&t.delete(n.MemberNumber),BCX_setTimeout((()=>{e.customData&&e.isEnforced&&ChatRoomCharacter.includes(n)&&void 0!==n.MemberNumber&&!(t.has(n.MemberNumber)&&t.get(n.MemberNumber)>=Date.now())&&(t.set(n.MemberNumber,0),ServerSend("ChatRoomChat",{Content:e.customData.greetingSentence,Type:"Chat",Target:n.MemberNumber}),ServerSend("ChatRoomChat",{Content:e.customData.greetingSentence,Type:"Chat",Target:Player.MemberNumber}))}),5e3)}}),ModuleCategory.Rules)}}),registerRule("speech_alter_faltering",{name:"Enforce faltering speech",icon:"Icons/Chat.png",loggable:!1,shortDescription:"an enhanced studder effect is added to PLAYER_NAME's chat texts",longDescription:"Thus rule converts PLAYER_NAME's messages, so she is only able to speak studdering and with random filler sounds, for some [RP] reason (anxiousness, arousal, fear, etc.). Converts the typed chat text automatically. Affects chat messages and whispers, but not OOC.",defaultLimit:ConditionsLimit.limited,init(e){registerSpeechHook({modify:(t,o)=>!e.inEffect||"Chat"!==t.type&&"Whisper"!==t.type?o:falteringSpeech(o)})}})}function initRules_other(){let e=Date.now(),t=!1;function o(){e=Date.now(),t=!1}registerRule("other_forbid_afk",{name:"Forbid going afk",icon:"Icons/Chest.png",enforceable:!1,shortDescription:"logs whenever PLAYER_NAME is inactive",longDescription:"This rule forbids PLAYER_NAME to go afk and logs when the allowed inactivity threshold is overstepped.",triggerTexts:{log:"PLAYER_NAME became inactive, which was forbidden",announce:""},defaultLimit:ConditionsLimit.blocked,dataDefinition:{minutesBeforeAfk:{type:"number",default:10,description:"Amount of minutes, before being considered inactive:"}},load(){AfkTimerEventsList.forEach((e=>document.addEventListener(e,o,!0)))},tick:o=>!!(!t&&o.inEffect&&o.customData&&Date.now()>e+60*o.customData.minutesBeforeAfk*1e3)&&(t=!0,o.trigger(),ChatRoomSendLocal("You broke a BCX rule by being inactive for too long. The transgression was logged."),!0),unload(){AfkTimerEventsList.forEach((e=>document.removeEventListener(e,o,!0)))}});let n=0;registerRule("other_constant_reminder",{name:"Listen to my voice",icon:"Icons/Chest.png",loggable:!1,enforceable:!1,shortDescription:"regularily show configurable sentences to PLAYER_NAME",longDescription:"This rule reminds or tells PLAYER_NAME one of the recorded sentences at random in a settable interval. Only PLAYER_NAME can see the set message and it is only shown if in a chat room.",defaultLimit:ConditionsLimit.limited,dataDefinition:{reminderText:{type:"stringList",default:[],description:"The sentences that will be shown at random:",Y:296},reminderFrequency:{type:"number",default:15,description:"Frequency of a sentence being shown (in minutes):",Y:715}},tick:e=>!!(e.inEffect&&e.customData&&e.customData.reminderText!==[]&&ServerPlayerIsInChatRoom()&&Date.now()>n+60*e.customData.reminderFrequency*1e3)&&(n=Date.now(),ChatRoomSendLocal("[Voice] "+e.customData.reminderText[Math.floor(Math.random()*e.customData.reminderText.length)]),!0)})}const CONDITIONS_CHECK_INTERVAL=2e3;function guard_ConditionsConditionRequirements(e){return isObject$1(e)&&(void 0===e.orLogic||!0===e.orLogic)&&(void 0===e.room||isObject$1(e.room)&&(void 0===e.room.inverted||!0===e.room.inverted)&&("public"===e.room.type||"private"===e.room.type))&&(void 0===e.roomName||isObject$1(e.roomName)&&(void 0===e.roomName.inverted||!0===e.roomName.inverted)&&"string"==typeof e.roomName.name)&&(void 0===e.role||isObject$1(e.role)&&(void 0===e.role.inverted||!0===e.role.inverted)&&"number"==typeof e.role.role&&void 0!==AccessLevel[e.role.role])&&(void 0===e.player||isObject$1(e.player)&&(void 0===e.player.inverted||!0===e.player.inverted)&&"number"==typeof e.player.memberNumber)}function guard_ConditionsConditionPublicData(e,t,o){const n=o,r=conditionHandlers.get(e);return!!r&&(r.loadValidateConditionKey(t)&&isObject$1(n)&&"boolean"==typeof n.active&&"boolean"==typeof n.favorite&&(null===n.timer||"number"==typeof n.timer)&&"boolean"==typeof n.timerRemove&&(null===n.requirements||guard_ConditionsConditionRequirements(n.requirements))&&r.validatePublicData(t,n.data))}function guard_ConditionsCategoryPublicData(e,t,o=!1){const n=t,r=conditionHandlers.get(e);return!!r&&(isObject$1(n)&&"boolean"==typeof n.access_normal&&"boolean"==typeof n.access_limited&&"boolean"==typeof n.access_configure&&"boolean"==typeof n.access_changeLimits&&(null===n.highestRoleInRoom||"number"==typeof n.highestRoleInRoom&&void 0!==AccessLevel[n.highestRoleInRoom])&&isObject$1(n.conditions)&&Object.entries(n.conditions).every((([t,r])=>{const i=guard_ConditionsConditionPublicData(e,t,r);return!i&&o?(console.warn(`BCX: Removing invalid ${t}:${e} condition from public data`,r),delete n.conditions[t],!0):i}))&&(null===n.timer||"number"==typeof n.timer)&&"boolean"==typeof n.timerRemove&&r.validateCategorySpecificGlobalData(n.data)&&guard_ConditionsConditionRequirements(n.requirements)&&isObject$1(n.limits)&&Object.entries(n.limits).every((([e,t])=>void 0===t||"number"==typeof t&&void 0!==ConditionsLimit[t])))}const conditionHandlers=new Map;function ConditionsRegisterCategory(e,t){if(moduleInitPhase!==ModuleInitPhase.init)throw new Error("Conditions categories can be registered only during init");if(conditionHandlers.has(e))throw new Error(`Conditions categories "${e}" already defined!`);conditionHandlers.set(e,t)}function ConditionsGetCategoryHandler(e){const t=conditionHandlers.get(e);if(!t)throw new Error(`No handler for conditions category ${e}`);return t}function ConditionsGetCategoryEnabled(e){return moduleIsEnabled(ConditionsGetCategoryHandler(e).category)}function ConditionsGetCategoryData(e){var t;if(!conditionHandlers.has(e))throw new Error(`Attempt to get unknown conditions category data ${e}`);const o=null===(t=modStorage.conditions)||void 0===t?void 0:t[e];if(!o)throw new Error(`Attempt to get data for uninitialized category ${e}`);return o}function ConditionsMakeConditionPublicData(e,t,o){var n,r,i;return{active:o.active,data:e.makePublicData(t,o),timer:null!==(n=o.timer)&&void 0!==n?n:null,timerRemove:null!==(r=o.timerRemove)&&void 0!==r&&r,requirements:o.requirements?cloneDeep(o.requirements):null,favorite:null!==(i=o.favorite)&&void 0!==i&&i}}function ConditionsGetCategoryPublicData(e,t){var o,n;const r=ConditionsGetCategoryHandler(e),i=ConditionsGetCategoryData(e),a={access_normal:checkPermissionAccess(r.permission_normal,t),access_limited:checkPermissionAccess(r.permission_limited,t),access_configure:checkPermissionAccess(r.permission_configure,t),access_changeLimits:checkPermissionAccess(r.permission_changeLimits,t),highestRoleInRoom:getHighestRoleInRoom(),conditions:{},timer:null!==(o=i.timer)&&void 0!==o?o:null,timerRemove:null!==(n=i.timerRemove)&&void 0!==n&&n,data:cloneDeep(i.data),limits:{...r.getDefaultLimits(),...i.limits},requirements:cloneDeep(i.requirements)};for(const[e,t]of Object.entries(i.conditions))a.conditions[e]=ConditionsMakeConditionPublicData(r,e,t);return a}function ConditionsGetCondition(e,t){if(ConditionsGetCategoryEnabled(e))return ConditionsGetCategoryData(e).conditions[t]}function ConditionsIsConditionInEffect(e,t){var o;if(!ConditionsGetCategoryEnabled(e))return!1;const n=ConditionsGetCategoryData(e),r=n.conditions[t];if(!r)return!1;if(void 0!==r.timer&&r.timer<=Date.now())return!1;if(!r.active)return!1;return!!ConditionsEvaluateRequirements(null!==(o=r.requirements)&&void 0!==o?o:n.requirements)}function ConditionsSetCondition(e,t,o){if(!moduleIsEnabled(ConditionsGetCategoryHandler(e).category))return;const n=ConditionsGetCategoryData(e),r=n.conditions[t];r?r.data=o:n.conditions[t]={active:!0,lastActive:!1,timer:void 0!==n.timer?Date.now()+n.timer:void 0,timerRemove:n.timerRemove,data:o},modStorageSync(),notifyOfChange()}function ConditionsGetConditionLimit(e,t){var o,n;const r=ConditionsGetCategoryHandler(e);if(!moduleIsEnabled(r.category))return ConditionsLimit.blocked;return null!==(n=null!==(o=ConditionsGetCategoryData(e).limits[t])&&void 0!==o?o:r.getDefaultLimits()[t])&&void 0!==n?n:ConditionsLimit.normal}function ConditionsCheckAccess(e,t,o){const n=ConditionsGetConditionLimit(e,t);if(n===ConditionsLimit.blocked)return!1;const r=ConditionsGetCategoryHandler(e);return checkPermissionAccess(n===ConditionsLimit.limited?r.permission_limited:r.permission_normal,o)}function ConditionsRemoveCondition(e,t){if(!ConditionsGetCategoryEnabled(e))return!1;Array.isArray(t)||(t=[t]);const o=ConditionsGetCategoryData(e),n=ConditionsGetCategoryHandler(e);let r=!1;for(const e of t)o.conditions[e]&&(n.stateChangeHandler(e,o.conditions[e],!1),delete o.conditions[e],r=!0);return r&&(modStorageSync(),notifyOfChange()),r}function ConditionsSetLimit(e,t,o,n){var r,i;const a=ConditionsGetCategoryHandler(e);if(!moduleIsEnabled(a.category))return!1;if(!a.loadValidateConditionKey(t))return console.warn(`Attempt to set invalid condition limit ${e}:${t}`),!1;const s=ConditionsGetCategoryData(e);if(n&&!checkPermissionAccess(a.permission_changeLimits,n))return!1;if(void 0!==s.conditions[t])return!1;const l=null!==(r=a.getDefaultLimits()[t])&&void 0!==r?r:ConditionsLimit.normal,c=null!==(i=s.limits[t])&&void 0!==i?i:l;return c===o||(o===l?delete s.limits[t]:s.limits[t]=o,n&&a.logLimitChange(t,n,o,c),notifyOfChange(),modStorageSync()),!0}function ConditionsUpdate(e,t,o,n){const r=ConditionsGetCategoryHandler(e);if(!moduleIsEnabled(r.category))return!1;if(n&&!ConditionsCheckAccess(e,t,n))return!1;const i=ConditionsGetCondition(e,t);if(!i)return!1;const a=ConditionsMakeConditionPublicData(r,t,i);if(!r.updateCondition(t,i,o.data,n,o))return!1;if(i.active=o.active,o.favorite?i.favorite=!0:delete i.favorite,o.requirements){i.requirements=o.requirements;const e=i.requirements,t=!!(e.room||e.roomName||e.role||e.player);e.orLogic&&!t&&delete e.orLogic}else delete i.requirements;return null!==o.timer?i.timer=o.timer:delete i.timer,o.timerRemove&&o.active?i.timerRemove=!0:delete i.timerRemove,n&&r.logConditionUpdate(t,n,o,a),notifyOfChange(),modStorageSync(),!0}function ConditionsCategoryUpdate(e,t,o){const n=ConditionsGetCategoryHandler(e);if(!moduleIsEnabled(n.category))return!1;if(o&&!checkPermissionAccess(n.permission_configure,o))return!1;const r=ConditionsGetCategoryData(e);if(!r)return!1;const i=o&&ConditionsGetCategoryPublicData(e,o);r.requirements=t.requirements;const a=r.requirements,s=!!(a.room||a.roomName||a.role||a.player);return a.orLogic&&!s&&delete a.orLogic,null!==t.timer?r.timer=t.timer:delete r.timer,t.timerRemove?r.timerRemove=!0:delete r.timerRemove,r.data=cloneDeep(t.data),o&&i&&n.logCategoryUpdate(o,t,i),notifyOfChange(),modStorageSync(),!0}function ConditionsEvaluateRequirements(e,t){const o=ServerPlayerIsInChatRoom(),n=o&&ChatRoomData&&ChatRoomData.Private,r=[];if(e.room){const t=o&&("public"===e.room.type?!n:n);r.push(e.room.inverted?!t:t)}if(e.roomName){const t=o&&ChatRoomData&&"string"==typeof ChatRoomData.Name&&ChatRoomData.Name.toLocaleLowerCase()===e.roomName.name.toLocaleLowerCase();r.push(e.roomName.inverted?!t:t)}if(e.role){void 0===t&&(t=getHighestRoleInRoom());const o=null!=t&&t<=e.role.role;r.push(e.role.inverted?!o:o)}if(e.player){const t=o&&getAllCharactersInRoom().some((t=>t.MemberNumber===e.player.memberNumber));r.push(e.player.inverted?!t:t)}return 0===r.length||(e.orLogic?r.includes(!0):!r.includes(!1))}const ConditionsSubcommands=["setactive","triggers","globaltriggers","timer","defaulttimer","setlimit"],ConditionsCommandTriggersKeywords=["room","roomname","role","player"];function ConditionsCommandProcessTriggers(e,t,o,n){const r=(t[0]||"").toLocaleLowerCase(),i=(t[1]||"").toLocaleLowerCase();if("ignore"===i&&2!==t.length)return n(`Error:\n'${r} ignore' does not expect any extra arguments.`),!0;if(!["is","isnot","with","notwith"].includes(i))return n(`Error:\nUnknown setting '${i}'. please use one of: ${"room"===r||"roomname"===r?"is, isnot":"with, notwith"}`),!0;if(3!==t.length)return n(`Error:\n'${r} ${i} <value>' got too many arguments. Arguments with space need to be "quoted".`),!0;const a="isnot"===i||"notwith"===i||void 0;let s=t[2];if("room"===r){if("ignore"===i)return delete e.room,!1;if(s=s.toLocaleLowerCase(),"public"!==s&&"private"!==s)return n(`Error:\nRoom can be either 'public' or 'private', got: '${s}'`),!0;e.room={type:s,inverted:a}}else if("roomname"===r){if("ignore"===i)return delete e.roomName,!1;e.roomName={name:s,inverted:a}}else if("role"===r){if("ignore"===i)return delete e.role,!1;const t=AccessLevel[s.toLocaleLowerCase()];if("number"!=typeof t||t===AccessLevel.self)return n(`Error:\n'role ${i}' expects one of: clubowner, owner, lover, mistress, whitelist, friend, public; got: '${s.toLocaleLowerCase()}'`),!0;e.role={role:t,inverted:a}}else if("player"===r){if("ignore"===i)return delete e.player,!1;const t=Command_selectCharacterMemberNumber(s,!0);if("string"==typeof t)return n(t),!0;e.player={memberNumber:t,inverted:a}}return!1}function ConditionsCommandTriggersAutocomplete(e,t){const o=(e[0]||"").toLocaleLowerCase();return e.length<2?[]:"room"===o&&2===e.length?Command_pickAutocomplete(e[1],["ignore","is","isnot"]):"room"===o&&3===e.length?Command_pickAutocomplete(e[2],["public","private"]):"roomname"===o&&2===e.length?Command_pickAutocomplete(e[1],["ignore","is","isnot"]):"role"===o&&2===e.length?Command_pickAutocomplete(e[1],["ignore","with","notwith"]):"role"===o&&3===e.length?Command_pickAutocomplete(e[2],["clubowner","owner","lover","mistress","whitelist","friend","public"]):"player"===o&&2===e.length?Command_pickAutocomplete(e[1],["ignore","with","notwith"]):"player"===o&&3===e.length?Command_selectCharacterAutocomplete(e[2]):[]}function ConditionsRunSubcommand(e,t,o,n){const r=(t[0]||"").toLocaleLowerCase();if(!ConditionsSubcommands.includes(r))throw new Error(`Subcomand "${r}" passed to ConditionsRunSubcommand isn't valid ConditionsSubcommand`);const i=conditionHandlers.get(e);if(!i)throw new Error(`Attempt to run command for unknown conditions category ${e}`);if(!moduleIsEnabled(i.category))return n(`The command failed to execute, because ${Player.Name} disabled her ${MODULE_NAMES[i.category]} module.`);const a=ConditionsGetCategoryData(e),s=e.slice(0,-1),l=i.commandConditionSelectorHelp;if("setactive"===r){const r=(t[2]||"").toLocaleLowerCase();if(3!==t.length||"yes"!==r&&"no"!==r)return n(`Usage:\nsetactive <${l}> <yes/no>`);const[c,u]=i.parseConditionName(t[1],Object.keys(a.conditions));if(!c)return n(u);if(!a.conditions[u])return n(`This ${s} doesn't exist`);const d=ConditionsMakeConditionPublicData(i,u,a.conditions[u]);d.active="yes"===r,n(ConditionsUpdate(e,u,d,o)?"Ok.":COMMAND_GENERIC_ERROR)}else if("triggers"===r){const[r,c]=i.parseConditionName(t[1]||"",Object.keys(a.conditions));if(!r)return n(c);if(!a.conditions[c])return n(`This ${s} doesn't exist`);const u=ConditionsMakeConditionPublicData(i,c,a.conditions[c]),d=(t[2]||"").toLocaleLowerCase();if(!d){if(u.requirements){const e=[],t=u.requirements;if(e.push(t.orLogic?"Logic: OR (at least one)":"Logic: AND (all of)"),t.room&&e.push(`When ${t.room.inverted?"not in":"in"} ${t.room.type} room`),t.roomName&&e.push(`When ${t.roomName.inverted?"not in":"in"} room named '${t.roomName.name}'`),t.role){const o=capitalizeFirstLetter(AccessLevel[t.role.role])+(t.role.role!==AccessLevel.clubowner?" ":"");e.push(`When ${t.role.inverted?"not in":"in"} room with role '${o}'`)}if(t.player){const o=getCharacterName(t.player.memberNumber,null);e.push(`When ${t.player.inverted?"not in":"in"} room with member '${t.player.memberNumber}'${o?` (${o})`:""}`)}return e.length>1?n(`Current status:\nThis ${s} will trigger under following conditions:\n`+e.join("\n")):n(`Current status:\nNo triggers are set. The ${s} will now always trigger, while it is active`)}return n(`Current status:\nUses global ${e} trigger configuration`)}if("global"===d){const e=(t[3]||"").toLocaleLowerCase();if(4!==t.length||"yes"!==e&&"no"!==e)return n(`Usage:\ntriggers <${l}> global <yes/no>`);"yes"===e?u.requirements=null:u.requirements||(u.requirements=cloneDeep(a.requirements))}else if("logic"===d){const e=(t[3]||"").toLocaleLowerCase();if(4!==t.length||"or"!==e&&"and"!==e)return n(`Usage:\ntriggers <${l}> logic <or/and>`);if(!u.requirements)return n(`Cannot configure specific trigger while using global data. First use:\ntriggers <${l}> global no`);"or"===e?u.requirements.orLogic=!0:delete u.requirements.orLogic}else{if(!ConditionsCommandTriggersKeywords.includes(d))return n(`${"help"!==d?`Unknown trigger '${d}'. `:""}List of possible 'triggers <${l}> *' options:\nglobal <yes/no> - Set the trigger condition of this ${s} to the global configuration\nlogic <or/and>\t- Set if the logic should be OR (at least one) or AND (all of) logic; default is AND\nroom ignore - Remove the 'room type'-based trigger condition\nroom <is/isnot> <public/private> - Add such a 'room type'-based trigger condition\nroomname ignore - Remove the 'room name'-based trigger condition\nroomname <is/isnot> <name> - Add such a 'room name'-based trigger condition\nrole ignore - Remove the role-based trigger condition\nrole <with/notwith> <role> - Add such a role-based trigger condition\nplayer ignore - Remove the person-based trigger condition\nplayer <with/notwith> <memberNumber> - Add such a person-based trigger condition\n\nTo show currently set triggers, use just 'triggers <group>' without adding one of the above sub-commands.`);if(!u.requirements)return n(`Cannot configure specific trigger while using global data. First use:\ntriggers <${l}> global no`);if(ConditionsCommandProcessTriggers(u.requirements,t.slice(2),o,n))return}n(ConditionsUpdate(e,c,u,o)?"Ok.":COMMAND_GENERIC_ERROR)}else if("globaltriggers"===r){const r=ConditionsGetCategoryPublicData(e,o);if(!t[1]){const t=[],o=r.requirements;if(t.push(o.orLogic?"Logic: OR (at least one)":"Logic: AND (all of)"),o.room&&t.push(`When ${o.room.inverted?"not in":"in"} ${o.room.type} room`),o.roomName&&t.push(`When ${o.roomName.inverted?"not in":"in"} room named '${o.roomName.name}'`),o.role){const e=capitalizeFirstLetter(AccessLevel[o.role.role])+(o.role.role!==AccessLevel.clubowner?" ":"");t.push(`When ${o.role.inverted?"not in":"in"} room with role '${e}'`)}if(o.player){const e=getCharacterName(o.player.memberNumber,null);t.push(`When ${o.player.inverted?"not in":"in"} room with member '${o.player.memberNumber}'${e?` (${e})`:""}`)}return t.length>1?n(`Current status:\nGlobally ${e} are set to trigger under following conditions:\n`+t.join("\n")):n(`Current status:\nNo triggers are set globally. ${capitalizeFirstLetter(e)} using global config will now always trigger, if they are active`)}if("logic"===t[1].toLocaleLowerCase()){const e=(t[2]||"").toLocaleLowerCase();if(3!==t.length||"or"!==e&&"and"!==e)return n("Usage:\nglobaltriggers logic <or/and>");"or"===e?r.requirements.orLogic=!0:delete r.requirements.orLogic}else{if(!ConditionsCommandTriggersKeywords.includes(t[1].toLocaleLowerCase()))return n(("help"!==t[1]?`Unknown trigger '${t[1].toLocaleLowerCase()}'. `:"")+"List of possible 'globaltriggers *' options:\nlogic <or/and>\t- Set if the logic should be OR (at least one) or AND (all of) logic; default is AND\nroom ignore - Remove the 'room type'-based trigger condition\nroom <is/isnot> <public/private> - Add such a 'room type'-based trigger condition\nroomname ignore - Remove the 'room name'-based trigger condition\nroomname <is/isnot> <name> - Add such a 'room name'-based trigger condition\nrole ignore - Remove the role-based trigger condition\nrole <with/notwith> <role> - Add such a role-based trigger condition\nplayer ignore - Remove the person-based trigger condition\nplayer <with/notwith> <memberNumber> - Add such a person-based trigger condition\n\nTo show currently set global triggers, use just 'globaltriggers' without anything behind.");if(ConditionsCommandProcessTriggers(r.requirements,t.slice(1),o,n))return}n(ConditionsCategoryUpdate(e,r,o)?"Ok.":COMMAND_GENERIC_ERROR)}else if("timer"===r){const[r,c]=i.parseConditionName(t[1]||"",Object.keys(a.conditions));if(!r)return n(c);if(!a.conditions[c])return n(`This ${s} doesn't exist`);const u=(t[2]||"").toLocaleLowerCase();if("set"!==u&&"disable"!==u&&"autoremove"!==u)return n(`Usage:\ntimer <${l}> disable - Remove the timer and set lifetime to infinite\ntimer <${l}> set <time> - Set timer to the given amount of days, hours, minutes or seconds (e.g. 23h 30m)\ntimer <${l}> autoremove <yes/no> - Set if the ${s} is removed when the timer runs out or just disables itself`);const d=ConditionsMakeConditionPublicData(i,c,a.conditions[c]);if("disable"===u)d.timer=null,d.timerRemove=!1;else if("set"===u){let e=0;for(const o of t.slice(3)){const t=Command_parseTime(o);if("string"==typeof t)return n(t);e+=t}d.timer=Date.now()+e}else if("autoremove"===u){const e=(t[3]||"").toLocaleLowerCase();if(4!==t.length||"yes"!==e&&"no"!==e)return n(`Usage:\ntimer <${l}> autoremove <yes/no>`);if(!d.active)return n(`Timer is counting until ${s} becomes enabled, cannot use autoremove in this mode.`);if(null===d.timer)return n(`Timer is disabled on this ${s}. To use autoremove, first set timer`);d.timerRemove="yes"===e}n(ConditionsUpdate(e,c,d,o)?"Ok.":COMMAND_GENERIC_ERROR)}else if("defaulttimer"===r){const r=(t[1]||"").toLocaleLowerCase();if("set"!==r&&"disable"!==r&&"autoremove"!==r)return n(`Usage:\ndefaulttimer disable - Remove the timer and set lifetime to infinite\ndefaulttimer set <time> - Set timer to the given amount of days, hours, minutes or seconds (e.g. 23h 30m)\ndefaulttimer autoremove <yes/no> - Set if the ${s} is removed when the timer runs out or just disables itself`);const i=ConditionsGetCategoryPublicData(e,o);if("disable"===r)i.timer=null,i.timerRemove=!1;else if("set"===r){let e=0;for(const o of t.slice(2)){const t=Command_parseTime(o);if("string"==typeof t)return n(t);e+=t}i.timer=e}else if("autoremove"===r){const o=(t[2]||"").toLocaleLowerCase();if(3!==t.length||"yes"!==o&&"no"!==o)return n(`Usage:\ndefaulttimer <${l}> autoremove <yes/no>`);if(null===i.timer)return n(`Timer is disabled by default for ${e}. To use autoremove, first set timer`);i.timerRemove="yes"===o}n(ConditionsCategoryUpdate(e,i,o)?"Ok.":COMMAND_GENERIC_ERROR)}else if("setlimit"===r){const[r,a]=i.parseConditionName(t[1]||"",!1);if(!r)return n(a);if(!i.loadValidateConditionKey(a))throw new Error("Parse name returned invalid condition key");const s=(t[2]||"").toLocaleLowerCase();if("normal"!==s&&"limited"!==s&&"blocked"!==s)return n(`Usage:\nsetlimit <${l}> <normal/limited/blocked> - Set a limit on certain <${l}>`);n(ConditionsSetLimit(e,a,ConditionsLimit[s],o)?"Ok.":COMMAND_GENERIC_ERROR)}}function ConditionsAutocompleteSubcommand(e,t,o){const n=(t[0]||"").toLocaleLowerCase();if(!ConditionsSubcommands.includes(n))throw new Error(`Subcomand "${n}" passed to ConditionsAutocompleteSubcommand isn't valid ConditionsSubcommand`);const r=conditionHandlers.get(e);if(!r)throw new Error(`Attempt to autocomplete command for unknown conditions category ${e}`);if(!moduleIsEnabled(r.category))return[];const i=ConditionsGetCategoryData(e);if("setactive"===n){if(2===t.length)return r.autocompleteConditionName(t[1],Object.keys(i.conditions));if(3===t.length)return Command_pickAutocomplete(t[2],["yes","no"])}else if("triggers"===n){if(2===t.length)return r.autocompleteConditionName(t[1],Object.keys(i.conditions));const[e,n]=r.parseConditionName(t[1]||"",Object.keys(i.conditions));if(!e||!i.conditions[n])return[];if(3===t.length)return Command_pickAutocomplete(t[2],["global","logic",...ConditionsCommandTriggersKeywords]);if("global"===t[2].toLocaleLowerCase())return Command_pickAutocomplete(t[3],["yes","no"]);if("logic"===t[2].toLocaleLowerCase())return Command_pickAutocomplete(t[3],["and","or"]);if(i.conditions[n].requirements&&ConditionsCommandTriggersKeywords.includes(t[2].toLocaleLowerCase()))return ConditionsCommandTriggersAutocomplete(t.slice(2),o)}else if("globaltriggers"===n){if(2===t.length)return Command_pickAutocomplete(t[1],["logic",...ConditionsCommandTriggersKeywords]);if("logic"===t[1].toLocaleLowerCase())return Command_pickAutocomplete(t[2],["and","or"]);if(ConditionsCommandTriggersKeywords.includes(t[2].toLocaleLowerCase()))return ConditionsCommandTriggersAutocomplete(t.slice(1),o)}else if("timer"===n){if(2===t.length)return r.autocompleteConditionName(t[1],Object.keys(i.conditions));if(3===t.length)return Command_pickAutocomplete(t[2],["set","disable","autoremove"]);if(4===t.length&&"autoremove"===t[2].toLocaleLowerCase())return Command_pickAutocomplete(t[3],["yes","no"])}else if("defaulttimer"===n){if(2===t.length)return Command_pickAutocomplete(t[1],["set","disable","autoremove"]);if(3===t.length&&"autoremove"===t[1].toLocaleLowerCase())return Command_pickAutocomplete(t[2],["yes","no"])}else if("setlimit"===n){if(2===t.length)return r.autocompleteConditionName(t[1],!1);if(3===t.length)return Command_pickAutocomplete(t[2],["normal","limited","blocked"])}return[]}class ModuleConditions extends BaseModule{constructor(){super(...arguments),this.timer=null}load(){var e;if(isObject$1(modStorage.conditions)||(modStorage.conditions={}),modStorage.cursedItems){const e=modStorage.conditions.curses={conditions:{},limits:{},requirements:{},data:{itemRemove:!1}};for(const[t,o]of Object.entries(modStorage.cursedItems))e.conditions[t]={active:!0,lastActive:!1,data:o};delete modStorage.cursedItems}for(const t of Object.keys(modStorage.conditions)){const o=conditionHandlers.get(t);if(!o||!moduleIsEnabled(o.category)){console.debug(`BCX: Removing unknown or disabled conditions category ${t}`),delete modStorage.conditions[t];continue}const n=modStorage.conditions[t];if(isObject$1(n)&&isObject$1(n.conditions)){void 0!==n.timer&&"number"!=typeof n.timer&&(console.warn(`BCX: Removing category ${t} invalid timer`,n.timer),delete n.timer),void 0!==n.timerRemove&&!0!==n.timerRemove&&(console.warn(`BCX: Removing category ${t} invalid timerRemove`,n.timerRemove),delete n.timerRemove),isObject$1(n.limits)||(console.warn(`BCX: Resetting category ${t} limits with invalid data`),n.limits={});for(const[r,i]of Object.entries(n.limits))o.loadValidateConditionKey(r)?"number"==typeof i&&i!==(null!==(e=o.getDefaultLimits()[r])&&void 0!==e?e:ConditionsLimit.normal)&&void 0!==ConditionsLimit[i]||(console.warn(`BCX: Bad condition ${t}:${r} limit value, removing it`,i),delete n.limits[r]):(console.warn(`BCX: Unknown condition ${t}:${r} limit, removing it`),delete n.limits[r]);guard_ConditionsConditionRequirements(n.requirements)||(console.warn(`BCX: Resetting category ${t} requirements with invalid data`),n.requirements={}),n.data=o.loadCategorySpecificGlobalData(n.data);for(const[e,r]of Object.entries(n.conditions))o.loadValidateConditionKey(e)?o.loadValidateCondition(e,r)?"boolean"!=typeof r.active||void 0!==r.requirements&&!guard_ConditionsConditionRequirements(r.requirements)||void 0!==r.timer&&"number"!=typeof r.timer||void 0!==r.timerRemove&&!0!==r.timerRemove||void 0!==r.favorite&&!0!==r.favorite?(console.warn(`BCX: Condition ${t}:${e} has bad data, removing it`),delete n.conditions[e]):ConditionsGetConditionLimit(t,e)!==ConditionsLimit.blocked?(r.timerRemove&&!r.active&&(console.warn(`BCX: Condition ${t}:${e} had timerRemove while inactive, cleaning up`),delete r.timerRemove),"boolean"!=typeof r.lastActive&&(console.warn(`BCX: Condition ${t}:${e} missing lastActive, adding`),r.lastActive=!1)):(console.warn(`BCX: Condition ${t}:${e} became blocked while active, removing it`),delete n.conditions[e]):delete n.conditions[e]:(console.warn(`BCX: Unknown condition ${t}:${e}, removing it`),delete n.conditions[e])}else console.warn(`BCX: Removing category ${t} with invalid data`),delete modStorage.conditions[t]}for(const[e,t]of conditionHandlers.entries())moduleIsEnabled(t.category)&&!isObject$1(modStorage.conditions[e])&&(console.debug(`BCX: Adding missing conditions category ${e}`),modStorage.conditions[e]={conditions:{},limits:{},requirements:{},data:t.loadCategorySpecificGlobalData(void 0)});queryHandlers.conditionsGet=(e,t,o)=>{"string"==typeof o&&conditionHandlers.has(o)&&ConditionsGetCategoryEnabled(o)?t(!0,ConditionsGetCategoryPublicData(o,e)):t(!1)},queryHandlers.conditionSetLimit=(e,t,o)=>{isObject$1(o)&&"string"==typeof o.category&&conditionHandlers.has(o.category)&&"string"==typeof o.condition&&"number"==typeof o.limit&&void 0!==ConditionsLimit[o.limit]?t(!0,ConditionsSetLimit(o.category,o.condition,o.limit,e)):t(!1)},queryHandlers.conditionUpdate=(e,t,o)=>{isObject$1(o)&&"string"==typeof o.category&&conditionHandlers.has(o.category)&&"string"==typeof o.condition&&guard_ConditionsConditionPublicData(o.category,o.condition,o.data)?t(!0,ConditionsUpdate(o.category,o.condition,o.data,e)):t(!1)},queryHandlers.conditionCategoryUpdate=(e,t,o)=>{isObject$1(o)&&"string"==typeof o.category&&conditionHandlers.has(o.category)&&isObject$1(o.data)&&(null===o.data.timer||"number"==typeof o.data.timer)&&"boolean"==typeof o.data.timerRemove&&guard_ConditionsConditionRequirements(o.data.requirements)?t(!0,ConditionsCategoryUpdate(o.category,o.data,e)):t(!1)}}run(){this.timer=BCX_setInterval((()=>this.conditionsTick()),CONDITIONS_CHECK_INTERVAL)}unload(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)}reload(){this.unload(),this.load(),this.run()}conditionsTick(){var e,t;if(!ServerIsConnected||!modStorage.conditions)return;let o=!1;const n=Date.now();for(const[r,i]of conditionHandlers.entries()){const a=modStorage.conditions[r];if(moduleIsEnabled(i.category)&&a){for(const[t,s]of Object.entries(a.conditions)){if(void 0!==s.timer&&s.timer<=n){if(s.timerRemove&&s.active)return void ConditionsRemoveCondition(r,t);delete s.timer,delete s.timerRemove,s.active=!s.active,o=!0}const l=s.active&&ConditionsEvaluateRequirements(null!==(e=s.requirements)&&void 0!==e?e:a.requirements);if(l!==s.lastActive){s.lastActive=l,o=!0;const e=cloneDeep(s);i.stateChangeHandler(t,s,l),isEqual(e,s)||(o=!0)}if(!l)continue;const c=cloneDeep(s);i.tickHandler(t,s),isEqual(c,s)||(o=!0)}null===(t=i.afterTickHandler)||void 0===t||t.call(i)}}o&&(modStorageSync(),notifyOfChange())}}const RULES_ANTILOOP_RESET_INTERVAL=6e4,RULES_ANTILOOP_THRESHOLD=10,RULES_ANTILOOP_SUSPEND_TIME=6e5;function guard_BCX_Rule(e){return"string"==typeof e&&rules.has(e)}function guard_RuleCustomData(e,t){const o=rules.get(e);if(!o)return!1;if(o.dataDefinition){if(!isObject$1(t))return!1;for(const e of Object.keys(t))if(!o.dataDefinition[e])return!1;for(const[e,n]of Object.entries(o.dataDefinition)){const o=ruleCustomDataHandlers[n.type];if(!o||!o.validate(t[e],n))return!1}}else if(void 0!==t)return!1;return!0}const rules=new Map,rulesList=[];function registerRule(e,t){var o;if(moduleInitPhase!==ModuleInitPhase.init)throw new Error("Rules can be registered only during init");if(rules.has(e))throw new Error(`Rule "${e}" already defined!`);if(t.dataDefinition)for(const[o,n]of Object.entries(t.dataDefinition)){const t=ruleCustomDataHandlers[n.type];if(!t)throw new Error(`Unknown handler for ${e}:${o} (${n.type})`);if(t.validateOptions&&!t.validateOptions(n.options))throw new Error(`Bad options for ${e}:${o} (${n.type})`);const r="function"==typeof n.default?n.default():n.default;if(!t.validate(r,n))throw new Error(`Default doesn't validate for ${e}:${o} (${n.type})`)}if(t.internalDataValidate){if(!t.internalDataValidate(null===(o=t.internalDataDefault)||void 0===o?void 0:o.call(t)))throw new Error(`Default internal data doesn't validate for rule ${e}`)}else if(void 0!==t.internalDataDefault)throw new Error(`Default internal data for rule ${e} without internal data validation`);rules.set(e,{...t,state:new RuleState(e,t)}),rulesList.push(e)}function RulesGetDisplayDefinition(e){const t=rules.get(e);if(!t)throw new Error(`Attempt to get display definition for unknown rule '${e}'`);return{name:t.name,icon:t.icon,shortDescription:t.shortDescription,longDescription:t.longDescription,triggerTexts:t.triggerTexts,defaultLimit:t.defaultLimit,enforceable:t.enforceable,loggable:t.loggable,dataDefinition:t.dataDefinition}}function RulesGetRuleState(e){const t=rules.get(e);if(!t)throw new Error(`Attempt to get state for unknown rule '${e}'`);return t.state}const ruleCustomDataHandlerPage=new Map;let memberNumberListAutoFill=null;const ruleCustomDataHandlers={listSelect:{validateOptions:e=>Array.isArray(e)&&e.every((e=>Array.isArray(e)&&2===e.length&&e.every((e=>"string"==typeof e)))),validate:(e,t)=>"string"==typeof e&&t.options.map((e=>e[0])).includes(e),run({def:e,value:t,Y:o,access:n}){DrawTextFit(e.description,1050,o+0,900,"Black");const r=e.options.findIndex((e=>e[0]===t));if(r<0)throw new Error("Bad data during listSelect render");const i=clampWrap(r+1,0,e.options.length-1),a=clampWrap(r-1,0,e.options.length-1);MainCanvas.textAlign="center",DrawBackNextButton(1050,o+36,250,60,e.options[r][1],n?"White":"#ddd","",(()=>e.options[a][1]),(()=>e.options[i][1]),!n),MainCanvas.textAlign="left"},click({def:e,value:t,Y:o}){const n=e.options.findIndex((e=>e[0]===t));return MouseIn(1050,o+36,125,60)?e.options[clampWrap(n-1,0,e.options.length-1)][0]:MouseIn(1175,o+36,125,60)?e.options[clampWrap(n+1,0,e.options.length-1)][0]:void 0}},memberNumberList:{validate:e=>Array.isArray(e)&&e.every(Number.isInteger),onDataChange({active:e,key:t,access:o}){let n=document.getElementById(`BCX_RCDH_${t}`);e?(n||(n=ElementCreateInput(`BCX_RCDH_${t}`,"text","","100"),n.inputMode="numeric",n.pattern="[0-9]+",null!==memberNumberListAutoFill&&(n.value=`${memberNumberListAutoFill}`,memberNumberListAutoFill=null)),n.disabled=!o):n&&n.remove()},run({def:e,value:t,Y:o,key:n,access:r}){var i;o-=20;const a=Math.max(1,Math.ceil(t.length/4)),s=clamp(null!==(i=ruleCustomDataHandlerPage.get(n))&&void 0!==i?i:0,0,a-1);DrawTextFit(e.description,1050,o+0,900,"Black");for(let e=0;e<4;e++){const n=4*s+e;if(n>=t.length)break;MainCanvas.strokeRect(1050,o+26+70*e,766,64);const i=`${getCharacterName(t[n],"[unknown]")} (${t[n]})`;DrawTextFit(i,1060,o+26+70*e+34,380,"Black"),r&&(MainCanvas.textAlign="center",DrawButton(1836,o+26+70*e,64,64,"X","White"),MainCanvas.textAlign="left")}ElementPositionFix(`BCX_RCDH_${n}`,40,1050,o+280+43,360,60),MainCanvas.textAlign="center";const l=document.getElementById(`BCX_RCDH_${n}`);l&&document.activeElement===l&&DrawHoverElements.push((()=>{const e=l.value&&Number.parseInt(l.value,10);if(!e)return;MainCanvas.fillStyle="#FFFF88",MainCanvas.fillRect(580,630,450,65),MainCanvas.lineWidth=2,MainCanvas.strokeStyle="black",MainCanvas.strokeRect(580,630,450,65),DrawTextFit(getCharacterName(e,"[unknown]"),805,663,444,"black")})),DrawButton(1444,o+280+43,64,64,"",r?"White":"#ddd",void 0,void 0,!r),DrawImageEx("Icons/Title.png",1446,o+280+43,{Width:60,Height:60}),DrawButton(1530,o+280+43,100,64,"Add",r?"White":"#ddd",void 0,void 0,!r),DrawBackNextButton(1650,o+280+43,250,64,`Page ${s+1}/${a}`,"White",void 0,(()=>""),(()=>"")),MainCanvas.textAlign="left"},click({value:e,Y:t,key:o,target:n}){var r;t-=20;const i=Math.max(1,Math.ceil(e.length/4)),a=clamp(null!==(r=ruleCustomDataHandlerPage.get(o))&&void 0!==r?r:0,0,i-1);for(let o=0;o<4;o++){const n=4*a+o;if(n>=e.length)break;if(MouseIn(1836,t+26+70*o,64,64))return e.splice(n,1),e}const s=document.getElementById(`BCX_RCDH_${o}`),l=getCurrentSubscreen();if(MouseIn(1444,t+280+43,64,64)&&s&&l&&setSubscreen(new GuiMemberSelect(n,l,(e=>{memberNumberListAutoFill=e}),e.slice())),MouseIn(1530,t+280+43,100,64)&&s&&s.value){const t=Number.parseInt(s.value,10);if(Number.isInteger(t)&&!e.includes(t))return e.push(t),e.sort(((e,t)=>e-t)),s.value="",e}MouseIn(1650,t+280+43,125,64)&&a>0?ruleCustomDataHandlerPage.set(o,a-1):MouseIn(1775,t+280+43,125,64)&&a+1<i&&ruleCustomDataHandlerPage.set(o,a+1)},unload({key:e}){ElementRemove(`BCX_RCDH_${e}`),ruleCustomDataHandlerPage.delete(e)}},number:{validate:e=>"number"==typeof e&&Number.isInteger(e),onDataChange({active:e,key:t,onInput:o,value:n,access:r}){let i=document.getElementById(`BCX_RCDH_${t}`);e?(i?i.value=n.toString(10):(i=ElementCreateInput(`BCX_RCDH_${t}`,"text",n.toString(10),"50"),i.inputMode="numeric",i.pattern="[0-9]+",i.oninput=o),i.disabled=!r):i&&i.remove()},processInput({key:e,value:t}){const o=document.getElementById(`BCX_RCDH_${e}`);if(o&&o.value){if(/^[0-9]+$/.test(o.value))return Number.parseInt(o.value,10);o.value=t.toString(10)}},run({def:e,Y:t,key:o}){DrawTextFit(e.description,1050,t+0,850,"Black"),ElementPositionFix(`BCX_RCDH_${o}`,40,1050,t+26,850,60)},unload({key:e}){ElementRemove(`BCX_RCDH_${e}`)}},poseSelect:{validate:e=>Array.isArray(e)&&e.every((e=>"string"==typeof e)),run({def:e,value:t,Y:o,access:n}){DrawTextFit(e.description,1050,o+0,900,"Black"),DialogActivePoses&&DialogActivePoses.length||DialogActivePoseMenuBuild();for(let e=0;e<DialogActivePoses.length;e++){const r=o+60+140*e,i=DialogActivePoses[e];for(let e=0;e<i.length;e++){const o=1070+100*e,a=t.includes(i[e].Name);DrawButton(o,r,90,90,"",a?n?"Darkred":"#333":n?"White":"#ddd","Icons/Poses/"+i[e].Name+".png","",!n)}}},click({value:e,Y:t}){for(let o=0;o<DialogActivePoses.length;o++){const n=t+60+140*o,r=DialogActivePoses[o];for(let t=0;t<r.length;t++){if(MouseIn(1070+100*t,n,90,90))return e.includes(r[t].Name)?e.splice(e.indexOf(r[t].Name),1):e.push(r[t].Name),e}}}},roleSelector:{validate:e=>"number"==typeof e&&void 0!==AccessLevel[e],run({def:e,value:t,Y:o,access:n}){DrawTextFit(e.description,1050,o+0,900,"Black");const r=t<AccessLevel.public?t+1:AccessLevel.clubowner,i=t>AccessLevel.clubowner?t-1:AccessLevel.public;MainCanvas.textAlign="center",DrawBackNextButton(1050,o+46,250,60,capitalizeFirstLetter(AccessLevel[t])+(t!==AccessLevel.clubowner?" ":""),n?"White":"#ddd","",(()=>capitalizeFirstLetter(AccessLevel[i])),(()=>capitalizeFirstLetter(AccessLevel[r])),!n),MainCanvas.textAlign="left"},click:({value:e,Y:t})=>MouseIn(1050,t+46,125,60)?e>AccessLevel.clubowner?e-1:AccessLevel.public:MouseIn(1175,t+46,125,60)?e<AccessLevel.public?e+1:AccessLevel.clubowner:void 0},string:{validate:e=>"string"==typeof e,onDataChange({active:e,key:t,onInput:o,value:n,access:r}){let i=document.getElementById(`BCX_RCDH_${t}`);e?(i?i.value=n:(i=ElementCreateInput(`BCX_RCDH_${t}`,"text",n,"160"),i.oninput=o),i.disabled=!r):i&&i.remove()},processInput({key:e}){const t=document.getElementById(`BCX_RCDH_${e}`);return t?t.value:void 0},run({def:e,Y:t,key:o}){DrawTextFit(e.description,1050,t+0,850,"Black"),ElementPositionFix(`BCX_RCDH_${o}`,40,1050,t+26,850,60)},unload({key:e}){ElementRemove(`BCX_RCDH_${e}`)}},stringList:{validate:e=>Array.isArray(e)&&e.every((e=>"string"==typeof e)),onDataChange({active:e,key:t,access:o}){let n=document.getElementById(`BCX_RCDH_${t}`);e?(n||(n=ElementCreateInput(`BCX_RCDH_${t}`,"text","","120")),n.disabled=!o):n&&n.remove()},run({def:e,value:t,Y:o,key:n,access:r}){var i;o-=20;const a=Math.max(1,Math.ceil(t.length/4)),s=clamp(null!==(i=ruleCustomDataHandlerPage.get(n))&&void 0!==i?i:0,0,a-1);DrawTextFit(e.description,1050,o+0,900,"Black");for(let e=0;e<4;e++){const n=4*s+e;if(n>=t.length)break;MainCanvas.strokeRect(1050,o+26+70*e,766,64);const i=t[n];DrawTextFit(i.length>81?i.substr(0,80)+"":i,1060,o+26+70*e+34,750,"Black"),r&&(MainCanvas.textAlign="center",DrawButton(1836,o+26+70*e,64,64,"X","White"),MainCanvas.textAlign="left")}ElementPositionFix(`BCX_RCDH_${n}`,40,1050,o+280+43,450,60),MainCanvas.textAlign="center",DrawButton(1530,o+280+43,100,64,"Add",r?"White":"#ddd",void 0,void 0,!r),DrawBackNextButton(1650,o+280+43,250,64,`Page ${s+1}/${a}`,"White",void 0,(()=>""),(()=>"")),MainCanvas.textAlign="left"},click({value:e,Y:t,key:o}){var n;t-=20;const r=Math.max(1,Math.ceil(e.length/4)),i=clamp(null!==(n=ruleCustomDataHandlerPage.get(o))&&void 0!==n?n:0,0,r-1);for(let o=0;o<4;o++){const n=4*i+o;if(n>=e.length)break;if(MouseIn(1836,t+26+70*o,64,64))return e.splice(n,1),e}const a=document.getElementById(`BCX_RCDH_${o}`);if(MouseIn(1530,t+280+43,100,64)&&a&&a.value&&!e.includes(a.value))return e.push(a.value),e.sort(),a.value="",e;MouseIn(1650,t+280+43,125,64)&&i>0?ruleCustomDataHandlerPage.set(o,i-1):MouseIn(1775,t+280+43,125,64)&&i+1<r&&ruleCustomDataHandlerPage.set(o,i+1)},unload({key:e}){ElementRemove(`BCX_RCDH_${e}`),ruleCustomDataHandlerPage.delete(e)}},textArea:{validate:e=>"string"==typeof e,onDataChange({active:e,key:t,onInput:o,value:n,access:r}){let i=document.getElementById(`BCX_RCDH_${t}`);e?(i?i.value=n:(i=document.createElement("textarea"),i.id=`BCX_RCDH_${t}`,i.name=`BCX_RCDH_${t}`,i.value=n,i.maxLength=1e4,i.setAttribute("screen-generated",CurrentScreen),i.className="HideOnPopup",i.oninput=o,document.body.appendChild(i)),i.disabled=!r):i&&i.remove()},processInput({key:e}){const t=document.getElementById(`BCX_RCDH_${e}`);return t?t.value:void 0},run({def:e,Y:t,key:o}){DrawTextFit(e.description,1e3,t+0,900,"Black");const n=document.getElementById(`BCX_RCDH_${o}`);n&&document.activeElement===n?ElementPositionFix(`BCX_RCDH_${o}`,36,105,170,1790,750):ElementPositionFix(`BCX_RCDH_${o}`,28,1e3,t+26,900,765-t)},unload({key:e}){ElementRemove(`BCX_RCDH_${e}`)}},toggle:{validate:e=>"boolean"==typeof e,run({def:e,value:t,Y:o,access:n}){DrawCheckbox(1050,o,64,64,e.description,t,!n)},click({value:e,Y:t}){if(MouseIn(1050,t,64,64))return!e}}};function parseRuleName(e,t){e=e.toLocaleLowerCase();const o=Array.from(rules.entries()).filter((e=>!t||t(e[0]))).find((([t,o])=>t.toLocaleLowerCase()===e||o.name.toLocaleLowerCase()===e));return o?[!0,o[0]]:[!1,`Unknown rule "${e}".`]}function autocompleteRuleName(e,t){e=e.toLocaleLowerCase();let o=Array.from(rules.entries()).filter((o=>o[1].name.toLocaleLowerCase().startsWith(e)&&(!t||t(o[0])))).map((e=>e[1].name));return 0===o.length&&(o=Array.from(rules.entries()).filter((o=>o[0].toLocaleLowerCase().startsWith(e)&&(!t||t(o[0])))).map((e=>e[0]))),o}function RulesGetList(){return rulesList.map((e=>[e,RulesGetDisplayDefinition(e)]))}function RulesCreate(e,t){var o;if(!moduleIsEnabled(ModuleCategory.Rules))return!1;if(t&&!ConditionsCheckAccess("rules",e,t))return!1;const n=rules.get(e);if(!n)throw new Error(`Attempt to create unknown rule '${e}'`);if(!ConditionsGetCondition("rules",e)){const r={};if(n.dataDefinition){r.customData={};for(const[e,t]of Object.entries(n.dataDefinition))r.customData[e]=cloneDeep("function"==typeof t.default?t.default():t.default)}if(n.internalDataDefault&&(r.internalData=n.internalDataDefault(),!(null===(o=n.internalDataValidate)||void 0===o?void 0:o.call(n,r.internalData))))throw new Error(`Failed to create valid internal data for rule '${e}'`);ConditionsSetCondition("rules",e,r),t&&(logMessage("rule_change",LogEntryType.plaintext,`${t} added a new rule: ${n.name}`),t.isPlayer()||ChatRoomSendLocal(`${t} gave you a new rule: "${n.name}"`))}return!0}function RulesDelete(e,t){if(!moduleIsEnabled(ModuleCategory.Rules))return!1;if(t&&!ConditionsCheckAccess("rules",e,t))return!1;const o=RulesGetDisplayDefinition(e);return ConditionsRemoveCondition("rules",e)&&t&&(logMessage("rule_change",LogEntryType.plaintext,`${t} removed the rule: ${o.name}`),t.isPlayer()||ChatRoomSendLocal(`${t} removed your rule "${o.name}"`)),!0}class RuleState{constructor(e,t){this.rule=e,this.ruleDefinition=t}get condition(){return ConditionsGetCondition("rules",this.rule)}get inEffect(){return ConditionsIsConditionInEffect("rules",this.rule)}get isEnforced(){const e=this.condition;return!(!e||!this.inEffect)&&!1!==e.data.enforce}get isLogged(){const e=this.condition;return!(!e||!this.inEffect)&&!1!==e.data.log}get customData(){var e;return null===(e=this.condition)||void 0===e?void 0:e.data.customData}get internalData(){var e;return cloneDeep(null===(e=this.condition)||void 0===e?void 0:e.data.internalData)}set internalData(e){const t=this.condition;t&&!isEqual(t.data.internalData,e)&&(t.data.internalData=e,modStorageSync())}trigger(e={}){var t;const o=this.ruleDefinition.triggerTexts;if(o&&(o.infoBeep&&InfoBeep("BCX: "+dictionaryProcess(o.infoBeep,e),7e3),this.isLogged)){o.log&&logMessage("rule_trigger",LogEntryType.ruleTrigger,[this.rule,e]);const n=null!==(t=o.announce)&&void 0!==t?t:o.log;n&&ChatRoomActionMessage(`${dictionaryProcess(n,e)}.`)}}triggerAttempt(e={}){var t,o;const n=this.ruleDefinition.triggerTexts;if(n){const r=null!==(t=n.attempt_infoBeep)&&void 0!==t?t:n.infoBeep;if(r&&InfoBeep("BCX: "+dictionaryProcess(r,e),7e3),this.isLogged){n.attempt_log&&logMessage("rule_trigger",LogEntryType.ruleTriggerAttempt,[this.rule,e]);const t=null!==(o=n.attempt_announce)&&void 0!==o?o:n.attempt_log;t&&ChatRoomActionMessage(`${dictionaryProcess(t,e)}.`)}}}}class ModuleRules extends BaseModule{constructor(){super(...arguments),this.resetTimer=null,this.triggerCounts=new Map,this.suspendedUntil=null}init(){registerPermission("rules_normal",{name:"Allows controlling non-limited rules",category:ModuleCategory.Rules,defaults:{[Preset.dominant]:[!0,AccessLevel.lover],[Preset.switch]:[!0,AccessLevel.lover],[Preset.submissive]:[!1,AccessLevel.mistress],[Preset.slave]:[!1,AccessLevel.mistress]}}),registerPermission("rules_limited",{name:"Allows controlling limited rules",category:ModuleCategory.Rules,defaults:{[Preset.dominant]:[!0,AccessLevel.owner],[Preset.switch]:[!0,AccessLevel.owner],[Preset.submissive]:[!1,AccessLevel.lover],[Preset.slave]:[!1,AccessLevel.lover]}}),registerPermission("rules_global_configuration",{name:"Allows editing the global rules configuration",category:ModuleCategory.Rules,defaults:{[Preset.dominant]:[!0,AccessLevel.owner],[Preset.switch]:[!0,AccessLevel.owner],[Preset.submissive]:[!1,AccessLevel.lover],[Preset.slave]:[!1,AccessLevel.lover]}}),registerPermission("rules_change_limits",{name:"Allows to limit/block specific rules",category:ModuleCategory.Rules,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.self],[Preset.slave]:[!1,AccessLevel.owner]}}),queryHandlers.ruleCreate=(e,t,o)=>{guard_BCX_Rule(o)?t(!0,RulesCreate(o,e)):t(!1)},queryHandlers.ruleDelete=(e,t,o)=>{guard_BCX_Rule(o)?t(!0,RulesDelete(o,e)):t(!1)},registerWhisperCommand("rules","- Manage rules",((e,t,o)=>{if(!moduleIsEnabled(ModuleCategory.Rules))return o("Rules module is disabled.");const n=(e[0]||"").toLocaleLowerCase(),r=ConditionsGetCategoryPublicData("rules",t).conditions;if(ConditionsSubcommands.includes(n))return ConditionsRunSubcommand("rules",e,t,o);if("list"===n){let e="Current rules:";for(const[t,n]of Object.entries(r)){const r=RulesGetDisplayDefinition(t),i=`Timer: ${n.timer?formatTimeInterval(n.timer-Date.now(),"short"):""}`,a=`\n${r.name} | ${i}`;e.length+a.length>=990&&(e+="\n...",o(e),e="Current rules (continued):"),e+=a}o(e)}else if("description"===n){const t=parseRuleName(e[1]||"");if(!t[0])return o(t[1]);o(RulesGetDisplayDefinition(t[1]).longDescription.replaceAll("PLAYER_NAME",Player.Name))}else if("remove"===n){const n=parseRuleName(e[1]||"");if(!n[0])return o(n[1]);o(RulesDelete(n[1],t)?"Ok.":COMMAND_GENERIC_ERROR)}else o(Command_fixExclamationMark(t,"!rules usage (page 1):\n!rules list - List all currently applied rules\n!rules description <rule> - Show the rule's description\n!rules remove <rule> - Remove a currently applied rule if permitted to\n\nNote: Adding and setting up rules is only supported via using BCX's graphical user interface yourself.")),o(Command_fixExclamationMark(t,'!rules usage (page 2):\n!rules setactive <rule> <yes/no> - Switch the rule and its conditions on and off\n!rules triggers <rule> global <yes/no> - Set the trigger condition of this rule to the global configuration\n!rules triggers <rule> help - Set the trigger configuration of a rule\n!rules globaltriggers help - Set global trigger configuration\n!rules timer <rule> help - Set timer options of a rule\n!rules defaulttimer help - Set default timer options used on new rules\n!rules setlimit <rule> <normal/limited/blocked> - Set a limit on certain <rule>\n\nHint: If an argument contains spaces: "put it in quotes"'))}),((e,t)=>{if(!moduleIsEnabled(ModuleCategory.Rules))return[];if(e.length<=1)return Command_pickAutocomplete(e[0],["list","description","remove",...ConditionsSubcommands]);const o=e[0].toLocaleLowerCase();return ConditionsSubcommands.includes(o)?ConditionsAutocompleteSubcommand("rules",e,t):[]})),ConditionsRegisterCategory("rules",{category:ModuleCategory.Rules,permission_normal:"rules_normal",permission_limited:"rules_limited",permission_configure:"rules_global_configuration",permission_changeLimits:"rules_change_limits",loadValidateConditionKey:e=>guard_BCX_Rule(e),loadValidateCondition:(e,t)=>{const o=t.data,n=rules.get(e);if(!n)return console.error(`BCX: Bad data for rule ${e}: descriptor not found, removing it`),!1;if(!isObject$1(o)||void 0!==o.enforce&&!1!==o.enforce||void 0!==o.log&&!1!==o.log)return console.error(`BCX: Bad data for rule ${e}, removing it`,o),!1;if(n.dataDefinition){isObject$1(o.customData)||(console.warn(`BCX: Missing custom data for rule ${e}, fixing`),o.customData={});for(const t of Object.keys(o.customData))n.dataDefinition[t]||(console.warn(`BCX: Unknown custom data attribute '${t}' for rule ${e}, cleaning up`,o.customData[t]),delete o.customData[t]);for(const[t,r]of Object.entries(n.dataDefinition)){const n=ruleCustomDataHandlers[r.type];if(!n)return console.error(`BCX: Custom data for rule ${e} unknown type ${r.type}, removing it`,o),!1;n.validate(o.customData[t],r)||(console.warn(`BCX: Bad custom data ${t} for rule ${e}, expected type ${r.type}, replacing with default`,o.customData[t]),o.customData[t]="function"==typeof r.default?r.default():r.default)}}else if(void 0!==o.customData)return console.error(`BCX: Custom data for rule ${e} without data definition, removing it`,o),!1;if(n.internalDataValidate){if(!n.internalDataValidate(o.internalData)){if(void 0!==o.internalData||!n.internalDataDefault)return console.error(`BCX: Bad internal data for rule ${e}, removing it`,o),!1;console.warn(`BCX: Missing internal data for rule ${e}, fixing`),o.internalData=n.internalDataDefault()}}else if(void 0!==o.internalData)return console.error(`BCX: Internal data for rule ${e} without validator, removing it`,o),!1;return!0},loadCategorySpecificGlobalData:()=>{},stateChangeHandler:this.ruleStateChange.bind(this),tickHandler:this.ruleTick.bind(this),makePublicData:(e,t)=>{var o,n;return{enforce:null===(o=t.data.enforce)||void 0===o||o,log:null===(n=t.data.log)||void 0===n||n,customData:cloneDeep(t.data.customData)}},validateCategorySpecificGlobalData:()=>!0,validatePublicData:(e,t)=>isObject$1(t)&&"boolean"==typeof t.enforce&&"boolean"==typeof t.log&&guard_RuleCustomData(e,t.customData),updateCondition:(e,t,o)=>(o.enforce?delete t.data.enforce:t.data.enforce=!1,o.log?delete t.data.log:t.data.log=!1,o.customData&&(t.data.customData=cloneDeep(o.customData)),!0),parseConditionName:(e,t)=>parseRuleName(e,t?e=>t.includes(e):void 0),autocompleteConditionName:(e,t)=>autocompleteRuleName(e,t?e=>t.includes(e):void 0),logLimitChange:(e,t,o)=>{const n=RulesGetDisplayDefinition(e);logMessage("rule_change",LogEntryType.plaintext,`${t} changed ${Player.Name}'s '${n.name}' rule permission to ${ConditionsLimit[o]}`),t.isPlayer()||ChatRoomSendLocal(`${t} changed '${n.name}' rule permission to ${ConditionsLimit[o]}`,void 0,t.MemberNumber)},logConditionUpdate:(e,t,o,n)=>{var r,i,a,s,l,c;const u=RulesGetDisplayDefinition(e),d=u.name,m=o.active!==n.active,h=o.timer!==n.timer||o.timerRemove!==n.timerRemove,g=!isEqual(o.requirements,n.requirements),f=o.data.enforce!==n.data.enforce,p=o.data.log!==n.data.log,C=[];if(m&&C.push("active state"),h&&C.push("timer"),g&&C.push("trigger condition"),f&&C.push("enforcement"),p&&C.push("logging"),u.dataDefinition)for(const[e,t]of Object.entries(u.dataDefinition))if(!isEqual(null===(r=n.data.customData)||void 0===r?void 0:r[e],null===(i=o.data.customData)||void 0===i?void 0:i[e])){let e=t.description;e.includes(":")&&(e=e.slice(0,e.lastIndexOf(":"))),C.push(`${C.length>0?"and ":""}the value of the setting '${e}'`)}if(C.length>0&&logMessage("rule_change",LogEntryType.plaintext,`${t} changed the ${C.join(", ")} of ${Player.Name}'s '${d}' rule`),!t.isPlayer()){if(m&&ChatRoomSendLocal(`${t} ${o.active?"reactivated":"deactivated"} the '${d}' rule`,void 0,t.MemberNumber),o.timer!==n.timer&&(null===o.timer?ChatRoomSendLocal(`${t} disabled the timer of the '${d}' rule`,void 0,t.MemberNumber):ChatRoomSendLocal(`${t} changed the remaining time of the timer of the '${d}' rule to ${formatTimeInterval(o.timer-Date.now())}`,void 0,t.MemberNumber)),null!==o.timer&&o.timerRemove!==n.timerRemove&&ChatRoomSendLocal(`${t} changed the timer behavior of the '${d}' rule to ${o.timerRemove?"remove":"disable"} the rule when time runs out`,void 0,t.MemberNumber),g)if(null===o.requirements)ChatRoomSendLocal(`${t} set the triggers of '${d}' rule to the global rules configuration`,void 0,t.MemberNumber);else{const e=[],n=o.requirements;if(n.room&&e.push(`When ${n.room.inverted?"not in":"in"} ${n.room.type} room`),n.roomName&&e.push(`When ${n.roomName.inverted?"not in":"in"} room named '${n.roomName.name}'`),n.role){const t=capitalizeFirstLetter(AccessLevel[n.role.role])+(n.role.role!==AccessLevel.clubowner?" ":"");e.push(`When ${n.role.inverted?"not in":"in"} room with role '${t}'`)}if(n.player){const t=getCharacterName(n.player.memberNumber,null);e.push(`When ${n.player.inverted?"not in":"in"} room with member '${n.player.memberNumber}'${t?` (${t})`:""}`)}e.length>0?ChatRoomSendLocal(`${t} set the '${d}' rule to trigger under following conditions:\n`+e.join("\n"),void 0,t.MemberNumber):ChatRoomSendLocal(`${t} deactivated all trigger conditions of the '${d}' rule. The rule will now always trigger, while it is active`,void 0,t.MemberNumber)}if(f&&ChatRoomSendLocal(`${t} ${o.data.enforce?"enabled enforcement":"stopped enforcement"} of the '${d}' rule`,void 0,t.MemberNumber),p&&ChatRoomSendLocal(`${t} ${o.data.log?"enabled logging":"stopped logging"} of the '${d}' rule`,void 0,t.MemberNumber),u.dataDefinition)for(const[e,r]of Object.entries(u.dataDefinition))isEqual(null===(a=n.data.customData)||void 0===a?void 0:a[e],null===(s=o.data.customData)||void 0===s?void 0:s[e])||ChatRoomSendLocal(`${t} changed the '${d}' rule's setting '${r.description}' from '${null===(l=n.data.customData)||void 0===l?void 0:l[e]}' to '${null===(c=o.data.customData)||void 0===c?void 0:c[e]}'`,void 0,t.MemberNumber)}},logCategoryUpdate:(e,t,o)=>{const n=t.timer!==o.timer||t.timerRemove!==o.timerRemove,r=!isEqual(t.requirements,o.requirements),i=[];if(n&&i.push("default timer"),r&&i.push("trigger condition"),i.length>0&&logMessage("curse_change",LogEntryType.plaintext,`${e} changed the ${i.join(", ")} of ${Player.Name}'s global rules config`),!e.isPlayer()&&(t.timer!==o.timer&&(null===t.timer?ChatRoomSendLocal(`${e} removed the default timer of the global rules configuration`,void 0,e.MemberNumber):ChatRoomSendLocal(`${e} changed the default timer of the global rules configuration to ${formatTimeInterval(t.timer)}`,void 0,e.MemberNumber)),null!==t.timer&&t.timerRemove!==o.timerRemove&&ChatRoomSendLocal(`${e} changed the default timeout behavior of the global rules configuration to ${t.timerRemove?"removal of rules":"disabling rules"} when time runs out`,void 0,e.MemberNumber),r)){const o=[],n=t.requirements;if(n.room&&o.push(`When ${n.room.inverted?"not in":"in"} ${n.room.type} room`),n.roomName&&o.push(`When ${n.roomName.inverted?"not in":"in"} room named '${n.roomName.name}'`),n.role){const e=capitalizeFirstLetter(AccessLevel[n.role.role])+(n.role.role!==AccessLevel.clubowner?" ":"");o.push(`When ${n.role.inverted?"not in":"in"} room with role '${e}'`)}if(n.player){const e=getCharacterName(n.player.memberNumber,null);o.push(`When ${n.player.inverted?"not in":"in"} room with member '${n.player.memberNumber}'${e?` (${e})`:""}`)}o.length>0?ChatRoomSendLocal(`${e} set the global rules configuration to trigger rules under following conditions:\n`+o.join("\n"),void 0,e.MemberNumber):ChatRoomSendLocal(`${e} deactivated all trigger conditions for the global rules configuration. Rules set to this default configuration will now always trigger, while active`,void 0,e.MemberNumber)}},getDefaultLimits:()=>{const e={};for(const[t,o]of rules.entries())e[t]=o.defaultLimit;return e},commandConditionSelectorHelp:"rule"}),initRules_bc_blocks(),initRules_bc_alter(),initRules_bc_settings(),initRules_bc_relation_control(),initRules_bc_speech_control(),initRules_other();for(const e of rules.values())e.init&&e.init(e.state)}load(){if(moduleIsEnabled(ModuleCategory.Rules))for(const e of rules.values())e.load&&e.load(e.state)}run(){moduleIsEnabled(ModuleCategory.Rules)&&(this.resetTimer=BCX_setInterval((()=>{this.triggerCounts.clear()}),RULES_ANTILOOP_RESET_INTERVAL))}unload(){null!==this.resetTimer&&(clearInterval(this.resetTimer),this.resetTimer=null);for(const e of rules.values())e.unload&&e.unload()}reload(){this.unload(),this.load(),this.run()}ruleStateChange(e,t,o){var n;const r=rules.get(e);if(!r)throw new Error(`Definition for rule ${e} not found`);null===(n=r.stateChange)||void 0===n||n.call(r,r.state,o)}ruleTick(e,t){var o;if(null!==this.suspendedUntil){if(!(Date.now()>=this.suspendedUntil))return;this.suspendedUntil=null,this.triggerCounts.clear(),ChatRoomActionMessage(`All of ${Player.Name}'s temporarily suspended rules are in effect again.`)}const n=rules.get(e);if(!n)throw new Error(`Definition for rule ${e} not found`);if(n.tick&&n.tick(n.state)){const t=(null!==(o=this.triggerCounts.get(e))&&void 0!==o?o:0)+1;this.triggerCounts.set(e,t),t>=RULES_ANTILOOP_THRESHOLD&&(ChatRoomActionMessage("Protection triggered: The effects of rules have been suspended for 10 minutes. Please refrain from triggering rules so rapidly, as it creates strain on the server and may lead to unwanted side effects! If you believe this message was triggered by a bug, please report it to BCX Discord."),this.suspendedUntil=Date.now()+RULES_ANTILOOP_SUSPEND_TIME)}}}const CURSES_TRIGGER_TEXTS={remove:"PLAYER_NAME's body seems to be cursed and the ASSET_NAME just falls off her body.",add:"The curse on PLAYER_NAME's ASSET_NAME wakes up and the item reappears.",swap:"The curse on PLAYER_NAME's ASSET_NAME wakes up, not allowing the item to be replaced by another item.",update:"The curse on PLAYER_NAME's ASSET_NAME wakes up and undoes all changes to the item.",color:"The curse on PLAYER_NAME's ASSET_NAME wakes up, changing the color of the item back.",autoremove:"The curse on PLAYER_NAME's body becomes dormant and the ASSET_NAME falls off her body."},CURSES_TRIGGER_TEXTS_BATCH={remove:"PLAYER_NAME's body seems to be cursed and several items just fall off her body.",add:"The curses on PLAYER_NAME's body wake up and several items reappear.",swap:"The curses on PLAYER_NAME's body wake up, not allowing several items to be replaced.",update:"The curses on PLAYER_NAME's body wake up and undoes all changes to several items.",color:"The curses on PLAYER_NAME's body wake up, changing the color of several items back.",autoremove:"The curses on PLAYER_NAME's body become dormant and several items fall off her body."},CURSES_TRIGGER_LOGS={remove:"The curse on PLAYER_NAME's body prevented a ASSET_NAME from being added to it",add:"The curse on PLAYER_NAME's ASSET_NAME made the item reappear",swap:"The curse on PLAYER_NAME's ASSET_NAME prevented the item from being replaced",update:"The curse on PLAYER_NAME's ASSET_NAME reverted all changes to the item",color:"The curse on PLAYER_NAME's ASSET_NAME reverted the color of the item"},CURSES_TRIGGER_LOGS_BATCH={remove:"The curses on PLAYER_NAME's body prevented several items from being added to it",add:"The curses on PLAYER_NAME's body made several items reappear",swap:"The curses on PLAYER_NAME's body prevented several items from being replaced",update:"The curses on PLAYER_NAME's body reverted all changes to several items",color:"The curses on PLAYER_NAME's body reverted the color of several items"},LOG_ENTRIES_LIMIT=256;var LogEntryType,LogAccessLevel;function logMessage(e,t,o){var n;if(!moduleIsEnabled(ModuleCategory.Log))return;const r=null===(n=modStorage.logConfig)||void 0===n?void 0:n[e];if(void 0===r)throw new Error(`Attempt to log message with unknown category "${e}"`);r>LogAccessLevel.none&&logMessageAdd(r,t,o)}function logMessageAdd(e,t,o){if(moduleIsEnabled(ModuleCategory.Log)){if(!modStorage.log)throw new Error("Mod storage log not initialized");modStorage.log.unshift([Date.now(),e,t,o]),modStorage.log.length>=2&&modStorage.log[0][0]<=modStorage.log[1][0]&&(modStorage.log[0][0]=modStorage.log[1][0]+1),modStorage.log.splice(LOG_ENTRIES_LIMIT),modStorageSync(),notifyOfChange()}}function logMessageDelete(e,t){var o;if(!moduleIsEnabled(ModuleCategory.Log))return!1;if(t&&!checkPermissionAccess("log_delete",t))return!1;const n=null===(o=modStorage.logConfig)||void 0===o?void 0:o.log_deleted;if(void 0===n)throw new Error("log_deleted category not found");if(!modStorage.log)throw new Error("Mod storage log not initialized");for(let t=0;t<modStorage.log.length;t++){const o=modStorage.log[t];if(o[0]===e)return n===LogAccessLevel.none?modStorage.log.splice(t,1):(o[1]=n,o[2]=LogEntryType.deleted,o[3]=null),modStorageSync(),notifyOfChange(),!0}return!1}function logConfigSet(e,t,o){var n;if(!moduleIsEnabled(ModuleCategory.Log))return!1;if(o&&!checkPermissionAccess("log_configure",o))return!1;if(void 0===(null===(n=modStorage.logConfig)||void 0===n?void 0:n[e]))return!1;if(![LogAccessLevel.none,LogAccessLevel.normal,LogAccessLevel.protected].includes(t))return!1;if(o){const n=`${o} changed log configuration "${LOG_CONFIG_NAMES[e]}" from "${LOG_LEVEL_NAMES[modStorage.logConfig[e]]}" to "${LOG_LEVEL_NAMES[t]}"`;logMessage("log_config_change",LogEntryType.plaintext,n),o.isPlayer()||ChatRoomSendLocal(n,void 0,o.MemberNumber)}return modStorage.logConfig[e]=t,modStorageSync(),notifyOfChange(),!0}function logClear(e){return!!moduleIsEnabled(ModuleCategory.Log)&&(!(e&&!checkPermissionAccess("log_delete",e))&&(modStorage.log=[],logMessageAdd(LogAccessLevel.everyone,LogEntryType.plaintext,"The log has been cleared"),!0))}function getVisibleLogEntries(e){if(!moduleIsEnabled(ModuleCategory.Log))return[];if(!modStorage.log)throw new Error("Mod storage log not initialized");const t={[LogAccessLevel.none]:e.isPlayer(),[LogAccessLevel.normal]:checkPermissionAccess("log_view_normal",e),[LogAccessLevel.protected]:checkPermissionAccess("log_view_protected",e),[LogAccessLevel.everyone]:!0};return modStorage.log.filter((e=>t[e[1]]))}function logMessageRender(e,t){var o,n;if(e[2]===LogEntryType.plaintext){return e[3]}if(e[2]===LogEntryType.deleted)return"[Log message deleted]";if(e[2]===LogEntryType.ruleTrigger||e[2]===LogEntryType.ruleTriggerAttempt){const r=e[3];if(!Array.isArray(r)||2!==r.length||"string"!=typeof r[0])return`[ERROR: Bad data for type ${e[2]}]`;if(!guard_BCX_Rule(r[0]))return`[ERROR: Trigger for unknown rule "${r[0]}"]`;const i=RulesGetDisplayDefinition(r[0]),a=e[2]===LogEntryType.ruleTriggerAttempt?null===(o=i.triggerTexts)||void 0===o?void 0:o.attempt_log:null===(n=i.triggerTexts)||void 0===n?void 0:n.log;return a?dictionaryProcess(a,{PLAYER_NAME:t.Name,...r[1]}):`[ERROR: Missing log text for rule "${r[0]}" trigger]`}if(e[2]===LogEntryType.curseTrigger){const o=e[3];return Array.isArray(o)&&2===o.length&&!o.some((e=>"string"!=typeof e))&&Object.keys(CURSES_TRIGGER_LOGS).includes(o[0])?dictionaryProcess(CURSES_TRIGGER_LOGS[o[0]],{PLAYER_NAME:t.Name,ASSET_NAME:o[1]}):`[ERROR: Bad data for type ${e[2]}]`}if(e[2]===LogEntryType.curseTriggerBatch){const o=e[3];return"string"==typeof o&&Object.keys(CURSES_TRIGGER_LOGS_BATCH).includes(o)?dictionaryProcess(CURSES_TRIGGER_LOGS_BATCH[o],{PLAYER_NAME:t.Name}):`[ERROR: Bad data for type ${e[2]}]`}return`[ERROR: Unknown entry type ${e[2]}]`}!function(e){e[e.plaintext=0]="plaintext",e[e.deleted=1]="deleted",e[e.ruleTrigger=2]="ruleTrigger",e[e.ruleTriggerAttempt=3]="ruleTriggerAttempt",e[e.curseTrigger=4]="curseTrigger",e[e.curseTriggerBatch=5]="curseTriggerBatch"}(LogEntryType||(LogEntryType={})),function(e){e[e.none=0]="none",e[e.protected=1]="protected",e[e.normal=2]="normal",e[e.everyone=3]="everyone"}(LogAccessLevel||(LogAccessLevel={}));const alreadyPraisedBy=new Set;function logGetAllowedActions(e){var t;return{configure:checkPermissionAccess("log_configure",e),delete:checkPermissionAccess("log_delete",e),leaveMessage:checkPermissionAccess("log_add_note",e)&&!!(null===(t=modStorage.logConfig)||void 0===t?void 0:t.user_note),praise:checkPermissionAccess("log_praise",e)&&!alreadyPraisedBy.has(e.MemberNumber)}}function logGetConfig(){if(!moduleIsEnabled(ModuleCategory.Log))return{};if(!modStorage.logConfig)throw new Error("Mod storage log not initialized");return{...modStorage.logConfig}}function logPraise(e,t,o){if(!moduleIsEnabled(ModuleCategory.Log))return!1;if(![-1,0,1].includes(e))throw new Error("Invalid value");if(0===e&&!t)return!1;const n=logGetAllowedActions(o);return!(0!==e&&!n.praise)&&(!(t&&!n.leaveMessage)&&(0!==e&&alreadyPraisedBy.add(o.MemberNumber),e>0?t?(logMessage("user_note",LogEntryType.plaintext,`Praised by ${o} with note: ${t}`),ChatRoomSendLocal(`${o} praised you with the following note: ${t}`,void 0,o.MemberNumber)):(logMessage("praise",LogEntryType.plaintext,`Praised by ${o}`),ChatRoomSendLocal(`${o} praised you.`,void 0,o.MemberNumber)):e<0?t?(logMessage("user_note",LogEntryType.plaintext,`Scolded by ${o} with note: ${t}`),ChatRoomSendLocal(`${o} scolded you with the following note: ${t}`,void 0,o.MemberNumber)):(logMessage("praise",LogEntryType.plaintext,`Scolded by ${o}`),ChatRoomSendLocal(`${o} scolded you.`,void 0,o.MemberNumber)):t&&(logMessage("user_note",LogEntryType.plaintext,`${o} attached a note: ${t}`),ChatRoomSendLocal(`${o} put the following note on you: ${t}`,void 0,o.MemberNumber)),!0))}const logConfigDefaults={log_config_change:LogAccessLevel.protected,log_deleted:LogAccessLevel.normal,praise:LogAccessLevel.normal,user_note:LogAccessLevel.normal,entered_public_room:LogAccessLevel.none,entered_private_room:LogAccessLevel.none,had_orgasm:LogAccessLevel.none,permission_change:LogAccessLevel.protected,curse_change:LogAccessLevel.none,curse_trigger:LogAccessLevel.none,rule_change:LogAccessLevel.none,rule_trigger:LogAccessLevel.none,authority_roles_change:LogAccessLevel.protected},LOG_CONFIG_NAMES={log_config_change:"Log changes in logging configuration",log_deleted:"Log deleted log entries",praise:"Log praising or scolding behavior",user_note:"Ability to see attached notes",entered_public_room:"Log which public rooms are entered",entered_private_room:"Log which private rooms are entered",had_orgasm:"Log each single orgasm",permission_change:"Log changes in permission settings",curse_change:"Log each application, removal or change of curses",curse_trigger:"Log every time a triggered curse reapplies an item",rule_change:"Log each addition, removal or change of rules",rule_trigger:"Log every misbehaviour detected by rules",authority_roles_change:"Log getting or losing a BCX owner/mistress"},LOG_LEVEL_NAMES={[LogAccessLevel.everyone]:"[ERROR]",[LogAccessLevel.none]:"No",[LogAccessLevel.protected]:"Protected",[LogAccessLevel.normal]:"Yes"};class ModuleLog extends BaseModule{init(){registerPermission("log_view_normal",{name:"Allow to see normal log entries",category:ModuleCategory.Log,defaults:{[Preset.dominant]:[!0,AccessLevel.mistress],[Preset.switch]:[!0,AccessLevel.mistress],[Preset.submissive]:[!0,AccessLevel.friend],[Preset.slave]:[!0,AccessLevel.public]}}),registerPermission("log_view_protected",{name:"Allow to see protected log entries",category:ModuleCategory.Log,defaults:{[Preset.dominant]:[!0,AccessLevel.lover],[Preset.switch]:[!0,AccessLevel.lover],[Preset.submissive]:[!0,AccessLevel.mistress],[Preset.slave]:[!0,AccessLevel.mistress]}}),registerPermission("log_configure",{name:"Allow to configure what is logged",category:ModuleCategory.Log,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.owner],[Preset.slave]:[!1,AccessLevel.owner]}}),registerPermission("log_delete",{name:"Allow deleting log entries",category:ModuleCategory.Log,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.owner],[Preset.slave]:[!1,AccessLevel.owner]}}),registerPermission("log_praise",{name:"Allow to praise or scold",category:ModuleCategory.Log,defaults:{[Preset.dominant]:[!1,AccessLevel.friend],[Preset.switch]:[!1,AccessLevel.friend],[Preset.submissive]:[!1,AccessLevel.public],[Preset.slave]:[!1,AccessLevel.public]}}),registerPermission("log_add_note",{name:"Allow to attach notes to the body",category:ModuleCategory.Log,defaults:{[Preset.dominant]:[!1,AccessLevel.mistress],[Preset.switch]:[!1,AccessLevel.mistress],[Preset.submissive]:[!1,AccessLevel.friend],[Preset.slave]:[!1,AccessLevel.public]}}),queryHandlers.logData=(e,t)=>{t(!0,getVisibleLogEntries(e))},queryHandlers.logDelete=(e,t,o)=>{"number"==typeof o?t(!0,logMessageDelete(o,e)):t(!1)},queryHandlers.logConfigGet=(e,t)=>{checkPermissionAccess("log_configure",e)?t(!0,logGetConfig()):t(!1)},queryHandlers.logConfigEdit=(e,t,o)=>{if(!isObject$1(o)||"string"!=typeof o.category||"number"!=typeof o.target)return console.warn(`BCX: Bad logConfigEdit query from ${e}`,o),t(!1);t(!0,logConfigSet(o.category,o.target,e))},queryHandlers.logClear=(e,t)=>{t(!0,logClear(e))},queryHandlers.logPraise=(e,t,o)=>{if(!isObject$1(o)||null!==o.message&&"string"!=typeof o.message||![-1,0,1].includes(o.value))return console.warn(`BCX: Bad logPraise query from ${e}`,o),t(!1);t(!0,logPraise(o.value,o.message,e))},queryHandlers.logGetAllowedActions=(e,t)=>{t(!0,logGetAllowedActions(e))},registerWhisperCommand("log","- Manage the behaviour log",((e,t,o)=>{const n=(e[0]||"").toLocaleLowerCase();if("list"===n){const n=getVisibleLogEntries(t),r=Math.ceil(n.length/5),i=clamp(Number.parseInt(e[1]||"",10)||1,1,r);let a=`Page ${i} / ${r}:`;for(let e=5*(i-1);e<Math.min(5*i,n.length);e++){const t=n[e];a+=`\n[${new Date(t[0]).toUTCString()}] (${t[0]})\n  ${logMessageRender(t,getPlayerCharacter())}`}o(a)}else if("delete"===n){if(!/^[0-9]+$/.test(e[1]||""))return o("Expected number as timestamp.");const n=Number.parseInt(e[1],10);if(!getVisibleLogEntries(t).some((e=>e[0]===n)))return o("No such log entry found");o(logMessageDelete(n,t)?"Ok.":COMMAND_GENERIC_ERROR)}else{if("config"===n){if(!checkPermissionAccess("log_configure",t))return o(COMMAND_GENERIC_ERROR);const n=e[1]||"",r=logGetConfig();if(n){if(void 0===LOG_CONFIG_NAMES[n])return o(`Unknown category "${n}".`);{const r=(e[2]||"").toLocaleLowerCase();return o("yes"!==r&&"protected"!==r&&"no"!==r?"Expected level to be one of:\nno, protected, yes":logConfigSet(n,"yes"===r?LogAccessLevel.normal:"protected"===r?LogAccessLevel.protected:LogAccessLevel.none,t)?"Ok.":COMMAND_GENERIC_ERROR)}}{let e="Current log config:";for(const[t,o]of Object.entries(r))void 0!==LOG_CONFIG_NAMES[t]&&void 0!==LOG_LEVEL_NAMES[o]&&(e+=`\n[${t}]\n  ${LOG_CONFIG_NAMES[t]}: ${LOG_LEVEL_NAMES[o]}`);return o(e)}}o(Command_fixExclamationMark(t,`!log usage:\n!log list [page] - List all visible logs\n!log delete <timestamp> - Deletes the log with the given <timestamp> (the number in parentheses in list)\n!log config - Shows the current logging settings for ${Player.Name}\n!log config <category> <no|protected|yes> - Sets visibility of the given config <category>`))}}),((e,t)=>{if(e.length<=1){const t=e[0].toLocaleLowerCase();return["list","delete","config"].filter((e=>e.startsWith(t)))}const o=e[0].toLocaleLowerCase();if("delete"===o){if(2===e.length)return getVisibleLogEntries(t).map((e=>e[0].toString())).filter((t=>t.startsWith(e[1])))}else if("config"===o){if(!checkPermissionAccess("log_configure",t))return[];if(2===e.length)return Object.keys(logGetConfig()).concat("").filter((t=>t.startsWith(e[1].toLocaleLowerCase())));if(3===e.length)return["no","protected","yes"].filter((t=>t.startsWith(e[2].toLocaleLowerCase())))}return[]}))}load(){if(!moduleIsEnabled(ModuleCategory.Log))return delete modStorage.log,void delete modStorage.logConfig;if(Array.isArray(modStorage.log)?modStorage.log.every((e=>Array.isArray(e)&&4===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&"number"==typeof e[2]))||(console.error("BCX: Some log entries have invalid format, reseting whole log!"),logClear(null)):logClear(null),modStorage.logConfig){const e={permissionChange:"permission_change",logConfigChange:"log_config_change",logDeleted:"log_deleted",userNote:"user_note",curseChange:"curse_change",curseTrigger:"curse_trigger",hadOrgasm:"had_orgasm",enteredPublicRoom:"entered_public_room",enteredPrivateRoom:"entered_private_room",ownershipChangesBCX:"authority_roles_change"};for(const t of Object.keys(modStorage.logConfig))void 0===e[t]?void 0===logConfigDefaults[t]&&(console.info(`BCX: Removing unknown log config category "${t}"`),delete modStorage.logConfig[t]):(console.info(`BCX: Updating log config name "${t}"->"${e[t]}"`),modStorage.logConfig[e[t]]=modStorage.logConfig[t],delete modStorage.logConfig[t]);for(const e of Object.keys(logConfigDefaults))void 0===modStorage.logConfig[e]&&(console.info(`BCX: Adding missing log category "${e}"`),modStorage.logConfig[e]=logConfigDefaults[e])}else modStorage.logConfig={...logConfigDefaults};hookFunction("ActivityOrgasmStart",0,((e,t)=>(0!==e[0].ID||"undefined"!=typeof ActivityOrgasmRuined&&ActivityOrgasmRuined||logMessage("had_orgasm",LogEntryType.plaintext,`${Player.Name} had an orgasm`),t(e))),ModuleCategory.Log),hookFunction("ChatRoomSync",0,((e,t)=>{const o=e[0];return o.Private?logMessage("entered_private_room",LogEntryType.plaintext,`${Player.Name} entered private room "${o.Name}"`):logMessage("entered_public_room",LogEntryType.plaintext,`${Player.Name} entered public room "${o.Name}"`),t(e)}),ModuleCategory.Log)}reload(){removeAllHooksByModule(ModuleCategory.Log),this.load()}}const PER_PAGE_COUNT$3=6;class GuiLogConfig extends GuiSubscreen{constructor(e){super(),this.config=null,this.failed=!1,this.configList=[],this.allowDelete=!1,this.allowConfigure=!1,this.page=0,this.showHelp=!1,this.filterInput=createInputElement("text",30),this.character=e,this.filterInput.addEventListener("input",(e=>{this.rebuildList()}))}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.config=null,this.rebuildList(),Promise.all([this.character.getLogConfig(),this.character.getPermissionAccess("log_delete"),this.character.getPermissionAccess("log_configure")]).then((e=>{this.config=e[0],this.allowDelete=e[1],this.allowConfigure=e[2],this.rebuildList()}),(e=>{console.error(`BCX: Failed to get log config for ${this.character}`,e),this.failed=!0}))}rebuildList(){if(!this.active)return;if(this.configList=[],null===this.config)return void this.filterInput.remove();this.filterInput.parentElement||document.body.appendChild(this.filterInput);const e=this.filterInput.value.trim().toLocaleLowerCase().split(" ");for(const[t,o]of Object.entries(this.config))void 0!==LOG_CONFIG_NAMES[t]&&void 0!==LOG_LEVEL_NAMES[o]&&e.every((e=>LOG_CONFIG_NAMES[t].toLocaleLowerCase().includes(e)||t.toLocaleLowerCase().includes(e)))&&this.configList.push({category:t,access:o,name:LOG_CONFIG_NAMES[t]});this.configList.sort(((e,t)=>e.name.localeCompare(t.name)));const t=Math.ceil(this.configList.length/PER_PAGE_COUNT$3);this.page<0?this.page=Math.max(t-1,0):this.page>=t&&(this.page=0)}Run(){if(null!==this.config){DrawText("Filter:",130,215,"Black"),positionElement(this.filterInput,550,210,600,64),this.filterInput.value&&(MainCanvas.textAlign="center",DrawButton(870,182,64,64,"X","White")),MainCanvas.textAlign="left";for(let e=0;e<PER_PAGE_COUNT$3;e++){const t=this.page*PER_PAGE_COUNT$3+e;if(t>=this.configList.length)break;const o=this.configList[t],n=290+100*e;DrawButton(130,n,1070,64,"","White"),DrawTextFit(o.name,140,n+34,1060,"Black"),MainCanvas.textAlign="center",this.allowConfigure?DrawBackNextButton(1270,n,170,64,LOG_LEVEL_NAMES[o.access],"White","",(()=>o.access>0?LOG_LEVEL_NAMES[o.access-1]:""),(()=>o.access<2?LOG_LEVEL_NAMES[o.access+1]:"")):DrawButton(1270,n,170,64,LOG_LEVEL_NAMES[o.access],"#ccc",void 0,void 0,!0),MainCanvas.textAlign="left"}const e=Math.max(1,Math.ceil(this.configList.length/PER_PAGE_COUNT$3));MainCanvas.textAlign="center",DrawBackNextButton(1605,800,300,90,`${DialogFindPlayer("Page")} ${this.page+1} / ${e}`,"White","",(()=>""),(()=>""))}else this.failed?(MainCanvas.textAlign="center",DrawText(`Failed to get log config data from ${this.character.Name}. Maybe you have no access?`,1e3,480,"Black")):(MainCanvas.textAlign="center",DrawText("Loading...",1e3,480,"Black"));MainCanvas.textAlign="left",DrawText(`- Behaviour Log: Configuration for ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",this.allowDelete&&DrawButton(1525,690,380,64,"Delete all log entries","White"),this.showHelp&&showHelp(HELP_TEXTS[Views.LogConfig]),DrawButton(1815,75,90,90,"","White","Icons/Exit.png","Back"),DrawButton(1815,190,90,90,"","White","Icons/Question.png")}Click(){if(MouseIn(1815,75,90,90))return this.Exit();if(MouseIn(1815,190,90,90))this.showHelp=!this.showHelp;else if(null!==this.config){MouseIn(870,182,64,64)&&(this.filterInput.value="",this.rebuildList());for(let e=0;e<PER_PAGE_COUNT$3;e++){const t=this.page*PER_PAGE_COUNT$3+e;if(t>=this.configList.length)break;const o=this.configList[t],n=290+100*e;if(o.access>0&&MouseIn(1270,n,85,64)&&this.allowConfigure)return void this.character.setLogConfig(o.category,o.access-1);if(o.access<2&&MouseIn(1355,n,85,64)&&this.allowConfigure)return void this.character.setLogConfig(o.category,o.access+1)}if(MouseIn(1525,690,380,64)&&this.allowDelete)return void this.character.logClear().then((()=>{setSubscreen(new GuiLog(this.character))}));const e=Math.ceil(this.configList.length/PER_PAGE_COUNT$3);MouseIn(1605,800,150,90)?(this.page--,this.page<0&&(this.page=Math.max(e-1,0))):MouseIn(1755,800,150,90)&&(this.page++,this.page>=e&&(this.page=0))}}Exit(){setSubscreen(new GuiLog(this.character))}Unload(){this.filterInput.remove()}}const PER_PAGE_COUNT$2=5;class GuiLog extends GuiSubscreen{constructor(e){super(),this.failed=!1,this.logData=null,this.logEntries=[],this.allowDeletion=!1,this.allowConfiguration=!1,this.allowPraise=!1,this.allowLeaveMessage=!1,this.page=0,this.showMore=new Array(PER_PAGE_COUNT$2).fill(!1),this.showHelp=!1,this.filterInput=createInputElement("text",30),this.character=e,this.filterInput.addEventListener("input",(e=>{this.refreshScreen()}))}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.logData=null,this.refreshScreen(),Promise.all([this.character.getLogEntries(),this.character.logGetAllowedActions()]).then((e=>{this.logData=e[0],this.allowDeletion=e[1].delete,this.allowConfiguration=e[1].configure||this.character.isPlayer(),this.allowPraise=e[1].praise,this.allowLeaveMessage=e[1].leaveMessage,this.refreshScreen()}),(e=>{console.error(`BCX: Failed to get log data for ${this.character}`,e),this.failed=!0}))}refreshScreen(){if(!this.active)return;this.logEntries=[];let e=document.getElementById("BCX_NoteField");if(null===this.logData)return this.filterInput.remove(),void(e&&e.remove());this.filterInput.parentElement||document.body.appendChild(this.filterInput),!this.allowLeaveMessage&&e?e.remove():this.allowLeaveMessage&&!e&&(e=ElementCreateInput("BCX_NoteField","text","","30"));const t=this.filterInput.value.trim().toLocaleLowerCase().split(" ");this.logEntries=this.logData.filter((e=>{const o=logMessageRender(e,this.character).toLocaleLowerCase();return t.every((e=>o.includes(e)))}));const o=Math.ceil(this.logEntries.length/PER_PAGE_COUNT$2);this.page<0?this.page=Math.max(o-1,0):this.page>=o&&(this.page=0)}Run(){if(null!==this.logData){DrawText("Filter:",130,215,"Black"),positionElement(this.filterInput,550,210,600,64),this.filterInput.value&&(MainCanvas.textAlign="center",DrawButton(870,182,64,64,"X","White"));for(let e=0;e<PER_PAGE_COUNT$2;e++){const t=this.page*PER_PAGE_COUNT$2+e;if(t>=this.logEntries.length)break;const o=this.logEntries[t],n=290+95*e;DrawImageEx(o[1]===LogAccessLevel.protected?"Icons/Security.png":"Icons/Public.png",125,n,{Height:64,Width:64}),MainCanvas.textAlign="left";const r=logMessageRender(o,this.character);if(this.showMore[e])MainCanvas.fillStyle="#ffff88",MainCanvas.fillRect(200,n-32,1030,128),MainCanvas.strokeStyle="Black",MainCanvas.strokeRect(200,n-32,1030,128),DrawTextWrap(r,-285,n-32+5,990,118,"black",void 0,3);else{DrawButton(200,n,1030,64,"","White");let e=r;r.length>95&&(e=e.slice(0,80)+"... >> click <<"),DrawTextFit(e,210,n+34,1020,e.startsWith("[")?"Gray":"Black")}MainCanvas.beginPath(),MainCanvas.rect(1270,n,320,64),MainCanvas.stroke(),DrawTextFit(new Date(o[0]).toLocaleString(),1290,n+34,300,"Black",""),MainCanvas.textAlign="center",this.allowDeletion&&DrawButton(1630,n,64,64,"X","White","","Delete log entry"),MouseIn(125,n,64,64)&&DrawButtonHover(125,n,64,64,o[1]===LogAccessLevel.protected?"Protected visibility":"Normal visibility")}this.allowLeaveMessage&&(MainCanvas.textAlign="left",DrawText("Attach",130,831,"Black"),DrawText("note:",130,869,"Black"),ElementPosition("BCX_NoteField",580,842,660,64)),MainCanvas.textAlign="center",this.allowPraise&&DrawButton(950,815,150,64,"Praise","White"),this.allowLeaveMessage&&DrawButton(1150,815,200,64,"Only note","White"),this.allowPraise&&DrawButton(1400,815,150,64,"Scold","White");const e=Math.max(1,Math.ceil(this.logEntries.length/PER_PAGE_COUNT$2));DrawBackNextButton(1605,800,300,90,`${DialogFindPlayer("Page")} ${this.page+1} / ${e}`,"White","",(()=>""),(()=>""))}else this.failed?(MainCanvas.textAlign="center",DrawText(`Failed to get log data from ${this.character.Name}. Maybe you have no access?`,1e3,480,"Black")):(MainCanvas.textAlign="center",DrawText("Loading...",1e3,480,"Black"));this.showHelp&&showHelp(HELP_TEXTS[Views.Log]),MainCanvas.textAlign="left",DrawText(`- Behaviour Log: About ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","BCX main menu"),DrawButton(1815,190,90,90,"","White","Icons/Question.png"),DrawButton(1815,305,90,90,"",this.allowConfiguration?"White":"#ddd","Icons/Preference.png","Configure logging",!this.allowConfiguration)}Click(){if(MouseIn(1815,75,90,90))return this.Exit();if(MouseIn(1815,190,90,90))this.showHelp=!this.showHelp;else{if(MouseIn(1815,305,90,90)&&this.allowConfiguration)return setSubscreen(new GuiLogConfig(this.character));if(null!==this.logData){MouseIn(870,182,64,64)&&(this.filterInput.value="",this.refreshScreen());for(let e=0;e<PER_PAGE_COUNT$2;e++){const t=this.page*PER_PAGE_COUNT$2+e;if(t>=this.logEntries.length)break;const o=this.logEntries[t],n=290+95*e;if(this.allowDeletion&&MouseIn(1630,n,64,64))return void this.character.logMessageDelete(o[0]);MouseIn(200,n-32,1030,128)&&this.showMore[e]?this.showMore[e]=!this.showMore[e]:MouseIn(200,n,1030,64)&&(this.showMore.includes(!0)&&this.showMore.fill(!1),this.showMore[e]=!this.showMore[e])}const e=document.getElementById("BCX_NoteField"),t=(null==e?void 0:e.value)||null;let o=!1;if(this.allowPraise&&MouseIn(950,815,150,64)&&(this.character.logPraise(1,t),o=!0),this.allowLeaveMessage&&MouseIn(1150,815,200,64)&&t&&(this.character.logPraise(0,t),o=!0),this.allowPraise&&MouseIn(1400,815,150,64)&&(this.character.logPraise(-1,t),o=!0),o)return this.allowPraise=!1,void(e&&(e.value=""));const n=Math.ceil(this.logEntries.length/PER_PAGE_COUNT$2);MouseIn(1605,800,150,90)?(this.showMore.fill(!1),this.page--,this.page<0&&(this.page=Math.max(n-1,0))):MouseIn(1755,800,150,90)&&(this.showMore.fill(!1),this.page++,this.page>=n&&(this.page=0))}}}Exit(){setSubscreen(new GuiMainMenu(this.character))}Unload(){this.filterInput.remove(),ElementRemove("BCX_NoteField")}}class GuiMisc extends GuiSubscreen{constructor(e){super(),this.showHelp=!1,this.character=e}Run(){MainCanvas.textAlign="left",DrawText(`- Miscellaneous: Configuration for ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","BCX main menu"),this.character.isPlayer()&&DrawButton(1815,190,90,90,"","White","Icons/Question.png"),this.character.isPlayer()?(MainCanvas.textAlign="left",DrawCheckbox(125,200,64,64,"Enable typing indicator",!!modStorage.typingIndicatorEnable),DrawCheckbox(125,300,64,64,"Enable status indicator showing when you are in any player's BCX menu, biography, or wardrobe",!!modStorage.screenIndicatorEnable),DrawCheckbox(125,400,64,64,"Cheat: Prevent random NPC events (kidnappings, ransoms, asylum, club slaves)",cheatIsEnabled(MiscCheat.BlockRandomEvents)),DrawCheckbox(125,500,64,64,"Cheat: Prevent loosing Mistress status when reputation falls below 50 dominance",cheatIsEnabled(MiscCheat.CantLoseMistress)),DrawCheckbox(125,600,64,64,"Cheat: Give yourself the mistress padlock and its key",cheatIsEnabled(MiscCheat.GiveMistressKey)),DrawCheckbox(125,700,64,64,"Cheat: Give yourself the pandora padlock and its key",cheatIsEnabled(MiscCheat.GivePandoraKey)),this.showHelp&&showHelp(HELP_TEXTS[Views.Misc])):DrawText("Miscellaneous module configuration is not possible on others",1e3,500,"Black")}Click(){if(MouseIn(1815,75,90,90))return this.Exit();MouseIn(1815,190,90,90)&&this.character.isPlayer()?this.showHelp=!this.showHelp:this.character.isPlayer()&&(MouseIn(125,200,64,64)&&(modStorage.typingIndicatorEnable=!modStorage.typingIndicatorEnable,modStorageSync()),MouseIn(125,300,64,64)&&(modStorage.screenIndicatorEnable=!modStorage.screenIndicatorEnable,modStorageSync()),MouseIn(125,400,64,64)&&cheatToggle(MiscCheat.BlockRandomEvents),MouseIn(125,500,64,64)&&cheatToggle(MiscCheat.CantLoseMistress),MouseIn(125,600,64,64)&&cheatToggle(MiscCheat.GiveMistressKey),MouseIn(125,700,64,64)&&cheatToggle(MiscCheat.GivePandoraKey))}Exit(){setSubscreen(new GuiMainMenu(this.character))}}const CURSES_ANTILOOP_RESET_INTERVAL=6e4,CURSES_ANTILOOP_THRESHOLD=10,CURSES_ANTILOOP_SUSPEND_TIME=6e5,CURSE_IGNORED_PROPERTIES=ValidationModifiableProperties.slice(),CURSE_IGNORED_EFFECTS=["Lock"];function curseMakeSavedProperty(e){const t={};if(isObject$1(e))for(const o of Object.keys(e))if("Effect"===o)if(Array.isArray(e.Effect)&&e.Effect.every((e=>"string"==typeof e))){const o=e.Effect.filter((e=>!CURSE_IGNORED_EFFECTS.includes(e)));o.length>0&&(t.Effect=o)}else console.error("BCX: Bad effect of properties: ",e.Effect);else CURSE_IGNORED_PROPERTIES.includes(o)||void 0===e[o]||(t[o]=cloneDeep(e[o]));return t}function curseCreateCurseItemInfo(e){const t={Name:e.Asset.Name,curseProperty:!1,Difficulty:e.Difficulty||void 0,Color:e.Color&&"Default"!==e.Color?cloneDeep(e.Color):void 0,Property:curseMakeSavedProperty(e.Property)};return 0===Object.keys(t.Property).length&&delete t.Property,t}function curseAllowItemCurseProperty(e){var t,o,n,r;return!!(e.Extended||(null===(t=e.Effect)||void 0===t?void 0:t.includes("Egged"))||(null===(o=e.AllowEffect)||void 0===o?void 0:o.includes("Egged"))||(null===(n=e.Effect)||void 0===n?void 0:n.includes("UseRemote"))||(null===(r=e.AllowEffect)||void 0===r?void 0:r.includes("UseRemote")))}function curseDefaultItemCurseProperty(e){return curseAllowItemCurseProperty(e)&&e.Extended&&"typed"===e.Archetype}function curseItem(e,t,o){var n;if(!moduleIsEnabled(ModuleCategory.Curses))return!1;const r=AssetGroup.find((t=>t.Name===e));if(!r||"boolean"!=typeof t&&null!==t)return console.error("BCX: Attempt to curse with invalid data",e,t),!1;if("Appearance"===r.Category&&!r.Clothing)return console.warn("BCX: Attempt to curse body",e),!1;if(o&&!ConditionsCheckAccess("curses",e,o))return!1;const i=InventoryGet(Player,e);if(i){if(null===t){if(ConditionsGetCondition("curses",e))return!0;t=curseDefaultItemCurseProperty(i.Asset)}!curseAllowItemCurseProperty(i.Asset)&&t&&(console.warn(`BCX: Attempt to curse properties of item ${i.Asset.Group.Name}:${i.Asset.Name}, while not allowed`),t=!1);const r=curseCreateCurseItemInfo(i);t&&(r.curseProperty=!0),(null===(n=ConditionsGetCategoryData("curses").data)||void 0===n?void 0:n.itemRemove)&&(r.itemRemove=!0),ConditionsSetCondition("curses",e,r),o&&(logMessage("curse_change",LogEntryType.plaintext,`${o} cursed ${Player.Name}'s ${i.Asset.Description}`),o.isPlayer()||ChatRoomSendLocal(`${o} cursed the ${i.Asset.Description} on you`))}else ConditionsSetCondition("curses",e,null),o&&(logMessage("curse_change",LogEntryType.plaintext,`${o} cursed ${Player.Name}'s body part to stay exposed (${getVisibleGroupName(r)})`),o.isPlayer()||ChatRoomSendLocal(`${o} put a curse on you, forcing part of your body to stay exposed (${getVisibleGroupName(r)})`));return modStorageSync(),notifyOfChange(),!0}function curseBatch(e,t,o){if(o&&!checkPermissionAccess("curses_normal",o)&&!checkPermissionAccess("curses_limited",o))return!1;let n;if("items"===e)n=AssetGroup.filter((e=>"Item"===e.Category&&(t||InventoryGet(Player,e.Name))));else{if("clothes"!==e)return console.error("BCX: Attempt to curse in invalid mode",e),!1;n=AssetGroup.filter((e=>"Appearance"===e.Category&&e.Clothing&&(t||InventoryGet(Player,e.Name))))}o&&(logMessage("curse_change",LogEntryType.plaintext,`${o} cursed all of ${Player.Name}'s ${t?"":"occupied "}${"items"===e?"item":"clothing"} slots`),o.isPlayer()||ChatRoomSendLocal(`${o} cursed all of your ${t?"":"occupied "}${"items"===e?"item":"clothing"} slots`));for(const e of n)if(!ConditionsGetCondition("curses",e.Name)&&(!o||ConditionsCheckAccess("curses",e.Name,o))&&!curseItem(e.Name,null,null))return!1;return!0}function curseLift(e,t){var o;if(!moduleIsEnabled(ModuleCategory.Curses))return!1;if(t&&!ConditionsCheckAccess("curses",e,t))return!1;const n=ConditionsGetCondition("curses",e);if(n){const r=AssetGroup.find((t=>t.Name===e));if(t&&r){const i=n.data&&(null===(o=AssetGet(Player.AssetFamily,e,n.data.Name))||void 0===o?void 0:o.Description);i?(logMessage("curse_change",LogEntryType.plaintext,`${t} lifted the curse on ${Player.Name}'s ${i}`),t.isPlayer()||ChatRoomSendLocal(`${t} lifted the curse on your ${i}`)):(logMessage("curse_change",LogEntryType.plaintext,`${t} lifted the curse on ${Player.Name}'s body part (${getVisibleGroupName(r)})`),t.isPlayer()||ChatRoomSendLocal(`${t} lifted the curse on part of your body (${getVisibleGroupName(r)})`))}return ConditionsRemoveCondition("curses",e),!0}return!1}function curseLiftAll(e){return!!moduleIsEnabled(ModuleCategory.Curses)&&(!!(!e||checkPermissionAccess("curses_normal",e)&&checkPermissionAccess("curses_limited",e))&&(e&&(logMessage("curse_change",LogEntryType.plaintext,`${e} lifted all curse on ${Player.Name}`),e.isPlayer()||ChatRoomSendLocal(`${e} lifted all curses on you`)),ConditionsRemoveCondition("curses",Object.keys(ConditionsGetCategoryData("curses").conditions)),!0))}class ModuleCurses extends BaseModule{constructor(){super(...arguments),this.resetTimer=null,this.triggerCounts=new Map,this.suspendedUntil=null,this.pendingMessages={remove:[],add:[],swap:[],update:[],color:[],autoremove:[]}}init(){registerPermission("curses_normal",{name:"Allows handling curses on non-limited object slots",category:ModuleCategory.Curses,defaults:{[Preset.dominant]:[!0,AccessLevel.lover],[Preset.switch]:[!0,AccessLevel.lover],[Preset.submissive]:[!1,AccessLevel.mistress],[Preset.slave]:[!1,AccessLevel.mistress]}}),registerPermission("curses_limited",{name:"Allows handling curses on limited object slots",category:ModuleCategory.Curses,defaults:{[Preset.dominant]:[!0,AccessLevel.owner],[Preset.switch]:[!0,AccessLevel.owner],[Preset.submissive]:[!1,AccessLevel.lover],[Preset.slave]:[!1,AccessLevel.lover]}}),registerPermission("curses_global_configuration",{name:"Allows editing the global curses configuration",category:ModuleCategory.Curses,defaults:{[Preset.dominant]:[!0,AccessLevel.owner],[Preset.switch]:[!0,AccessLevel.owner],[Preset.submissive]:[!1,AccessLevel.lover],[Preset.slave]:[!1,AccessLevel.lover]}}),registerPermission("curses_change_limits",{name:"Allows to limit/block individual curse object slots",category:ModuleCategory.Curses,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.self],[Preset.slave]:[!1,AccessLevel.owner]}}),registerPermission("curses_color",{name:"Allow changing colors of cursed objects",category:ModuleCategory.Curses,defaults:{[Preset.dominant]:[!0,AccessLevel.lover],[Preset.switch]:[!0,AccessLevel.lover],[Preset.submissive]:[!0,AccessLevel.mistress],[Preset.slave]:[!1,AccessLevel.mistress]}}),queryHandlers.curseItem=(e,t,o)=>{!isObject$1(o)||"string"!=typeof o.Group||"boolean"!=typeof o.curseProperties&&null!==o.curseProperties?t(!1):t(!0,curseItem(o.Group,o.curseProperties,e))},queryHandlers.curseLift=(e,t,o)=>{"string"==typeof o?t(!0,curseLift(o,e)):t(!1)},queryHandlers.curseBatch=(e,t,o)=>{isObject$1(o)&&"string"==typeof o.mode&&"boolean"==typeof o.includingEmpty?t(!0,curseBatch(o.mode,o.includingEmpty,e)):t(!1)},queryHandlers.curseLiftAll=(e,t)=>{t(!0,curseLiftAll(e))},registerWhisperCommand("curses","- Manage curses",((e,t,o)=>{var n;if(!moduleIsEnabled(ModuleCategory.Curses))return o("Curses module is disabled.");const r=(e[0]||"").toLocaleLowerCase(),i=ConditionsGetCategoryPublicData("curses",t).conditions;if(ConditionsSubcommands.includes(r))return ConditionsRunSubcommand("curses",e,t,o);if("list"===r){let e="Current curses:";for(const[t,r]of Object.entries(i)){const i=AssetGroup.find((e=>e.Name===t));if(!i){console.warn(`BCX: Unknown group ${t}`);continue}let a=`\n[${i.Clothing?"Clothing":"Item"}] `;if(null===r.data)a+=`Blocked: ${getVisibleGroupName(i)}`;else{const e=AssetGet(Player.AssetFamily,t,r.data.Name),o=`Timer: ${r.timer?formatTimeInterval(r.timer-Date.now(),"short"):""}`;a+=`${null!==(n=null==e?void 0:e.Description)&&void 0!==n?n:r.data.Name} (${getVisibleGroupName(i)}) | ${o}`+(r.data.curseProperties?" | Item configuration also cursed":"")}e.length+a.length>=990&&(e+="\n...",o(e),e="Current curses (continued):"),e+=a}o(e)}else if("listgroups"===r){const n=(e[1]||"").toLocaleLowerCase();if("items"===n){let e="List of item groups:";const t=AssetGroup.filter((e=>"Item"===e.Category));for(const o of t){const t=InventoryGet(Player,o.Name),n=void 0!==i[o.Name];e+=`\n${getVisibleGroupName(o)}: ${t?t.Asset.Description:"[Nothing]"}`,n&&(e+=" [cursed]")}o(e)}else if("clothes"===n){let e="List of clothes groups:";const t=AssetGroup.filter((e=>"Appearance"===e.Category&&e.Clothing));for(const o of t){const t=InventoryGet(Player,o.Name),n=void 0!==i[o.Name];e+=`\n${getVisibleGroupName(o)}: ${t?t.Asset.Description:"[Nothing]"}`,n&&(e+=" [cursed]")}o(e)}else o(Command_fixExclamationMark(t,"Expected one of:\n!curses listgroups items\n!curses listgroups clothes"))}else if("curse"===r){const n=Command_selectGroup(e[1]||"",getPlayerCharacter(),(e=>"Appearance"!==e.Category||e.Clothing));if("string"==typeof n)return o(n);if(void 0!==i[n.Name])return o("This group or item is already cursed");o(curseItem(n.Name,null,t)?"Ok.":COMMAND_GENERIC_ERROR)}else if("curseworn"===r||"curseall"===r){const n=(e[1]||"").toLocaleLowerCase();if("items"===n||"clothes"===n)return o(curseBatch(n,"curseall"===r,t)?"Ok.":COMMAND_GENERIC_ERROR);o(Command_fixExclamationMark(t,`Expected one of:\n!curses ${r} items\n!curses ${r} clothes`))}else if("lift"===r){const n=Command_selectGroup(e[1]||"",getPlayerCharacter(),(e=>"Appearance"!==e.Category||e.Clothing));if("string"==typeof n)return o(n);if(void 0===i[n.Name])return o("This group or item is not cursed");o(curseLift(n.Name,t)?"Ok.":COMMAND_GENERIC_ERROR)}else if("liftall"===r)o(curseLiftAll(t)?"Ok.":COMMAND_GENERIC_ERROR);else if("configuration"===r){const n=Command_selectGroup(e[1]||"",getPlayerCharacter(),(e=>"Appearance"!==e.Category||e.Clothing));if("string"==typeof n)return o(n);const r=i[n.Name];if(!r)return o("This group or item is not cursed");const a=(e[2]||"").toLocaleLowerCase();if("yes"!==a&&"no"!==a)return o("Expected yes or no");if(null==r.data)return o("Empty groups cannot have configuration cursed");const s=AssetGet(Player.AssetFamily,n.Name,i[n.Name].data.Name);if(s&&"yes"===a&&!curseAllowItemCurseProperty(s))return o("This item cannot have configuration cursed");r.data.curseProperties="yes"===a,o(ConditionsUpdate("curses",n.Name,r,t)?"Ok.":COMMAND_GENERIC_ERROR)}else if("autoremove"===r){const n=Command_selectGroup(e[1]||"",getPlayerCharacter(),(e=>"Appearance"!==e.Category||e.Clothing));if("string"==typeof n)return o(n);const r=i[n.Name];if(!r)return o("This group or item is not cursed");if(!i[n.Name].requirements)return o("Cannot change autoremove while the curse uses the global configuration. First use:\ncurses triggers <curse> global no");const a=(e[2]||"").toLocaleLowerCase();if("yes"!==a&&"no"!==a)return o("Expected yes or no");if(null==r.data)return o("Empty groups have no item to be automatically removed");r.data.itemRemove="yes"===a,o(ConditionsUpdate("curses",n.Name,r,t)?"Ok.":COMMAND_GENERIC_ERROR)}else o(Command_fixExclamationMark(t,"!curses usage (page 1):\n!curses list - List all cursed <group>s and related info (eg. cursed items)\n!curses listgroups <items|clothes> - Lists all possible item or cloth <group> slots and worn items\n!curses curse <group> - Places a curse on the specified item/cloth <group>\n!curses curseworn <items|clothes> - Place a curse on all currently worn items/clothes\n!curses curseall <items|clothes> - Place a curse on all item/cloth slots, both used and empty\n!curses lift <group> - Lifts (removes) the curse from the specified item/cloth <group>\n!curses liftall - Lifts (removes) all curses\n!curses configuration <group> <yes|no> - Curses or uncurses the item configuration of an item/cloth in <group>\n!curses autoremove <group> <yes|no> - Removes an item/cloth in <group> when the curse is no longer in effect")),o(Command_fixExclamationMark(t,'!curses usage (page 2):\n!curses setactive <group> <yes/no> - Switch the curse and its conditions on and off\n!curses triggers <group> global <yes/no> - Set the trigger condition of this curse to the global configuration\n!curses triggers <group> help - Set the trigger configuration of a curse\n!curses globaltriggers help - Set global trigger configuration\n!curses timer <group> help - Set timer options of a curse\n!curses defaulttimer help - Set default timer options used on new curses\n!curses setlimit <group> <normal/limited/blocked> - Set a limit on certain <group>\n\nHint: If an argument contains spaces: "put it in quotes"'))}),((e,t)=>{if(!moduleIsEnabled(ModuleCategory.Curses))return[];if(e.length<=1)return Command_pickAutocomplete(e[0],["list","listgroups","curse","curseworn","curseall","lift","liftall","configuration","autoremove",...ConditionsSubcommands]);const o=e[0].toLocaleLowerCase(),n=ConditionsGetCategoryPublicData("curses",t).conditions;if(ConditionsSubcommands.includes(o))return ConditionsAutocompleteSubcommand("curses",e,t);if("listgroups"===o){if(2===e.length)return Command_pickAutocomplete(e[1],["items","clothes"])}else if("curse"===o){if(2===e.length)return Command_selectGroupAutocomplete(e[1]||"",getPlayerCharacter(),(e=>"Appearance"!==e.Category||e.Clothing))}else if("curseworn"===o||"curseall"===o){if(2===e.length)return Command_pickAutocomplete(e[1],["items","clothes"])}else if("lift"===o){if(2===e.length)return Command_selectGroupAutocomplete(e[1]||"",getPlayerCharacter(),(e=>void 0!==n[e.Name]))}else if("configuration"===o){if(2===e.length)return Command_selectGroupAutocomplete(e[1]||"",getPlayerCharacter(),(e=>void 0!==n[e.Name]));if(3===e.length)return Command_pickAutocomplete(e[2],["yes","no"])}else if("autoremove"===o){if(2===e.length)return Command_selectGroupAutocomplete(e[1]||"",getPlayerCharacter(),(e=>void 0!==n[e.Name]));if(3===e.length)return Command_pickAutocomplete(e[2],["yes","no"])}return[]})),ConditionsRegisterCategory("curses",{category:ModuleCategory.Curses,permission_normal:"curses_normal",permission_limited:"curses_limited",permission_configure:"curses_global_configuration",permission_changeLimits:"curses_change_limits",loadValidateConditionKey:e=>AssetGroup.some((t=>t.Name===e)),loadValidateCondition:(e,t)=>{const o=t.data;return null===o||(isObject$1(o)&&"string"==typeof o.Name&&"boolean"==typeof o.curseProperty?null!=AssetGet("Female3DCG",e,o.Name)||(console.warn(`BCX: Unknown cursed item ${e}:${o.Name}, removing it`,o),!1):(console.error(`BCX: Bad data for cursed item in group ${e}, removing it`,o),!1))},loadCategorySpecificGlobalData:e=>(isObject$1(e)||(console.warn("BCX: Bad curses global data, resetting"),e={itemRemove:!1}),"boolean"!=typeof e.itemRemove&&(e.itemRemove=!1),e),stateChangeHandler:this.curseStateChange.bind(this),tickHandler:this.curseTick.bind(this),afterTickHandler:this.afterCurseTick.bind(this),makePublicData:(e,t)=>{var o;return null===t.data?null:{Name:t.data.Name,curseProperties:t.data.curseProperty,itemRemove:null!==(o=t.data.itemRemove)&&void 0!==o&&o}},validateCategorySpecificGlobalData:e=>isObject$1(e)&&"boolean"==typeof e.itemRemove,validatePublicData:(e,t)=>null===t||isObject$1(t)&&"string"==typeof t.Name&&"boolean"==typeof t.curseProperties&&"boolean"==typeof t.itemRemove,updateCondition:(e,t,o,n,r)=>{var i;if((null===(i=t.data)||void 0===i?void 0:i.Name)!==(null==o?void 0:o.Name))return!1;if(!t.data||!o)return!0;const a=AssetGet(Player.AssetFamily,e,t.data.Name);return a?(t.data.curseProperty=o.curseProperties,!curseAllowItemCurseProperty(a)&&t.data.curseProperty&&(console.warn(`BCX: Attempt to curse properties of item ${e}:${t.data.Name}, while not allowed`),t.data.curseProperty=!1),o.itemRemove&&r.requirements?t.data.itemRemove=!0:delete t.data.itemRemove,!0):(console.warn(`BCX: Curse asset ${e}:${t.data.Name} not found during update`),!1)},parseConditionName:(e,t)=>{const o=Command_selectGroup(e,getPlayerCharacter(),(e=>("Appearance"!==e.Category||e.Clothing)&&(!t||t.includes(e.Name))));return"string"==typeof o?[!1,o]:[!0,o.Name]},autocompleteConditionName:(e,t)=>Command_selectGroupAutocomplete(e,getPlayerCharacter(),(e=>("Appearance"!==e.Category||e.Clothing)&&(!t||t.includes(e.Name)))),logLimitChange:(e,t,o)=>{logMessage("curse_change",LogEntryType.plaintext,`${t} changed ${Player.Name}'s curse slot '${e}' permission to ${ConditionsLimit[o]}`),t.isPlayer()||ChatRoomSendLocal(`${t} changed curse slot '${e}' permission to ${ConditionsLimit[o]}`,void 0,t.MemberNumber)},logConditionUpdate:(e,t,o,n)=>{var r,i,a,s,l,c;const u=AssetGroup.find((t=>t.Name===e)),d=u?getVisibleGroupName(u):"[ERROR]",m=o.active!==n.active,h=o.timer!==n.timer||o.timerRemove!==n.timerRemove,g=!isEqual(o.requirements,n.requirements),f=null!=o.requirements&&(null===(r=o.data)||void 0===r?void 0:r.itemRemove)!==(null===(i=n.data)||void 0===i?void 0:i.itemRemove),p=(null===(a=o.data)||void 0===a?void 0:a.curseProperties)!==(null===(s=n.data)||void 0===s?void 0:s.curseProperties),C=[];if(m&&C.push("active state"),h&&C.push("timer"),g&&C.push("trigger condition"),f&&C.push("autoremove option"),p&&C.push("item config curse"),C.length>0&&logMessage("curse_change",LogEntryType.plaintext,`${t} changed the ${C.join(", ")} of ${Player.Name}'s curse on slot '${d}'`),!t.isPlayer()){if(m&&ChatRoomSendLocal(`${t} ${o.active?"reactivated":"deactivated"} the curse on slot '${d}'`,void 0,t.MemberNumber),o.timer!==n.timer&&(null===o.timer?ChatRoomSendLocal(`${t} disabled the timer of the curse on slot '${d}'`,void 0,t.MemberNumber):ChatRoomSendLocal(`${t} changed the remaining time of the timer of the curse on slot '${d}' to ${formatTimeInterval(o.timer-Date.now())}`,void 0,t.MemberNumber)),null!==o.timer&&o.timerRemove!==n.timerRemove&&ChatRoomSendLocal(`${t} changed the timer behavior of the curse on slot '${d}' to ${o.timerRemove?"remove":"disable"} the curse when time runs out`,void 0,t.MemberNumber),f&&ChatRoomSendLocal(`${t} set the curse on slot '${d}' to ${(null===(l=o.data)||void 0===l?void 0:l.itemRemove)?"remove":"keep"} the item when the curse is no longer in effect`,void 0,t.MemberNumber),g)if(null===o.requirements)ChatRoomSendLocal(`${t} set the curse on slot '${d}' to use the global curses configuration`,void 0,t.MemberNumber);else{const e=[],n=o.requirements;if(n.room&&e.push(`When ${n.room.inverted?"not in":"in"} ${n.room.type} room`),n.roomName&&e.push(`When ${n.roomName.inverted?"not in":"in"} room named '${n.roomName.name}'`),n.role){const t=capitalizeFirstLetter(AccessLevel[n.role.role])+(n.role.role!==AccessLevel.clubowner?" ":"");e.push(`When ${n.role.inverted?"not in":"in"} room with role '${t}'`)}if(n.player){const t=getCharacterName(n.player.memberNumber,null);e.push(`When ${n.player.inverted?"not in":"in"} room with member '${n.player.memberNumber}'${t?` (${t})`:""}`)}e.length>0?ChatRoomSendLocal(`${t} set the curse on slot ${d} to trigger under following conditions:\n`+e.join("\n"),void 0,t.MemberNumber):ChatRoomSendLocal(`${t} deactivated all trigger conditions of the curse on slot ${d}. The curse will now always trigger, while it is active`,void 0,t.MemberNumber)}p&&ChatRoomSendLocal(`${t} ${(null===(c=o.data)||void 0===c?void 0:c.curseProperties)?"cursed":"lifted the curse of"} the '${d}' item's configuration`,void 0,t.MemberNumber)}},logCategoryUpdate:(e,t,o)=>{var n,r,i;const a=t.timer!==o.timer||t.timerRemove!==o.timerRemove,s=!isEqual(t.requirements,o.requirements),l=(null===(n=t.data)||void 0===n?void 0:n.itemRemove)!==(null===(r=o.data)||void 0===r?void 0:r.itemRemove),c=[];if(a&&c.push("default timer"),s&&c.push("trigger condition"),l&&c.push("autoremove option"),c.length>0&&logMessage("curse_change",LogEntryType.plaintext,`${e} changed the ${c.join(", ")} of ${Player.Name}'s global curses config`),!e.isPlayer()&&(t.timer!==o.timer&&(null===t.timer?ChatRoomSendLocal(`${e} removed the default timer of the global curses configuration`,void 0,e.MemberNumber):ChatRoomSendLocal(`${e} changed the default timer of the global curses configuration to ${formatTimeInterval(t.timer)}`,void 0,e.MemberNumber)),null!==t.timer&&t.timerRemove!==o.timerRemove&&ChatRoomSendLocal(`${e} changed the default timeout behavior of the global curses configuration to ${t.timerRemove?"removal of curses":"disabling curses"} when time runs out`,void 0,e.MemberNumber),l&&ChatRoomSendLocal(`${e} changed the default curses behaviour to ${(null===(i=t.data)||void 0===i?void 0:i.itemRemove)?"remove":"keep"} an item when the curse on it is no longer in effect`,void 0,e.MemberNumber),s)){const o=[],n=t.requirements;if(n.room&&o.push(`When ${n.room.inverted?"not in":"in"} ${n.room.type} room`),n.roomName&&o.push(`When ${n.roomName.inverted?"not in":"in"} room named '${n.roomName.name}'`),n.role){const e=capitalizeFirstLetter(AccessLevel[n.role.role])+(n.role.role!==AccessLevel.clubowner?" ":"");o.push(`When ${n.role.inverted?"not in":"in"} room with role '${e}'`)}if(n.player){const e=getCharacterName(n.player.memberNumber,null);o.push(`When ${n.player.inverted?"not in":"in"} room with member '${n.player.memberNumber}'${e?` (${e})`:""}`)}o.length>0?ChatRoomSendLocal(`${e} set the global curses configuration to trigger curses under following conditions:\n`+o.join("\n"),void 0,e.MemberNumber):ChatRoomSendLocal(`${e} deactivated all trigger conditions for the global curses configuration. Curses set to this default configuration will now always trigger, while active`,void 0,e.MemberNumber)}},getDefaultLimits:()=>({}),commandConditionSelectorHelp:"group"})}load(){moduleIsEnabled(ModuleCategory.Curses)&&(hookFunction("ValidationResolveModifyDiff",0,((e,t)=>{const o=e[2],n=t(e);if(0===o.C.ID&&n.item){const e=ConditionsGetCondition("curses",n.item.Asset.Group.Name),t=null==e?void 0:e.data,r=getChatroomCharacter(o.sourceMemberNumber);t&&n.item.Asset.Name===t.Name&&!itemColorsEquals(t.Color,n.item.Color)&&r&&checkPermissionAccess("curses_color",r)&&(n.item.Color&&"Default"!==n.item.Color?t.Color=cloneDeep(n.item.Color):delete t.Color,modStorageSync())}return n}),ModuleCategory.Curses),hookFunction("ColorPickerDraw",0,((e,t)=>{const o=e[5];return o===ItemColorOnPickerChange&&(e[5]=e=>{if(ItemColorCharacter===Player&&ItemColorItem){const t=ItemColorState.colors.slice();ItemColorPickerIndices.forEach((o=>t[o]=e)),ItemColorItem.Color=t,CharacterLoadCanvas(ItemColorCharacter);const o=ConditionsGetCondition("curses",ItemColorItem.Asset.Group.Name),n=null==o?void 0:o.data;n&&!itemColorsEquals(n.Color,ItemColorItem.Color)&&checkPermissionAccess("curses_color",getPlayerCharacter())&&(ItemColorItem.Color&&"Default"!==ItemColorItem.Color?n.Color=cloneDeep(ItemColorItem.Color):delete n.Color,modStorageSync())}else o(e)}),t(e)})))}run(){moduleIsEnabled(ModuleCategory.Curses)&&(this.resetTimer=BCX_setInterval((()=>{this.triggerCounts.clear()}),CURSES_ANTILOOP_RESET_INTERVAL))}unload(){null!==this.resetTimer&&(clearInterval(this.resetTimer),this.resetTimer=null),removeAllHooksByModule(ModuleCategory.Curses)}reload(){this.unload(),this.load(),this.run()}curseTick(e,t){var o,n,r;if(null!==this.suspendedUntil){if(!(Date.now()>=this.suspendedUntil))return;this.suspendedUntil=null,this.triggerCounts.clear(),ChatRoomActionMessage(`The dormant curse on ${Player.Name}'s body wakes up again.`)}const i=AssetGroupGet(Player.AssetFamily,e);if(!i)return void console.error(`BCX: AssetGroup not found for curse ${e}`,t);if("Appearance"===CurrentScreen&&!isBind(i))return;const a=t.data;if(null===a){const t=InventoryGet(Player,e);return t?(InventoryRemove(Player,e,!1),CharacterRefresh(Player,!0),ChatRoomCharacterUpdate(Player),void this.pendingMessages.remove.push(t.Asset.Description)):void 0}const s=AssetGet("Female3DCG",e,a.Name);if(!s)return void console.error(`BCX: Asset not found for curse ${e}:${a.Name}`,a);let l="",c=InventoryGet(Player,e);if(c&&c.Asset.Name!==a.Name&&(InventoryRemove(Player,e,!1),l="swap",c=null),c||(c={Asset:s,Color:null!=a.Color?cloneDeep(a.Color):"Default",Property:null!=a.Property?cloneDeep(a.Property):{},Difficulty:null!=a.Difficulty?a.Difficulty:0},Player.Appearance.push(c),l||(l="add")),a.curseProperty){const e=c.Property=null!==(o=c.Property)&&void 0!==o?o:{},t=null!==(n=a.Property)&&void 0!==n?n:{};for(const o of arrayUnique(Object.keys(t).concat(Object.keys(e))))"Effect"!==o&&(CURSE_IGNORED_PROPERTIES.includes(o)?delete t[o]:void 0===t[o]?void 0!==e[o]&&(delete e[o],l||(l="update")):typeof t[o]==typeof e[o]&&isEqual(t[o],e[o])||(e[o]=cloneDeep(t[o]),l||(l="update")));const r=Array.isArray(e.Effect)?e.Effect.filter((e=>CURSE_IGNORED_EFFECTS.includes(e))):[],i=Array.isArray(e.Effect)?e.Effect.filter((e=>!CURSE_IGNORED_EFFECTS.includes(e))).sort():[],s=Array.isArray(t.Effect)?t.Effect.filter((e=>!CURSE_IGNORED_EFFECTS.includes(e))).sort():[];CommonArraysEqual(i,s)||(e.Effect=s.concat(r)),0===Object.keys(t).length?delete a.Property:isEqual(a.Property,t)||(a.Property=t)}else a.Property=curseCreateCurseItemInfo(c).Property;if(itemColorsEquals(a.Color,c.Color)||(void 0===a.Color||"Default"===a.Color?delete c.Color:c.Color=cloneDeep(a.Color),l||(l="color")),l){CharacterRefresh(Player,!0),ChatRoomCharacterUpdate(Player),this.pendingMessages[l].push(s.Description);const t=(null!==(r=this.triggerCounts.get(e))&&void 0!==r?r:0)+1;this.triggerCounts.set(e,t),t>=CURSES_ANTILOOP_THRESHOLD&&(ChatRoomActionMessage("Protection triggered: Curses have been disabled for 10 minutes. Please refrain from triggering curses so rapidly, as it creates strain on the server and may lead to unwanted side effects! If you believe this message was triggered by a bug, please report it to BCX Discord."),this.suspendedUntil=Date.now()+CURSES_ANTILOOP_SUSPEND_TIME)}}afterCurseTick(){for(const e of Object.keys(this.pendingMessages)){const t=this.pendingMessages[e];if(0!==t.length){if(t.length>=3)ChatRoomActionMessage(dictionaryProcess(CURSES_TRIGGER_TEXTS_BATCH[e],{})),"autoremove"!==e&&logMessage("curse_trigger",LogEntryType.curseTriggerBatch,e);else for(const o of t)ChatRoomActionMessage(dictionaryProcess(CURSES_TRIGGER_TEXTS[e],{ASSET_NAME:o})),"autoremove"!==e&&logMessage("curse_trigger",LogEntryType.curseTrigger,[e,o]);this.pendingMessages[e]=[]}}}curseStateChange(e,t,o){var n;if(!o&&t.data&&(t.requirements?t.data.itemRemove:null===(n=ConditionsGetCategoryData("curses").data)||void 0===n?void 0:n.itemRemove)){const o=InventoryGet(Player,e);o&&o.Asset.Name===t.data.Name&&null==InventoryGetLock(o)&&(InventoryRemove(Player,e,!0),ChatRoomCharacterUpdate(Player),this.pendingMessages.autoremove.push(o.Asset.Description))}}}class GuiConditionEdit extends GuiSubscreen{constructor(e,t,o,n){super(),this.conditionCategoryData=null,this.conditionData=null,this.failed=!1,this.changes=null,this.showHelp=!1,this.character=e,this.conditionCategory=t,this.conditionName=o,this.back=n}makeChangesData(){var e;if(!this.conditionData)throw new Error("Data required");return null!==(e=this.changes)&&void 0!==e?e:cloneDeep(this.conditionData)}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.conditionCategoryData=null,this.conditionData=null,this.failed=!1,this.onDataChange(),this.character.conditionsGetByCategory(this.conditionCategory).then((e=>{if(!this.active)return;const t=e.conditions[this.conditionName];t?(this.conditionCategoryData=e,this.conditionData=t,this.checkAccess()||(this.changes=null),this.onDataChange()):(console.warn(`BCX: Condition ${this.conditionCategory}:${this.conditionName} not found in list from ${this.character}`),this.failed=!0,this.Exit())}),(e=>{console.error(`BCX: Failed to get condition info for ${this.conditionCategory}:${this.conditionName} from ${this.character}`,e),this.failed=!0}))}setUseGlobal(e){var t;this.changes&&this.conditionData&&this.conditionCategoryData&&(this.changes.requirements=e?null:cloneDeep(null!==(t=this.conditionData.requirements)&&void 0!==t?t:this.conditionCategoryData.requirements))}onDataChange(){var e,t,o,n,r,i,a,s,l,c,u,d;let m=document.getElementById("BCX_ConditionRoomName"),h=document.getElementById("BCX_ConditionMemberNumber");if(!this.conditionCategoryData||!this.conditionData)return m&&m.remove(),void(h&&h.remove());const g=null!==(e=this.changes)&&void 0!==e?e:this.conditionData,f=null!==(t=g.requirements)&&void 0!==t?t:this.conditionCategoryData.requirements,p=!g.requirements,C=!this.checkAccess()||p;m||(m=ElementCreateInput("BCX_ConditionRoomName","text",null!==(n=null===(o=f.roomName)||void 0===o?void 0:o.name)&&void 0!==n?n:"","30"),m.oninput=()=>{this.changes=this.makeChangesData(),this.processInputs()}),h||(h=ElementCreateInput("BCX_ConditionMemberNumber","text",null!==(a=null===(i=null===(r=f.player)||void 0===r?void 0:r.memberNumber)||void 0===i?void 0:i.toString())&&void 0!==a?a:"0","6"),h.inputMode="numeric",h.pattern="[0-9]+",h.oninput=()=>{this.changes=this.makeChangesData(),this.processInputs()}),m.disabled=C||!f.roomName,h.disabled=C||!f.player,this.changes&&!C&&f.roomName||(m.value=null!==(l=null===(s=f.roomName)||void 0===s?void 0:s.name)&&void 0!==l?l:""),this.changes&&!C&&f.player||(h.value=null!==(d=null===(u=null===(c=f.player)||void 0===c?void 0:c.memberNumber)||void 0===u?void 0:u.toString())&&void 0!==d?d:"0")}processInputs(){var e,t,o,n,r;const i=document.getElementById("BCX_ConditionRoomName"),a=document.getElementById("BCX_ConditionMemberNumber");if(this.changes&&i&&a&&((null===(e=this.changes.requirements)||void 0===e?void 0:e.roomName)&&(this.changes.requirements.roomName.name=i.value),null===(t=this.changes.requirements)||void 0===t?void 0:t.player)){const e=a.value;if(!e)return;/^[0-9]+$/.test(e)?this.changes.requirements.player.memberNumber=Number.parseInt(e,10):a.value=(null!==(r=null===(n=null===(o=this.changes.requirements)||void 0===o?void 0:o.player)||void 0===n?void 0:n.memberNumber)&&void 0!==r?r:0).toString()}}checkAccess(){var e;if(!this.conditionCategoryData)return!1;const t=null!==(e=this.conditionCategoryData.limits[this.conditionName])&&void 0!==e?e:ConditionsLimit.normal;return[this.conditionCategoryData.access_normal,this.conditionCategoryData.access_limited,!1][t]}Run(){var e,t,o,n,r,i,a,s,l;if(MainCanvas.textAlign="left",DrawText(`- ${this.headerText()} -`,175,125,"Black","Gray"),MainCanvas.textAlign="center",this.changes?(DrawButton(1815,75,90,90,"","White","Icons/Accept.png","Save all changes and go back"),DrawButton(1815,190,90,90,"","White","Icons/Cancel.png","Go back without saving")):(DrawButton(1815,75,90,90,"","White","Icons/Exit.png","Back"),DrawButton(1815,190,90,90,"","White","Icons/Question.png")),null===this.conditionCategoryData||null===this.conditionData)return MainCanvas.textAlign="center",DrawText(this.failed?`Failed to get data from ${this.character.Name}. Maybe you have no access?`:"Loading...",1e3,480,"Black"),!0;this.changes&&null!==this.changes.timer&&(this.changes.timer<Date.now()?(this.changes.timer=null,this.changes.timerRemove=!1,this.changes.active=!this.changes.active):this.changes.active||(this.changes.timerRemove=!1));const c=null!==(e=this.changes)&&void 0!==e?e:this.conditionData,u=null!==(t=c.requirements)&&void 0!==t?t:this.conditionCategoryData.requirements,d=!c.requirements,m=this.checkAccess(),h=!m||d,g=m?c.favorite?"Yellow":"White":"#ddd";let f;drawIcon(MainCanvas,icon_star,105,91,60,60,24,1,1.5,g,m&&MouseIn(93,80,85,80)?"Cyan":"black"),MainCanvas.beginPath(),MainCanvas.moveTo(98,272),MainCanvas.lineTo(960,272),MainCanvas.strokeStyle="Gray",MainCanvas.stroke(),MainCanvas.beginPath(),MainCanvas.moveTo(98,540),MainCanvas.lineTo(960,540),MainCanvas.stroke(),MainCanvas.textAlign="left",DrawCheckbox(125,180,64,64,`This ${this.conditionCategory.slice(0,-1)} is active and can trigger`,c.active,!m),d&&(MainCanvas.fillStyle="#0052A3",MainCanvas.fillRect(526,546,418,68),MainCanvas.fillRect(120,615,74,74),MainCanvas.fillRect(120,695,74,74),MainCanvas.fillRect(120,775,74,74),MainCanvas.fillRect(120,855,74,74)),MainCanvas.textAlign="center",f=null===c.timer?"Timer disabled":`${c.active?"Deactivates":"Activates"} in: ${formatTimeInterval(c.timer-Date.now())}`,DrawText(f,530,311,c.active||!c.timer?"Black":"#060"),null===c.timer?(DrawButton(120,360,820,160,"Enable timer","White"),MainCanvas.textAlign="left"):(DrawButton(120,360,85,60,"-1d",m?"White":"#ddd","","Remove 1 day from the timer",!m),DrawButton(245,360,85,60,"-1h",m?"White":"#ddd","","Remove 1 hour from the timer",!m),DrawButton(370,360,85,60,"-5m",m?"White":"#ddd","","Remove 5 minutes from the timer",!m),DrawButton(495,360,70,60,"",m?"White":"#ddd","","Disable the timer",!m),DrawButton(605,360,85,60,"+5m",m?"White":"#ddd","","Add 5 minutes to the timer",!m),DrawButton(730,360,85,60,"+1h",m?"White":"#ddd","","Add 1 hour to the timer",!m),DrawButton(855,360,85,60,"+1d",m?"White":"#ddd","","Add 1 day to the timer",!m),MainCanvas.textAlign="left",c.active&&DrawCheckbox(125,450,64,64,`Delete the ${this.conditionCategory.slice(0,-1)} when timer runs out`,c.timerRemove,!m)),DrawText(`${capitalizeFirstLetter(this.conditionCategory.slice(0,-1))} trigger conditions:`,130,580,"Black",""),MainCanvas.textAlign="center";const p=!!(u.room||u.roomName||u.role||u.player);if(DrawButton(530,550,410,60,p?u.orLogic?"Any selected below":"All selected below":"Always in effect",h||!p?"#ddd":"White","","",h||!p),MainCanvas.textAlign="left",MainCanvas.fillStyle=ConditionsEvaluateRequirements(u,this.conditionCategoryData.highestRoleInRoom)?"#00FF22":"#AA0000",MainCanvas.fillRect(80,620,15,304),DrawCheckbox(125,620,64,64,"when",!!u.room,h),MainCanvas.textAlign="center",DrawButton(324,622,115,60,(null===(o=u.room)||void 0===o?void 0:o.inverted)?"not in":"in",h||!u.room?"#ddd":"White","","",h||!u.room),DrawButton(453,622,130,60,"private"===(null===(n=u.room)||void 0===n?void 0:n.type)?"private":"public",h||!u.room?"#ddd":"White","","",h||!u.room),MainCanvas.textAlign="left",DrawText("room",597,652,"Black","Gray"),u.room){const e=ServerPlayerIsInChatRoom(),t=e&&ChatRoomData&&ChatRoomData.Private,o=e&&("public"===u.room.type?!t:t);MainCanvas.fillStyle=(u.room.inverted?!o:o)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,620,15,64)}if(DrawCheckbox(125,700,64,64,"when",!!u.roomName,h),MainCanvas.textAlign="center",DrawButton(324,702,115,60,(null===(r=u.roomName)||void 0===r?void 0:r.inverted)?"not in":"in",h||!u.roomName?"#ddd":"White","","",h||!u.roomName),MainCanvas.textAlign="left",DrawText("room named",453,732,"Black","Gray"),ElementPosition("BCX_ConditionRoomName",813,726,285,60),u.roomName){const e=ServerPlayerIsInChatRoom()&&ChatRoomData&&"string"==typeof ChatRoomData.Name&&ChatRoomData.Name.toLocaleLowerCase()===u.roomName.name.toLocaleLowerCase();MainCanvas.fillStyle=(u.roomName.inverted?!e:e)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,700,15,64)}DrawCheckbox(125,780,64,64,"when",!!u.role,h),MainCanvas.textAlign="center",DrawButton(324,782,115,60,(null===(i=u.role)||void 0===i?void 0:i.inverted)?"not in":"in",h||!u.role?"#ddd":"White","","",h||!u.role);const C=null!==(s=null===(a=u.role)||void 0===a?void 0:a.role)&&void 0!==s?s:AccessLevel.mistress,y=C<AccessLevel.public?C+1:AccessLevel.clubowner,v=C>AccessLevel.clubowner?C-1:AccessLevel.public;if(DrawBackNextButton(695,782,244,60,capitalizeFirstLetter(AccessLevel[C])+(C!==AccessLevel.clubowner?" ":""),h||!u.role?"#ddd":"White","",(()=>capitalizeFirstLetter(AccessLevel[v])),(()=>capitalizeFirstLetter(AccessLevel[y])),h||!u.role),MainCanvas.textAlign="left",DrawText("room with role",453,812,"Black","Gray"),u.role){const e=null!=this.conditionCategoryData.highestRoleInRoom&&this.conditionCategoryData.highestRoleInRoom<=u.role.role;MainCanvas.fillStyle=(u.role.inverted?!e:e)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,780,15,64)}if(DrawCheckbox(125,860,64,64,"when",!!u.player,h),MainCanvas.textAlign="center",DrawButton(324,862,115,60,(null===(l=u.player)||void 0===l?void 0:l.inverted)?"not in":"in",h||!u.player?"#ddd":"White","","",h||!u.player),MainCanvas.textAlign="left",DrawText("room with member",453,892,"Black","Gray"),ElementPositionFix("BCX_ConditionMemberNumber",40,768,860,162,60),DrawButton(950,862,64,64,"",h||!u.player?"#ddd":"White",void 0,void 0,h||!u.player),DrawImageEx("Icons/Title.png",952,864,{Width:60,Height:60}),u.player){const e=ServerPlayerIsInChatRoom()&&getAllCharactersInRoom().some((e=>e.MemberNumber===u.player.memberNumber));MainCanvas.fillStyle=(u.player.inverted?!e:e)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,860,15,64);const t=document.getElementById("BCX_ConditionMemberNumber");t&&document.activeElement===t&&DrawHoverElements.push((()=>{if(!u.player)return;MainCanvas.fillStyle="#FFFF88",MainCanvas.fillRect(957,858,450,65),MainCanvas.lineWidth=2,MainCanvas.strokeStyle="black",MainCanvas.strokeRect(957,858,450,65),DrawTextFit(getCharacterName(u.player.memberNumber,"[unknown]"),1182,891,444,"black")}))}return MainCanvas.beginPath(),MainCanvas.rect(1190,830,720,104),MainCanvas.strokeStyle="#0052A3",MainCanvas.stroke(),DrawCheckbox(1210,850,64,64,`Set to global ${this.conditionCategory} configuration`,d,!m),MainCanvas.beginPath(),MainCanvas.ellipse(1910,830,22,22,360,0,360),MainCanvas.fillStyle="#0052A3",MainCanvas.fill(),DrawImageEx("Icons/General.png",1887,807,{Height:46,Width:46}),MainCanvas.textAlign="center",null!==c.timer&&MouseIn(125,450,80,64)&&DrawButtonHover(125,450,64,64,`Removes ${this.conditionCategory.slice(0,-1)} instead of only deactivating it `),MouseIn(1190,830,100,104)&&DrawButtonHover(1786,854,64,64,"Overwrites current trigger conditions"),MouseIn(950,862,64,64)&&DrawButtonHover(950,782,4,64,"Select member number from list"),MouseIn(93,80,85,80)&&DrawButtonHover(93,80,80,80,"Favorite: Listed first in overview"),!1}Click(){var e,t,o,n;if(MouseIn(1815,75,90,90))return this.changes&&(this.processInputs(),this.character.conditionUpdate(this.conditionCategory,this.conditionName,this.changes)),this.Exit(),!0;if(this.changes&&MouseIn(1815,190,90,90))return this.Exit(),!0;if(MouseIn(1815,190,90,90))return this.showHelp=!this.showHelp,!0;if(null===this.conditionCategoryData||null===this.conditionData)return!0;if(!this.checkAccess())return!1;const r=null!==(e=this.changes)&&void 0!==e?e:this.conditionData;if(MouseIn(125,180,64,64))return this.changes=this.makeChangesData(),this.changes.active=!this.changes.active,this.changes.timer=null,this.changes.timerRemove=!1,!0;if(MouseIn(93,80,85,80))return this.changes=this.makeChangesData(),this.changes.favorite=!this.changes.favorite,!0;if(null===r.timer){if(MouseIn(120,360,820,160))return this.changes=this.makeChangesData(),this.changes.timer=Date.now()+3e5,!0}else{if(MouseIn(120,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer-=864e5,!0;if(MouseIn(245,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer-=36e5,!0;if(MouseIn(370,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer-=3e5,!0;if(MouseIn(495,360,70,60))return this.changes=this.makeChangesData(),this.changes.timer=null,this.changes.timerRemove=!1,!0;if(MouseIn(605,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer+=3e5,!0;if(MouseIn(730,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer+=36e5,!0;if(MouseIn(855,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer+=864e5,!0;if(MouseIn(125,450,64,64)&&r.active)return this.changes=this.makeChangesData(),this.changes.timerRemove=!this.changes.timerRemove,!0}const i=!(this.changes?this.changes.requirements:this.conditionData.requirements),a=null!==(t=this.changes?this.changes.requirements:this.conditionData.requirements)&&void 0!==t?t:this.conditionCategoryData.requirements;if(MouseIn(530,550,410,60)&&!i)return this.changes=this.makeChangesData(),this.changes.requirements.orLogic=!this.changes.requirements.orLogic||void 0,!0;if(MouseIn(125,620,64,64)&&!i)return this.changes=this.makeChangesData(),this.changes.requirements.room=this.changes.requirements.room?void 0:{type:"public"},!0;if(MouseIn(324,622,115,60)&&!i&&a.room)return this.changes=this.makeChangesData(),this.changes.requirements.room.inverted=!this.changes.requirements.room.inverted||void 0,!0;if(MouseIn(453,622,130,60)&&!i&&a.room)return this.changes=this.makeChangesData(),this.changes.requirements.room.type="public"===this.changes.requirements.room.type?"private":"public",!0;if(MouseIn(125,700,64,64)&&!i)return this.changes=this.makeChangesData(),this.changes.requirements.roomName=this.changes.requirements.roomName?void 0:{name:""},this.onDataChange(),!0;if(MouseIn(324,702,115,60)&&!i&&a.roomName)return this.changes=this.makeChangesData(),this.changes.requirements.roomName.inverted=!this.changes.requirements.roomName.inverted||void 0,!0;if(MouseIn(125,780,64,64)&&!i)return this.changes=this.makeChangesData(),this.changes.requirements.role=this.changes.requirements.role?void 0:{role:AccessLevel.mistress},!0;if(MouseIn(324,782,115,60)&&!i&&a.role)return this.changes=this.makeChangesData(),this.changes.requirements.role.inverted=!this.changes.requirements.role.inverted||void 0,!0;const s=null!==(n=null===(o=a.role)||void 0===o?void 0:o.role)&&void 0!==n?n:AccessLevel.mistress;return MouseIn(727,782,106,60)&&!i&&a.role?(this.changes=this.makeChangesData(),this.changes.requirements.role.role=s>AccessLevel.clubowner?s-1:AccessLevel.public,!0):MouseIn(833,782,106,60)&&!i&&a.role?(this.changes=this.makeChangesData(),this.changes.requirements.role.role=s<AccessLevel.public?s+1:AccessLevel.clubowner,!0):MouseIn(125,860,64,64)&&!i?(this.changes=this.makeChangesData(),this.changes.requirements.player=this.changes.requirements.player?void 0:{memberNumber:0},this.onDataChange(),!0):MouseIn(324,862,115,60)&&!i&&a.player?(this.changes=this.makeChangesData(),this.changes.requirements.player.inverted=!this.changes.requirements.player.inverted||void 0,!0):MouseIn(950,862,64,64)&&!i&&a.player?(setSubscreen(new GuiMemberSelect(this.character,this,(e=>{this.changes=this.makeChangesData(),this.changes.requirements.player.memberNumber=e}))),!0):!!MouseIn(1210,850,64,64)&&(this.changes=this.makeChangesData(),this.setUseGlobal(!!this.changes.requirements),this.onDataChange(),!0)}Exit(){setSubscreen(this.back)}Unload(){ElementRemove("BCX_ConditionRoomName"),ElementRemove("BCX_ConditionMemberNumber")}}class GuiConditionEditCurses extends GuiConditionEdit{constructor(e,t,o){super(e,"curses",t,o),this.item=null,this.allowSettingsCurse=!1}headerText(){const e=AssetGroup.find((e=>e.Name===this.conditionName));return`View / Edit the '${e?getVisibleGroupName(e):"[ERROR]"}' curse`}setUseGlobal(e){var t;super.setUseGlobal(e),this.changes&&this.conditionData&&this.conditionCategoryData&&(null===(t=this.changes)||void 0===t?void 0:t.data)&&(this.changes.data.itemRemove=!e&&this.conditionCategoryData.data.itemRemove)}onDataChange(){var e,t;super.onDataChange(),this.conditionCategoryData&&this.conditionData&&(this.conditionData.data?(this.item=AssetGet(this.character.Character.AssetFamily,this.conditionName,this.conditionData.data.Name),this.allowSettingsCurse=this.conditionData.data.curseProperties||!this.item||curseAllowItemCurseProperty(this.item)):(this.item=null,this.allowSettingsCurse=!1),this.changes&&(null===(e=this.changes.data)||void 0===e?void 0:e.Name)!==(null===(t=this.conditionData.data)||void 0===t?void 0:t.Name)&&(this.changes.data=cloneDeep(this.conditionData.data)))}Run(){var e,t;if(super.Run()||null===this.conditionCategoryData||null===this.conditionData)return!0;const o=null!==(e=this.changes)&&void 0!==e?e:this.conditionData,n=!o.requirements,r=!!(n?this.conditionCategoryData.data.itemRemove:null===(t=o.data)||void 0===t?void 0:t.itemRemove),i=this.checkAccess();return MainCanvas.textAlign="left",o.data&&(n&&(MainCanvas.fillStyle="#0052A3",MainCanvas.fillRect(1045,100,74,74)),DrawCheckbox(1050,105,64,64,"Remove the item when the curse",r,!i||n),MainCanvas.save(),MainCanvas.font=CommonGetFont(28),DrawText("becomes inactive, removed, or is no longer",1152,185,"Black"),DrawText("triggering - does not remove locked items",1152,225,"Black"),MainCanvas.restore()),this.allowSettingsCurse&&o.data&&(DrawCheckbox(1050,265,64,64,"Also curse the item's configuration",o.data.curseProperties,!i),MainCanvas.save(),MainCanvas.font=CommonGetFont(28),DrawText("Example: which rope tie is used",1151,347,"Black",""),MainCanvas.restore(),this.item&&!curseDefaultItemCurseProperty(this.item)&&(MainCanvas.save(),MainCanvas.font=CommonGetFont(30),DrawTextWrap("Warning: This item is not standardized and some or all of its configuration states could behave in unexpected ways if they are cursed with the above checkbox. Please assume most of them will not work correctly. Issues could range from respawning with a different configuration to the curse triggering randomly all the time. As some of these items do work (partially), the option to curse the configuration is still offered.",621,365,860,400,"FireBrick"),MainCanvas.restore())),this.showHelp&&showHelp(HELP_TEXTS[Views.ConditionsEditCurses]),!1}Click(){var e;if(super.Click()||null===this.conditionCategoryData||null===this.conditionData)return!0;if(!this.checkAccess())return!1;const t=null!==(e=this.changes)&&void 0!==e?e:this.conditionData,o=!(this.changes?this.changes.requirements:t.requirements);return MouseIn(1050,105,64,64)&&t.data&&!o?(this.changes=this.makeChangesData(),this.changes.data.itemRemove=!this.changes.data.itemRemove,!0):!!(MouseIn(1050,265,64,64)&&this.allowSettingsCurse&&t.data)&&(this.changes=this.makeChangesData(),this.changes.data.curseProperties=!this.changes.data.curseProperties,!0)}}class GuiConditionGlobal extends GuiSubscreen{constructor(e,t,o){super(),this.conditionCategoryData=null,this.failed=!1,this.showHelp=!1,this.changes=null,this.character=e,this.conditionCategory=t,this.back=o}makeChangesData(){var e;if(!this.conditionCategoryData)throw new Error("Data required");return null!==(e=this.changes)&&void 0!==e?e:{requirements:cloneDeep(this.conditionCategoryData.requirements),timer:this.conditionCategoryData.timer,timerRemove:this.conditionCategoryData.timerRemove,data:cloneDeep(this.conditionCategoryData.data)}}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.conditionCategoryData=null,this.failed=!1,this.onDataChange(),this.character.conditionsGetByCategory(this.conditionCategory).then((e=>{this.active&&(this.conditionCategoryData=e,this.checkAccess()||(this.changes=null),this.onDataChange())}),(e=>{console.error(`BCX: Failed to get condition info for ${this.conditionCategory} from ${this.character}`,e),this.failed=!0}))}onDataChange(){var e,t,o,n,r,i,a,s,l,c,u;let d=document.getElementById("BCX_ConditionRoomName"),m=document.getElementById("BCX_ConditionMemberNumber");if(!this.conditionCategoryData)return d&&d.remove(),void(m&&m.remove());const h=(null!==(e=this.changes)&&void 0!==e?e:this.conditionCategoryData).requirements,g=!this.checkAccess();d||(d=ElementCreateInput("BCX_ConditionRoomName","text",null!==(o=null===(t=h.roomName)||void 0===t?void 0:t.name)&&void 0!==o?o:"","30"),d.oninput=()=>{this.changes=this.makeChangesData(),this.processInputs()}),m||(m=ElementCreateInput("BCX_ConditionMemberNumber","text",null!==(i=null===(r=null===(n=h.player)||void 0===n?void 0:n.memberNumber)||void 0===r?void 0:r.toString())&&void 0!==i?i:"0","6"),m.inputMode="numeric",m.pattern="[0-9]+",m.oninput=()=>{this.changes=this.makeChangesData(),this.processInputs()}),d.disabled=g||!h.roomName,m.disabled=g||!h.player,this.changes&&!g&&h.roomName||(d.value=null!==(s=null===(a=h.roomName)||void 0===a?void 0:a.name)&&void 0!==s?s:""),this.changes&&!g&&h.player||(m.value=null!==(u=null===(c=null===(l=h.player)||void 0===l?void 0:l.memberNumber)||void 0===c?void 0:c.toString())&&void 0!==u?u:"0")}processInputs(){var e,t,o,n,r;const i=document.getElementById("BCX_ConditionRoomName"),a=document.getElementById("BCX_ConditionMemberNumber");if(this.changes&&i&&a&&((null===(e=this.changes.requirements)||void 0===e?void 0:e.roomName)&&(this.changes.requirements.roomName.name=i.value),null===(t=this.changes.requirements)||void 0===t?void 0:t.player)){const e=a.value;if(!e)return;/^[0-9]+$/.test(e)?this.changes.requirements.player.memberNumber=Number.parseInt(e,10):a.value=(null!==(r=null===(n=null===(o=this.changes.requirements)||void 0===o?void 0:o.player)||void 0===n?void 0:n.memberNumber)&&void 0!==r?r:0).toString()}}checkAccess(){return!!this.conditionCategoryData&&this.conditionCategoryData.access_configure}Run(){var e,t,o,n,r,i,a,s;if(MainCanvas.textAlign="left",DrawText(`- ${this.headerText()} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",this.changes?(DrawButton(1815,75,90,90,"","White","Icons/Accept.png","Save all changes and go back"),DrawButton(1815,190,90,90,"","White","Icons/Cancel.png","Go back without saving")):(DrawButton(1815,75,90,90,"","White","Icons/Exit.png","Back"),DrawButton(1815,190,90,90,"","White","Icons/Question.png")),null===this.conditionCategoryData)return MainCanvas.textAlign="center",DrawText(this.failed?`Failed to get data from ${this.character.Name}. Maybe you have no access?`:"Loading...",1e3,480,"Black"),!0;this.changes&&null!==this.changes.timer&&this.changes.timer<=0&&(this.changes.timer=null,this.changes.timerRemove=!1);const l=null!==(e=this.changes)&&void 0!==e?e:this.conditionCategoryData,c=l.requirements,u=this.checkAccess(),d=!u;let m;MainCanvas.beginPath(),MainCanvas.moveTo(98,272),MainCanvas.lineTo(960,272),MainCanvas.strokeStyle="Gray",MainCanvas.stroke(),MainCanvas.beginPath(),MainCanvas.moveTo(98,540),MainCanvas.lineTo(960,540),MainCanvas.stroke(),MainCanvas.textAlign="center",m=null===l.timer?"Timer disabled by default":`Default timer: ${formatTimeInterval(l.timer)}`,DrawText(m,530,311,"Black"),null===l.timer?(DrawButton(120,360,820,160,"Enable timer","White"),MainCanvas.textAlign="left"):(DrawButton(120,360,85,60,"-1d",u?"White":"#ddd","","Remove 1 day from the timer",!u),DrawButton(245,360,85,60,"-1h",u?"White":"#ddd","","Remove 1 hour from the timer",!u),DrawButton(370,360,85,60,"-5m",u?"White":"#ddd","","Remove 5 minutes from the timer",!u),DrawButton(495,360,70,60,"",u?"White":"#ddd","","Set lifetime to infinite",!u),DrawButton(605,360,85,60,"+5m",u?"White":"#ddd","","Add 5 minutes to the timer",!u),DrawButton(730,360,85,60,"+1h",u?"White":"#ddd","","Add 1 hour to the timer",!u),DrawButton(855,360,85,60,"+1d",u?"White":"#ddd","","Add 1 day to the timer",!u),MainCanvas.textAlign="left",DrawCheckbox(125,450,64,64,`Remove the ${this.conditionCategory.slice(0,-1)} when timer runs out`,l.timerRemove,!u)),DrawText(`${capitalizeFirstLetter(this.conditionCategory.slice(0,-1))} trigger conditions:`,130,580,"Black",""),MainCanvas.textAlign="center";const h=!!(c.room||c.roomName||c.role||c.player);if(DrawButton(530,550,410,60,h?c.orLogic?"Any selected below":"All selected below":"Always in effect",d||!h?"#ddd":"White","","",d||!h),MainCanvas.textAlign="left",MainCanvas.fillStyle=ConditionsEvaluateRequirements(c,this.conditionCategoryData.highestRoleInRoom)?"#00FF22":"#AA0000",MainCanvas.fillRect(75,620,15,304),DrawCheckbox(125,620,64,64,"when",!!c.room,d),MainCanvas.textAlign="center",DrawButton(324,622,115,60,(null===(t=c.room)||void 0===t?void 0:t.inverted)?"not in":"in",d||!c.room?"#ddd":"White","","",d||!c.room),DrawButton(453,622,130,60,"private"===(null===(o=c.room)||void 0===o?void 0:o.type)?"private":"public",d||!c.room?"#ddd":"White","","",d||!c.room),MainCanvas.textAlign="left",DrawText("room",597,652,"Black","Gray"),c.room){const e=ServerPlayerIsInChatRoom(),t=e&&ChatRoomData&&ChatRoomData.Private,o=e&&("public"===c.room.type?!t:t);MainCanvas.fillStyle=(c.room.inverted?!o:o)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,620,15,64)}if(DrawCheckbox(125,700,64,64,"when",!!c.roomName,d),MainCanvas.textAlign="center",DrawButton(324,702,115,60,(null===(n=c.roomName)||void 0===n?void 0:n.inverted)?"not in":"in",d||!c.roomName?"#ddd":"White","","",d||!c.roomName),MainCanvas.textAlign="left",DrawText("room named",453,732,"Black","Gray"),ElementPosition("BCX_ConditionRoomName",813,726,285,60),c.roomName){const e=ServerPlayerIsInChatRoom()&&ChatRoomData&&"string"==typeof ChatRoomData.Name&&ChatRoomData.Name.toLocaleLowerCase()===c.roomName.name.toLocaleLowerCase();MainCanvas.fillStyle=(c.roomName.inverted?!e:e)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,700,15,64)}DrawCheckbox(125,780,64,64,"when",!!c.role,d),MainCanvas.textAlign="center",DrawButton(324,782,115,60,(null===(r=c.role)||void 0===r?void 0:r.inverted)?"not in":"in",d||!c.role?"#ddd":"White","","",d||!c.role);const g=null!==(a=null===(i=c.role)||void 0===i?void 0:i.role)&&void 0!==a?a:AccessLevel.mistress,f=g<AccessLevel.public?g+1:AccessLevel.clubowner,p=g>AccessLevel.clubowner?g-1:AccessLevel.public;if(DrawBackNextButton(695,782,244,60,capitalizeFirstLetter(AccessLevel[g])+(g!==AccessLevel.clubowner?" ":""),d||!c.role?"#ddd":"White","",(()=>capitalizeFirstLetter(AccessLevel[p])),(()=>capitalizeFirstLetter(AccessLevel[f])),d||!c.role),MainCanvas.textAlign="left",DrawText("room with role",453,812,"Black","Gray"),c.role){const e=null!=this.conditionCategoryData.highestRoleInRoom&&this.conditionCategoryData.highestRoleInRoom<=c.role.role;MainCanvas.fillStyle=(c.role.inverted?!e:e)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,780,15,64)}if(DrawCheckbox(125,860,64,64,"when",!!c.player,d),MainCanvas.textAlign="center",DrawButton(324,862,115,60,(null===(s=c.player)||void 0===s?void 0:s.inverted)?"not in":"in",d||!c.player?"#ddd":"White","","",d||!c.player),MainCanvas.textAlign="left",DrawText("room with member",453,892,"Black","Gray"),ElementPositionFix("BCX_ConditionMemberNumber",40,768,860,162,60),c.player){const e=ServerPlayerIsInChatRoom()&&getAllCharactersInRoom().some((e=>e.MemberNumber===c.player.memberNumber));MainCanvas.fillStyle=(c.player.inverted?!e:e)?"#00FF22":"#AA0000",MainCanvas.fillRect(95,860,15,64);const t=document.getElementById("BCX_ConditionMemberNumber");t&&document.activeElement===t&&DrawHoverElements.push((()=>{if(!c.player)return;MainCanvas.fillStyle="#FFFF88",MainCanvas.fillRect(957,858,450,65),MainCanvas.lineWidth=2,MainCanvas.strokeStyle="black",MainCanvas.strokeRect(957,858,450,65),DrawTextFit(getCharacterName(c.player.memberNumber,"[unknown]"),1182,891,444,"black")}))}return MainCanvas.textAlign="center",null!==l.timer&&MouseIn(125,450,80,64)&&DrawButtonHover(125,450,64,64,`Removes ${this.conditionCategory.slice(0,-1)} instead of only deactivating it `),!1}Click(){var e,t,o;if(MouseIn(1815,75,90,90))return this.changes&&(this.processInputs(),this.character.conditionCategoryUpdate(this.conditionCategory,this.changes)),this.Exit(),!0;if(this.changes&&MouseIn(1815,190,90,90))return this.Exit(),!0;if(MouseIn(1815,190,90,90))return this.showHelp=!this.showHelp,!0;if(null===this.conditionCategoryData)return!0;if(!this.checkAccess())return!1;const n=null!==(e=this.changes)&&void 0!==e?e:this.conditionCategoryData;if(null===n.timer){if(MouseIn(120,360,820,160))return this.changes=this.makeChangesData(),this.changes.timer=3e5,!0}else{if(MouseIn(120,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer-=864e5,!0;if(MouseIn(245,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer-=36e5,!0;if(MouseIn(370,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer-=3e5,!0;if(MouseIn(495,360,70,60))return this.changes=this.makeChangesData(),this.changes.timer=null,this.changes.timerRemove=!1,!0;if(MouseIn(605,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer+=3e5,!0;if(MouseIn(730,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer+=36e5,!0;if(MouseIn(855,360,85,60))return this.changes=this.makeChangesData(),this.changes.timer+=864e5,!0;if(MouseIn(125,450,64,64))return this.changes=this.makeChangesData(),this.changes.timerRemove=!this.changes.timerRemove,!0}const r=n.requirements;if(MouseIn(530,550,410,60))return this.changes=this.makeChangesData(),this.changes.requirements.orLogic=!this.changes.requirements.orLogic||void 0,!0;if(MouseIn(125,620,64,64))return this.changes=this.makeChangesData(),this.changes.requirements.room=this.changes.requirements.room?void 0:{type:"public"},!0;if(MouseIn(324,622,115,60)&&r.room)return this.changes=this.makeChangesData(),this.changes.requirements.room.inverted=!this.changes.requirements.room.inverted||void 0,!0;if(MouseIn(453,622,130,60)&&r.room)return this.changes=this.makeChangesData(),this.changes.requirements.room.type="public"===this.changes.requirements.room.type?"private":"public",!0;if(MouseIn(125,700,64,64))return this.changes=this.makeChangesData(),this.changes.requirements.roomName=this.changes.requirements.roomName?void 0:{name:""},this.onDataChange(),!0;if(MouseIn(324,702,115,60)&&r.roomName)return this.changes=this.makeChangesData(),this.changes.requirements.roomName.inverted=!this.changes.requirements.roomName.inverted||void 0,!0;if(MouseIn(125,780,64,64))return this.changes=this.makeChangesData(),this.changes.requirements.role=this.changes.requirements.role?void 0:{role:AccessLevel.mistress},!0;if(MouseIn(324,782,115,60)&&r.role)return this.changes=this.makeChangesData(),this.changes.requirements.role.inverted=!this.changes.requirements.role.inverted||void 0,!0;const i=null!==(o=null===(t=r.role)||void 0===t?void 0:t.role)&&void 0!==o?o:AccessLevel.mistress;return MouseIn(727,782,106,60)&&r.role?(this.changes=this.makeChangesData(),this.changes.requirements.role.role=i>AccessLevel.clubowner?i-1:AccessLevel.public,!0):MouseIn(833,782,106,60)&&r.role?(this.changes=this.makeChangesData(),this.changes.requirements.role.role=i<AccessLevel.public?i+1:AccessLevel.clubowner,!0):MouseIn(125,860,64,64)?(this.changes=this.makeChangesData(),this.changes.requirements.player=this.changes.requirements.player?void 0:{memberNumber:0},this.onDataChange(),!0):!(!MouseIn(324,862,115,60)||!r.player)&&(this.changes=this.makeChangesData(),this.changes.requirements.player.inverted=!this.changes.requirements.player.inverted||void 0,!0)}Exit(){setSubscreen(this.back)}Unload(){ElementRemove("BCX_ConditionRoomName"),ElementRemove("BCX_ConditionMemberNumber")}}class GuiConditionGlobalCurses extends GuiConditionGlobal{constructor(e,t){super(e,"curses",t)}headerText(){return`View / Edit the global ${this.conditionCategory} configuration`}Run(){var e;if(super.Run()||null===this.conditionCategoryData)return!0;MainCanvas.textAlign="left",DrawText("Note: Settings are applied to new curses and all existing ones set to the global config.",130,210,"Black","");const t=null!==(e=this.changes)&&void 0!==e?e:this.conditionCategoryData,o=this.checkAccess();return t.data&&(DrawCheckbox(1050,267,64,64,"Remove the item when the curse",t.data.itemRemove,!o),MainCanvas.save(),MainCanvas.font=CommonGetFont(28),DrawText("becomes inactive, removed, or is no longer",1152,347,"Black"),DrawText("triggering - does not remove locked items",1152,387,"Black"),MainCanvas.restore()),this.showHelp&&showHelp(HELP_TEXTS[Views.ConditionsGlobalCurses]),!1}Click(){var e;if(super.Click()||null===this.conditionCategoryData)return!0;if(!this.checkAccess())return!1;const t=null!==(e=this.changes)&&void 0!==e?e:this.conditionCategoryData;return!(!MouseIn(1050,267,64,64)||!t.data)&&(this.changes=this.makeChangesData(),this.changes.data.itemRemove=!this.changes.data.itemRemove,!0)}}const PER_COLUMN_COUNT=7,PER_PAGE_COUNT$1=2*PER_COLUMN_COUNT;class GuiConditionView extends GuiSubscreen{constructor(e,t){super(),this.conditionEntries=[],this.conditionCategoryData=null,this.failed=!1,this.page=0,this.showHelp=!1,this.character=e,this.conditionCategory=t,this.conditionCategorySingluar=t.slice(0,-1)}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.conditionCategoryData=null,this.failed=!1,this.onDataChange(),this.character.conditionsGetByCategory(this.conditionCategory).then((e=>{this.active&&(this.conditionCategoryData=e,this.onDataChange())}),(e=>{console.error(`BCX: Failed to get condition info for ${this.conditionCategory} from ${this.character}`,e),this.failed=!0}))}onDataChange(){var e;if(this.active&&(this.conditionEntries=[],null!==this.conditionCategoryData)){for(const[t,o]of Object.entries(this.conditionCategoryData.conditions)){const n=this.loadCondition(t,o);if(null===n)continue;const r=[this.conditionCategoryData.access_normal,this.conditionCategoryData.access_limited,!1][null!==(e=this.conditionCategoryData.limits[t])&&void 0!==e?e:ConditionsLimit.normal];this.conditionEntries.push({condition:t,access:r,data:o,displayName:n[0],extra:n[1]})}this.conditionEntries.sort(((e,t)=>!e.data.favorite&&t.data.favorite?1:e.data.favorite&&!t.data.favorite?-1:0)),this.page=clamp(this.page,0,Math.ceil(this.conditionEntries.length/PER_PAGE_COUNT$1))}}Run(){if(MainCanvas.textAlign="left",DrawText(`- ${this.headerText()} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","BCX main menu"),DrawButton(1815,190,90,90,"","White","Icons/Question.png"),null===this.conditionCategoryData)return MainCanvas.textAlign="center",DrawText(this.failed?`Failed to get data from ${this.character.Name}. Maybe you have no access?`:"Loading...",1e3,480,"Black"),!0;MainCanvas.beginPath(),MainCanvas.moveTo(953,160),MainCanvas.lineTo(953,780),MainCanvas.stroke();for(let e=0;e<PER_PAGE_COUNT$1;e++){const t=this.page*PER_PAGE_COUNT$1+e;if(t>=this.conditionEntries.length)break;const o=this.conditionEntries[t],n=170+e%PER_COLUMN_COUNT*90,r=120+865*Math.floor(e/PER_COLUMN_COUNT),i=!o.data.requirements;MouseIn(r,n,440,90)&&DrawHoverElements.push((()=>{this.showDetailedDescriptionBackground(e<PER_COLUMN_COUNT?985:120),MouseIn(r,n,440,60)&&this.showDetailedDescriptionText(e<PER_COLUMN_COUNT?985:120,o.condition,o)})),MainCanvas.textAlign="left",DrawButton(r,n,440,60,"","White"),this.drawCategoryImage(r,n,o),DrawTextFit(o.displayName,r+65,n+30,365,"Black"),MainCanvas.textAlign="center",DrawButton(r+470,n,240,60,"",o.data.active?"#d8fed7":"White"),i&&(MainCanvas.beginPath(),MainCanvas.ellipse(r+470+33,n+30,22,22,360,0,360),MainCanvas.fillStyle="#0052A3",MainCanvas.fill()),DrawImageEx("Icons/General.png",r+480,n+7,{Height:46,Width:46});let a="n/a";a=null===o.data.timer?"":formatTimeInterval(o.data.timer-Date.now(),"short"),DrawText(a,r+570,n+30,"Black",""),this.drawEntryExtra(r,n,o),o.access&&DrawButton(r+740,n,60,60,"X","White","",this.removeLabel),MouseIn(r+470,n,60,60)&&DrawHoverElements.push((()=>{DrawButtonHover(r+470,n,60,60,`Change this ${this.conditionCategorySingluar}'s configuration`)})),MouseIn(r+531,n,78,60)&&DrawHoverElements.push((()=>{DrawButtonHover(r+531,n,78,60,`Remaining duration of the ${this.conditionCategorySingluar}`)}))}MainCanvas.textAlign="center",DrawButton(968,820,605,90,"",this.conditionCategoryData.access_configure?"White":"#ddd","",this.conditionCategoryData.access_configure?`Existing ${this.conditionCategory} set to global ${this.conditionCategory} config are also changed`:"You have no permission to use this",!this.conditionCategoryData.access_configure),DrawText(`Change global ${this.conditionCategory} config`,1308,865,"Black",""),MainCanvas.beginPath(),MainCanvas.ellipse(1013,864,34,34,360,0,360),MainCanvas.fillStyle="#0052A3",MainCanvas.fill(),DrawImageEx("Icons/General.png",978,830,{Height:70,Width:70});const e=Math.ceil(this.conditionEntries.length/PER_PAGE_COUNT$1);return DrawBackNextButton(1605,820,300,90,`Page ${this.page+1} / ${Math.max(e,1)}`,"White","",(()=>""),(()=>"")),!1}Click(){if(MouseIn(1815,75,90,90))return this.Exit(),!0;if(MouseIn(1815,190,90,90))return this.showHelp=!this.showHelp,!0;if(null===this.conditionCategoryData)return!0;for(let e=0;e<PER_PAGE_COUNT$1;e++){const t=this.page*PER_PAGE_COUNT$1+e;if(t>=this.conditionEntries.length)break;const o=this.conditionEntries[t],n=170+e%PER_COLUMN_COUNT*90,r=120+865*Math.floor(e/PER_COLUMN_COUNT);if(MouseIn(r,n,440,60)&&this.onDecriptionTextClick(o.condition,o),MouseIn(r+470,n,240,60))return this.openEditSubscreen(o.condition),!0;if(o.access&&MouseIn(r+740,n,60,60))return this.removeCondition(o.condition),!0}if(this.conditionCategoryData.access_configure&&MouseIn(968,820,605,90))return this.openGlobalConfig(),!0;const e=Math.ceil(this.conditionEntries.length/PER_PAGE_COUNT$1);return MouseIn(1605,800,150,90)?(this.page--,this.page<0&&(this.page=Math.max(e-1,0)),!0):!!MouseIn(1755,800,150,90)&&(this.page++,this.page>=e&&(this.page=0),!0)}Exit(){setSubscreen(new GuiMainMenu(this.character))}}class GuiCursesAdd extends GuiSubscreen{constructor(e){super(),this.curseData=null,this.failed=!1,this.permissionMode=!1,this.showHelp=!1,this.character=e}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.curseData=null,this.character.conditionsGetByCategory("curses").then((e=>{this.curseData=e,this.curseData.access_changeLimits||(this.permissionMode=!1)}),(e=>{console.error(`BCX: Failed to get permission info for ${this.character}`,e),this.failed=!0}))}Run(){var e,t;if(MainCanvas.textAlign="left",DrawText(`- Curses: Place new curses on ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","Back"),DrawButton(1815,190,90,90,"","White","Icons/Question.png"),null===this.curseData)return void DrawText(this.failed?`Failed to get curse data from ${this.character.Name}. Maybe you have no access?`:"Loading...",1e3,480,"Black");DrawButton(1815,305,90,90,"",this.curseData.access_changeLimits?"White":"#ddd",this.permissionMode?"Icons/Reset.png":"Icons/Preference.png",this.curseData.access_changeLimits?this.permissionMode?"Leave permission mode":"Edit curse slot permissions":"You have no permission to change limits",!this.curseData.access_changeLimits),MainCanvas.textAlign="left",MainCanvas.beginPath(),MainCanvas.rect(105,165,830,64),MainCanvas.fillStyle="#cccccc",MainCanvas.fill(),DrawText("Items",120,199,"Black"),MainCanvas.textAlign="center",this.permissionMode||(DrawButton(440,173,265,48,"Curse occupied","White",void 0,"Curse all items on the body at once"),DrawButton(720,173,200,48,"Curse all","White",void 0,"Curse all item slots at once"));const o=AssetGroup.filter((e=>"Item"===e.Category));for(let t=0;t<o.length;t++){const n=t%10,r=Math.floor(t/10),i=o[t],a=InventoryGet(this.character.Character,i.Name),s=void 0!==this.curseData.conditions[i.Name],l=null!==(e=this.curseData.limits[i.Name])&&void 0!==e?e:ConditionsLimit.normal,c=[this.curseData.access_normal,this.curseData.access_limited,!1][l];let u,d;this.permissionMode?(u=["#50ff56","#f6fe78","#ffa7a7 "][l],d=["Normal","Limited","Blocked"][l]):(u=s?"#88c":c?a?"Gold":"White":"#ccc",d=s?"Already cursed":c?a?a.Asset.Description:"Nothing":"You have no permission to curse this"),DrawButton(106+281*r,240+69*n,265,54,getVisibleGroupName(i),u,void 0,d,s||!c||this.permissionMode)}MainCanvas.textAlign="left",MainCanvas.beginPath(),MainCanvas.rect(950,165,830,64),MainCanvas.fillStyle="#cccccc",MainCanvas.fill(),DrawText("Clothing",965,199,"Black"),MainCanvas.textAlign="center",this.permissionMode||(DrawButton(1285,173,265,48,"Curse occupied","White",void 0,"Curse all clothes on the body at once"),DrawButton(1565,173,200,48,"Curse all","White",void 0,"Curse all clothing slots at once"));const n=AssetGroup.filter((e=>"Appearance"===e.Category&&e.Clothing));for(let e=0;e<n.length;e++){const o=e%10,r=Math.floor(e/10),i=n[e],a=InventoryGet(this.character.Character,i.Name),s=void 0!==this.curseData.conditions[i.Name],l=null!==(t=this.curseData.limits[i.Name])&&void 0!==t?t:ConditionsLimit.normal,c=[this.curseData.access_normal,this.curseData.access_limited,!1][l];let u,d;this.permissionMode?(u=["#50ff56","#f6fe78","#ffa7a7 "][l],d=["Normal","Limited","Blocked"][l]):(u=s?"#88c":c?a?"Gold":"White":"#ccc",d=s?"Already cursed":c?a?a.Asset.Description:"Nothing":"You have no permission to curse this"),DrawButton(951+281*r,240+69*o,265,54,getVisibleGroupName(i),u,void 0,d,s||!c||this.permissionMode)}this.permissionMode&&(MainCanvas.fillStyle="#50ff56",MainCanvas.fillRect(1284,75,166,64),MainCanvas.fillStyle="#f6fe78",MainCanvas.fillRect(1450,75,166,64),MainCanvas.fillStyle="#ffa7a7",MainCanvas.fillRect(1616,75,165,64),MainCanvas.textAlign="center",DrawText("Normal",1367,109,"Black"),DrawText("Limited",1533,109,"Black"),DrawText("Blocked",1699,109,"Black")),this.showHelp&&showHelp(HELP_TEXTS[this.permissionMode?Views.CursesAddPermissionMode:Views.CursesAdd])}Click(){var e,t;if(MouseIn(1815,75,90,90))return this.Exit();if(MouseIn(1815,190,90,90))return void(this.showHelp=!this.showHelp);if(null===this.curseData)return;if(MouseIn(1815,305,90,90))return void(this.permissionMode=this.curseData.access_changeLimits&&!this.permissionMode);const o=AssetGroup.filter((e=>"Item"===e.Category));for(let t=0;t<o.length;t++){const n=t%10,r=Math.floor(t/10),i=o[t],a=void 0!==this.curseData.conditions[i.Name];if(MouseIn(106+281*r,240+69*n,265,54)){if(this.permissionMode){const t=null!==(e=this.curseData.limits[i.Name])&&void 0!==e?e:ConditionsLimit.normal;this.character.conditionSetLimit("curses",i.Name,(t+1)%3)}else a||this.character.curseItem(i.Name,null);return}}if(MouseIn(440,173,265,48)&&!this.permissionMode)return void this.character.curseBatch("items",!1);if(MouseIn(720,173,200,48)&&!this.permissionMode)return void this.character.curseBatch("items",!0);const n=AssetGroup.filter((e=>"Appearance"===e.Category&&e.Clothing));for(let e=0;e<n.length;e++){const o=e%10,r=Math.floor(e/10),i=n[e],a=void 0!==this.curseData.conditions[i.Name];if(MouseIn(951+281*r,240+69*o,265,54)){if(this.permissionMode){const e=null!==(t=this.curseData.limits[i.Name])&&void 0!==t?t:ConditionsLimit.normal;this.character.conditionSetLimit("curses",i.Name,(e+1)%3)}else a||this.character.curseItem(i.Name,null);return}}!MouseIn(1285,173,265,48)||this.permissionMode?!MouseIn(1565,173,200,48)||this.permissionMode||this.character.curseBatch("clothes",!0):this.character.curseBatch("clothes",!1)}Exit(){setSubscreen(new GuiConditionViewCurses(this.character))}}class GuiConditionViewCurses extends GuiConditionView{constructor(e){super(e,"curses"),this.removeLabel="Lift curse"}Run(){if(super.Run()||null===this.conditionCategoryData)return!0;DrawButton(120,820,384,90,"Add new curse","White","","Place new curses on body, items or clothes");const e=this.conditionCategoryData.access_normal||this.conditionCategoryData.access_limited;return DrawButton(536,820,400,90,"Lift all curses",e?"White":"#ddd","",e?"Remove all curses on body, items or clothes":"You have no permission to use this",!e),this.showHelp&&showHelp(HELP_TEXTS[Views.ConditionsViewCurses]),!1}Click(){if(super.Click()||null===this.conditionCategoryData)return!0;if(MouseIn(120,820,384,90))return setSubscreen(new GuiCursesAdd(this.character)),!0;return!(!this.conditionCategoryData.access_normal&&!this.conditionCategoryData.access_limited||!MouseIn(536,820,400,90))&&(this.character.curseLiftAll(),!0)}drawCategoryImage(e,t,o){DrawImageEx("clothing"===o.extra.type?"Icons/Dress.png":"Assets/Female3DCG/ItemArms/Preview/NylonRope.png",e+6,t+6,{Height:50,Width:50})}drawEntryExtra(e,t,o){o.extra.propertiesCursedShow&&(DrawImageEx(o.extra.propertiesCursed?"Icons/Lock.png":"Icons/Unlock.png",e+635,t+10,{Height:40,Width:40,Alpha:o.extra.propertiesCursed?1:.2}),MouseIn(e+635,t+6,44,44)&&DrawHoverElements.push((()=>{DrawButtonHover(e+635,t+6,44,44,o.extra.propertiesCursed?"Item configuration cursed":"Item configuration not cursed")})))}headerText(){return`Curses: All active curses on ${this.character.Name}`}loadCondition(e,t){var o;const n=AssetGroup.find((t=>t.Name===e));if(!n)return console.warn(`BCX: Unknown group ${e}`),null;if(null===t.data)return[`Blocked: ${getVisibleGroupName(n)}`,{type:n.Clothing?"clothing":"item"}];{const r=AssetGet(this.character.Character.AssetFamily,e,t.data.Name);return[`${null!==(o=null==r?void 0:r.Description)&&void 0!==o?o:t.data.Name} (${getVisibleGroupName(n)})`,{type:n.Clothing?"clothing":"item",propertiesCursed:t.data.curseProperties,propertiesCursedShow:t.data.curseProperties||!r||curseAllowItemCurseProperty(r)}]}}showDetailedDescriptionBackground(e){}showDetailedDescriptionText(e,t,o){}onDecriptionTextClick(e,t){}openEditSubscreen(e){setSubscreen(new GuiConditionEditCurses(this.character,e,this))}removeCondition(e){this.character.curseLift(e)}openGlobalConfig(){setSubscreen(new GuiConditionGlobalCurses(this.character,this))}}class GuiConditionEditRules extends GuiConditionEdit{constructor(e,t,o){super(e,"rules",t,o),this.definition=RulesGetDisplayDefinition(t)}headerText(){return`View / Edit the '${this.definition.name}' rule`}onDataChange(){var e,t,o;super.onDataChange();const n=!!this.conditionCategoryData&&!!this.conditionData,r=null!==(e=this.changes)&&void 0!==e?e:this.conditionData,i=this.checkAccess();if(this.definition.dataDefinition)for(const[e,a]of Object.entries(this.definition.dataDefinition)){const s=ruleCustomDataHandlers[a.type];null===(t=s.onDataChange)||void 0===t||t.call(s,{def:a,active:n,key:e,onInput:()=>{this.changes=this.makeChangesData(),this.processInputs()},value:null!==(o=null==r?void 0:r.data.customData[e])&&void 0!==o?o:"function"==typeof a.default?a.default():a.default,access:i})}}processInputs(){if(super.processInputs(),this.changes&&this.definition.dataDefinition)for(const[e,t]of Object.entries(this.definition.dataDefinition)){const o=ruleCustomDataHandlers[t.type];if(o.processInput){const n=o.processInput({def:t,key:e,value:this.changes.data.customData[e]});void 0!==n&&(this.changes.data.customData[e]=n)}}}Run(){var e,t;if(super.Run()||null===this.conditionCategoryData||null===this.conditionData)return!0;const o=null!==(e=this.changes)&&void 0!==e?e:this.conditionData,n=this.checkAccess();MainCanvas.textAlign="left";let r=175;if(!1!==this.definition.enforceable&&(DrawCheckbox(1050,r,64,64,"Enforce this rule",o.data.enforce,!n),r+=100),!1!==this.definition.loggable&&(DrawCheckbox(1050,r,64,64,"Behaviour log entry when rule is violated",o.data.log,!n),r+=100),r+=45,this.definition.dataDefinition)for(const[e,i]of Object.entries(this.definition.dataDefinition)){ruleCustomDataHandlers[i.type].run({def:i,value:o.data.customData[e],Y:null!==(t=i.Y)&&void 0!==t?t:r,key:e,target:this.character,access:n})}return this.showHelp&&(MainCanvas.fillStyle="#ffff88",MainCanvas.fillRect(95,80,800,600),MainCanvas.strokeStyle="Black",MainCanvas.strokeRect(95,80,800,600),MainCanvas.textAlign="left",DrawTextWrap(HELP_TEXTS[Views.ConditionsEditRules],-265,100,760,560,"black")),!1}Click(){var e,t;if(super.Click()||null===this.conditionCategoryData||null===this.conditionData)return!0;if(!this.checkAccess())return!1;let o=175;if(!1!==this.definition.enforceable){if(MouseIn(1050,o,64,64))return this.changes=this.makeChangesData(),this.changes.data.enforce=!this.changes.data.enforce,!0;o+=100}if(!1!==this.definition.loggable){if(MouseIn(1050,o,64,64))return this.changes=this.makeChangesData(),this.changes.data.log=!this.changes.data.log,!0;o+=100}if(o+=45,this.definition.dataDefinition)for(const[n,r]of Object.entries(this.definition.dataDefinition)){const i=ruleCustomDataHandlers[r.type];if(i.click){const a=null!==(e=this.changes)&&void 0!==e?e:this.conditionData,s=i.click({def:r,value:a.data.customData[n],Y:null!==(t=r.Y)&&void 0!==t?t:o,key:n,target:this.character});if(void 0!==s)return this.changes=this.makeChangesData(),this.changes.data.customData[n]=s,!0}}return!1}Unload(){if(this.definition.dataDefinition)for(const[e,t]of Object.entries(this.definition.dataDefinition)){const o=ruleCustomDataHandlers[t.type];o.unload&&o.unload({def:t,key:e})}super.Unload()}}class GuiConditionGlobalRules extends GuiConditionGlobal{constructor(e,t){super(e,"rules",t)}headerText(){return`View / Edit the global ${this.conditionCategory} configuration`}Run(){return!(!super.Run()&&null!==this.conditionCategoryData)||(MainCanvas.textAlign="left",DrawText("Note: Settings are applied to new rules and all existing ones set to the global config.",130,210,"Black",""),this.showHelp&&showHelp(HELP_TEXTS[Views.ConditionsGlobalRules]),!1)}Click(){return!(!super.Click()&&null!==this.conditionCategoryData)}}class GuiRulesViewDescription extends GuiSubscreen{constructor(e,t,o,n){super(),this.showFailedMsg=!1,this.character=e,this.back=t,this.rule=o,this.ruleDefinition=RulesGetDisplayDefinition(o),this.allowAdd=n}onChange(e){e===this.character.MemberNumber&&this.Exit()}Run(){MainCanvas.textAlign="left",DrawText(`- Rules: Description of the rule: "${this.ruleDefinition.name}"-`,125,125,"Black","Gray"),MainCanvas.textAlign="left",DrawTextWrap(dictionaryProcess(this.ruleDefinition.longDescription,{PLAYER_NAME:this.character.Name}),-750,220,1750,500,"Black"),MainCanvas.textAlign="center",this.showFailedMsg&&DrawText(`Adding this rule failed! Likely cause is that it does not exist on ${this.character.Name}'s BCX version.`,1e3,750,"Red","Gray"),this.allowAdd?(DrawButton(700,800,200,80,"Add","White"),DrawButton(1100,800,200,80,"Back","White")):DrawButton(900,800,200,80,"Back","White")}Click(){if(this.allowAdd){if(MouseIn(700,800,200,80)&&this.character.ruleCreate(this.rule).then((e=>{e&&setSubscreen(new GuiConditionEditRules(this.character,this.rule,new GuiConditionViewRules(this.character)))})).catch((e=>{this.showFailedMsg=!0,console.warn(`Error creating rule on ${this.character}: `,e)})),MouseIn(1100,800,200,80))return this.Exit()}else MouseIn(900,800,200,80)&&this.Exit()}Exit(){setSubscreen(this.back)}}const PER_PAGE_COUNT=6;class GuiRulesAdd extends GuiSubscreen{constructor(e){super(),this.rulesData=null,this.failed=!1,this.permissionMode=!1,this.ruleList=[],this.page=0,this.showHelp=!1,this.filterInput=createInputElement("text",30),this.character=e,this.filterInput.addEventListener("input",(e=>{this.rebuildList()}))}Load(){this.requestData()}onChange(e){e===this.character.MemberNumber&&this.requestData()}requestData(){this.rulesData=null,this.rebuildList(),this.character.conditionsGetByCategory("rules").then((e=>{this.rulesData=e,this.rulesData.access_changeLimits||(this.permissionMode=!1),this.rebuildList()}),(e=>{console.error(`BCX: Failed to get rules info for ${this.character}`,e),this.failed=!0}))}rebuildList(){if(!this.active)return;if(this.ruleList=[],null===this.rulesData)return void this.filterInput.remove();this.filterInput.parentElement||document.body.appendChild(this.filterInput);const e=this.filterInput.value.trim().toLocaleLowerCase().split(" ").filter(Boolean);for(const t of RulesGetList())e.some((e=>{var o;return!t[0].toLocaleLowerCase().includes(e)&&!t[1].name.toLocaleLowerCase().includes(e)&&!(null===(o=t[1].shortDescription)||void 0===o?void 0:o.toLocaleLowerCase().includes(e))}))||this.ruleList.push({name:t[0],definition:t[1]});const t=Math.ceil(this.ruleList.length/PER_PAGE_COUNT);this.page<0?this.page=Math.max(t-1,0):this.page>=t&&(this.page=0)}Run(){var e;if(MainCanvas.textAlign="left",DrawText(`- Rules: Create new rules for ${this.character.Name} -`,125,125,"Black","Gray"),MainCanvas.textAlign="center",DrawButton(1815,75,90,90,"","White","Icons/Exit.png","Back"),DrawButton(1815,190,90,90,"","White","Icons/Question.png"),null===this.rulesData)return void DrawText(this.failed?`Failed to get rules data from ${this.character.Name}. Maybe you have no access?`:"Loading...",1e3,480,"Black");DrawButton(1815,305,90,90,"",this.rulesData.access_changeLimits?"White":"#ddd",this.permissionMode?"Icons/Reset.png":"Icons/Preference.png",this.rulesData.access_changeLimits?this.permissionMode?"Leave permission mode":"Edit rules permissions":"You have no permission to change limits",!this.rulesData.access_changeLimits),MainCanvas.textAlign="left",DrawText("Filter:",130,215,"Black"),positionElement(this.filterInput,550,210,600,64),this.filterInput.value&&(MainCanvas.textAlign="center",DrawButton(870,182,64,64,"X","White")),MainCanvas.textAlign="left";for(let t=0;t<PER_PAGE_COUNT;t++){const o=this.page*PER_PAGE_COUNT+t;if(o>=this.ruleList.length)break;const n=this.ruleList[o];if(null===n)continue;const r=275+100*t,i=void 0!==this.rulesData.conditions[n.name],a=null!==(e=this.rulesData.limits[n.name])&&void 0!==e?e:ConditionsLimit.normal,s=[this.rulesData.access_normal,this.rulesData.access_limited,!1][a];let l,c;DrawImageEx(n.definition.icon,125,r,{Height:64,Width:64}),this.permissionMode?(l=["#50ff56","#f6fe78","#ffa7a7"][a],c=["Normal","Limited","Blocked"][a]):(l=i?"#88c":s?"White":"#ccc",c=i?"Already applied":s?"":"You don't have permission to use this rule"),DrawButton(200,r,1350,64,"",l,"","",i||!s||this.permissionMode);let u=n.definition.name;n.definition.shortDescription&&(u+=` (${dictionaryProcess(n.definition.shortDescription,{PLAYER_NAME:this.character.Name})})`),DrawTextFit(u,210,r+34,1340,"Black"),MouseIn(200,r,1350,64)&&DrawHoverElements.push((()=>{DrawButtonHover(1200,r,60,60,c)}))}const t=Math.max(1,Math.ceil(this.ruleList.length/PER_PAGE_COUNT));MainCanvas.textAlign="center",DrawBackNextButton(1605,800,300,90,`${DialogFindPlayer("Page")} ${this.page+1} / ${t}`,"White","",(()=>""),(()=>"")),this.permissionMode&&(MainCanvas.fillStyle="#50ff56",MainCanvas.fillRect(1284,75,166,64),MainCanvas.fillStyle="#f6fe78",MainCanvas.fillRect(1450,75,166,64),MainCanvas.fillStyle="#ffa7a7",MainCanvas.fillRect(1616,75,165,64),MainCanvas.textAlign="center",DrawText("Normal",1367,109,"Black"),DrawText("Limited",1533,109,"Black"),DrawText("Blocked",1699,109,"Black")),this.showHelp&&showHelp(HELP_TEXTS[this.permissionMode?Views.RulesAddPermissionMode:Views.RulesAdd])}Click(){var e;if(MouseIn(1815,75,90,90))return this.Exit();if(MouseIn(1815,190,90,90))return void(this.showHelp=!this.showHelp);if(null===this.rulesData)return;if(MouseIn(1815,305,90,90))return void(this.permissionMode=this.rulesData.access_changeLimits&&!this.permissionMode);MouseIn(870,182,64,64)&&(this.filterInput.value="",this.rebuildList());for(let t=0;t<PER_PAGE_COUNT;t++){const o=this.page*PER_PAGE_COUNT+t;if(o>=this.ruleList.length)break;const n=this.ruleList[o];if(null===n)continue;const r=275+100*t,i=void 0!==this.rulesData.conditions[n.name],a=null!==(e=this.rulesData.limits[n.name])&&void 0!==e?e:ConditionsLimit.normal,s=[this.rulesData.access_normal,this.rulesData.access_limited,!1][a];if(MouseIn(200,r,1350,64)){const e=n.name;return void(this.permissionMode?this.character.conditionSetLimit("rules",n.name,(a+1)%3):!i&&s&&setSubscreen(new GuiRulesViewDescription(this.character,this,e,!0)))}}const t=Math.ceil(this.ruleList.length/PER_PAGE_COUNT);MouseIn(1605,800,150,90)?(this.page--,this.page<0&&(this.page=Math.max(t-1,0))):MouseIn(1755,800,150,90)&&(this.page++,this.page>=t&&(this.page=0))}Exit(){setSubscreen(new GuiConditionViewRules(this.character))}Unload(){this.filterInput.remove()}}class GuiConditionViewRules extends GuiConditionView{constructor(e){super(e,"rules"),this.removeLabel="Remove rule"}Run(){return!(!super.Run()&&null!==this.conditionCategoryData)||(DrawButton(120,820,384,90,"Add new rule","White","","...from the list of yet unestablished rules"),this.showHelp&&showHelp(HELP_TEXTS[Views.ConditionsViewRules]),!1)}Click(){return!(!super.Click()&&null!==this.conditionCategoryData)||!!MouseIn(120,820,384,90)&&(setSubscreen(new GuiRulesAdd(this.character)),!0)}drawCategoryImage(e,t,o){DrawImageEx(o.extra.definition.icon,e+6,t+6,{Height:50,Width:50})}drawEntryExtra(e,t,o){!1!==o.extra.definition.enforceable&&(DrawImageEx("Icons/Management.png",e+610,t+10,{Height:40,Width:40,Alpha:o.data.data.enforce?1:.2}),MouseIn(e+610,t+6,44,44)&&DrawHoverElements.push((()=>{DrawButtonHover(e+610,t+6,44,44,o.data.data.enforce?"Rule will be enforced":"Rule will not be enforced")}))),!1!==o.extra.definition.loggable&&(DrawImageEx("Icons/Title.png",e+660,t+10,{Height:40,Width:40,Alpha:o.data.data.log?1:.2}),MouseIn(e+660,t+6,44,44)&&DrawHoverElements.push((()=>{DrawButtonHover(e+660,t+6,44,44,o.data.data.log?"Rule violations will be logged":"Rule violations will not be logged")})))}headerText(){return`Rules: All active rules on ${this.character.Name}`}loadCondition(e,t){const o=RulesGetDisplayDefinition(e);return[o.name,{definition:o}]}showDetailedDescriptionBackground(e){MainCanvas.fillStyle="White",MainCanvas.fillRect(e,170,801,600),MainCanvas.strokeStyle="Black",MainCanvas.strokeRect(e,170,801,600)}showDetailedDescriptionText(e,t,o){MainCanvas.textAlign="left",DrawTextWrap(dictionaryProcess(o.extra.definition.longDescription,{PLAYER_NAME:this.character.Name}),e+20-380,190,760,560,"black")}onDecriptionTextClick(e,t){setSubscreen(new GuiRulesViewDescription(this.character,this,e,!1))}openEditSubscreen(e){setSubscreen(new GuiConditionEditRules(this.character,e,this))}removeCondition(e){this.character.ruleDelete(e)}openGlobalConfig(){setSubscreen(new GuiConditionGlobalRules(this.character,this))}}class GuiWelcomeSelection extends GuiSubscreen{constructor(e){super(),this.selectedPreset=-1,this.character=e}Run(){MainCanvas.textAlign="center",DrawButton(800,66,400,54,"<< Back to the tutorial","White"),DrawText("Please choose a preset, which sets your default experience, permissions and configuration.",1e3,150,"Black"),DrawText("Note: You can change the defaults, but changing to another preset is not possible without resetting BCX fully.",1e3,200,"FireBrick");const e=400,t=["Dominant","Switch/Exploring","Submissive","Slave"],o=["Icons/Management.png","Icons/Swap.png","Icons/Kneel.png",icon_OwnerList],n=["This preset is for dominants who\nnever intend to submit. Therefore,\nmost modules are not loaded at\nstart. That said, you can still use\nthe BCX graphical user interface\non other BCX users to use actions,\nyou have permission for, on them,\nsame as with all other presets.","This preset is for switches who\nare sometimes dominant and\nsometimes submissive, enabling\nthem to explore BCX slowly, while\nhaving full control over all of its\nsettings and features.","This preset is for submissives,\nwho want to give some of their\ncontrol to selected dominants and\nlovers, giving only them authority\nover some of BCX's settings. You\ncan irreversably give away more\nand more control, when you want.","This preset is a much more\nextreme submissive experience,\nnot leaving much control over the\nsettings and permissions to you,\nthus enabling others to use many\nof BCX's features on you. Owners\ncan even unblock the most extreme\nsettings, if they desire so."];for(let r=0;r<4;r++){const i=125+450*r;if(MouseIn(i,250,e,575)&&DrawRect(i,250,e,575,"#ddd"),DrawEmptyRect(i,250,e,575,"Black"),r===this.selectedPreset){const t=10;DrawEmptyRect(i-t,250-t,e+2*t,575+2*t,"Cyan",5),DrawButton(i+20,850,360,65,"Confirm","White")}DrawImageEx(o[r],i+200-43,275),DrawText(t[r],i+200,400,"Black"),MainCanvas.font=CommonGetFont(24);let a=475;for(const e of n[r].split("\n"))DrawText(e,i+200,a,"Black"),a+=36;1===r?DrawText("Easily try out all features",i+200,775,"Black"):2===r&&DrawText("Similar to Ace's Cursed Script",i+200,775,"Black"),MainCanvas.font=CommonGetFont(36)}}Click(){for(let e=0;e<4;e++){const t=125+450*e;if(MouseIn(t,250,400,575))return void(this.selectedPreset=e);e===this.selectedPreset&&MouseIn(t+20,850,360,65)&&(applyPreset(e),setSubscreen(new GuiMainMenu(getPlayerCharacter())))}MouseIn(800,66,400,54)&&setSubscreen(new GuiTutorial(this.character,!0))}Exit(){}}const TUTORIAL_PAGES=[{name:"Welcome",image:"welcome.png",afterDraw(){DrawButton(1815,190,90,90,"","White","Icons/Question.png","",!0),MainCanvas.save(),MainCanvas.font='28px "Arial", sans-serif',MainCanvas.textAlign="left",DrawText(`Dear ${Player.Name},`,285,510,"Black"),DrawTextWrap("we are happy you are interested in our extension for the Bondage Club (BC) in which we invest a lot of our free time and love. If you have any questions, suggestions, or encounter any bugs, please feel free to get in touch with us on Discord. A button linking to it is in the main menu.",-185,544,940,160,"black"),MainCanvas.restore()}},{name:"Quick overview",image:"quick_overview.png"},{name:"New chat room icons",image:"status_icons.png",afterDraw(){DrawCharacter(Player,130,100,.82,!0,MainCanvas),drawIcon(MainCanvas,icon_heart,450,70,50,50,50,1,4,"#6e6eff");const e=Date.now()%1e4;(e<4e3||e>6e3&&e<9e3)&&drawTypingIndicatorSpeechBubble(MainCanvas,450,128,50,48,1)}},{name:"Introduction to roles and permissions",image:"basic_roles_permissions.png"},{name:"End of introduction",image:"basic_end.png",afterDraw(){DrawCharacter(Player,240,160,.78,!0,MainCanvas)}}],TUTORIAL_BASIC_END=TUTORIAL_PAGES.findIndex((e=>"End of introduction"===e.name));class GuiTutorial extends GuiSubscreen{constructor(e,t){super(),this.page=0,this.character=e,this.firstRun=t}Load(){this.page=0}Run(){const e=TUTORIAL_PAGES[this.page];MainCanvas.textAlign="center",DrawText(`BCX TUTORIAL: ${e.name}`,1e3,125,"Black","Gray"),DrawButton(1500,830,300,90,this.firstRun&&this.page<TUTORIAL_BASIC_END?"Skip tutorial":"Close tutorial","White"),e.image&&(DrawImageBCX("tutorial/"+e.image,200,180)||DrawText("Loading...",1e3,500,"Black")),e.afterDraw&&e.afterDraw(),DrawBackNextButton(850,830,300,90,`Page ${this.page+1}/${TUTORIAL_PAGES.length}`,"White",void 0,(()=>""),(()=>""))}Click(){if(MouseIn(1500,830,300,90))return this.Exit();MouseIn(850,830,150,90)&&(this.page=clampWrap(this.page-1,0,TUTORIAL_PAGES.length-1)),MouseIn(1e3,830,150,90)&&(this.page=clampWrap(this.page+1,0,TUTORIAL_PAGES.length-1))}Exit(){setSubscreen(this.firstRun?new GuiWelcomeSelection(this.character):new GuiMainMenu(this.character))}}let nextCheckTimer=null,versionCheckNewAvailable=null,versionCheckDidNotify=!1;function sendVersionCheckBeep(){null!==nextCheckTimer&&(clearTimeout(nextCheckTimer),nextCheckTimer=null),sendHiddenBeep("versionCheck",{version:VERSION,devel:BCX_DEVEL,GameVersion:GameVersion,Source:(BCXSourceExternal?"E:":"")+BCXSource,UA:window.navigator.userAgent},VERSION_CHECK_BOT,!0),nextCheckTimer=BCX_setTimeout(sendVersionCheckBeep,3e5)}class ModuleVersionCheck extends BaseModule{load(){hiddenBeepHandlers.set("versionResponse",((e,t)=>{var o,n;if(e===VERSION_CHECK_BOT)if(isObject$1(t)&&"string"==typeof t.status)if(null!==nextCheckTimer&&clearTimeout(nextCheckTimer),nextCheckTimer=BCX_setTimeout(sendVersionCheckBeep,9e5),"current"!==t.status)if("newAvailable"===t.status){if(versionCheckNewAvailable=!0,versionCheckDidNotify)return;versionCheckDidNotify=!0,ServerPlayerIsInChatRoom()?ChatRoomSendLocal("New BCX version is available! You can upgrade by logging in again."):InfoBeep("New BCX version is available! You can upgrade by logging in again.",1e4)}else if("deprecated"===t.status){if(versionCheckNewAvailable=!0,versionCheckDidNotify)return;versionCheckDidNotify=!0;const e=document.createElement("div");e.style.position="fixed",e.style.top="0px",e.style.right="0px",e.style.bottom="0px",e.style.left="0px",e.style.background="#00000090",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center";const t=document.createElement("div");e.appendChild(t),t.style.background="white",t.style.display="flex",t.style.flexDirection="column",t.style.padding="1em";const r=document.createElement("h1");t.appendChild(r),r.innerText="Deprecated BCX version";const i=document.createElement("p");t.appendChild(i),i.innerText="The BCX version you are using is too old and either contains critical bugs or is no longer compatible with the current Bondage Club release version.\nUnless you are using additional mods preventing this, please refresh the page and log into the club again to load the newest version.";const a=document.createElement("button");t.appendChild(a),a.innerText="Close",a.onclick=()=>{e.remove()},null===(n=null===(o=document.activeElement)||void 0===o?void 0:o.blur)||void 0===n||n.call(o),window.document.body.appendChild(e)}else"unsupported"===t.status?(unload(),alert("The BCX version you are trying to load is too old and either contains critical bugs or is no longer compatible with the current Bondage Club release version. Please update your BCX.")):console.warn(`BCX: bad versionResponse status "${t.status}"`);else versionCheckNewAvailable=!1;else console.warn("BCX: bad versionResponse",t);else console.warn(`BCX: got versionResponse from unexpected sender ${e}, ignoring`)}))}run(){sendVersionCheckBeep()}unload(){null!==nextCheckTimer&&(clearTimeout(nextCheckTimer),nextCheckTimer=null)}}const MAIN_MENU_ITEMS=[{module:ModuleCategory.Global,onclick:e=>{setSubscreen(new GuiGlobal(e))}},{module:ModuleCategory.Authority,onclick:e=>{setSubscreen(new GuiAuthorityRoles(e))}},{module:ModuleCategory.Log,onclick:e=>{setSubscreen(new GuiLog(e))}},{module:ModuleCategory.Curses,onclick:e=>{setSubscreen(new GuiConditionViewCurses(e))}},{module:ModuleCategory.Rules,onclick:e=>{setSubscreen(new GuiConditionViewRules(e))}},{module:ModuleCategory.Misc,onclick:e=>{setSubscreen(new GuiMisc(e))}}];class GuiMainMenu extends GuiSubscreen{constructor(e){super(),this.disabledModules=TOGGLEABLE_MODULES,this.character=e}Load(){this.character.getDisabledModules(5e3).then((e=>{this.disabledModules=e})).catch((e=>{this.disabledModules=[],console.error("BCX: error getting disabled modules",e)}))}onChange(e){e===this.character.MemberNumber&&this.Load()}Run(){var e;DrawText("- Bondage Club Extended -",125,125,"Black","Gray"),DrawButton(1815,75,90,90,"","White","Icons/Exit.png"),DrawButton(1815,190,90,90,"","White","Icons/Question.png","Show the BCX tutorial again");for(let e=0;e<MAIN_MENU_ITEMS.length;e++){const t=MAIN_MENU_ITEMS[e],o=Math.floor(e/7),n=e%7,r=this.disabledModules.includes(t.module);DrawButton(150+420*o,160+110*n,400,90,"",r?"#ddd":"White",MODULE_ICONS[t.module],r?"Module is deactivated":"",r),DrawTextFit(MODULE_NAMES[t.module],250+420*o,205+110*n,310,"Black")}if(MainCanvas.textAlign="center",this.character.isPlayer()){if(DrawText(`Your BCX version: ${VERSION.replace(/-[0-f]+$/i,"")}`,1650,610,"Black",""),DrawButton(1450,700,400,90,"","White","","Open changelog on GitHub"),!0===versionCheckNewAvailable){Date.now()%6e3<3e3?DrawText("New version available",1650,665,"Red","Black"):DrawText("Login again to upgrade",1650,665,"Red","Black")}else!1===versionCheckNewAvailable&&DrawText("This is the latest version",1650,665,"Black","");DrawText("View changelog",1625,745,"Black",""),DrawImageEx(icon_ExternalLink,1770,730,{Width:30,Height:30}),DrawButton(1450,810,400,90,"","White","","Open invite to BCX Discord server"),DrawText("BCX Discord",1625,855,"Black",""),DrawImageEx(icon_ExternalLink,1770,840,{Width:30,Height:30})}else DrawText(`Your BCX version: ${VERSION.replace(/-[0-f]+$/i,"")}`,1650,765,"Black",""),DrawText(`${this.character.Name}'s BCX version: ${null===(e=this.character.BCXVersion)||void 0===e?void 0:e.replace(/-[0-f]+$/i,"")}`,1650,845,"Black","")}Click(){if(MouseIn(1815,75,90,90))return this.Exit();MouseIn(1815,190,90,90)&&setSubscreen(new GuiTutorial(this.character,!1)),MouseIn(1450,700,400,90)&&this.character.isPlayer()&&window.open(`https://github.com/Jomshir98/bondage-club-extended/blob/${BCX_DEVEL?"master":"stable"}/CHANGELOG.md`,"_blank"),MouseIn(1450,810,400,90)&&this.character.isPlayer()&&window.open("https://discord.gg/SHJMjEh9VH","_blank");for(let e=0;e<MAIN_MENU_ITEMS.length;e++){const t=MAIN_MENU_ITEMS[e],o=Math.floor(e/7);if(MouseIn(150+420*o,160+110*(e%7),400,90)&&!this.disabledModules.includes(t.module))return t.onclick(this.character)}}}function getCurrentSubscreen(){return ModuleGUI.instance&&ModuleGUI.instance.currentSubscreen}function setSubscreen(e){if(!ModuleGUI.instance)throw new Error("Attempt to set subscreen before init");ModuleGUI.instance.currentSubscreen=e}class ModuleGUI extends BaseModule{constructor(){if(super(),this._currentSubscreen=null,ModuleGUI.instance)throw new Error("Duplicate initialization");ModuleGUI.instance=this}get currentSubscreen(){return this._currentSubscreen}set currentSubscreen(e){this._currentSubscreen&&this._currentSubscreen.Unload(),this._currentSubscreen=e,this._currentSubscreen&&this._currentSubscreen.Load(),ChatroomSM.UpdateStatus()}getInformationSheetCharacter(){const e=InformationSheetSelection;return e&&"number"==typeof e.MemberNumber?getChatroomCharacter(e.MemberNumber):null}init(){changeHandlers.push((e=>{this._currentSubscreen&&this._currentSubscreen.onChange(e)}))}load(){patchFunction("InformationSheetRun",{"DrawButton(1815, 765, 90, 90,":"DrawButton(1815, 800, 90, 90,"}),patchFunction("InformationSheetClick",{"MouseIn(1815, 765, 90, 90)":"MouseIn(1815, 800, 90, 90)"}),hookFunction("InformationSheetRun",10,((e,t)=>{if(this._currentSubscreen)return MainCanvas.textAlign="left",this._currentSubscreen.Run(),MainCanvas.textAlign="center",void(developmentMode&&(MouseX>0||MouseY>0)&&(MainCanvas.save(),MainCanvas.lineWidth=1,MainCanvas.strokeStyle="red",MainCanvas.beginPath(),MainCanvas.moveTo(0,MouseY),MainCanvas.lineTo(2e3,MouseY),MainCanvas.moveTo(MouseX,0),MainCanvas.lineTo(MouseX,1e3),MainCanvas.stroke(),MainCanvas.fillStyle="black",MainCanvas.strokeStyle="white",MainCanvas.fillRect(0,950,250,50),MainCanvas.strokeRect(0,950,250,50),DrawText(`X: ${MouseX} Y: ${MouseY}`,125,975,"white"),MainCanvas.restore()));t(e);const o=this.getInformationSheetCharacter();if(firstTimeInit)o&&o.isPlayer()&&(DrawButton(1815,685,90,90,"","White",icon_BCX),MainCanvas.beginPath(),MainCanvas.rect(1300,685,500,90),MainCanvas.fillStyle="Black",MainCanvas.fill(),DrawText("You can find BCX here ",1550,730,"White"));else if(o&&null!==o.BCXVersion){const e=o.playerHasAccessToCharacter();DrawButton(1815,685,90,90,"",e?"White":"#ddd",icon_BCX,e?"BCX":"Needs BC item permission",!e)}})),hookFunction("InformationSheetClick",10,((e,t)=>{if(this._currentSubscreen)return this._currentSubscreen.Click();const o=this.getInformationSheetCharacter();if(!MouseIn(1815,685,90,90))return t(e);firstTimeInit?o&&o.isPlayer()&&(ServerBeep={},this.currentSubscreen=new GuiTutorial(o,!0)):o&&null!==o.BCXVersion&&o.playerHasAccessToCharacter()&&(this.currentSubscreen=new GuiMainMenu(o))})),hookFunction("InformationSheetExit",10,((e,t)=>this._currentSubscreen?this._currentSubscreen.Exit():t(e)))}unload(){this.currentSubscreen=null}}var ChatRoomStatusManagerStatusType;ModuleGUI.instance=null,function(e){e.None="None",e.Typing="Typing",e.Emote="Emote",e.Whisper="Whisper",e.DMS="DMS",e.Wardrobe="Wardrobe",e.Profile="Profile",e.Action="Action",e.Afk="Afk"}(ChatRoomStatusManagerStatusType||(ChatRoomStatusManagerStatusType={}));class ChatRoomStatusManager{constructor(){this.InputTimeoutMs=3e3,this.StatusTypes={},this.InputElement=null,this.InputTimeout=null,this.Status=ChatRoomStatusManagerStatusType.None,this.DMS=!1,this.TypingStatus=ChatRoomStatusManagerStatusType.None,this.WhisperTarget=null}GetCharacterStatus(e){return 0===e.ID?ChatroomSM.Status:e.Status}SetInputElement(e){this.InputElement!==e&&(this.InputElement=e,null!==e&&(e.addEventListener("blur",this.InputEnd.bind(this)),e.addEventListener("input",this.InputChange.bind(this))))}GetStatus(){if(this.DMS)return ChatRoomStatusManagerStatusType.DMS;if(modStorage.screenIndicatorEnable){if("Appearance"===CurrentScreen)return ChatRoomStatusManagerStatusType.Wardrobe;if("OnlineProfile"===CurrentScreen||null!=getCurrentSubscreen())return ChatRoomStatusManagerStatusType.Profile}return modStorage.typingIndicatorEnable?this.TypingStatus:ChatRoomStatusManagerStatusType.None}UpdateStatus(){const e=this.GetStatus();e!==this.Status&&(null!==this.WhisperTarget&&e===ChatRoomStatusManagerStatusType.Whisper&&this.SendUpdate(ChatRoomStatusManagerStatusType.None,null),this.Status=e,this.SendUpdate(e,e===ChatRoomStatusManagerStatusType.Whisper?this.WhisperTarget:null))}SendUpdate(e,t=null){sendHiddenMessage("ChatRoomStatusEvent",{Type:e,Target:t},t);isNModClient()&&ServerSend("ChatRoomStatusEvent",{Type:e,Target:t})}InputChange(){var e;const t=null===(e=this.InputElement)||void 0===e?void 0:e.value;if("string"==typeof t&&t.length>1){if(this.TypingStatus=ChatRoomStatusManagerStatusType.Typing,this.WhisperTarget=null,t.startsWith("*")||t.startsWith("/me ")||t.startsWith("/emote ")||t.startsWith("/action "))this.TypingStatus=ChatRoomStatusManagerStatusType.Emote;else{if(t.startsWith("/")||t.startsWith("."))return this.InputEnd();null!==ChatRoomTargetMemberNumber&&(this.TypingStatus=ChatRoomStatusManagerStatusType.Whisper,this.WhisperTarget=ChatRoomTargetMemberNumber)}null!==this.InputTimeout&&clearTimeout(this.InputTimeout),this.InputTimeout=BCX_setTimeout(this.InputEnd.bind(this),this.InputTimeoutMs),this.UpdateStatus()}else this.InputEnd()}InputEnd(){null!==this.InputTimeout&&(clearTimeout(this.InputTimeout),this.InputTimeout=null),this.TypingStatus=ChatRoomStatusManagerStatusType.None,this.UpdateStatus()}unload(){this.DMS=!1,this.InputEnd()}}function DMSKeydown(e){e.altKey&&"NumpadEnter"===e.code&&(e.preventDefault(),e.stopImmediatePropagation(),document.activeElement instanceof HTMLElement&&document.activeElement.blur(),ChatroomSM.DMS=!0,ChatroomSM.UpdateStatus())}function DMSKeyup(e){!ChatroomSM.DMS||"Alt"!==e.key&&"NumpadEnter"!==e.code||(ChatroomSM.DMS=!1,ChatroomSM.UpdateStatus())}let ChatroomSM;function queryAnnounce(){announceSelf(!0)}class ModuleChatroom extends BaseModule{constructor(){super(...arguments),this.o_ChatRoomSM=null}init(){ChatroomSM=new ChatRoomStatusManager}load(){"boolean"!=typeof modStorage.typingIndicatorEnable&&(modStorage.typingIndicatorEnable=!0),"boolean"!=typeof modStorage.screenIndicatorEnable&&(modStorage.screenIndicatorEnable=!0),hiddenMessageHandlers.set("hello",((e,t)=>{const o=getChatroomCharacter(e);if(!o)return void console.warn("BCX: Hello from character not found in room",e);if("string"!=typeof(null==t?void 0:t.version))return void console.warn("BCX: Invalid hello",e,t);o.BCXVersion=t.version;const n=isObject$1(t.effects)?t.effects:{};o.Effects=cloneDeep(defaultBCXEffects),Array.isArray(n.Effect)&&n.Effect.every((e=>"string"==typeof e))&&(o.Effects.Effect=n.Effect),CharacterRefresh(o.Character,!1),!0===t.request&&announceSelf(!1)})),hiddenMessageHandlers.set("goodbye",(e=>{const t=getChatroomCharacter(e);t&&(t.BCXVersion=null,t.Effects=cloneDeep(defaultBCXEffects),CharacterRefresh(t.Character,!1))})),hookFunction("ChatRoomMessage",10,((e,t)=>{const o=e[0];return"Action"===(null==o?void 0:o.Type)&&"ServerEnter"===o.Content&&announceSelf(!1),t(e)}));const e=isNModClient();e?(hookFunction("ChatRoomDrawFriendList",0,((e,t)=>{var o;const[n,r,i,a]=e,s=getChatroomCharacter(n.MemberNumber),l=0===n.ID||(null!==(o=Player.FriendList)&&void 0!==o?o:[]).includes(n.MemberNumber);(null==s?void 0:s.BCXVersion)&&0===ChatRoomHideIconState?l?drawIcon(MainCanvas,icon_heart,i+375*r,a,50*r,50*r,50,1,4,"#6e6eff"):drawIcon(MainCanvas,icon_BCX_cross,i+375*r,a,50*r,50*r,50,.5,3,"#6e6eff"):t(e)})),patchFunction("ChatRoomDrawCharacterOverlay",{"switch (C.Status)":"switch (null)"})):(patchFunction("ChatRoomDrawCharacterOverlay",{'DrawImageResize("Icons/Small/FriendList.png", CharX + 375 * Zoom, CharY, 50 * Zoom, 50 * Zoom);':""}),hookFunction("ChatRoomDrawCharacterOverlay",0,((e,t)=>{var o;t(e);const[n,r,i,a]=e,s=getChatroomCharacter(n.MemberNumber),l=0===n.ID||(null!==(o=Player.FriendList)&&void 0!==o?o:[]).includes(n.MemberNumber);(null==s?void 0:s.BCXVersion)&&0===ChatRoomHideIconState?l?drawIcon(MainCanvas,icon_heart,r+375*a,i,50*a,50*a,50,1,4,"#6e6eff"):drawIcon(MainCanvas,icon_BCX_cross,r+375*a,i,50*a,50*a,50,.7,3,"#6e6eff"):l&&0===ChatRoomHideIconState&&DrawImageEx("Icons/Small/FriendList.png",r+375*a,i,{Width:50*a,Height:50*a})})),hookFunction("ChatRoomCreateElement",0,((e,t)=>{t(e),ChatroomSM.SetInputElement(document.getElementById("InputChat"))}))),hookFunction("ChatRoomDrawCharacterOverlay",0,((e,t)=>{t(e);const[o,n,r,i]=e;switch(ChatroomSM.GetCharacterStatus(o)){case ChatRoomStatusManagerStatusType.Typing:drawTypingIndicatorSpeechBubble(MainCanvas,n+375*i,r+54*i,50*i,48*i,1);break;case ChatRoomStatusManagerStatusType.Whisper:drawTypingIndicatorSpeechBubble(MainCanvas,n+375*i,r+54*i,50*i,48*i,.5);break;case ChatRoomStatusManagerStatusType.Emote:drawTypingIndicatorSpeechBubble(MainCanvas,n+375*i,r+54*i,50*i,48*i,1,!0);break;case ChatRoomStatusManagerStatusType.DMS:DrawRect(n+380*i,r+53*i,40*i,40*i,"White"),DrawImageEx("Icons/Import.png",n+375*i,r+50*i,{Width:50*i,Height:50*i});break;case ChatRoomStatusManagerStatusType.Wardrobe:DrawImageEx("Assets/Female3DCG/Emoticon/Wardrobe/Icon.png",n+375*i,r+50*i,{Width:50*i,Height:50*i});break;case ChatRoomStatusManagerStatusType.Profile:DrawImageEx("Assets/Female3DCG/Emoticon/Read/Icon.png",n+375*i,r+50*i,{Width:50*i,Height:50*i,SourcePos:[7,9,74,74]})}})),window.addEventListener("keydown",DMSKeydown),window.addEventListener("keyup",DMSKeyup),hookFunction("ChatRoomSendChat",0,((e,t)=>{t(e),ChatroomSM.InputEnd()})),hookFunction("ChatRoomClearAllElements",0,((e,t)=>{t(e),ChatroomSM.SetInputElement(null)})),hookFunction("CommonSetScreen",0,((e,t)=>{t(e),ChatroomSM.UpdateStatus()})),hookFunction("ServerSend",5,((e,t)=>{modStorage.screenIndicatorEnable&&"ChatRoomCharacterExpressionUpdate"===e[0]&&isObject$1(e[1])&&"Emoticon"===e[1].Group&&"Wardrobe"===e[1].Name||t(e)})),hiddenMessageHandlers.set("ChatRoomStatusEvent",((e,t)=>{for(const o of ChatRoomCharacter)o.MemberNumber===e&&(o.Status=null==t.Target||t.Target===Player.MemberNumber?t.Type:"None")})),e&&(this.o_ChatRoomSM=window.ChatRoomSM,window.ChatRoomSM=ChatroomSM,ServerSocket.on("ChatRoomMessageSync",queryAnnounce))}run(){null!=document.getElementById("InputChat")&&ChatroomSM.SetInputElement(document.getElementById("InputChat")),queryAnnounce()}unload(){ChatroomSM.unload(),this.o_ChatRoomSM&&(window.ChatRoomSM=this.o_ChatRoomSM),ServerSocket.off("ChatRoomMessageSync",queryAnnounce),sendHiddenMessage("goodbye",void 0),window.removeEventListener("keydown",DMSKeydown),window.removeEventListener("keyup",DMSKeyup)}}function announceSelf(e=!1){const t=getPlayerCharacter();sendHiddenMessage("hello",{version:VERSION,request:e,effects:t.Effects})}var StorageLocations;!function(e){e[e.OnlineSettings=0]="OnlineSettings",e[e.LocalStorage=1]="LocalStorage"}(StorageLocations||(StorageLocations={}));let modStorage={},deletionPending=!1,firstTimeInit=!1,modStorageLocation=StorageLocations.OnlineSettings;function finalizeFirstTimeInit(){firstTimeInit&&(firstTimeInit=!1,modStorage.chatShouldDisplayFirstTimeHelp=!0,modStorageSync(),console.log("BCX: First time init finalized"),announceSelf(!0))}function getLocalStorageName(){return`BCX_${Player.MemberNumber}`}function storageClearData(){delete Player.OnlineSettings.BCX,localStorage.removeItem(getLocalStorageName()),"undefined"!=typeof ServerAccountUpdate?ServerAccountUpdate.QueueData({OnlineSettings:Player.OnlineSettings},!0):(console.debug("BCX: Old sync method"),ServerSend("AccountUpdate",{OnlineSettings:Player.OnlineSettings}))}function switchStorageLocation(e){if(e!==StorageLocations.LocalStorage&&e!==StorageLocations.OnlineSettings)throw new Error("Unknown storage location");modStorageLocation!==e&&(console.info(`BCX: Switching storage location to: ${StorageLocations[e]}`),modStorageLocation=e,storageClearData(),modStorageSync())}function modStorageSync(){if(moduleInitPhase!==ModuleInitPhase.ready&&moduleInitPhase!==ModuleInitPhase.destroy)return;if(deletionPending||firstTimeInit)return;if(!Player.OnlineSettings)return void console.error("BCX: Player OnlineSettings not defined during storage sync!");const e=LZString.compressToBase64(JSON.stringify(modStorage));if(modStorageLocation===StorageLocations.OnlineSettings)Player.OnlineSettings.BCX=e,"undefined"!=typeof ServerAccountUpdate?ServerAccountUpdate.QueueData({OnlineSettings:Player.OnlineSettings}):(console.debug("BCX: Old sync method"),ServerSend("AccountUpdate",{OnlineSettings:Player.OnlineSettings}));else{if(modStorageLocation!==StorageLocations.LocalStorage)throw new Error("Unknown StorageLocation");localStorage.setItem(getLocalStorageName(),e)}}function clearAllData(){deletionPending=!0,storageClearData(),sendHiddenBeep("clearData",!0,VERSION_CHECK_BOT,!0),BCX_setTimeout((()=>{window.location.reload()}),2e3)}class ModuleStorage extends BaseModule{init(){var e;let t=null;if(t=localStorage.getItem(getLocalStorageName()),"string"==typeof t&&(console.info("BCX: Detected storage location: local storage"),modStorageLocation=StorageLocations.LocalStorage),t||(t=null===(e=Player.OnlineSettings)||void 0===e?void 0:e.BCX,modStorageLocation=StorageLocations.OnlineSettings),"string"==typeof t)try{const e=JSON.parse(LZString.decompressFromBase64(t));if(!isObject$1(e))throw new Error("Bad data");modStorage=e}catch(e){console.error("BCX: Error while loading saved data, full reset.",e)}else console.log("BCX: First time init"),firstTimeInit=!0}run(){modStorageSync()}}var AccessLevel;!function(e){e[e.self=0]="self",e[e.clubowner=1]="clubowner",e[e.owner=2]="owner",e[e.lover=3]="lover",e[e.mistress=4]="mistress",e[e.whitelist=5]="whitelist",e[e.friend=6]="friend",e[e.public=7]="public"}(AccessLevel||(AccessLevel={}));const permissions=new Map;function registerPermission(e,t){if(moduleInitPhase!==ModuleInitPhase.init)throw new Error("Permissions can be registered only during init");if(permissions.has(e))throw new Error(`Permission "${e}" already defined!`);for(const[o,n]of Object.entries(t.defaults))n[1]!==AccessLevel.self||n[0]||console.error(`BCX: register permission "${e}": default for ${o} has invalid self value`);permissions.set(e,{...t,self:t.defaults[Preset.switch][0],min:t.defaults[Preset.switch][1]})}function getCharacterAccessLevel(e){var t,o,n;const r="number"==typeof e?e:e.MemberNumber;if(Player.MemberNumber===r)return AccessLevel.self;if(null!==r){if(Player.IsOwnedByMemberNumber(r))return AccessLevel.clubowner;if(null===(t=modStorage.owners)||void 0===t?void 0:t.includes(r))return AccessLevel.owner;if(Player.IsLoverOfMemberNumber(r))return AccessLevel.lover;if(null===(o=modStorage.mistresses)||void 0===o?void 0:o.includes(r))return AccessLevel.mistress;if(Player.WhiteList.includes(r))return AccessLevel.whitelist;if(null===(n=Player.FriendList)||void 0===n?void 0:n.includes(r))return AccessLevel.friend}return AccessLevel.public}function getHighestRoleInRoom(){let e=null;for(const t of getAllCharactersInRoom()){const o=getCharacterAccessLevel(t);o!==AccessLevel.self&&(!e||o<e)&&(e=o)}return e}function checkPermissionAccess(e,t){const o=permissions.get(e);return o?!!t.hasAccessToPlayer()&&(!!moduleIsEnabled(o.category)&&checkPermisionAccesData(o,getCharacterAccessLevel(t))):(console.error(new Error(`Check for unknown permission "${e}"`)),!1)}function checkPermisionAccesData(e,t){return t===AccessLevel.self?e.self||e.min===AccessLevel.self:t<=e.min}function permissionsMakeBundle(){const e={};for(const[t,o]of permissions.entries())moduleIsEnabled(o.category)&&(e[t]=[o.self,o.min]);return e}function getPermissionDataFromBundle(e){const t={};for(const[o,n]of permissions.entries())e[o]&&(t[o]={...n,self:e[o][0],min:e[o][1]});return t}function setPermissionSelfAccess(e,t,o){const n=permissions.get(e);if(!n)throw new Error(`Attempt to edit unknown permission "${e}"`);if(!moduleIsEnabled(n.category))return!1;if(t=t||n.min===AccessLevel.self,n.self===t)return!0;if(o&&(!checkPermissionAccess(t?"authority_grant_self":"authority_revoke_self",o)||!o.isPlayer()&&!checkPermissionAccess(e,o)))return console.warn(`BCX: Unauthorized self permission edit attempt for "${e}" by ${o}`),!1;if(o){const e=`${o} `+(t?`gave ${o.isPlayer()?"herself":Player.Name}`:"removed "+((null==o?void 0:o.isPlayer())?"her":Player.Name+"'s"))+` control over permission "${n.name}"`;logMessage("permission_change",LogEntryType.plaintext,e),o.isPlayer()||ChatRoomSendLocal(e,void 0,o.MemberNumber)}return n.self=t,permissionsSync(),notifyOfChange(),!0}function setPermissionMinAccess(e,t,o){const n=permissions.get(e);if(!n)throw new Error(`Attempt to edit unknown permission "${e}"`);if(!moduleIsEnabled(n.category))return!1;if(n.min===t)return!0;if(o){if(!(o.isPlayer()&&n.min<t&&t<=AccessLevel.owner||checkPermissionAccess("authority_edit_min",o)&&(checkPermissionAccess(e,o)||o.isPlayer()&&t>=n.min)&&(!o.isPlayer()||getCharacterAccessLevel(o)<=t)))return console.warn(`BCX: Unauthorized min permission edit attempt for "${e}" by ${o}`),!1}if(o){const e=`${o} changed permission "${n.name}" from "${getPermissionMinDisplayText(n.min,o)}" to "${getPermissionMinDisplayText(t,o)}"`;logMessage("permission_change",LogEntryType.plaintext,e),o.isPlayer()||ChatRoomSendLocal(e,void 0,o.MemberNumber)}return n.min=t,t===AccessLevel.self&&(n.self=!0),permissionsSync(),notifyOfChange(),!0}function permissionsSync(){modStorage.permissions=permissionsMakeBundle(),modStorageSync()}function getPlayerPermissionSettings(){const e={};for(const[t,o]of permissions.entries())moduleIsEnabled(o.category)&&(e[t]={...o});return e}function getPermissionMinDisplayText(e,t){return e===AccessLevel.self?t?t.Name:"Self":capitalizeFirstLetter(AccessLevel[e])}function getPlayerRoleData(e){var t,o,n,r;const i=e=>[e,getCharacterName(e,"")];let a=[],s=[];return checkPermissionAccess("authority_view_roles",e)||checkPermissionAccess("authority_mistress_remove",e)?a=(null!==(t=modStorage.mistresses)&&void 0!==t?t:[]).map(i):(null===(o=modStorage.mistresses)||void 0===o?void 0:o.includes(e.MemberNumber))&&(a=[[e.MemberNumber,e.Name]]),checkPermissionAccess("authority_view_roles",e)||checkPermissionAccess("authority_owner_remove",e)?s=(null!==(n=modStorage.owners)&&void 0!==n?n:[]).map(i):(null===(r=modStorage.owners)||void 0===r?void 0:r.includes(e.MemberNumber))&&(s=[[e.MemberNumber,e.Name]]),{mistresses:a,owners:s,allowAddMistress:checkPermissionAccess("authority_mistress_add",e),allowRemoveMistress:checkPermissionAccess("authority_mistress_remove",e),allowAddOwner:checkPermissionAccess("authority_owner_add",e),allowRemoveOwner:checkPermissionAccess("authority_owner_remove",e)}}function editRole(e,t,o,n){if(o===Player.MemberNumber)return!1;if(!modStorage.owners||!modStorage.mistresses)throw new Error("Not initialized");if(n){let r="authority_mistress_add";if("mistress"===e&&"remove"===t?r="authority_mistress_remove":"owner"===e&&"add"===t?r="authority_owner_add":"owner"===e&&"remove"===t&&(r="authority_owner_remove"),!checkPermissionAccess(r,n)&&("remove"!==t||o!==n.MemberNumber))return!1;if("mistress"===e&&"add"===t&&modStorage.owners.includes(o)&&!checkPermissionAccess("authority_owner_remove",n))return!1}if("owner"===e&&"remove"===t&&!modStorage.owners.includes(o)||"mistress"===e&&"remove"===t&&!modStorage.mistresses.includes(o))return!0;if(n){const r=n.MemberNumber===o?"herself":`${getCharacterName(o,"[unknown name]")} (${o})`,i="add"===t?`${n} added ${r} as ${e}.`:`${n} removed ${r} from being ${e}.`;if(logMessage("authority_roles_change",LogEntryType.plaintext,i),n.isPlayer()||ChatRoomSendLocal(i,void 0,n.MemberNumber),"add"===t&&n.MemberNumber!==o){const t=n.isPlayer()?"her":`${Player.Name}'s (${Player.MemberNumber})`;ChatRoomActionMessage(`${n} added you as ${t} BCX ${e}.`,o)}}const r=modStorage.owners.indexOf(o);r>=0&&modStorage.owners.splice(r,1);const i=modStorage.mistresses.indexOf(o);return i>=0&&modStorage.mistresses.splice(i,1),"add"===t&&("owner"===e?modStorage.owners.push(o):"mistress"===e&&modStorage.mistresses.push(o)),modStorageSync(),notifyOfChange(),!0}class ModuleAuthority extends BaseModule{init(){registerPermission("authority_grant_self",{name:"Allow granting self access",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!1,AccessLevel.owner],[Preset.slave]:[!1,AccessLevel.owner]}}),registerPermission("authority_revoke_self",{name:"Allow forbidding self access",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.self],[Preset.slave]:[!1,AccessLevel.owner]}}),registerPermission("authority_edit_min",{name:"Allow lowest access modification",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.self],[Preset.slave]:[!1,AccessLevel.owner]}}),registerPermission("authority_mistress_add",{name:"Allow granting Mistress status",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.lover],[Preset.slave]:[!0,AccessLevel.mistress]}}),registerPermission("authority_mistress_remove",{name:"Allow revoking Mistress status",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!1,AccessLevel.lover],[Preset.slave]:[!1,AccessLevel.lover]}}),registerPermission("authority_owner_add",{name:"Allow granting Owner status",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!0,AccessLevel.clubowner],[Preset.slave]:[!0,AccessLevel.owner]}}),registerPermission("authority_owner_remove",{name:"Allow revoking Owner status",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.self],[Preset.submissive]:[!1,AccessLevel.clubowner],[Preset.slave]:[!1,AccessLevel.clubowner]}}),registerPermission("authority_view_roles",{name:"Allow viewing list of owners/mistresses",category:ModuleCategory.Authority,defaults:{[Preset.dominant]:[!0,AccessLevel.self],[Preset.switch]:[!0,AccessLevel.mistress],[Preset.submissive]:[!0,AccessLevel.whitelist],[Preset.slave]:[!0,AccessLevel.public]}}),queryHandlers.permissions=(e,t)=>{t(!0,permissionsMakeBundle())},queryHandlers.permissionAccess=(e,t,o)=>{"string"==typeof o?t(!0,checkPermissionAccess(o,e)):t(!1)},queryHandlers.myAccessLevel=(e,t)=>{t(!0,getCharacterAccessLevel(e))},queryHandlers.editPermission=(e,t,o)=>{if(!isObject$1(o)||"string"!=typeof o.permission||"min"!==o.edit&&"self"!==o.edit||"min"===o.edit&&"number"!=typeof o.target||"self"===o.edit&&"boolean"!=typeof o.target)return console.warn(`BCX: Bad editPermission query from ${e}`,o),t(!1);if(!permissions.has(o.permission))return console.warn(`BCX: editPermission query from ${e}; unknown permission`,o),t(!1);if("self"===o.edit){if("boolean"!=typeof o.target)throw new Error("Assertion failed");return t(!0,setPermissionSelfAccess(o.permission,o.target,e))}if("number"!=typeof o.target)throw new Error("Assertion failed");return void 0===AccessLevel[o.target]?(console.warn(`BCX: editPermission query from ${e}; unknown access level`,o),t(!0,!1)):t(!0,setPermissionMinAccess(o.permission,o.target,e))},queryHandlers.rolesData=(e,t)=>{var o,n;if(!(checkPermissionAccess("authority_view_roles",e)||checkPermissionAccess("authority_mistress_add",e)||checkPermissionAccess("authority_mistress_remove",e)||checkPermissionAccess("authority_owner_add",e)||checkPermissionAccess("authority_owner_remove",e)||(null===(o=modStorage.mistresses)||void 0===o?void 0:o.includes(e.MemberNumber))||(null===(n=modStorage.owners)||void 0===n?void 0:n.includes(e.MemberNumber))))return t(!1);t(!0,getPlayerRoleData(e))},queryHandlers.editRole=(e,t,o)=>{if(!isObject$1(o)||"owner"!==o.type&&"mistress"!==o.type||"add"!==o.action&&"remove"!==o.action||"number"!=typeof o.target)return console.warn(`BCX: Bad editRole query from ${e}`,o),t(!1);t(!0,editRole(o.type,o.action,o.target,e))},registerWhisperCommand("role","- Manage Owner & Mistress roles",((e,t,o)=>{var n,r;const i=(e[0]||"").toLocaleLowerCase();if("list"===i){if(!(checkPermissionAccess("authority_view_roles",t)||checkPermissionAccess("authority_mistress_add",t)||checkPermissionAccess("authority_mistress_remove",t)||checkPermissionAccess("authority_owner_add",t)||checkPermissionAccess("authority_owner_remove",t)||(null===(n=modStorage.mistresses)||void 0===n?void 0:n.includes(t.MemberNumber))||(null===(r=modStorage.owners)||void 0===r?void 0:r.includes(t.MemberNumber))))return o(COMMAND_GENERIC_ERROR);const e=getPlayerRoleData(t);let i="Visible list:";for(const t of e.owners)i+=`\nOwner ${t[1]||"[unknown name]"} (${t[0]})`;for(const t of e.mistresses)i+=`\nMistress ${t[1]||"[unknown name]"} (${t[0]})`;o(i)}else if("owner"===i||"mistress"===i){const n=(e[1]||"").toLocaleLowerCase();if("add"!==n&&"remove"!==n)return o(`Expected either 'add' or 'remove', got '${n}'`);if(!e[2])return o("Missing required argument: target");const r=Command_selectCharacterMemberNumber(e[2],!0);if("string"==typeof r)return o(r);o(editRole(i,n,r,t)?"Ok!":COMMAND_GENERIC_ERROR)}else o(Command_fixExclamationMark(t,"!role usage:\n!role list - List all current owners/mistresses\n!role owner <add/remove> <target> - Add or remove target as owner\n!role mistress <add/remove> <target> - Add or remove target as mistress"))}),((e,t)=>{if(e.length<=1){const t=e[0].toLocaleLowerCase();return["list","owner","mistress"].filter((e=>e.startsWith(t)))}const o=e[0].toLocaleLowerCase();if("owner"===o||"mistress"===o){if(2===e.length){const t=e[1].toLocaleLowerCase();return["add","remove"].filter((e=>e.startsWith(t)))}const t=e[1].toLocaleLowerCase();if("add"===t||"remove"===t)return Command_selectCharacterAutocomplete(e[2])}return[]})),registerWhisperCommand("permission","- Manage permissions",((e,t,o)=>{const n=(e[0]||"").toLocaleLowerCase(),r=getPlayerPermissionSettings();if("list"===n){const t=new Map;let n=!1;const i=e.slice(1).map((e=>e.toLocaleLowerCase()));for(const[e,o]of Object.entries(r)){if(i.some((t=>!MODULE_NAMES[o.category].toLocaleLowerCase().includes(t)&&!o.name.toLocaleLowerCase().includes(t)&&!e.toLocaleLowerCase().includes(t))))continue;let r=t.get(o.category);r||t.set(o.category,r={}),n=!0,r[e]=o}if(!n)return o("No permission matches the filter!");for(const[e,n]of Array.from(t.entries()).sort(((e,t)=>e[0]-t[0]))){let t=`List of ${MODULE_NAMES[e]} module permissions:`;for(const[e,o]of Object.entries(n).sort(((e,t)=>e[1].name.localeCompare(t[1].name))))t+=`\n${e}:\n  ${o.name} - ${o.self?"self":"not self"}, ${getPermissionMinDisplayText(o.min,getPlayerCharacter())}`;o(t),t=""}}else if(void 0!==r[n]){const i=(e[1]||"").toLocaleLowerCase();let a=(e[2]||"").toLocaleLowerCase();if(""===i){const e=r[n];o(`${n}:\n  ${e.name} - ${e.self?"self":"not self"}, ${getPermissionMinDisplayText(e.min,getPlayerCharacter())}`)}else if("selfaccess"===i)o("yes"===a||"no"===a?setPermissionSelfAccess(n,"yes"===a,t)?"Ok!":COMMAND_GENERIC_ERROR:"Expected 'selfaccess yes' or 'selfaccess no'");else if("lowestaccess"===i){a===Player.Name.toLocaleLowerCase()&&(a="self");const e=AccessLevel[a];o("number"==typeof e?setPermissionMinAccess(n,e,t)?"Ok!":COMMAND_GENERIC_ERROR:`Unknown AccessLevel '${a}';\nexpected one of: ${Player.Name}, clubowner, owner, lover, mistress, whitelist, friend, public`)}else o(`Unknown setting '${i}'; expected 'selfaccess' or 'lowestaccess'`)}else o("help"!==n?`Unknown permission '${n}'.\nTo get list of permissions use '${t.isPlayer()?".":"!"}permission list'`:Command_fixExclamationMark(t,`!permission usage:\n!permission list [filter] - List all permissions and their current settings\n!permission <name> selfaccess <yes|no> - Gives or revokes ${Player.Name}'s access to permission <name>\n!permission <name> lowestaccess <${Player.Name}|clubowner|owner|lover|mistress|whitelist|friend|public> - Sets the lowest permitted role for the permission <name>`))}),((e,t)=>{const o=Object.keys(getPlayerPermissionSettings());if(e.length<=1){const t=e[0].toLocaleLowerCase();return["list",...o].filter((e=>e.startsWith(t)))}const n=e[0].toLocaleLowerCase();if(o.includes(n)){const t=e[1].toLocaleLowerCase(),o=(e[2]||"").toLocaleLowerCase();if(2===e.length)return["selfaccess","lowestaccess"].filter((e=>e.startsWith(t)));if(3===e.length){if("selfaccess"===t)return["yes","no"].filter((e=>e.startsWith(o)));if("lowestaccess"===t)return[Player.Name.toLocaleLowerCase(),"self","clubowner","owner","lover","mistress","whitelist","friend","public"].filter((e=>e.startsWith(o)))}}return[]}))}setDefultPermissionsForPreset(e){for(const t of permissions.values())t.self=t.defaults[e][0],t.min=t.defaults[e][1]}applyPreset(e){this.setDefultPermissionsForPreset(e),modStorage.permissions=permissionsMakeBundle()}load(e){var t;if(this.setDefultPermissionsForPreset(e),isObject$1(modStorage.permissions)){const e={log_leaveMessage:"log_add_note"};for(const[o,n]of Object.entries(modStorage.permissions)){void 0!==e[o]&&console.info(`BCX: Updating permission name "${o}"->"${e[o]}"`);const r=permissions.get(null!==(t=e[o])&&void 0!==t?t:o);Array.isArray(n)&&"boolean"==typeof n[0]&&"number"==typeof n[1]?void 0===AccessLevel[n[1]]?console.warn(`BCX: Storage: bad permission ${o} level ${n[1]}`):void 0===r?console.warn(`BCX: Storage: unknown permission ${o}`):(r.self=n[0],r.min=n[1]):console.warn(`BCX: Storage: bad permission ${o}`)}}modStorage.permissions=permissionsMakeBundle();const o=new Set,n=e=>"number"==typeof e&&e!==Player.MemberNumber&&!o.has(e)&&(o.add(e),!0);Array.isArray(modStorage.owners)?modStorage.owners=modStorage.owners.filter(n):modStorage.owners=[],Array.isArray(modStorage.mistresses)?modStorage.mistresses=modStorage.mistresses.filter(n):modStorage.mistresses=[]}reload(e){this.load(e)}}const PLAYER_EFFECT_REBUILD_INTERVAL=2e3;class ChatroomCharacter{constructor(e){this.BCXVersion=null,this.Character=e,0===e.ID&&(this.BCXVersion=VERSION),this.Effects=cloneDeep(defaultBCXEffects),console.debug(`BCX: Loaded character ${e.Name} (${e.MemberNumber})`)}isPlayer(){return!1}get MemberNumber(){if("number"!=typeof this.Character.MemberNumber)throw new Error("Character without MemberNumber");return this.Character.MemberNumber}get Name(){return this.Character.Name}toString(){return`${this.Name} (${this.MemberNumber})`}getDisabledModules(e){return sendQuery("disabledModules",void 0,this.MemberNumber,e).then((e=>{if(!Array.isArray(e))throw console.error("BCX: Bad data during 'disabledModules' query\n",e),new Error("Bad data");return e.filter((e=>TOGGLEABLE_MODULES.includes(e)))}))}getPermissions(){return sendQuery("permissions",void 0,this.MemberNumber).then((e=>{if(!isObject$1(e)||Object.values(e).some((e=>!Array.isArray(e)||"boolean"!=typeof e[0]||"number"!=typeof e[1]||void 0===AccessLevel[e[1]])))throw console.error("BCX: Bad data during 'permissions' query\n",e),new Error("Bad data");return getPermissionDataFromBundle(e)}))}getPermissionAccess(e){return sendQuery("permissionAccess",e,this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'permissionAccess' query\n",e),new Error("Bad data");return e})).catch((t=>(console.error(`BCX: Error while querying permission "${e}" access for ${this}`,t),!1)))}getMyAccessLevel(){return sendQuery("myAccessLevel",void 0,this.MemberNumber).then((e=>{if("number"!=typeof e||void 0===AccessLevel[e])throw console.error("BCX: Bad data during 'myAccessLevel' query\n",e),new Error("Bad data");return e}))}setPermission(e,t,o){return sendQuery("editPermission",{permission:e,edit:t,target:o},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'editPermission' query\n",e),new Error("Bad data");return e}))}getRolesData(){return sendQuery("rolesData",void 0,this.MemberNumber).then((e=>{if(!(isObject$1(e)&&Array.isArray(e.mistresses)&&e.mistresses.every((e=>Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"string"==typeof e[1]))&&Array.isArray(e.owners)&&e.owners.every((e=>Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"string"==typeof e[1]))&&"boolean"==typeof e.allowAddMistress&&"boolean"==typeof e.allowRemoveMistress&&"boolean"==typeof e.allowAddOwner&&"boolean"==typeof e.allowRemoveOwner))throw console.error("BCX: Bad data during 'rolesData' query\n",e),new Error("Bad data");return e}))}editRole(e,t,o){return sendQuery("editRole",{type:e,action:t,target:o},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'editRole' query\n",e),new Error("Bad data");return e}))}getLogEntries(){return sendQuery("logData",void 0,this.MemberNumber).then((e=>{if(!Array.isArray(e)||!e.every((e=>Array.isArray(e)&&4===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&"number"==typeof e[2])))throw console.error("BCX: Bad data during 'logData' query\n",e),new Error("Bad data");return e}))}logMessageDelete(e){return sendQuery("logDelete",e,this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'logDelete' query\n",e),new Error("Bad data");return e}))}getLogConfig(){return sendQuery("logConfigGet",void 0,this.MemberNumber).then((e=>{var t;if(!isObject$1(e)||Object.values(e).some((e=>"number"!=typeof e)))throw console.error("BCX: Bad data during 'logConfigGet' query\n",e),new Error("Bad data");for(const o of Object.keys(e))null!=e[o]&&void 0!==(null===(t=modStorage.logConfig)||void 0===t?void 0:t[o])&&void 0!==LogAccessLevel[e[o]]||delete e[o];return e}))}setLogConfig(e,t){return sendQuery("logConfigEdit",{category:e,target:t},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'logConfigEdit' query\n",e),new Error("Bad data");return e}))}logClear(){return sendQuery("logClear",void 0,this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'logClear' query\n",e),new Error("Bad data");return e}))}logPraise(e,t){return sendQuery("logPraise",{message:t,value:e},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'logPraise' query\n",e),new Error("Bad data");return e}))}logGetAllowedActions(){return sendQuery("logGetAllowedActions",void 0,this.MemberNumber).then((e=>{if(!isObject$1(e)||"boolean"!=typeof e.delete||"boolean"!=typeof e.configure||"boolean"!=typeof e.praise||"boolean"!=typeof e.leaveMessage)throw console.error("BCX: Bad data during 'logGetAllowedActions' query\n",e),new Error("Bad data");return e}))}curseItem(e,t){return sendQuery("curseItem",{Group:e,curseProperties:t},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'curseItem' query\n",e),new Error("Bad data");return e}))}curseLift(e){return sendQuery("curseLift",e,this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'curseLift' query\n",e),new Error("Bad data");return e}))}curseBatch(e,t){return sendQuery("curseBatch",{mode:e,includingEmpty:t},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'curseBatch' query\n",e),new Error("Bad data");return e}))}curseLiftAll(){return sendQuery("curseLiftAll",void 0,this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'curseLiftAll' query\n",e),new Error("Bad data");return e}))}conditionsGetByCategory(e){return sendQuery("conditionsGet",e,this.MemberNumber).then((t=>{if(!guard_ConditionsCategoryPublicData(e,t,!0))throw console.error("BCX: Bad data during 'conditionsGet' query\n",t),new Error("Bad data");return t}))}conditionSetLimit(e,t,o){return sendQuery("conditionSetLimit",{category:e,condition:t,limit:o},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'conditionSetLimit' query\n",e),new Error("Bad data");return e}))}conditionUpdate(e,t,o){return sendQuery("conditionUpdate",{category:e,condition:t,data:o},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'conditionUpdate' query\n",e),new Error("Bad data");return e}))}conditionCategoryUpdate(e,t){return sendQuery("conditionCategoryUpdate",{category:e,data:t},this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'conditionCategoryUpdate' query\n",e),new Error("Bad data");return e}))}ruleCreate(e){return sendQuery("ruleCreate",e,this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'ruleCreate' query\n",e),new Error("Bad data");return e}))}ruleDelete(e){return sendQuery("ruleDelete",e,this.MemberNumber).then((e=>{if("boolean"!=typeof e)throw console.error("BCX: Bad data during 'ruleDelete' query\n",e),new Error("Bad data");return e}))}hasAccessToPlayer(){return ServerChatRoomGetAllowItem(this.Character,Player)}playerHasAccessToCharacter(){return ServerChatRoomGetAllowItem(Player,this.Character)}}class PlayerCharacter extends ChatroomCharacter{constructor(){super(...arguments),this.playerObject=!0}isPlayer(){return!0}getDisabledModules(){return Promise.resolve(getDisabledModules())}getPermissions(){return Promise.resolve(getPlayerPermissionSettings())}getPermissionAccess(e){return Promise.resolve(checkPermissionAccess(e,this))}getMyAccessLevel(){return Promise.resolve(AccessLevel.self)}setPermission(e,t,o){if("self"===t){if("boolean"!=typeof o)throw new Error("Invalid target value for self permission edit");return Promise.resolve(setPermissionSelfAccess(e,o,this))}if("number"!=typeof o)throw new Error("Invalid target value for min permission edit");return Promise.resolve(setPermissionMinAccess(e,o,this))}getRolesData(){return Promise.resolve(getPlayerRoleData(this))}editRole(e,t,o){return Promise.resolve(editRole(e,t,o,this))}getLogEntries(){return Promise.resolve(getVisibleLogEntries(this))}logMessageDelete(e){return Promise.resolve(logMessageDelete(e,this))}getLogConfig(){return Promise.resolve(logGetConfig())}setLogConfig(e,t){return Promise.resolve(logConfigSet(e,t,this))}logClear(){return Promise.resolve(logClear(this))}logPraise(e,t){return Promise.resolve(logPraise(e,t,this))}logGetAllowedActions(){return Promise.resolve(logGetAllowedActions(this))}curseItem(e,t){return Promise.resolve(curseItem(e,t,this))}curseLift(e){return Promise.resolve(curseLift(e,this))}curseBatch(e,t){return Promise.resolve(curseBatch(e,t,this))}curseLiftAll(){return Promise.resolve(curseLiftAll(this))}conditionsGetByCategory(e){return ConditionsGetCategoryEnabled(e)?Promise.resolve(ConditionsGetCategoryPublicData(e,this)):Promise.reject("Category is disabled")}conditionSetLimit(e,t,o){return Promise.resolve(ConditionsSetLimit(e,t,o,this))}conditionUpdate(e,t,o){return Promise.resolve(ConditionsUpdate(e,t,o,this))}ruleCreate(e){return Promise.resolve(RulesCreate(e,this))}ruleDelete(e){return Promise.resolve(RulesDelete(e,this))}conditionCategoryUpdate(e,t){return Promise.resolve(ConditionsCategoryUpdate(e,t,this))}}const currentRoomCharacters=[];function cleanOldCharacters(){for(let e=currentRoomCharacters.length-1;e>=0;e--)currentRoomCharacters[e].isPlayer()||ChatRoomCharacter.includes(currentRoomCharacters[e].Character)||currentRoomCharacters.splice(e,1)}function getChatroomCharacter(e){if("number"!=typeof e)return null;cleanOldCharacters();let t=currentRoomCharacters.find((t=>t.Character.MemberNumber===e));if(!t){if(Player.MemberNumber===e)t=new PlayerCharacter(Player);else{const o=ChatRoomCharacter.find((t=>t.MemberNumber===e));if(!o)return null;t=new ChatroomCharacter(o)}currentRoomCharacters.push(t)}return t}function getAllCharactersInRoom(){return ServerPlayerIsInChatRoom()?ChatRoomCharacter.map((e=>getChatroomCharacter(e.MemberNumber))).filter(Boolean):[getPlayerCharacter()]}function getPlayerCharacter(){let e=currentRoomCharacters.find((e=>e.Character===Player));return e||(e=new PlayerCharacter(Player),currentRoomCharacters.push(e)),e}const effectBuilderFunctions=[];function registerEffectBuilder(e){effectBuilderFunctions.push(e)}function buildPlayerEffects(){const e=cloneDeep(defaultBCXEffects);for(const t of effectBuilderFunctions)t(e);const t=getPlayerCharacter();isEqual(e,t.Effects)||(t.Effects=e,CharacterRefresh(Player,!1),announceSelf(!1))}class ModuleCharacter extends BaseModule{constructor(){super(...arguments),this.timer=null}load(){hookFunction("CharacterLoadEffect",0,((e,t)=>{t(e);const o=e[0],n="number"==typeof o.MemberNumber&&getChatroomCharacter(o.MemberNumber);if(n)for(const e of n.Effects.Effect)o.Effect.includes(e)||o.Effect.push(e)}))}run(){this.timer=BCX_setInterval(buildPlayerEffects,PLAYER_EFFECT_REBUILD_INTERVAL)}unload(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)}}const hiddenMessageHandlers=new Map,hiddenBeepHandlers=new Map,queryHandlers={},changeHandlers=[];function sendHiddenMessage(e,t,o=null){ServerPlayerIsInChatRoom()&&!firstTimeInit&&ServerSend("ChatRoomChat",{Content:"BCXMsg",Type:"Hidden",Target:o,Dictionary:{type:e,message:t}})}function sendHiddenBeep(e,t,o,n=!1){ServerSend("AccountBeep",{MemberNumber:o,BeepType:n?"Leash":"BCX",Message:{BCX:{type:e,message:t}}})}const pendingQueries=new Map;function sendQuery(e,t,o,n=1e4){return firstTimeInit?Promise.reject("Unavailable during init"):new Promise(((r,i)=>{const a=uuidv4(),s={target:o,resolve:r,reject:i,timeout:BCX_setTimeout((()=>{console.warn("BCX: Query timed out",o,e),pendingQueries.delete(a),i("Timed out")}),n)};pendingQueries.set(a,s),sendHiddenMessage("query",{id:a,query:e,data:t},o)}))}function notifyOfChange(){if(moduleInitPhase!==ModuleInitPhase.ready)return;sendHiddenMessage("somethingChanged",void 0);const e=getPlayerCharacter().MemberNumber;changeHandlers.forEach((t=>t(e)))}hiddenMessageHandlers.set("query",((e,t)=>{if(!isObject$1(t)||"string"!=typeof t.id||"string"!=typeof t.query)return void console.warn("BCX: Invalid query",e,t);const o=getChatroomCharacter(e);if(!o||!o.hasAccessToPlayer())return sendHiddenMessage("queryAnswer",{id:t.id,ok:!1});const n=queryHandlers[t.query];if(!n)return console.warn("BCX: Query no handler",e,t),sendHiddenMessage("queryAnswer",{id:t.id,ok:!1});n(o,((o,n)=>{sendHiddenMessage("queryAnswer",{id:t.id,ok:o,data:n},e)}),t.data)})),hiddenMessageHandlers.set("queryAnswer",((e,t)=>{if(!isObject$1(t)||"string"!=typeof t.id||"boolean"!=typeof t.ok)return void console.warn("BCX: Invalid queryAnswer",e,t);const o=pendingQueries.get(t.id);o?o.target==o.target?(clearTimeout(o.timeout),pendingQueries.delete(t.id),t.ok?o.resolve(t.data):o.reject(t.data)):console.warn("BCX: Response to query not from target",e,t,o):console.warn("BCX: Response to unknown query",e,t)})),hiddenMessageHandlers.set("somethingChanged",(e=>{changeHandlers.forEach((t=>t(e)))}));class ModuleMessaging extends BaseModule{load(){hookFunction("ChatRoomMessage",10,((e,t)=>{const o=e[0];if("Hidden"!==(null==o?void 0:o.Type)||"BCXMsg"!==o.Content||"number"!=typeof o.Sender)return t(e);{if(o.Sender===Player.MemberNumber||firstTimeInit)return;if(!isObject$1(o.Dictionary))return void console.warn("BCX: Hidden message no Dictionary",o);const{type:e,message:t}=o.Dictionary;if("string"==typeof e){const n=hiddenMessageHandlers.get(e);void 0===n?console.warn("BCX: Hidden message no handler",o.Sender,e,t):n(o.Sender,t)}}})),hookFunction("ServerAccountBeep",10,((e,t)=>{var o;const n=e[0];if("string"!=typeof(null==n?void 0:n.BeepType)||!["Leash","BCX"].includes(n.BeepType)||!isObject$1(null===(o=n.Message)||void 0===o?void 0:o.BCX))return t(e);{const{type:e,message:t}=n.Message.BCX;if("string"==typeof e){const o=hiddenBeepHandlers.get(e);void 0===o?console.warn("BCX: Hidden beep no handler",n.MemberNumber,e,t):o(n.MemberNumber,t)}}}))}unload(){hiddenBeepHandlers.clear(),hiddenMessageHandlers.clear()}}const PRESET_DISABLED_MODULES={[Preset.dominant]:[ModuleCategory.Log,ModuleCategory.Curses,ModuleCategory.Rules],[Preset.switch]:[],[Preset.submissive]:[],[Preset.slave]:[]};function getCurrentPreset(){var e;return null!==(e=modStorage.preset)&&void 0!==e?e:Preset.switch}function applyPreset(e){modStorage.preset=e,modules_applyPreset(e),setDisabledModules(PRESET_DISABLED_MODULES[e]),finalizeFirstTimeInit()}function setDisabledModules(e){return Array.isArray(modStorage.disabledModules)?(e=arrayUnique(e.filter((e=>TOGGLEABLE_MODULES.includes(e)))),!!CommonArraysEqual(e,modStorage.disabledModules)||(modStorage.disabledModules=e,!!reload_modules()&&(modStorageSync(),notifyOfChange(),!0))):(console.error("BCX: Attempt to set disabled modules before initializetion"),!1)}function getDisabledModules(){return Array.isArray(modStorage.disabledModules)?modStorage.disabledModules.slice():[]}function moduleIsEnabled(e){return!TOGGLEABLE_MODULES.includes(e)||(!Array.isArray(modStorage.disabledModules)||!modStorage.disabledModules.includes(e))}class ModulePresets extends BaseModule{init(){queryHandlers.disabledModules=(e,t)=>t(!0,getDisabledModules())}load(){"number"==typeof modStorage.preset&&void 0!==Preset[modStorage.preset]||(modStorage.preset=Preset.switch),Array.isArray(modStorage.disabledModules)?modStorage.disabledModules=modStorage.disabledModules.filter((e=>TOGGLEABLE_MODULES.includes(e))):modStorage.disabledModules=[]}run(){firstTimeInit&&BCX_setTimeout((()=>{firstTimeInit&&null===getCurrentSubscreen()&&InfoBeep("Please visit your profile to finish BCX setup",1/0)}),2e3)}}let moduleInitPhase=ModuleInitPhase.construct;const modules=[];function registerModule(e){if(moduleInitPhase!==ModuleInitPhase.construct)throw new Error("Modules can be registered only before initialization");return modules.push(e),e}function init_modules(){moduleInitPhase=ModuleInitPhase.init;for(const e of modules)e.init();moduleInitPhase=ModuleInitPhase.load;for(const e of modules)e.load(getCurrentPreset());moduleInitPhase=ModuleInitPhase.ready;for(const e of modules)e.run()}function unload_modules(){moduleInitPhase=ModuleInitPhase.destroy;for(const e of modules)e.unload()}function reload_modules(){if(moduleInitPhase!==ModuleInitPhase.ready)return console.error("BCX: Attempt to reload modules, while not ready"),!1;for(const e of modules)e.reload(getCurrentPreset());return!0}function modules_applyPreset(e){if(moduleInitPhase!==ModuleInitPhase.ready)return console.error("BCX: Attempt to apply preset to modules, while not ready"),!1;for(const t of modules)t.applyPreset(e);return!0}const MAX_STACK_SIZE=15;let firstError=!0,lastReceivedMessageType="",lastSentMessageType="",originalSocketEmit,originalClick;function debugGenerateReport(e=!0){let t="----- Debug report -----\n";t+=`Location: ${window.location.href.replace(/\d{4,}/g,"<numbers>")}\n`,t+=`UA: ${window.navigator.userAgent}\n`,t+=`BC Version: ${GameVersion}\n`,t+=`BCX Version: ${VERSION}\n`;const o=Object.entries(detectOtherMods()).filter((e=>e[1]));o.length>0?t+="Other detected mods:\n"+o.map((e=>`  - ${e[0]}`+("boolean"!=typeof e[1]?`: ${e[1]}`:"")+"\n")).join(""):t+="No other mods detected.\n",t+="\n----- BC state report -----\n",t+=`Mouse position: ${MouseX} ${MouseY}\n`,t+=`Connected to server: ${ServerIsConnected}\n`,t+=`Screen: ${CurrentModule}/${CurrentScreen}\n`,t+=`In chatroom: ${ServerPlayerIsInChatRoom()}\n`,t+=`GLVersion: ${GLVersion}\n`,t+=`Last received message: ${lastReceivedMessageType}\n`,t+=`Last sent message: ${lastSentMessageType}\n`,e&&(t+="\n----- BCX report -----\n",t+=`Init state: ${ModuleInitPhase[moduleInitPhase]}\n`,t+=`First init: ${firstTimeInit}\n`,t+=`Disabled modules: ${getDisabledModules().map((e=>ModuleCategory[e])).join(", ")||"[None]"}\n`,ConditionsGetCategoryEnabled("curses")&&(t+=`Curses: ${Object.keys(ConditionsGetCategoryData("curses").conditions).join(", ")||"[None]"}\n`),ConditionsGetCategoryEnabled("rules")&&(t+=`Rules: ${Object.keys(ConditionsGetCategoryData("rules").conditions).join(", ")||"[None]"}\n`));const n=getPatchedFunctionsHashes(!1);return n.length>0?(t+="\n----- Patching report -----\n",n.length>0&&(t+="Patched functions with unknown checksums:\n"+n.map((e=>`${e[0]}: ${e[1]}\n`)).join(""))):e&&(t+="\n----- Patching report -----\n",t+="No warnings.\n"),t}function cleanupErrorLocation(e){return e.replaceAll(window.location.href.substring(0,window.location.href.lastIndexOf("/")),"<url>").replace(/https:\/\/[^?/]+\/([^?]+)?bcx.js(?=$|\?|:)/,"<bcx>").replace(/\/\d{4,}\.html/,"/<numbers>.html").replace(/[?&]_=\d+(?=$|&|:)/,"")}function debugPrettifyError(e){if(e instanceof Error){let t=`${e.stack}`.split("\n");return t.length>MAX_STACK_SIZE&&(t=t.slice(0,MAX_STACK_SIZE).concat("    ...")),t.map(cleanupErrorLocation).join("\n")}return`${e}`}function debugGenerateReportErrorEvent(e){const t=contextInBCXArea();let o=`----- UNHANDLED ERROR (${t?"IN BCX":"OUTSIDE OF BCX"}) -----\nMessage: ${e.message}\nSource: ${cleanupErrorLocation(e.filename)}:${e.lineno}:${e.colno}\n`;return o+=debugPrettifyError(e.error)+"\n\n",o+=debugMakeContextReport(),o+="\n"+debugGenerateReport(t),o}function showErrorOverlay(e,t,o,n=!0){var r,i;console.info("Error overlay displayed\n",o),n&&(o="```\n"+o.trim()+"\n```");const a=document.createElement("div");a.style.position="fixed",a.style.top="0px",a.style.right="0px",a.style.bottom="0px",a.style.left="0px",a.style.background="#00000090";const s=document.createElement("div");a.appendChild(s),s.style.position="absolute",s.style.top="5%",s.style.right="5%",s.style.bottom="5%",s.style.left="5%",s.style.background="white",s.style.display="flex",s.style.flexDirection="column",s.style.padding="1em";const l=document.createElement("h1");s.appendChild(l),l.innerText=e;const c=document.createElement("p");s.appendChild(c),c.innerHTML=t;const u=document.createElement("button");s.appendChild(u),u.innerText="Copy report";const d=document.createElement("textarea");s.appendChild(d),d.readOnly=!0,d.value=o,d.style.flex="1",d.style.margin="0.5em 0",u.onclick=()=>{if(d.focus(),d.select(),navigator.clipboard)navigator.clipboard.writeText(d.value);else try{document.execCommand("copy")}catch(e){}};const m=document.createElement("button");s.appendChild(m),m.innerText="Close",m.onclick=()=>{a.remove()},null===(i=null===(r=document.activeElement)||void 0===r?void 0:r.blur)||void 0===i||i.call(r),window.document.body.appendChild(a)}function onUnhandledError(e){if(!firstError)return;firstError=!1;showErrorOverlay("Crash Handler (by BCX)","The Crash Handler provided by BCX detected an uncaught error, which most likely crashed the Bondage Club.<br />While reporting this error, please use the information below to help us find the source faster.<br />You can use the 'Close' button at the bottom to continue, however BC may no longer work correctly until you reload the current tab."+(contextInBCXArea()?"<p>Whoops... seems like BCX might be to blame this time. Could you please help us by submitting the report below to the <a href='https://discord.gg/SHJMjEh9VH' target='_blank'>BC Scripting Community Discord</a> server?<br />Thank you!</p>":"<br /><h3>The error seems NOT to come from BCX!</h3> Please submit the report to <a href='https://discord.gg/dkWsEjf' target='_blank'>Bondage Club's Discord</a> server instead!"),debugGenerateReportErrorEvent(e))}function bcxSocketEmit(...e){const t=Array.isArray(e[0])&&"string"==typeof e[0][0]?e[0][0]:"[unknown]";lastReceivedMessageType=t;const o=Array.isArray(e[0])?e[0].slice(1):[],n=debugContextStart(`Server message ${t}`,{root:!0,bcxArea:!1,extraInfo:()=>`Event: ${t}\n`+o.map((e=>JSON.stringify(e,void 0,"  "))).join("\n")}),r=null==originalSocketEmit?void 0:originalSocketEmit.apply(this,e);return n.end(),r}function bcxClick(e){const t=debugContextStart("Canvas click",{root:!0,bcxArea:!1,extraInfo:()=>`X: ${MouseX}\nY: ${MouseY}`}),o=null==originalClick?void 0:originalClick.call(this,e);return t.end(),o}function InitErrorReporter(){window.addEventListener("error",onUnhandledError),originalSocketEmit=ServerSocket.__proto__.emitEvent,"function"==typeof originalSocketEmit&&(ServerSocket.__proto__.emitEvent=bcxSocketEmit);const e=document.getElementById("MainCanvas");e&&"function"==typeof e.onclick&&(originalClick=e.onclick,e.onclick=bcxClick),hookFunction("ServerSend",0,((e,t)=>(lastSentMessageType=e[0],t(e))))}function UnloadErrorReporter(){window.removeEventListener("error",onUnhandledError),ServerSocket.__proto__.emitEvent===bcxSocketEmit&&(ServerSocket.__proto__.emitEvent=originalSocketEmit);const e=document.getElementById("MainCanvas");e&&originalClick&&(e.onclick=originalClick)}function loginInit(e){window.BCX_Loaded||init()}function clearCaches(){if("undefined"!=typeof DrawRunMap&&(DrawRunMap.clear(),DrawScreen=""),"undefined"!=typeof CurrentScreenFunctions){const e=window;CurrentScreenFunctions={Run:e[`${CurrentScreen}Run`],Click:e[`${CurrentScreen}Click`],Load:"function"==typeof e[`${CurrentScreen}Load`]?e[`${CurrentScreen}Load`]:void 0,Unload:"function"==typeof e[`${CurrentScreen}Unload`]?e[`${CurrentScreen}Unload`]:void 0,Resize:"function"==typeof e[`${CurrentScreen}Resize`]?e[`${CurrentScreen}Resize`]:void 0,KeyDown:"function"==typeof e[`${CurrentScreen}KeyDown`]?e[`${CurrentScreen}KeyDown`]:void 0,Exit:"function"==typeof e[`${CurrentScreen}Exit`]?e[`${CurrentScreen}Exit`]:void 0}}}function init(){const e=debugContextStart("BCX init",{bcxArea:!0});InitErrorReporter(),init_modules(),clearCaches();const{BondageClubTools:t}=detectOtherMods();if(t)if(console.warn("BCX: Bondage Club Tools detected!"),!0===window.BCX_BondageClubToolsPatch)console.info("BCX: Bondage Club Tools already patched, skip!");else{window.BCX_BondageClubToolsPatch=!0;const e=ServerSocket.listeners("ChatRoomMessage").find((e=>e.toString().includes("window.postMessage"))),t=ServerSocket.listeners("AccountBeep").find((e=>e.toString().includes("window.postMessage")));if(!e||!t)throw new Error("Failed to patch for Bondage Club Tools!");ServerSocket.off("ChatRoomMessage",e),ServerSocket.on("ChatRoomMessage",(t=>{"Hidden"===(null==t?void 0:t.Type)&&"BCXMsg"===t.Content&&"number"==typeof t.Sender||e(t)})),ServerSocket.off("AccountBeep",t),ServerSocket.on("AccountBeep",(e=>{var o;"string"==typeof(null==e?void 0:e.BeepType)&&["Leash","BCX"].includes(e.BeepType)&&isObject$1(null===(o=e.Message)||void 0===o?void 0:o.BCX)||t(e)}))}window.BCX_Loaded=!0,InfoBeep(`BCX loaded! Version: ${VERSION.replace(/-[0-f]+$/i,"")}`),console.log(`BCX loaded! Version: ${VERSION}`),e.end()}function unload(){return unload_patches(),unload_modules(),UnloadErrorReporter(),clearCaches(),delete window.BCX_Loaded,console.log("BCX: Unloaded."),!0}const ROOM_TEMPLATES_COUNT=4;let onSecondPage=!1,overwriteMode;function ChatSettingsExtraRun(){var e;DrawText("Back",169,110,"Black","Gray"),DrawButton(124,147,90,90,"","White","Icons/West.png"),DrawText("Templates for storing / overwriting the current room information and settings",1e3,650,"Black","Gray");for(let t=0;t<ROOM_TEMPLATES_COUNT;t++){const o=124+455*t,n=null===(e=modStorage.roomTemplates)||void 0===e?void 0:e[t];n&&DrawImageEx("Backgrounds/"+n.Background+".jpg",o,700,{Alpha:MouseIn(o,700,400,200)?.3:1,Width:400,Height:200}),MainCanvas.fillStyle="rgba(255, 255, 255, 0.5)",MainCanvas.fillRect(o,700,340,64),MainCanvas.beginPath(),MainCanvas.rect(o,700,340,64),MainCanvas.stroke(),DrawTextFit(n?""===n.Name?"- template without room name -":n.Name:"- empty template slot -",o+170,734,325,"Black","Gray"),DrawButton(o+340,700,60,64,"X",n?"rgba(255, 255, 255, 0.3)":"#ddd","","Delete template",!n),overwriteMode===t?(DrawButton(o,835,150,64,"",n?"rgba(255, 255, 255, 0.2)":"#ddd","",void 0,!n),DrawText("Load",o+51,867,"Black"),DrawButton(o+170,835,230,64,"Overwrite ?","rgba(255, 242, 0, 0.2)","")):(DrawButton(o,835,230,64,"",n?"rgba(255, 255, 255, 0.2)":"#ddd","",void 0,!n),DrawText("Load",o+51,867,"Black"),DrawButton(o+250,835,150,64,"    Save","rgba(255, 255, 255, 0.2)",""))}}function ChatSettingsExtraClick(e,t){var o;if(MouseIn(124,147,90,90))return overwriteMode=void 0,void(onSecondPage=!onSecondPage);for(let n=0;n<ROOM_TEMPLATES_COUNT;n++){const r=124+455*n;if(MouseIn(r+340,700,60,64)&&modStorage.roomTemplates)return modStorage.roomTemplates[n]=null,modStorageSync(),void(overwriteMode=void 0);if(overwriteMode===n&&MouseIn(r,835,150,64)||MouseIn(r,835,230,64)){const e=null===(o=modStorage.roomTemplates)||void 0===o?void 0:o[n];return void(e&&(t(e),overwriteMode=void 0,onSecondPage=!onSecondPage))}if(modStorage.roomTemplates&&(MouseIn(r+250,835,150,64)&&!modStorage.roomTemplates[n]||overwriteMode===n&&MouseIn(r+170,835,230,64)))return modStorage.roomTemplates[n]={Name:ElementValue("InputName")?ElementValue("InputName").trim():"",Description:ElementValue("InputDescription")?ElementValue("InputDescription").trim():"",Background:e?ChatCreateBackgroundSelect:ChatAdminBackgroundSelect,Private:e?ChatCreatePrivate||!1:ChatAdminPrivate,Locked:e?ChatCreateLocked||!1:ChatAdminLocked,Game:e?ChatCreateGame:ChatAdminGame,Admin:ElementValue("InputAdminList")?CommonConvertStringToArray(ElementValue("InputAdminList").trim()):[],Limit:ElementValue("InputSize")?ElementValue("InputSize").trim():"",BlockCategory:cloneDeep(e?ChatBlockItemCategory:ChatAdminBlockCategory)},modStorageSync(),void(overwriteMode=void 0);if(MouseIn(r+250,835,150,64))return void(overwriteMode=n)}}class ModuleChatroomAdmin extends BaseModule{load(){for(Array.isArray(modStorage.roomTemplates)||(modStorage.roomTemplates=[]),modStorage.roomTemplates.length>ROOM_TEMPLATES_COUNT&&(modStorage.roomTemplates=modStorage.roomTemplates.filter(Boolean).slice(0,ROOM_TEMPLATES_COUNT-1));modStorage.roomTemplates.length<ROOM_TEMPLATES_COUNT;)modStorage.roomTemplates.push(null);for(let e=0;e<modStorage.roomTemplates.length;e++)null===modStorage.roomTemplates[e]||isObject$1(modStorage.roomTemplates[e])||(console.warn(`BCX: Resetting invalid room template slot ${e}`,modStorage.roomTemplates[e]),modStorage.roomTemplates[e]=null);patchFunction("ChatCreateRun",{'DrawText(TextGet("RoomName"), 535, 110,':'DrawText(TextGet("RoomName"), 675, 110,'}),patchFunction("ChatCreateRun",{'ElementPosition("InputName", 535, 170, 820);':'ElementPosition("InputName", 610, 170, 680);'}),hookFunction("ChatCreateRun",0,((e,t)=>{if(onSecondPage)return ChatSettingsExtraRun();t(e),ChatCreateShowBackgroundMode||(DrawText("More",169,110,"Black","Gray"),DrawButton(124,147,90,90,"","White",icon_BCX),MouseIn(124,147,90,90)&&DrawButtonHover(34,70,64,64,"More room setup options"))})),hookFunction("ChatCreateClick",0,((e,t)=>onSecondPage?ChatSettingsExtraClick(!0,(e=>{const t=document.getElementById("InputName"),o=document.getElementById("InputDescription"),n=document.getElementById("InputAdminList"),r=document.getElementById("InputSize");t&&(t.value=e.Name),o&&(o.value=e.Description),ChatCreateBackgroundSelect=e.Background,ChatCreatePrivate=e.Private,ChatCreateLocked=e.Locked,ChatCreateGame=e.Game,n&&(n.value=e.Admin.toString()),r&&(r.value=e.Limit),ChatBlockItemCategory=e.BlockCategory})):MouseIn(124,147,90,90)?(onSecondPage=!onSecondPage,void ElementToggleGeneratedElements("ChatCreate",!1)):void t(e))),patchFunction("ChatAdminRun",{'DrawText(TextGet("RoomName"), 535, 110,':'DrawText(TextGet("RoomName"), 675, 110,'}),patchFunction("ChatAdminRun",{'ElementPosition("InputName", 535, 170, 820);':'ElementPosition("InputName", 610, 170, 680);'}),hookFunction("ChatAdminRun",0,((e,t)=>{if(onSecondPage)return ChatSettingsExtraRun();t(e),DrawText("More",169,110,"Black","Gray"),DrawButton(124,147,90,90,"","White",icon_BCX),MouseIn(124,147,90,90)&&DrawButtonHover(34,70,64,64,"More room setup options")})),hookFunction("ChatAdminClick",0,((e,t)=>onSecondPage?ChatSettingsExtraClick(!1,(e=>{const t=document.getElementById("InputName"),o=document.getElementById("InputDescription"),n=document.getElementById("InputAdminList"),r=document.getElementById("InputSize");t&&(t.value=e.Name),o&&(o.value=e.Description),ChatAdminBackgroundSelect=e.Background,ChatAdminPrivate=e.Private,ChatAdminLocked=e.Locked,ChatAdminGame=e.Game,n&&(n.value=e.Admin.toString()),r&&(r.value=e.Limit),ChatAdminBlockCategory=e.BlockCategory})):MouseIn(124,147,90,90)?(onSecondPage=!onSecondPage,void ElementToggleGeneratedElements("ChatAdmin",!1)):void t(e)))}}var backgroundList=["AbandonedBuilding","AbandonedSideRoom","AlchemistOffice","AmandaCollarIntro","AmandaIntro","AncientRuins","AsylumBedroom","AsylumEntrance","AsylumMeeting","AsylumTherapy","BDSMRoomBlue","BDSMRoomPurple","BDSMRoomRed","BackAlley","BalconyNight","Bar","BarRestaurant","Beach","BeachCafe","BeachHotel","Bedroom","BondageBedChamber","Boudoir","BoutiqueBack","BoutiqueMain","BrickWall","CaptainCabin","Castle","Cell","Cellar","CeremonialVenue","ChillRoom","CollegeCafeteria","CollegeClass","CollegeDetention","CollegeEntrance","CollegeTeacherLounge","CollegeTennis","CollegeTennisPlay","CollegeTheater","Confessions","CosyChalet","CozyLivingRoom","CreepyBasement","DeepForest","Desert","DesolateVillage","DiningRoom","Dressing","Dungeon","DungeonRuin","DystopianCity","EgyptianExhibit","EgyptianTomb","EmptyWarehouse","ForestCave","ForestPath","Gambling","Gardens","HeavenEntrance","HellEntrance","HorseStable","HorseStableLight","HotelBedroom","HypnoSpiral2","HypnoticSpiral","IndoorPool","Industrial","Infiltration","Introduction","JungleTemple","Kennels","KidnapLeague","Kitchen","LatexRoom","LeatherChamber","LingerieShop","LockerRoom","LostVages","Magic","MagicSchoolEscape","MagicSchoolLaboratory","MaidCafe","MaidQuarters","MainHall","Management","MedinaMarket","MiddletownSchool","MovieStudio","NightClub","Nursery","Office1","Office2","OldFarm","Onsen","Orig/Dressing","Orig/Entrance","Orig/KidnapLeague","Orig/Lounge","Orig/MaidQuarters","Orig/MainHall","Orig/Shibari","Orig/Shop","Orig/buhne-dekorativ-kino-276179","OutdoorPool","OutdoorPool2","OutsideCells","PaddedCell","PaddedCell2","Pandora/Ground/Entrance","Pandora/Second/Cell0","Pandora/Second/Cell1","Pandora/Second/Cell2","Pandora/Second/Cell3","Pandora/Second/Cell4","Pandora/Second/Cell5","Pandora/Second/Cell6","Pandora/Second/Entrance","Pandora/Second/Fork0","Pandora/Second/Fork1","Pandora/Second/Fork2","Pandora/Second/Fork3","Pandora/Second/Fork4","Pandora/Second/Fork5","Pandora/Second/Fork6","Pandora/Second/Rest0","Pandora/Second/Tunnel0","Pandora/Second/Tunnel1","Pandora/Second/Tunnel2","Pandora/Second/Tunnel3","Pandora/Second/Tunnel4","Pandora/Second/Tunnel5","Pandora/Second/Tunnel6","Pandora/Underground/Cell0","Pandora/Underground/Cell1","Pandora/Underground/Cell2","Pandora/Underground/Cell3","Pandora/Underground/Cell4","Pandora/Underground/Cell5","Pandora/Underground/Cell6","Pandora/Underground/Entrance","Pandora/Underground/Fork0","Pandora/Underground/Fork1","Pandora/Underground/Fork2","Pandora/Underground/Fork3","Pandora/Underground/Fork4","Pandora/Underground/Fork5","Pandora/Underground/Fork6","Pandora/Underground/Rest0","Pandora/Underground/Tunnel0","Pandora/Underground/Tunnel1","Pandora/Underground/Tunnel2","Pandora/Underground/Tunnel3","Pandora/Underground/Tunnel4","Pandora/Underground/Tunnel5","Pandora/Underground/Tunnel6","ParkDay","ParkNight","ParkWinter","PartyBasement","PirateIsland","PirateIslandNight","PoolBottom","Prison","PrisonHall","Private","PublicBath","RainyForestPathDay","RainyForstPathNight","RainyStreetDay","RainyStreetNight","Ranch","ResearchPrep","ResearchProgress","RhythmGame","RhythmGameLoading","RooftopParty","RustySaloon","SarahBedroom0","SarahBedroom1","SarahBedroom2","SarahBedroom3","SarahCollarIntro","SarahIntro","SchoolHallway","SchoolHospital","SchoolRuins","SciFiCell","SciFiOutdoors","SciFiRed","SecretChamber","Sheet","SheetWhite","SheikhPrivate","SheikhTent","Shibari","ShipDeck","Shipwreck","Shop","SlaveMarket","SlipperyClassroom","SlumApartment","SlumCellar","SlumRuins","SnowyChaletDay","SnowyChaletNight","SnowyDeepForest","SnowyForestPathDay","SnowyForestPathNight","SnowyLakeNight","SnowyStreet","SnowyStreetDay1","SnowyStreetDay2","SnowyStreetNight2","SnowyTown1","SnowyTown2","SophieIntro","SpaceCaptainBedroom","SpookyForest","StreetNight","SunTemple","SynthWave","ThroneRoom","TiledBathroom","UnderwaterOne","VaultCorridor","Wagons","WeddingArch","WeddingBeach","WeddingRoom","WesternStreet","White","WitchWood","WoodenCabin","WrestlingRing","XmasDay","XmasEve","Yacht1","Yacht2","Yacht3","grey"],COMPARE_PARTIAL_FLAG$1=1,COMPARE_UNORDERED_FLAG$1=2;function baseIsMatch(e,t,o,n){var r=o.length,i=r,a=!n;if(null==e)return!i;for(e=Object(e);r--;){var s=o[r];if(a&&s[2]?s[1]!==e[s[0]]:!(s[0]in e))return!1}for(;++r<i;){var l=(s=o[r])[0],c=e[l],u=s[1];if(a&&s[2]){if(void 0===c&&!(l in e))return!1}else{var d=new Stack;if(n)var m=n(c,u,l,e,t,d);if(!(void 0===m?baseIsEqual(u,c,COMPARE_PARTIAL_FLAG$1|COMPARE_UNORDERED_FLAG$1,n,d):m))return!1}}return!0}function isStrictComparable(e){return e==e&&!isObject(e)}function getMatchData(e){for(var t=keys(e),o=t.length;o--;){var n=t[o],r=e[n];t[o]=[n,r,isStrictComparable(r)]}return t}function matchesStrictComparable(e,t){return function(o){return null!=o&&(o[e]===t&&(void 0!==t||e in Object(o)))}}function baseMatches(e){var t=getMatchData(e);return 1==t.length&&t[0][2]?matchesStrictComparable(t[0][0],t[0][1]):function(o){return o===e||baseIsMatch(o,e,t)}}var symbolTag="[object Symbol]";function isSymbol(e){return"symbol"==typeof e||isObjectLike(e)&&baseGetTag(e)==symbolTag}var reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/;function isKey(e,t){if(isArray(e))return!1;var o=typeof e;return!("number"!=o&&"symbol"!=o&&"boolean"!=o&&null!=e&&!isSymbol(e))||(reIsPlainProp.test(e)||!reIsDeepProp.test(e)||null!=t&&e in Object(t))}var FUNC_ERROR_TEXT="Expected a function";function memoize(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError(FUNC_ERROR_TEXT);var o=function(){var n=arguments,r=t?t.apply(this,n):n[0],i=o.cache;if(i.has(r))return i.get(r);var a=e.apply(this,n);return o.cache=i.set(r,a)||i,a};return o.cache=new(memoize.Cache||MapCache),o}memoize.Cache=MapCache;var MAX_MEMOIZE_SIZE=500;function memoizeCapped(e){var t=memoize(e,(function(e){return o.size===MAX_MEMOIZE_SIZE&&o.clear(),e})),o=t.cache;return t}var rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,reEscapeChar=/\\(\\)?/g,stringToPath=memoizeCapped((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(rePropName,(function(e,o,n,r){t.push(n?r.replace(reEscapeChar,"$1"):o||e)})),t}));function arrayMap(e,t){for(var o=-1,n=null==e?0:e.length,r=Array(n);++o<n;)r[o]=t(e[o],o,e);return r}var INFINITY$1=1/0,symbolProto=Symbol?Symbol.prototype:void 0,symbolToString=symbolProto?symbolProto.toString:void 0;function baseToString(e){if("string"==typeof e)return e;if(isArray(e))return arrayMap(e,baseToString)+"";if(isSymbol(e))return symbolToString?symbolToString.call(e):"";var t=e+"";return"0"==t&&1/e==-INFINITY$1?"-0":t}function toString(e){return null==e?"":baseToString(e)}function castPath(e,t){return isArray(e)?e:isKey(e,t)?[e]:stringToPath(toString(e))}var INFINITY=1/0;function toKey(e){if("string"==typeof e||isSymbol(e))return e;var t=e+"";return"0"==t&&1/e==-INFINITY?"-0":t}function baseGet(e,t){for(var o=0,n=(t=castPath(t,e)).length;null!=e&&o<n;)e=e[toKey(t[o++])];return o&&o==n?e:void 0}function get(e,t,o){var n=null==e?void 0:baseGet(e,t);return void 0===n?o:n}function baseHasIn(e,t){return null!=e&&t in Object(e)}function hasPath(e,t,o){for(var n=-1,r=(t=castPath(t,e)).length,i=!1;++n<r;){var a=toKey(t[n]);if(!(i=null!=e&&o(e,a)))break;e=e[a]}return i||++n!=r?i:!!(r=null==e?0:e.length)&&isLength(r)&&isIndex(a,r)&&(isArray(e)||isArguments(e))}function hasIn(e,t){return null!=e&&hasPath(e,t,baseHasIn)}var COMPARE_PARTIAL_FLAG=1,COMPARE_UNORDERED_FLAG=2;function baseMatchesProperty(e,t){return isKey(e)&&isStrictComparable(t)?matchesStrictComparable(toKey(e),t):function(o){var n=get(o,e);return void 0===n&&n===t?hasIn(o,e):baseIsEqual(t,n,COMPARE_PARTIAL_FLAG|COMPARE_UNORDERED_FLAG)}}function identity(e){return e}function baseProperty(e){return function(t){return null==t?void 0:t[e]}}function basePropertyDeep(e){return function(t){return baseGet(t,e)}}function property(e){return isKey(e)?baseProperty(toKey(e)):basePropertyDeep(e)}function baseIteratee(e){return"function"==typeof e?e:null==e?identity:"object"==typeof e?isArray(e)?baseMatchesProperty(e[0],e[1]):baseMatches(e):property(e)}function last(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}function baseSlice(e,t,o){var n=-1,r=e.length;t<0&&(t=-t>r?0:r+t),(o=o>r?r:o)<0&&(o+=r),r=t>o?0:o-t>>>0,t>>>=0;for(var i=Array(r);++n<r;)i[n]=e[n+t];return i}function parent(e,t){return t.length<2?e:baseGet(e,baseSlice(t,0,-1))}function baseUnset(e,t){return null==(e=parent(e,t=castPath(t,e)))||delete e[toKey(last(t))]}var arrayProto=Array.prototype,splice=arrayProto.splice;function basePullAt(e,t){for(var o=e?t.length:0,n=o-1;o--;){var r=t[o];if(o==n||r!==i){var i=r;isIndex(r)?splice.call(e,r,1):baseUnset(e,r)}}return e}function remove(e,t){var o=[];if(!e||!e.length)return o;var n=-1,r=[],i=e.length;for(t=baseIteratee(t,3);++n<i;){var a=e[n];t(a,n,e)&&(o.push(a),r.push(n))}return basePullAt(e,r),o}const BACKGROUNDS_BCX_NAME="[BCX] Hidden";function InvisibilityEarbuds(){var e;if("BluetoothEarbuds"===(null===(e=InventoryGet(Player,"ItemEars"))||void 0===e?void 0:e.Asset.Name))InventoryRemove(Player,"ItemEars");else{const e=Asset.find((e=>"BluetoothEarbuds"===e.Name));if(!e)return;Player.Appearance=Player.Appearance.filter((e=>"ItemEars"!==e.Asset.Group.Name)),Player.Appearance.push({Asset:e,Color:"Default",Difficulty:-100,Property:{Type:"Light",Effect:[],Hide:AssetGroup.map((e=>e.Name)).filter((e=>"ItemEars"!==e))}}),CharacterRefresh(Player)}ChatRoomCharacterUpdate(Player)}let antiblind=!1;function toggleAntiblind(){if(!antiblind){const e=RulesGetRuleState("block_antiblind");if(e.isEnforced)return e.triggerAttempt(),!1;e.inEffect&&e.trigger()}return antiblind=!antiblind,!0}class ModuleClubUtils extends BaseModule{load(){registerCommand("antiblind","- Toggles ability to always see despite items",(()=>!!toggleAntiblind()&&(ChatRoomSendLocal("Antiblind switched "+(antiblind?"on":"off")),!0))),hookFunction("Player.GetBlindLevel",9,((e,t)=>antiblind?0:t(e))),registerCommand("background","<name> - Changes chat room background",(e=>{if(""===e.trim())return ChatRoomSendLocal('Try pressing the "tab"-key to show autocomplete options'),!1;const t=backgroundList.find((t=>t.toLocaleLowerCase()===e.toLocaleLowerCase()));return t?(updateChatroom({Background:t})||ChatRoomSendLocal("Failed to update room. Are you admin?"),!0):(ChatRoomSendLocal("Invalid/unknown background"),!1)}),(e=>Command_pickAutocomplete(e,backgroundList))),BackgroundsTagList.includes(BACKGROUNDS_BCX_NAME)||BackgroundsTagList.push(BACKGROUNDS_BCX_NAME);for(const e of backgroundList)BackgroundsList.some((t=>t.Name===e))||(BackgroundsList.push({Name:e,Tag:[BACKGROUNDS_BCX_NAME]}),OverridePlayerDialog(e,`[Hidden] ${e}`));hookFunction("BackgroundSelectionRun",0,((e,t)=>{BackgroundSelectionOffset>=BackgroundSelectionView.length&&(BackgroundSelectionOffset=0),t(e)})),registerCommandParsed("colour","<source> <item> <target> - Copies color of certain item from source character to target character",(e=>{if(3!==e.length)return ChatRoomSendLocal("Expected three arguments: <source> <item> <target>"),!1;const t=Command_selectCharacter(e[0]);if("string"==typeof t)return ChatRoomSendLocal(t),!1;const o=Command_selectCharacter(e[2]);if("string"==typeof o)return ChatRoomSendLocal(o),!1;const n=Command_selectWornItem(t,e[1]);if("string"==typeof n)return ChatRoomSendLocal(n),!1;const r=o.Character.Appearance.find((e=>e.Asset===n.Asset));return r?(r.Color=Array.isArray(n.Color)?n.Color.slice():n.Color,CharacterRefresh(o.Character),ChatRoomCharacterUpdate(o.Character),!0):(ChatRoomSendLocal("Target must be wearing the same item"),!1)}),(e=>{if(1===e.length)return Command_selectCharacterAutocomplete(e[0]);if(2===e.length){const t=Command_selectCharacter(e[0]);if("string"!=typeof t)return Command_selectWornItemAutocomplete(t,e[1])}else if(3===e.length)return Command_selectCharacterAutocomplete(e[2]);return[]})),registerCommandParsed("allowactivities","<character> <item> - Modifies item to not block activities",(e=>{if(2!==e.length)return ChatRoomSendLocal("Expected two arguments: <charcater> <item>"),!1;const t=Command_selectCharacter(e[0]);if("string"==typeof t)return ChatRoomSendLocal(t),!1;const o=Command_selectWornItem(t,e[1]);return"string"==typeof o?(ChatRoomSendLocal(o),!1):(o.Property||(o.Property={}),o.Property.AllowActivityOn=AssetGroup.map((e=>e.Name)),CharacterRefresh(t.Character),ChatRoomCharacterUpdate(t.Character),!0)}),(e=>{if(1===e.length)return Command_selectCharacterAutocomplete(e[0]);if(2===e.length){const t=Command_selectCharacter(e[0]);if("string"!=typeof t)return Command_selectWornItemAutocomplete(t,e[1])}return[]}))}run(){null!=ChatCreateBackgroundList&&(ChatCreateBackgroundList=BackgroundsGenerateList(BackgroundSelectionTagList))}unload(){remove(BackgroundsTagList,(e=>e===BACKGROUNDS_BCX_NAME)),remove(BackgroundsList,(e=>e.Tag.includes(BACKGROUNDS_BCX_NAME))),null!=ChatCreateBackgroundList&&(ChatCreateBackgroundList=BackgroundsGenerateList(BackgroundSelectionTagList))}}function j_WardrobeExportSelectionClothes(e=!1){if(!CharacterAppearanceSelection)return"";const t=CharacterAppearanceSelection.Appearance.filter((t=>isCloth(t,!0)||e&&isBind(t))).map(WardrobeAssetBundle);return LZString.compressToBase64(JSON.stringify(t))}function j_WardrobeImportSelectionClothes(e,t,o=!1){var n,r;if("string"!=typeof e||e.length<1)return"Import error: No data";try{if("["!==e[0]){const t=LZString.decompressFromBase64(e);if(!t)return"Import error: Bad data";e=t}if(e=JSON.parse(e),!Array.isArray(e))return"Import error: Bad data"}catch(e){return console.warn(e),"Import error: Bad data"}const i=CharacterAppearanceSelection;if(!i)return"Import error: No character";const a=e=>isCloth(e,0===CharacterAppearanceSelection.ID)||t&&isBind(e);if(t&&!o&&i.Appearance.some((e=>{var t,o;return isBind(e)&&(null===(o=null===(t=e.Property)||void 0===t?void 0:t.Effect)||void 0===o?void 0:o.includes("Lock"))}))){const t=new Set,o=e=>{var n;if(isBind(e))for(const r of(e.Asset.Block||[]).concat(Array.isArray(null===(n=e.Property)||void 0===n?void 0:n.Block)?e.Property.Block:[])){if(t.has(r)||!AssetGroup.some((e=>e.Name===r)))continue;t.add(r);const e=i.Appearance.find((e=>e.Asset.Group.Name===r));e&&o(e)}};for(const e of i.Appearance)(null===(r=null===(n=e.Property)||void 0===n?void 0:n.Effect)||void 0===r?void 0:r.includes("Lock"))&&!t.has(e.Asset.Group.Name)&&(t.add(e.Asset.Group.Name),o(e));let s=!0;for(const o of t){const t=i.Appearance.find((e=>e.Asset.Group.Name===o)),n=e.find((e=>e.Group===o));if(t){if(a(t)&&(!n||t.Asset.Name!==n.Name||!itemColorsEquals(t.Color,n.Color)||!isEqual(t.Property,n.Property))){s=!1;break}}else if(n){s=!1;break}}if(!s)return"Refusing to change locked item!"}let s=t;const l=new Set;if(t)for(const t of arrayUnique(i.Appearance.filter(a).map((e=>e.Asset.Group.Name)).concat(e.map((e=>e.Group))))){const o=i.Appearance.find((e=>e.Asset.Group.Name===t)),n=e.find((e=>e.Group===t));if(!(o&&n&&o.Asset.Name===n.Name&&itemColorsEquals(o.Color,n.Color)&&isEqual(curseMakeSavedProperty(o.Property),curseMakeSavedProperty(n.Property)))){s=!1;break}l.add(t)}if(s)for(const t of e){const e=InventoryGet(i,t.Group);t.Property&&e&&(e.Property=cloneDeep(t.Property))}else{i.Appearance=i.Appearance.filter((e=>!a(e)||l.has(e.Asset.Group.Name)));for(const t of e){if(i.Appearance.some((e=>e.Asset.Group.Name===t.Group)))continue;const e=Asset.find((e=>e.Group.Name===t.Group&&e.Name===t.Name&&a(e)));if(null!=e){CharacterAppearanceSetItem(i,t.Group,e,t.Color,0,void 0,!1);const o=InventoryGet(i,t.Group);t.Property&&o&&(o.Property=cloneDeep(curseMakeSavedProperty(t.Property)))}else console.warn("Clothing not found: ",t)}}return CharacterRefresh(i),!s&&t&&e.some((e=>{var t,o;return Array.isArray(null===(t=e.Property)||void 0===t?void 0:t.Effect)&&(null===(o=e.Property)||void 0===o?void 0:o.Effect.includes("Lock"))}))?"Imported! Repeat to also import locks.":"Imported!"}let j_WardrobeIncludeBinds=!1,j_ShowHelp=!1;const helpText="BCX's wardrobe export/import works by converting your current appearance into a long code word that is copied to your device's clipboard. You can then paste it anywhere you like, for instance a text file with all your outfits. At any time, you can wear the look again by copying the outfit code word to the clipboard and importing it with the according button. Functionality of this feature depends on the device you are using and if the clipboard can be used on it. The button to the left of the 'Export'-button toggles whether items/restraints on your character should also be exported/imported. Importing with items has two stages: First usage adds no locks, second one also imports locks from the exported items. That said, importing an outfit with restraints will fail if it would change any item that is locked (or blocked by a locked item), except collars, neck accessories and neck restraints. Those, as well as the body itself, are ignored.";function PasteListener(e){if("Appearance"===CurrentScreen&&"Wardrobe"===CharacterAppearanceMode){e.preventDefault(),e.stopImmediatePropagation();const t=(e.clipboardData||window.clipboardData).getData("text");CharacterAppearanceWardrobeText=j_WardrobeImportSelectionClothes(t,j_WardrobeIncludeBinds,allowMode)}}let searchBar$1=null;function enterSearchMode$1(e){searchBar$1||(searchBar$1=ElementCreateInput("BCXSearch","text","","40"),searchBar$1.oninput=()=>{DialogInventoryBuild(e),AppearanceMenuBuild(e)},searchBar$1.focus(),DialogInventoryBuild(e),AppearanceMenuBuild(e))}function exitSearchMode$1(e){searchBar$1&&(searchBar$1.remove(),searchBar$1=null,DialogInventoryBuild(e),AppearanceMenuBuild(e))}class ModuleWardrobe extends BaseModule{load(){const e=isNModClient()&&"undefined"!=typeof AppearanceMode;hookFunction("AppearanceRun",0,((t,o)=>{if(o(t),("Wardrobe"===CharacterAppearanceMode||e&&"Wardrobe"===AppearanceMode)&&clipboardAvailable){const t=e?265:125;DrawButton(1380,t,50,50,"","White","","How does it work?"),DrawImageEx("Icons/Question.png",1383,t+3,{Width:44,Height:44}),DrawButton(1457,t,50,50,"","White","","Include items/restraints"),DrawImageEx("../Icons/Bondage.png",1463,t+6,{Alpha:j_WardrobeIncludeBinds?1:.2,Width:38,Height:38}),DrawButton(1534,t,207,50,"Export","White",""),DrawButton(1768,t,207,50,"Import","White","")}j_ShowHelp&&("Wardrobe"===CharacterAppearanceMode||e&&"Wardrobe"===AppearanceMode)&&(MainCanvas.fillStyle="#ffff88",MainCanvas.fillRect(30,190,1240,780),MainCanvas.strokeStyle="Black",MainCanvas.strokeRect(30,190,1240,780),MainCanvas.textAlign="left",DrawTextWrap(helpText,-550,210,1200,740,"black"),MainCanvas.textAlign="center")})),hookFunction("AppearanceClick",0,((t,o)=>{if(("Wardrobe"===CharacterAppearanceMode||e&&"Wardrobe"===AppearanceMode)&&clipboardAvailable){const t=e?265:125;if((MouseIn(1380,t,50,50)||MouseIn(30,190,1240,780)&&j_ShowHelp)&&(j_ShowHelp=!j_ShowHelp),MouseIn(1457,t,50,50)&&(j_WardrobeIncludeBinds=!j_WardrobeIncludeBinds),MouseIn(1534,t,207,50))return void BCX_setTimeout((async()=>{await navigator.clipboard.writeText(j_WardrobeExportSelectionClothes(j_WardrobeIncludeBinds)),CharacterAppearanceWardrobeText="Copied to clipboard!"}),0);if(MouseIn(1768,t,207,50))return void BCX_setTimeout((async()=>{if("function"!=typeof navigator.clipboard.readText)return void(CharacterAppearanceWardrobeText="Please press Ctrl+V");const e=await navigator.clipboard.readText();CharacterAppearanceWardrobeText=j_WardrobeImportSelectionClothes(e,j_WardrobeIncludeBinds,allowMode)}),0)}o(t)})),document.addEventListener("paste",PasteListener),RedirectGetImage("Icons/BCX_Search.png","Icons/Search.png"),RedirectGetImage("Icons/BCX_SearchExit.png","Icons/Remove.png"),hookFunction("TextGet",0,((e,t)=>"BCX_Search"===e[0]?"Filter items":"BCX_SearchExit"===e[0]?"":t(e))),hookFunction("AppearanceMenuBuild",5,((e,t)=>{t(e);const o=e[0];"Cloth"!==CharacterAppearanceMode?exitSearchMode$1(o):searchBar$1?(AppearanceMenu=[],DialogInventory.length>9&&AppearanceMenu.push("Next"),AppearanceMenu.push("BCX_SearchExit"),DialogItemPermissionMode||AppearanceMenu.push("Cancel"),AppearanceMenu.push("Accept")):AppearanceMenu.splice(AppearanceMenu.length-(AppearanceMenu.includes("Cancel")?2:1),0,"BCX_Search")})),hookFunction("AppearanceMenuClick",4,((e,t)=>{const o=2e3-117*AppearanceMenu.length,n=e[0];for(let e=0;e<AppearanceMenu.length;e++)if(MouseXIn(o+117*e,90)){const t=AppearanceMenu[e];if("BCX_Search"===t)return void enterSearchMode$1(n);if("BCX_SearchExit"===t)return void exitSearchMode$1(n)}t(e)})),hookFunction("DialogInventoryAdd",5,((e,t)=>{if(searchBar$1){const t=e[1];if(!searchBar$1.value.trim().toLocaleLowerCase().split(" ").every((e=>t.Asset.Description.toLocaleLowerCase().includes(e)||t.Asset.Name.toLocaleLowerCase().includes(e))))return}t(e)})),hookFunction("AppearanceMenuDraw",0,((e,t)=>{searchBar$1&&ElementPositionFix("BCXSearch",40,900,35,600,60),t(e)}))}unload(){document.removeEventListener("paste",PasteListener),exitSearchMode$1(null!==CharacterAppearanceSelection&&void 0!==CharacterAppearanceSelection?CharacterAppearanceSelection:Player),AppearanceMenuBuild(null!==CharacterAppearanceSelection&&void 0!==CharacterAppearanceSelection?CharacterAppearanceSelection:Player)}}class ConsoleInterface{get version(){return VERSION}getCharacterVersion(e){if(void 0!==e&&"number"!=typeof e)return null;const t=void 0===e?getPlayerCharacter():getChatroomCharacter(e);return t?t.BCXVersion:null}get isAllow(){return allowMode}AllowCheats(e){return("boolean"==typeof e||void 0===e)&&(allowMode===e||(void 0===e&&(e=!allowMode),setAllowMode(e)))}get isDevel(){return developmentMode}Devel(e){return("boolean"==typeof e||void 0===e)&&(developmentMode===e||(void 0===e&&(e=!developmentMode),setDevelopmentMode(e)))}j_WardrobeExportSelectionClothes(e=!1){return j_WardrobeExportSelectionClothes(e)}j_WardrobeImportSelectionClothes(e,t,o=!1){return j_WardrobeImportSelectionClothes(e,t,o)}ToggleInvisibilityEarbuds(){return InvisibilityEarbuds()}Unload(){return unload()}get storage(){return developmentMode?modStorage:"Development mode required"}devGetCharacter(e){return!(!developmentMode||void 0!==e&&"number"!=typeof e)&&(void 0===e?getPlayerCharacter():getChatroomCharacter(e))}devSendQuery(e,t,o){return!(!developmentMode||"number"!=typeof e||"string"!=typeof t)&&(sendQuery(t,o,e).then((o=>{console.info(`Query ${t} to ${e} resolved:`,o)}),(o=>{console.warn(`Query ${t} to ${e} failed:`,o)})),!0)}switchStorageLocation(e){return"number"==typeof e&&(switchStorageLocation(e),!0)}showDebugReport(){showErrorOverlay("BCX Debug Report","This is manually created debug report.\nYou can use the 'Close' button at the bottom to close this overlay.",debugGenerateReport())}}const consoleInterface=Object.freeze(new ConsoleInterface);class ModuleConsole extends BaseModule{load(){window.bcx=consoleInterface;patchFunction("ChatRoomMessage",isNModClient()?{"A.DynamicDescription(Source).toLowerCase()":"( bcx.isDevel ? A.Description : A.DynamicDescription(Source).toLowerCase() )","G.Description.toLowerCase()":"( bcx.isDevel ? G.Description : G.Description.toLowerCase() )"}:{"Asset[A].DynamicDescription(SourceCharacter || Player).toLowerCase()":"( bcx.isDevel ? Asset[A].Description : Asset[A].DynamicDescription(SourceCharacter || Player).toLowerCase() )","G.Description.toLowerCase()":"( bcx.isDevel ? G.Description : G.Description.toLowerCase() )"}),patchFunction("ExtendedItemDraw",{"DialogFindPlayer(DialogPrefix + Option.Name)":"( bcx.isDevel ? JSON.stringify(Option.Property.Type) : DialogFindPlayer(DialogPrefix + Option.Name) )"}),hookFunction("DialogDrawItemMenu",0,((e,t)=>{var o;return developmentMode&&(DialogTextDefault=(null===(o=e[0].FocusGroup)||void 0===o?void 0:o.Description)||""),t(e)})),patchFunction("DialogDrawPoseMenu",{'"Icons/Poses/" + PoseGroup[P].Name + ".png"':'"Icons/Poses/" + PoseGroup[P].Name + ".png", ( bcx.isDevel ? PoseGroup[P].Name : undefined )'}),hookFunction("DialogDrawExpressionMenu",0,((e,t)=>{if(t(e),developmentMode)for(let e=0;e<DialogFacialExpressions.length;e++){const t=DialogFacialExpressions[e];if(MouseIn(20,185+100*e,90,90)&&DrawText(JSON.stringify(t.Group),300,950,"White"),e===DialogFacialExpressionsSelected)for(let e=0;e<t.ExpressionList.length;e++){const o=155+e%3*100,n=185+100*Math.floor(e/3);MouseIn(o,n,90,90)&&DrawText(JSON.stringify(t.ExpressionList[e]),300,950,"White")}}})),DialogSelfMenuOptions.forEach((e=>{"Pose"===e.Name?(e.IsAvailable=()=>!0,e.Draw=function(){return DialogDrawPoseMenu()}):"Expression"===e.Name&&(e.Draw=function(){return DialogDrawExpressionMenu()})}))}run(){window.BCX_Devel&&setDevelopmentMode(!0)}unload(){delete window.bcx}}function customIsEnabled(e){var t,o;return!!(null===(o=null===(t=Player.OnlineSettings)||void 0===t?void 0:t.BCX_Custom)||void 0===o?void 0:o.includes(e))}class ModuleCustom extends BaseModule{load(){const e={};customIsEnabled("c")&&(e.ctoggle=[()=>{const e=InventoryGet(Player,"ItemVulva"),t=AssetGet(Player.AssetFamily,"ItemVulva","DoubleEndDildo");!e&&t?(CharacterAppearanceSetItem(Player,"ItemVulva",t,"#A7806F"),ChatRoomCharacterUpdate(Player)):e&&e.Asset===t&&(InventoryRemove(Player,"ItemVulva"),ChatRoomCharacterUpdate(Player))},null],e.ccage=[e=>{var t;const o=Command_selectCharacter(null!==(t=e[1])&&void 0!==t?t:"");if("string"==typeof o)return void ChatRoomSendLocal(o,1e4);const n=InventoryGet(o.Character,"ItemVulva"),r=AssetGet(o.Character.AssetFamily,"ItemVulva","DoubleEndDildo"),i=AssetGet(o.Character.AssetFamily,"ItemVulva","FuturisticVibrator");n&&n.Asset===r&&"#A7806F"===n.Color&&i?(InventoryRemove(Player,"ItemVulva"),o.Character.Appearance.push({Asset:i,Difficulty:20,Color:["#A7806F","Default","Default"],Property:{Mode:"Off",Intensity:-1,Effect:["Egged"],TriggerValues:",".repeat(7)+"",AccessMode:"LockMember"}}),CharacterRefresh(o.Character,!1),ChatRoomCharacterUpdate(o.Character)):n&&n.Asset===i&&isEqual(n.Color,["#A7806F","Default","Default"])&&r&&(CharacterAppearanceSetItem(Player,"ItemVulva",r,"#A7806F"),ChatRoomCharacterUpdate(Player))},e=>2===e.length?Command_selectCharacterAutocomplete(e[1]):[]]),Object.keys(e).length>0&&registerCommandParsed("custom","",(t=>{var o;const n=e[null!==(o=t[0])&&void 0!==o?o:""];return!!n&&(n[0](t),!0)}),(t=>{var o,n,r,i;return 1===t.length?Command_pickAutocomplete(t[0],Object.keys(e)):null!==(i=null===(r=null===(n=e[null!==(o=t[0])&&void 0!==o?o:""])||void 0===n?void 0:n[1])||void 0===r?void 0:r.call(n,t))&&void 0!==i?i:[]}))}}let searchBar=null,searchBarAutoCloase=!1,struggleCooldown=0;const STRUGGLE_COOLDOWN_TIME=2e3;function allowSearchMode(){return null==DialogColor&&StruggleProgress<0&&!StruggleLockPickOrder&&null==DialogFocusItem&&!DialogActivityMode&&null==DialogItemToLock}function enterSearchMode(e){searchBar||(searchBar=ElementCreateInput("BCXSearch","text","","40"),searchBar.oninput=()=>{searchBar&&(searchBarAutoCloase&&!searchBar.value?(exitSearchMode(e),MainCanvas.canvas.focus()):DialogInventoryBuild(e))},searchBar.focus(),DialogInventoryBuild(e))}function exitSearchMode(e){searchBar&&(searchBar.remove(),searchBar=null,searchBarAutoCloase=!1,DialogInventoryBuild(e))}class ModuleDialog extends BaseModule{load(){OverridePlayerDialog("BCX_Search","Filter items"),OverridePlayerDialog("BCX_SearchExit",""),RedirectGetImage("Icons/BCX_Search.png","Icons/Search.png"),RedirectGetImage("Icons/BCX_SearchExit.png","Icons/Remove.png"),hookFunction("DialogMenuButtonBuild",5,((e,t)=>{t(e),allowSearchMode()?searchBar?(DialogMenuButton=["Exit","BCX_SearchExit"],DialogInventory.length>12&&DialogMenuButton.push("Next")):DialogMenuButton.splice(1,0,"BCX_Search"):exitSearchMode(e[0])})),HookDialogMenuButtonClick("BCX_Search",(e=>(enterSearchMode(e),!0))),HookDialogMenuButtonClick("BCX_SearchExit",(e=>(exitSearchMode(e),!0))),hookFunction("CommonKeyDown",5,((e,t)=>{const o=e[0];if(!searchBar&&CurrentCharacter&&allowSearchMode()&&1===o.key.length&&(struggleCooldown<=Date.now()||!["a","s"].includes(o.key.toLowerCase())))return enterSearchMode(CurrentCharacter),searchBarAutoCloase=!0,void(searchBar&&(searchBar.value=o.key,o.preventDefault()));t(e)})),hookFunction("StruggleDrawStrengthProgress",0,((e,t)=>{t(e),struggleCooldown=Date.now()+STRUGGLE_COOLDOWN_TIME})),hookFunction("DialogInventoryAdd",5,((e,t)=>{if(searchBar){const t=e[1];if(!searchBar.value.trim().toLocaleLowerCase().split(" ").every((e=>t.Asset.Description.toLocaleLowerCase().includes(e)||t.Asset.Name.toLocaleLowerCase().includes(e))))return}t(e)})),hookFunction("DialogDrawItemMenu",0,((e,t)=>{searchBar&&ElementPositionFix("BCXSearch",40,1005,25,625,60),t(e)})),hookFunction("DialogLeaveItemMenu",0,((e,t)=>{var o;exitSearchMode(null!==(o=CharacterGetCurrent())&&void 0!==o?o:Player),t(e)})),hookFunction("DialogItemClick",0,((e,t)=>{var o;t(e),exitSearchMode(null!==(o=CharacterGetCurrent())&&void 0!==o?o:Player)}))}run(){const e=CharacterGetCurrent();e&&DialogInventoryBuild(e)}unload(){var e,t;exitSearchMode(null!==(e=CharacterGetCurrent())&&void 0!==e?e:Player),DialogInventoryBuild(null!==(t=CharacterGetCurrent())&&void 0!==t?t:Player)}}const AUTOREFRESH_INTERVAL=1e4;class ModuleFriends extends BaseModule{load(){let e=0,t=!1;hookFunction("FriendListRun",0,((o,n)=>{n(o),DrawButton(1755,25,40,40,"",t?"#88c":"White","","Toggle 10 sec auto-refresh"),DrawImageEx("Icons/Wait.png",1758,28,{Alpha:modStorage.FLAutorefresh?1:.2,Width:34,Height:34}),modStorage.FLAutorefresh&&Date.now()>=e&&ServerIsConnected&&(e=Date.now()+AUTOREFRESH_INTERVAL,t=!0,ServerSend("AccountQuery",{Query:"OnlineFriends"}))})),hookFunction("FriendListLoadFriendList",0,((e,o)=>{t=!1,o(e)})),hookFunction("FriendListClick",4,((o,n)=>{if(MouseIn(1755,25,40,40))return modStorage.FLAutorefresh?delete modStorage.FLAutorefresh:(modStorage.FLAutorefresh=!0,e=Date.now()+AUTOREFRESH_INTERVAL,t=!0,ElementContent("FriendList",""),ServerSend("AccountQuery",{Query:"OnlineFriends"})),void modStorageSync();n(o)}))}}async function initWait(){console.debug("BCX: Init wait"),null==CurrentScreen||"Login"===CurrentScreen?(hookFunction("LoginResponse",0,((e,t)=>{console.debug("BCX: Init LoginResponse caught",e),t(e);const o=e[0];isObject$1(o)&&"string"==typeof o.Name&&"string"==typeof o.AccountName&&loginInit(e[0])})),InfoBeep("BCX Ready!"),console.log("BCX Ready!")):(console.debug("BCX: Already logged in, init"),init())}registerModule(new ModuleAuthority),registerModule(new ModuleCharacter),registerModule(new ModuleChatroom),registerModule(new ModuleChatroomAdmin),registerModule(new ModuleClubUtils),registerModule(new ModuleCommands),registerModule(new ModuleConditions),registerModule(new ModuleConsole),registerModule(new ModuleCurses),registerModule(new ModuleCustom),registerModule(new ModuleDialog),registerModule(new ModuleFriends),registerModule(new ModuleGUI),registerModule(new ModuleLog),registerModule(new ModuleMessaging),registerModule(new ModuleMiscPatches),registerModule(new ModulePresets),registerModule(new ModuleRules),registerModule(new ModuleSpeech),registerModule(new ModuleStorage),registerModule(new ModuleVersionCheck),registerModule(new ModuleWardrobe),init_findBCXSource(),initWait()}();
//# sourceMappingURL=bcx.js.map
